{% extends "shared/base.html" %}

{% block content %}
<section class="section dashboard">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <h5 class="m-0 me-3">Training Plans Management</h5>
      <div class="btn-group btn-group-sm" role="group">
        <button class="btn btn-outline-secondary active" data-status="all" onclick="filterByStatus('all')">
          All Plans
        </button>
        <button class="btn btn-outline-success" data-status="active" onclick="filterByStatus('active')">
          Active
        </button>
        <button class="btn btn-outline-primary" data-status="completed" onclick="filterByStatus('completed')">
          Completed
        </button>
        <button class="btn btn-outline-warning" data-status="archived" onclick="filterByStatus('archived')">
          Archived
        </button>
      </div>
    </div>
    <button class="btn btn-primary" onclick="openCreatePlan()">
      <i class="bi bi-plus-lg me-1"></i> Create Plan
    </button>
  </div>

  <div class="card mb-4">
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label small text-muted">Select Athlete</label>
          <select class="form-select form-select-sm" id="athleteFilter" onchange="applyFilters()">
            <option value="">All Athletes</option>
            {% for athlete in athletes %}
              <option value="{{ athlete.id }}">{{ athlete.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Start Date</label>
          <input type="date" class="form-control form-control-sm" id="startDateFilter" onchange="applyFilters()">
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">End Date</label>
          <input type="date" class="form-control form-control-sm" id="endDateFilter" onchange="applyFilters()">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearFilters()">
            <i class="bi bi-x-circle me-1"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4" id="stats-cards-row">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small mb-1">Total Plans</div>
              <h3 class="mb-0" id="totalPlans">0</h3>
            </div>
            <div class="fs-1 opacity-50">
              <i class="bi bi-journal-text"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small mb-1">Active Plans</div>
              <h3 class="mb-0" id="activePlans">0</h3>
            </div>
            <div class="fs-1 opacity-50">
              <i class="bi bi-play-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small mb-1">Completed</div>
              <h3 class="mb-0" id="completedPlans">0</h3>
            </div>
            <div class="fs-1 opacity-50">
              <i class="bi bi-check-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small mb-1">Athletes</div>
              <h3 class="mb-0">{{ athletes|length }}</h3>
            </div>
            <div class="fs-1 opacity-50">
              <i class="bi bi-people"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Training Plans</h6>
          <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-secondary active" onclick="setView('cards')">
              <i class="bi bi-grid-3x3"></i>
            </button>
            <button class="btn btn-outline-secondary" onclick="setView('list')">
              <i class="bi bi-list-ul"></i>
            </button>
          </div>
        </div>
        <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
          <div id="plansList">
            <div class="text-center text-muted py-5">
              <i class="bi bi-journal-text fs-1"></i>
              <p class="mt-2">Loading plans...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card mb-3" id="athleteStatsCard" style="display: none;">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0" id="selectedAthleteName">
            <i class="bi bi-person-circle me-2"></i>Athlete Stats
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-2 small">
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center">
                <div class="text-muted">Total Plans</div>
                <div class="fw-bold fs-5" id="athleteTotalPlans">0</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center">
                <div class="text-muted">Active</div>
                <div class="fw-bold fs-5 text-success" id="athleteActivePlans">0</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center">
                <div class="text-muted">Completed</div>
                <div class="fw-bold fs-5 text-info" id="athleteCompletedPlans">0</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 bg-light rounded text-center">
                <div class="text-muted">Avg Duration</div>
                <div class="fw-bold fs-5" id="athleteAvgDuration">0w</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-lightbulb me-2"></i>Quick Templates
          </h6>
        </div>
        <div class="card-body p-2">
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-primary text-start" onclick="useTemplate('beginner')">
              <i class="bi bi-star me-2"></i>
              <strong>Beginner Program</strong>
              <div class="small text-muted">4 weeks ‚Ä¢ Foundation building</div>
            </button>
            <button class="btn btn-sm btn-outline-success text-start" onclick="useTemplate('strength')">
              <i class="bi bi-lightning me-2"></i>
              <strong>Strength Training</strong>
              <div class="small text-muted">8 weeks ‚Ä¢ Muscle building</div>
            </button>
            <button class="btn btn-sm btn-outline-warning text-start" onclick="useTemplate('endurance')">
              <i class="bi bi-heart-pulse me-2"></i>
              <strong>Endurance Program</strong>
              <div class="small text-muted">6 weeks ‚Ä¢ Cardio focus</div>
            </button>
            <button class="btn btn-sm btn-outline-info text-start" onclick="useTemplate('hybrid')">
              <i class="bi bi-diagram-3 me-2"></i>
              <strong>Hybrid Training</strong>
              <div class="small text-muted">12 weeks ‚Ä¢ Combined approach</div>
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Quick Actions</h6>
        </div>
        <div class="card-body p-2">
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="viewCalendar()">
              <i class="bi bi-calendar3 me-1"></i> View Calendar
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="exportPlans()">
              <i class="bi bi-download me-1"></i> Export Plans
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="generateReport()">
              <i class="bi bi-file-earmark-bar-graph me-1"></i> Generate Report
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <form id="planForm" class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="planModalTitle">Create Training Plan</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="planId">
        
        <div class="mb-3">
          <label class="form-label">Select Athlete <span class="text-danger">*</span></label>
          <select id="planAthleteId" class="form-select" required>
            <option value="">Choose athlete...</option>
            {% for athlete in athletes %}
              <option value="{{ athlete.id }}">{{ athlete.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="mb-3">
              <label class="form-label">Plan Title <span class="text-danger">*</span></label>
              <input id="planTitle" type="text" class="form-control" required maxlength="150" 
                     placeholder="e.g., 8-Week Strength Building Program">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select id="planStatus" class="form-select">
                <option value="active">‚úÖ Active</option>
                <option value="completed">üèÜ Completed</option>
                <option value="archived">üì¶ Archived</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea id="planDescription" class="form-control" rows="3" 
                    placeholder="Describe the training plan, goals, and approach..."></textarea>
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Start Date <span class="text-danger">*</span></label>
              <input id="planStartDate" type="date" class="form-control" required onchange="calculateDuration()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">End Date</label>
              <input id="planEndDate" type="date" class="form-control" onchange="calculateDuration()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Duration (weeks)</label>
              <input id="planDurationWeeks" type="number" class="form-control" min="1" max="52" value="4" readonly>
              <small class="text-muted">Auto-calculated from dates</small>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label">Plan Cover Image</label>
              <div class="text-center p-3 border rounded" id="imagePreview">
                <img id="generatedImage" src="" style="width: 300px; height: 180px; object-fit: cover; border-radius: 8px; display: none;">
                <div id="imagePlaceholder" class="bg-light d-flex align-items-center justify-content-center rounded" 
                     style="width: 300px; height: 180px; margin: 0 auto;">
                  <i class="bi bi-image fs-1 text-muted"></i>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="generatePlanImage()">
                  <i class="bi bi-stars me-1"></i> Generate Cover
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">
              <i class="bi bi-list-check me-2"></i>Exercises & Workouts
            </label>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addExercise()">
              <i class="bi bi-plus-lg me-1"></i> Add Exercise
            </button>
          </div>
          <div id="exercisesList" class="border rounded p-3 bg-light">
            <div class="text-center text-muted py-3">
              <i class="bi bi-clipboard-plus fs-2"></i>
              <p class="mb-0 mt-2">No exercises added yet</p>
              <small>Click "Add Exercise" to start building the plan</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger me-auto" type="button" id="deletePlanBtn" style="display: none;" onclick="deletePlan()">
          <i class="bi bi-trash me-1"></i> Delete
        </button>
        <button class="btn btn-primary" type="submit" id="savePlanBtn">
          <span id="saveButtonText">Save Plan</span>
          <div class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner"></div>
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="planDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalTitle">Plan Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="planDetailContent">
        </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-info me-2" onclick="duplicatePlanFromDetail()">
          <i class="bi bi-files me-1"></i> Duplicate
        </button>
        <button class="btn btn-primary" onclick="editPlanFromDetail()">
          <i class="bi bi-pencil me-1"></i> Edit Plan
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exerciseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Exercise</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Exercise Name</label>
          <input id="exerciseName" type="text" class="form-control" placeholder="e.g., Bench Press">
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Sets</label>
              <input id="exerciseSets" type="number" class="form-control" min="1" value="3">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Reps</label>
              <input id="exerciseReps" type="text" class="form-control" placeholder="8-12">
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Rest (seconds)</label>
          <input id="exerciseRest" type="number" class="form-control" min="0" value="60">
        </div>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <textarea id="exerciseNotes" class="form-control" rows="2" 
                    placeholder="Add form cues, weight progression, etc."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveExercise()">Add Exercise</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

<script>
// Global variables
let PLANS = [];
let EXERCISES = [];
let editingPlanId = null;
let selectedPlan = null;
let currentView = 'cards';
let currentFilters = {
  athlete_id: null,
  status: 'all',
  start_date: null,
  end_date: null
};

// Plan templates
const PLAN_TEMPLATES = {
  beginner: {
    title: 'Beginner Foundation Program',
    description: 'A comprehensive 4-week program designed for beginners to build strength, endurance, and proper form.',
    duration_weeks: 4,
    exercises: [
      {name: 'Push-ups', sets: 3, reps: '8-10', rest: 60, notes: 'Focus on form'},
      {name: 'Bodyweight Squats', sets: 3, reps: '12-15', rest: 45, notes: 'Keep chest up'},
      {name: 'Plank', sets: 3, reps: '30-45s', rest: 30, notes: 'Maintain straight line'}
    ]
  },
  strength: {
    title: 'Strength Building Program',
    description: '8-week progressive strength training program focusing on compound movements and muscle building.',
    duration_weeks: 8,
    exercises: [
      {name: 'Bench Press', sets: 4, reps: '6-8', rest: 120, notes: 'Progressive overload'},
      {name: 'Squats', sets: 4, reps: '6-8', rest: 120, notes: 'Depth to parallel'},
      {name: 'Deadlifts', sets: 3, reps: '5', rest: 180, notes: 'Neutral spine'}
    ]
  },
  endurance: {
    title: 'Endurance Enhancement Program',
    description: '6-week cardiovascular and muscular endurance program with progressive intensity.',
    duration_weeks: 6,
    exercises: [
      {name: 'Running Intervals', sets: 1, reps: '30min', rest: 0, notes: '5min warmup, 20min intervals'},
      {name: 'Cycling', sets: 1, reps: '45min', rest: 0, notes: 'Moderate to high intensity'},
      {name: 'Circuit Training', sets: 3, reps: '15-20', rest: 30, notes: 'Full body movements'}
    ]
  },
  hybrid: {
    title: 'Hybrid Training Program',
    description: '12-week comprehensive program combining strength, power, and endurance training.',
    duration_weeks: 12,
    exercises: [
      {name: 'Olympic Lifts', sets: 5, reps: '3-5', rest: 180, notes: 'Focus on technique'},
      {name: 'Plyometrics', sets: 4, reps: '8-10', rest: 90, notes: 'Explosive movements'},
      {name: 'HIIT Cardio', sets: 1, reps: '20min', rest: 0, notes: 'Work:rest 40:20'}
    ]
  }
};

// Utility functions
function alertShow(message, type = "info") {
  const container = document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-lg" role="alert" style="z-index:1060; min-width: 300px;">
      <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'info-circle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleDateString('en-US', { 
    year: 'numeric',
    month: 'short', 
    day: 'numeric' 
  });
}

// Calculate duration between dates
function calculateDuration() {
  const startDate = document.getElementById('planStartDate').value;
  const endDate = document.getElementById('planEndDate').value;
  
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    if (end < start) {
        alertShow('End date must be after start date.', 'danger');
        document.getElementById('planEndDate').value = '';
        return;
    }
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    const weeks = Math.max(1, Math.ceil(diffDays / 7));
    document.getElementById('planDurationWeeks').value = weeks;
  }
}

// Generate plan cover image
function generatePlanImage() {
  const planTitle = document.getElementById('planTitle').value || 'Training Plan';
  const canvas = document.createElement('canvas');
  canvas.width = 600;
  canvas.height = 360;
  const ctx = canvas.getContext('2d');
  
  // Create gradient background
  const gradient = ctx.createLinearGradient(0, 0, 600, 360);
  gradient.addColorStop(0, '#667eea');
  gradient.addColorStop(1, '#764ba2');
  
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 600, 360);
  
  // Add icon
  ctx.font = '80px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('üìã', 300, 150);
  
  // Add title
  ctx.font = 'bold 32px Arial';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(planTitle.substring(0, 30), 300, 230);
  
  // Add subtitle
  ctx.font = '20px Arial';
  ctx.fillStyle = '#ffffffcc';
  ctx.fillText('Training Plan', 300, 270);
  
  const dataURL = canvas.toDataURL('image/png');
  document.getElementById('generatedImage').src = dataURL;
  document.getElementById('generatedImage').style.display = 'block';
  document.getElementById('imagePlaceholder').style.display = 'none';
  
  return dataURL;
}

// Exercise management
function addExercise() {
  // Clear exercise modal
  document.getElementById('exerciseName').value = '';
  document.getElementById('exerciseSets').value = '3';
  document.getElementById('exerciseReps').value = '';
  document.getElementById('exerciseRest').value = '60';
  document.getElementById('exerciseNotes').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
  modal.show();
}

function saveExercise() {
  const exercise = {
    name: document.getElementById('exerciseName').value,
    sets: parseInt(document.getElementById('exerciseSets').value),
    reps: document.getElementById('exerciseReps').value,
    rest: parseInt(document.getElementById('exerciseRest').value),
    notes: document.getElementById('exerciseNotes').value
  };
  
  if (!exercise.name) {
    alertShow('Please enter exercise name', 'warning');
    return;
  }
  
  EXERCISES.push(exercise);
  updateExercisesList();
  
  bootstrap.Modal.getInstance(document.getElementById('exerciseModal')).hide();
  alertShow('Exercise added', 'success');
}

function removeExercise(index) {
  EXERCISES.splice(index, 1);
  updateExercisesList();
}

function updateExercisesList() {
  const container = document.getElementById('exercisesList');
  
  if (EXERCISES.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted py-3">
        <i class="bi bi-clipboard-plus fs-2"></i>
        <p class="mb-0 mt-2">No exercises added yet</p>
        <small>Click "Add Exercise" to start building the plan</small>
      </div>
    `;
    return;
  }
  
  container.innerHTML = EXERCISES.map((ex, idx) => `
    <div class="exercise-item p-3 mb-2 bg-white rounded border d-flex justify-content-between align-items-center">
      <div class="flex-grow-1">
        <div class="fw-bold mb-1">${ex.name}</div>
        <div class="small text-muted">
          <span class="badge bg-primary me-1">${ex.sets} sets</span>
          <span class="badge bg-success me-1">${ex.reps} reps</span>
          <span class="badge bg-info">${ex.rest}s rest</span>
        </div>
        ${ex.notes ? `<div class="small text-muted mt-1"><i class="bi bi-info-circle me-1"></i>${ex.notes}</div>` : ''}
      </div>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExercise(${idx})">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  `).join('');
}

// Template usage
function useTemplate(templateName) {
  const template = PLAN_TEMPLATES[templateName];
  if (!template) return;
  
  document.getElementById('planTitle').value = template.title;
  document.getElementById('planDescription').value = template.description;
  document.getElementById('planDurationWeeks').value = template.duration_weeks;
  
  // Set dates
  const today = new Date();
  document.getElementById('planStartDate').value = today.toISOString().split('T')[0];
  
  const endDate = new Date(today);
  endDate.setDate(today.getDate() + (template.duration_weeks * 7));
  document.getElementById('planEndDate').value = endDate.toISOString().split('T')[0];
  
  // Load exercises
  EXERCISES = [...template.exercises];
  updateExercisesList();
  
  generatePlanImage();
  alertShow(`Template "${template.title}" loaded`, 'success');
  
  // Open modal
  openCreatePlan();
}

// Fetch plans
async function fetchPlans() {
  try {
    const listContainer = document.getElementById('plansList');
    listContainer.innerHTML = `
      <div class="text-center text-muted py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading plans...</p>
      </div>`;
      
    let url = '/coach/api/training-plans?';
    const params = new URLSearchParams();
    
    if (currentFilters.athlete_id) params.append('athlete_id', currentFilters.athlete_id);
    if (currentFilters.status && currentFilters.status !== 'all') params.append('status', currentFilters.status);
    if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
    if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);
    
    const response = await fetch(url + params.toString(), {
      credentials: 'include'
    });
    
    if (!response.ok) throw new Error(await response.text() || 'Network error');
    
    PLANS = await response.json();
    updateDashboard();
    
  } catch (error) {
    console.error('Fetch error:', error);
    PLANS = [];
    alertShow(`Failed to load plans: ${error.message}`, 'danger');
    updatePlansList(); // Update UI to show no plans found
  }
}

// Filter functions
function filterByStatus(status) {
  currentFilters.status = status;
  
  // Update button states
  document.querySelectorAll('[data-status]').forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-status') === status) {
      btn.classList.add('active');
    }
  });
  
  fetchPlans();
}

function applyFilters() {
  currentFilters.athlete_id = document.getElementById('athleteFilter').value || null;
  currentFilters.start_date = document.getElementById('startDateFilter').value || null;
  currentFilters.end_date = document.getElementById('endDateFilter').value || null;
  
  fetchPlans();
  
  if (currentFilters.athlete_id) {
    loadAthleteStats(currentFilters.athlete_id);
  } else {
    document.getElementById('athleteStatsCard').style.display = 'none';
  }
}

function clearFilters() {
  document.getElementById('athleteFilter').value = '';
  document.getElementById('startDateFilter').value = '';
  document.getElementById('endDateFilter').value = '';
  currentFilters = {
    athlete_id: null,
    status: 'all',
    start_date: null,
    end_date: null
  };
  // Reset status buttons
  document.querySelectorAll('[data-status]').forEach(btn => btn.classList.remove('active'));
  document.querySelector('[data-status="all"]').classList.add('active');

  fetchPlans();
  document.getElementById('athleteStatsCard').style.display = 'none';
}

// Load athlete stats
async function loadAthleteStats(athleteId) {
  try {
    const response = await fetch(`/coach/api/athletes/${athleteId}/plan-stats`, {
      credentials: 'include'
    });
    
    if (!response.ok) throw new Error('Failed to load stats');
    
    const stats = await response.json();
    
    document.getElementById('athleteStatsCard').style.display = 'block';
    
    const athleteSelect = document.getElementById('athleteFilter');
    const athleteName = athleteSelect.options[athleteSelect.selectedIndex].text;
    document.getElementById('selectedAthleteName').innerHTML = `<i class="bi bi-person-circle me-2"></i>${athleteName} Stats`;
    
    document.getElementById('athleteTotalPlans').textContent = stats.total_plans;
    document.getElementById('athleteActivePlans').textContent = stats.active_plans;
    document.getElementById('athleteCompletedPlans').textContent = stats.completed_plans;
    document.getElementById('athleteAvgDuration').textContent = `${stats.avg_duration_weeks}w`;
    
  } catch (error) {
    console.error('Stats error:', error);
  }
}

// Dashboard update
function updateDashboard() {
  updateStatsCards();
  updatePlansList();
}

function updateStatsCards() {
  const active = PLANS.filter(p => p.status === 'active');
  const completed = PLANS.filter(p => p.status === 'completed');
  
  document.getElementById('totalPlans').textContent = PLANS.length;
  document.getElementById('activePlans').textContent = active.length;
  document.getElementById('completedPlans').textContent = completed.length;
}

function updatePlansList() {
  const container = document.getElementById('plansList');
  
  if (PLANS.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted py-5">
        <i class="bi bi-journal-x fs-1"></i>
        <p class="mt-2">No training plans found</p>
        <button class="btn btn-primary btn-sm" onclick="openCreatePlan()">
          <i class="bi bi-plus-lg me-1"></i> Create First Plan
        </button>
      </div>
    `;
    return;
  }
  
  if (currentView === 'cards') {
    container.innerHTML = `
      <div class="row g-3 p-2">
        ${PLANS.map(plan => {
          const statusColor = plan.status === 'active' ? 'success' : 
                             plan.status === 'completed' ? 'info' : 'secondary';
          const statusIcon = plan.status === 'active' ? '‚ñ∂Ô∏è' : 
                            plan.status === 'completed' ? '‚úÖ' : 'üì¶';
          
          const weeksLeft = plan.end_date ? 
            Math.max(0, Math.ceil((new Date(plan.end_date) - new Date()) / (7 * 24 * 60 * 60 * 1000))) : null;
          
          return `
            <div class="col-md-6">
              <div class="card plan-card h-100" style="cursor: pointer;" onclick="showPlanDetails(${plan.id})">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${plan.title}</h6>
                    <span class="badge bg-${statusColor}">${statusIcon} ${plan.status}</span>
                  </div>
                  <div class="small text-muted mb-2">
                    <span class="badge bg-secondary">${plan.athlete_name}</span>
                  </div>
                  <div class="small text-muted mb-2">
                    <i class="bi bi-calendar3 me-1"></i>${formatDate(plan.start_date)} 
                    ${plan.end_date ? `‚Üí ${formatDate(plan.end_date)}` : ''}
                  </div>
                  <div class="small">
                    <span class="badge bg-primary">${plan.duration_weeks} weeks</span>
                    ${weeksLeft !== null && plan.status === 'active' ? 
                      `<span class="badge bg-warning text-dark">${weeksLeft} weeks left</span>` : ''}
                  </div>
                  ${plan.description ? `
                    <p class="small text-muted mt-2 mb-0" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                      ${plan.description}
                    </p>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  } else {
    container.innerHTML = PLANS.map(plan => {
      const statusColor = plan.status === 'active' ? 'success' : 
                         plan.status === 'completed' ? 'info' : 'secondary';
      
      return `
        <div class="d-flex align-items-center p-3 border-bottom plan-item" 
             style="cursor: pointer;" onclick="showPlanDetails(${plan.id})">
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-medium">${plan.title}</div>
                <div class="text-muted small">
                  <span class="badge bg-secondary me-1">${plan.athlete_name}</span>
                  ${formatDate(plan.start_date)} ‚Üí ${formatDate(plan.end_date)} ‚Ä¢ ${plan.duration_weeks} weeks
                </div>
              </div>
              <span class="badge bg-${statusColor}">${plan.status}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
}

function setView(view) {
  currentView = view;
  document.querySelectorAll('.btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.closest('button').classList.add('active');
  updatePlansList();
}

// Modal functions
function openCreatePlan() {
  resetForm();
  document.getElementById('planStartDate').value = new Date().toISOString().split('T')[0];
  
  if (currentFilters.athlete_id) {
    document.getElementById('planAthleteId').value = currentFilters.athlete_id;
  }
  
  const modal = new bootstrap.Modal(document.getElementById('planModal'));
  modal.show();
}

function showPlanDetails(planId) {
  const plan = PLANS.find(p => p.id === planId);
  if (!plan) {
    alertShow('Plan not found', 'error');
    return;
  }
  
  selectedPlan = plan;
  
  document.getElementById('detailModalTitle').textContent = plan.title;
  
  const statusColor = plan.status === 'active' ? 'success' : 
                     plan.status === 'completed' ? 'info' : 'secondary';
  
  const exercisesCount = plan.exercises ? Object.keys(plan.exercises).length : 0;
  
  let exercisesHtml = '';
  if (exercisesCount > 0) {
    exercisesHtml = `
      <h6>Exercises</h6>
      <ul class="list-group list-group-flush">
        ${Object.values(plan.exercises).map(ex => `
          <li class="list-group-item">
            <div class="fw-bold">${ex.name}</div>
            <div class="small text-muted">
              ${ex.sets} sets, ${ex.reps} reps, ${ex.rest}s rest
            </div>
            ${ex.notes ? `<div class="small text-muted mt-1"><em>${ex.notes}</em></div>` : ''}
          </li>
        `).join('')}
      </ul>
    `;
  } else {
    exercisesHtml = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        This plan contains no exercises.
      </div>
    `;
  }

  document.getElementById('planDetailContent').innerHTML = `
    <div class="row">
      <div class="col-md-12">
        <div class="mb-3">
          <span class="badge bg-${statusColor} fs-6">${plan.status.toUpperCase()}</span>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="p-3 bg-light rounded">
              <div class="small text-muted">Athlete</div>
              <div class="fw-bold">${plan.athlete_name}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 bg-light rounded">
              <div class="small text-muted">Duration</div>
              <div class="fw-bold">${plan.duration_weeks} weeks</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 bg-light rounded">
              <div class="small text-muted">Start Date</div>
              <div class="fw-bold">${formatDate(plan.start_date)}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 bg-light rounded">
              <div class="small text-muted">End Date</div>
              <div class="fw-bold">${formatDate(plan.end_date)}</div>
            </div>
          </div>
        </div>
        
        ${plan.description ? `
          <div class="mb-3">
            <h6>Description</h6>
            <p class="text-muted">${plan.description}</p>
          </div>
        ` : ''}
        
        ${exercisesHtml}
        
        <div class="small text-muted mt-4">
          Created: ${formatDate(plan.created_at)}
        </div>
      </div>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('planDetailModal'));
  modal.show();
}

function editPlanFromDetail() {
  if (!selectedPlan) return;
  
  bootstrap.Modal.getInstance(document.getElementById('planDetailModal')).hide();
  
  editingPlanId = selectedPlan.id;
  document.getElementById('planModalTitle').textContent = 'Edit Training Plan';
  document.getElementById('deletePlanBtn').style.display = 'block';
  
  // Populate form
  document.getElementById('planId').value = selectedPlan.id;
  document.getElementById('planAthleteId').value = selectedPlan.athlete_id;
  document.getElementById('planTitle').value = selectedPlan.title || '';
  document.getElementById('planDescription').value = selectedPlan.description || '';
  document.getElementById('planStartDate').value = selectedPlan.start_date;
  document.getElementById('planEndDate').value = selectedPlan.end_date || '';
  document.getElementById('planDurationWeeks').value = selectedPlan.duration_weeks;
  document.getElementById('planStatus').value = selectedPlan.status;
  
  // Load exercises
  if (selectedPlan.exercises && typeof selectedPlan.exercises === 'object') {
    EXERCISES = Object.values(selectedPlan.exercises);
    updateExercisesList();
  }
  
  // Update image preview
  if (selectedPlan.image_url) {
    document.getElementById('generatedImage').src = selectedPlan.image_url;
    document.getElementById('generatedImage').style.display = 'block';
    document.getElementById('imagePlaceholder').style.display = 'none';
  } else {
    document.getElementById('generatedImage').style.display = 'none';
    document.getElementById('imagePlaceholder').style.display = 'flex';
  }
  
  const modal = new bootstrap.Modal(document.getElementById('planModal'));
  modal.show();
}

async function duplicatePlanFromDetail() {
  if (!selectedPlan) return;
  
  const athleteSelect = document.getElementById('athleteFilter');
  if (!athleteSelect.value) {
      alertShow('Please select an athlete from the filter dropdown to duplicate the plan for them.', 'warning');
      return;
  }

  const confirmed = confirm(`Are you sure you want to duplicate "${selectedPlan.title}" for this athlete?`);
  if (!confirmed) return;
  
  try {
    const formData = new FormData();
    formData.append('athlete_id', athleteSelect.value);
    
    const response = await fetch(`/coach/api/training-plans/${selectedPlan.id}/duplicate`, {
      method: 'POST',
      credentials: 'include',
      body: formData
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      alertShow(data.msg || 'Duplication failed', 'danger');
      return;
    }
    
    alertShow('Plan duplicated successfully!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('planDetailModal')).hide();
    fetchPlans();
    
  } catch (error) {
    console.error('Duplicate error:', error);
    alertShow('Network error occurred', 'danger');
  }
}

// Form submission
document.getElementById('planForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const athleteId = document.getElementById('planAthleteId').value;
  if (!athleteId) {
    alertShow('Please select an athlete', 'warning');
    return;
  }
  
  document.getElementById('saveButtonText').textContent = 'Saving...';
  document.getElementById('saveSpinner').classList.remove('d-none');
  document.getElementById('savePlanBtn').disabled = true;
  
  const formData = new FormData();
  
  formData.append('athlete_id', athleteId);
  formData.append('title', document.getElementById('planTitle').value);
  formData.append('description', document.getElementById('planDescription').value);
  formData.append('start_date', document.getElementById('planStartDate').value);
  formData.append('end_date', document.getElementById('planEndDate').value);
  formData.append('duration_weeks', document.getElementById('planDurationWeeks').value);
  formData.append('status', document.getElementById('planStatus').value);
  
  // Add exercises
  if (EXERCISES.length > 0) {
    const exercisesObj = {};
    EXERCISES.forEach((ex, idx) => {
      exercisesObj[`exercise_${idx}`] = ex;
    });
    formData.append('exercises', JSON.stringify(exercisesObj));
  }
  
  // Generate and attach image only if a new one is generated
  const generatedImageElement = document.getElementById('generatedImage');
  if (generatedImageElement.src && generatedImageElement.style.display !== 'none' && generatedImageElement.src.startsWith('data:')) {
    const response = await fetch(generatedImageElement.src);
    const blob = await response.blob();
    formData.append('image', blob, `plan_${Date.now()}.png`);
  }
  
  try {
    const url = editingPlanId ? 
      `/coach/api/training-plans/${editingPlanId}` : 
      '/coach/api/training-plans';
    const method = editingPlanId ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      credentials: 'include',
      body: formData
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      alertShow(data.msg || 'Operation failed', 'danger');
      return;
    }
    
    alertShow(data.msg || (editingPlanId ? 'Plan updated successfully!' : 'Plan created successfully!'), 'success');
    bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
    resetForm();
    fetchPlans();
    
  } catch (error) {
    console.error('Submit error:', error);
    alertShow('Network error occurred', 'danger');
  } finally {
    document.getElementById('saveButtonText').textContent = 'Save Plan';
    document.getElementById('saveSpinner').classList.add('d-none');
    document.getElementById('savePlanBtn').disabled = false;
  }
});

function resetForm() {
  document.getElementById('planForm').reset();
  EXERCISES = [];
  editingPlanId = null;
  selectedPlan = null;
  document.getElementById('planModalTitle').textContent = 'Create Training Plan';
  document.getElementById('deletePlanBtn').style.display = 'none';
  document.getElementById('planStartDate').value = new Date().toISOString().split('T')[0];
  
  document.getElementById('generatedImage').style.display = 'none';
  document.getElementById('generatedImage').src = '';
  document.getElementById('imagePlaceholder').style.display = 'flex';
  
  updateExercisesList();
}

async function deletePlan() {
  if (!editingPlanId) return;
  
  const confirmed = confirm('Are you sure you want to delete this training plan? This action cannot be undone.');
  if (!confirmed) return;
  
  try {
    const response = await fetch(`/coach/api/training-plans/${editingPlanId}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      alertShow(data.msg || 'Delete failed', 'danger');
      return;
    }
    
    alertShow('Plan deleted successfully', 'success');
    bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
    resetForm();
    fetchPlans();
    
  } catch (error) {
    console.error('Delete error:', error);
    alertShow('Network error occurred', 'danger');
  }
}

// Quick actions
function viewCalendar() {
  alertShow('Calendar view coming soon!', 'info');
}

function exportPlans() {
  if (PLANS.length === 0) {
    alertShow('No plans to export', 'info');
    return;
  }
  
  const csvContent = [
    ['Athlete', 'Title', 'Start Date', 'End Date', 'Duration (weeks)', 'Status'].join(','),
    ...PLANS.map(p => [
      p.athlete_name,
      p.title,
      p.start_date,
      p.end_date || 'N/A',
      p.duration_weeks,
      p.status
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `training_plans_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  alertShow('Plans exported successfully', 'success');
}

function generateReport() {
  alertShow('Report generation feature coming soon!', 'info');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  fetchPlans();
  
  document.getElementById('planModal').addEventListener('hidden.bs.modal', resetForm);
});
</script>

<style>
/* CSS for an elegant and clean design */
/* Using Nice Admin colors and conventions where applicable */

:root {
  --primary-color: #4154f1;
  --secondary-color: #6c757d;
  --success-color: #28a745;
  --info-color: #17a2b8;
  --warning-color: #ffc107;
  --danger-color: #dc3545;
  --light-bg: #f8f9fa;
  --card-border-radius: 8px;
  --shadow: 0 0 10px rgba(0, 0, 0, 0.05);
}

.card {
  border-radius: var(--card-border-radius);
  border: none;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Header and navigation */
.dashboard h5 {
  font-weight: 600;
  color: #333;
}

.btn-group .btn {
  border-radius: 50px !important;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn-group .btn.active {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  transform: scale(1.05);
}

.btn-primary {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
  font-weight: 500;
}

.btn-primary:hover {
  background-color: #3646d9;
  border-color: #3646d9;
}

/* Stats Cards */
#stats-cards-row .card {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

#stats-cards-row .card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.1);
  transform: scale(0);
  transition: transform 0.4s ease;
  border-radius: inherit;
}

#stats-cards-row .card:hover::after {
  transform: scale(1);
}

.bg-primary { background-color: var(--primary-color) !important; }
.bg-success { background-color: var(--success-color) !important; }
.bg-info { background-color: var(--info-color) !important; }
.bg-warning { background-color: var(--warning-color) !important; }

.bg-primary:hover { background-color: #3646d9 !important; }
.bg-success:hover { background-color: #218838 !important; }
.bg-info:hover { background-color: #117a8b !important; }
.bg-warning:hover { background-color: #d39e00 !important; }

/* Main content layout */
.plan-card, .plan-item {
  cursor: pointer;
  border-left: 4px solid var(--primary-color);
  transition: all 0.3s ease;
}

.plan-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.plan-item {
  border-bottom: 1px solid #eee !important;
}

.plan-item:hover {
  background-color: #f8f9fa;
}

/* Modals */
.modal-content {
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.modal-header {
  border-bottom: none;
  font-weight: 600;
  color: #333;
}

/* Form Styling */
.form-control, .form-select {
  border-radius: 5px;
  border-color: #ccc;
}

.form-control:focus, .form-select:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 0.2rem rgba(65, 84, 241, 0.25);
}

/* Exercises list */
.exercise-item {
  border-left: 3px solid transparent;
  transition: all 0.2s ease;
}

.exercise-item:hover {
  border-left-color: var(--primary-color);
  background-color: #f1f1f1;
}

.badge {
  font-weight: 600;
}

.badge.bg-success { background-color: var(--success-color) !important; }
.badge.bg-info { background-color: var(--info-color) !important; }
.badge.bg-primary { background-color: var(--primary-color) !important; }
.badge.bg-warning { background-color: var(--warning-color) !important; }
.badge.bg-secondary { background-color: var(--secondary-color) !important; }

/* Custom scrollbar for better look */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #3646d9;
}
</style>
{% endblock %}