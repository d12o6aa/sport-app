{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Manage Athletes</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Coach Dashboard</a></li>
      <li class="breadcrumb-item active">Manage Athletes</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="row mb-4">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card athletes-card">
        <div class="card-body">
          <h5 class="card-title">Total Athletes</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-people"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalAthletes">0</h6>
              <span class="text-success small pt-1 fw-bold" id="activeAthletes">0 active</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card compliance-card">
        <div class="card-body">
          <h5 class="card-title">Avg Readiness</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-activity"></i>
            </div>
            <div class="ps-3">
              <h6 id="avgReadiness">0%</h6>
              <span class="text-info small pt-1">from ML model</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card workouts-card">
        <div class="card-body">
          <h5 class="card-title">High Risk</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="ps-3">
              <h6 id="highRiskCount">0</h6>
              <span class="text-danger small pt-1">injury risk</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card alerts-card">
        <div class="card-body">
          <h5 class="card-title">Need Attention</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-bell"></i>
            </div>
            <div class="ps-3">
              <h6 id="needAttention">0</h6>
              <span class="text-warning small pt-1">low readiness</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Search Athletes</label>
              <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email">
            </div>
            <div class="col-md-2">
              <label class="form-label">Status</label>
              <select id="statusFilter" class="form-select" onchange="filterAthletes()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="suspended">Suspended</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Injury Risk</label>
              <select id="riskFilter" class="form-select" onchange="filterAthletes()">
                <option value="">All Levels</option>
                <option value="High">High Risk</option>
                <option value="Low">Low Risk</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Readiness</label>
              <select id="readinessFilter" class="form-select" onchange="filterAthletes()">
                <option value="">All</option>
                <option value="high">High (80%+)</option>
                <option value="medium">Medium (50-80%)</option>
                <option value="low">Low (<50%)</option>
              </select>
            </div>
            <div class="col-md-3">
              <div class="btn-group w-100">
                <button class="btn btn-outline-primary" onclick="filterAthletes()">
                  <i class="bi bi-funnel"></i> Apply Filters
                </button>
                <button class="btn btn-primary" onclick="addAthlete()">
                  <i class="bi bi-plus-circle"></i> Add Athlete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Athletes List</h5>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-primary active" onclick="toggleView('grid')">
                <i class="bi bi-grid-3x3"></i>
              </button>
              <button type="button" class="btn btn-outline-primary" onclick="toggleView('list')">
                <i class="bi bi-list-ul"></i>
              </button>
            </div>
          </div>

          <div id="athletesGrid" class="row g-3">
            </div>

          <div id="athletesList" class="table-responsive" style="display: none;">
            <table class="table table-hover datatable" id="athletesTable">
              <thead>
                <tr>
                  <th>Athlete</th>
                  <th>Contact</th>
                  <th>Status</th>
                  <th>Readiness</th>
                  <th>Injury Risk</th>
                  <th>Last Active</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="athletesTableBody">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="athleteModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="athleteModalLabel">Add New Athlete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="athleteForm">
          <input type="hidden" id="athleteId">
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Full Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="athleteName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="athleteEmail" required>
              </div>
            </div>
          </div>

          <div class="row" id="passwordField">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Password <span class="text-danger">*</span></label>
                <input type="password" class="form-control" id="athletePassword" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                <input type="password" class="form-control" id="athletePasswordConfirm" required>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Age</label>
                <input type="number" class="form-control" id="athleteAge" min="1" max="120">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Gender</label>
                <select class="form-select" id="athleteGender">
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Team/Position</label>
                <input type="text" class="form-control" id="athleteTeam">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Weight (kg)</label>
                <input type="number" step="0.1" class="form-control" id="athleteWeight">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Height (cm)</label>
                <input type="number" step="0.1" class="form-control" id="athleteHeight">
              </div>
            </div>
          </div>

          <hr>
          <h6 class="mb-3 text-primary">Key Performance Metrics</h6>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Previous Injuries</label>
                <input type="number" class="form-control" id="athletePreviousInjuries">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Training Intensity</label>
                <input type="number" step="0.1" class="form-control" id="athleteTrainingIntensity">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Recovery Time (Days)</label>
                <input type="number" step="0.1" class="form-control" id="athleteRecoveryTime">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveAthlete()">
          <span id="saveButtonText">Save Athlete</span>
          <div class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner"></div>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="athleteDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-person-badge"></i> <span id="detailAthleteName"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <div class="mb-3">
                  <img id="detailAthleteAvatar" src="" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;" alt="Avatar">
                </div>
                <h5 id="detailAthleteNameFull"></h5>
                <p class="text-muted mb-3" id="detailAthleteEmail"></p>
                <span id="detailAthleteStatus" class="badge"></span>
                
                <hr>
                
                <div class="alert alert-info mb-3">
                  <h6 class="mb-2"><i class="bi bi-cpu"></i> ML Insights</h6>
                  <div class="mb-2">
                    <small class="text-muted">Readiness Score</small>
                    <div class="progress mb-1" style="height: 20px;">
                      <div id="mlReadinessBar" class="progress-bar" style="width: 0%">0%</div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <small><strong>Injury Risk:</strong></small>
                    <span id="mlInjuryRisk" class="badge bg-secondary">N/A</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <small><strong>Injury Probability:</strong></small>
                    <span id="mlInjuryProbability" class="badge bg-secondary">N/A</span>
                  </div>
                </div>
                
                <div class="profile-stats">
                  <div class="stat-item mb-2">
                    <strong>Age:</strong> <span id="detailAge">-</span>
                  </div>
                  <div class="stat-item mb-2">
                    <strong>Weight:</strong> <span id="detailWeight">-</span> kg
                  </div>
                  <div class="stat-item mb-2">
                    <strong>Height:</strong> <span id="detailHeight">-</span> cm
                  </div>
                  <div class="stat-item mb-2">
                    <strong>BMI:</strong> <span id="detailBMI">-</span>
                  </div>
                  <div class="stat-item mb-2">
                    <strong>Training Intensity:</strong> <span id="detailTrainingIntensity">-</span>
                  </div>
                  <div class="stat-item mb-2">
                    <strong>Recovery Time:</strong> <span id="detailRecoveryTime">-</span> days
                  </div>
                  <div class="stat-item mb-2">
                    <strong>Previous Injuries:</strong> <span id="detailPreviousInjuries">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <ul class="nav nav-tabs nav-tabs-bordered" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview-tab">Overview</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#progress-tab">Progress</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#workouts-tab">Workouts</button>
              </li>
            </ul>

            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="overview-tab">
                <div class="row">
                  <div class="col-md-6">
                    <div class="card mb-3">
                      <div class="card-body">
                        <h6 class="card-title">Compliance Rate</h6>
                        <div class="progress mb-2" style="height: 20px;">
                          <div id="detailComplianceBar" class="progress-bar" style="width: 0%">0%</div>
                        </div>
                        <small class="text-muted">Based on completed workouts</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card mb-3">
                      <div class="card-body">
                        <h6 class="card-title">Last Activity</h6>
                        <p id="detailLastActivity" class="mb-0">-</p>
                        <small class="text-muted">Last workout session</small>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Recent Activity</h6>
                    <div id="recentActivity">
                      </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="progress-tab">
                <canvas id="progressChart" width="100" height="50"></canvas>
              </div>

              <div class="tab-pane fade" id="workouts-tab">
                <div id="athleteWorkouts">
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-warning" onclick="editAthleteFromDetails()">
          <i class="bi bi-pencil"></i> Edit Profile
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let athletes = [];
let currentView = 'grid';
let currentAthleteId = null;
let progressChart = null;
let currentAthleteName = ''; 

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadAthletes();
  
  // Search functionality
  document.getElementById('searchInput').addEventListener('input', function() {
    filterAthletes();
  });
});

// Load all athletes (unchanged)
function loadAthletes() {
  fetch('/coach/athletes', {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token')
    }
  })
  .then(response => {
    if (!response.ok) {
        return response.json().then(err => { throw new Error(err.msg); });
    }
    return response.json();
  })
  .then(data => {
    if (Array.isArray(data)) {
        athletes = data;
        displayAthletes();
        updateStats();
    } else {
        console.error('API response is not an array:', data);
        showAlert('Failed to load athletes due to invalid data format.', 'danger');
    }
  })
  .catch(error => {
    console.error('Error loading athletes:', error);
    showAlert(`Failed to load athletes: ${error.message}`, 'danger');
  });
}

// Display athletes in current view (unchanged)
function displayAthletes() {
  if (currentView === 'grid') {
    displayAthletesGrid();
  } else {
    displayAthletesList();
  }
}

// Display athletes in grid view (unchanged)
function displayAthletesGrid() {
  const grid = document.getElementById('athletesGrid');
  const filteredAthletes = getFilteredAthletes();
  
  if (filteredAthletes.length === 0) {
    grid.innerHTML = `
      <div class="col-12 text-center py-5">
        <i class="bi bi-people fs-1 text-muted"></i>
        <p class="mt-2 text-muted">No athletes found matching your criteria</p>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = filteredAthletes.map(athlete => `
    <div class="col-lg-4 col-md-6">
      <div class="card athlete-card h-100 ${getCardBorderClass(athlete.injury_risk)}">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="athlete-avatar me-3">
              <img src="${athlete.profile_image}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;" alt="Avatar">
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-1">${athlete.name}</h6>
              <small class="text-muted">${athlete.email}</small>
            </div>
            <span class="badge bg-${getStatusColor(athlete.status)}">${athlete.status}</span>
          </div>

          <div class="mb-3 p-2 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted"><i class="bi bi-activity"></i> Readiness</small>
              <strong class="text-${getReadinessColor(athlete.readiness_score)}">${athlete.readiness_score || 'N/A'}${athlete.readiness_score && athlete.readiness_score !== 'No Data' ? '%' : ''}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted"><i class="bi bi-shield-exclamation"></i> Injury Risk</small>
              <span class="badge bg-${getRiskColor(athlete.injury_risk)}">${athlete.injury_risk || 'No Data'}</span>
            </div>
          </div>

          <div class="athlete-stats mb-3">
            <div class="d-flex justify-content-between mb-2">
              <small class="text-muted">Compliance</small>
              <strong class="text-${getComplianceColor(athlete.compliance)}">${athlete.compliance}%</strong>
            </div>
            <div class="progress mb-2" style="height: 6px;">
              <div class="progress-bar bg-${getComplianceColor(athlete.compliance)}" style="width: ${athlete.compliance}%"></div>
            </div>
            
            <div class="d-flex justify-content-between">
              <small class="text-muted">
                <i class="bi bi-clock"></i> ${athlete.last_activity}
              </small>
            </div>
          </div>

          <div class="athlete-actions d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewAthleteDetails(${athlete.id})">
              <i class="bi bi-eye"></i> View
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="editAthlete(${athlete.id})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="unassignAthlete(${athlete.id})">
              <i class="bi bi-x-circle"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// Display athletes in list view (unchanged)
function displayAthletesList() {
  const tbody = document.getElementById('athletesTableBody');
  const filteredAthletes = getFilteredAthletes();
  
  tbody.innerHTML = filteredAthletes.map(athlete => `
    <tr onclick="viewAthleteDetails(${athlete.id})" style="cursor: pointer;">
      <td>
        <div class="d-flex align-items-center">
          <div class="athlete-avatar me-2">
             <img src="${athlete.profile_image}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;" alt="Avatar">
          </div>
          <span>${athlete.name}</span>
        </div>
      </td>
      <td>${athlete.email}</td>
      <td><span class="badge bg-${getStatusColor(athlete.status)}">${athlete.status}</span></td>
      <td>
        <div class="d-flex align-items-center">
          <div class="progress me-2" style="height: 8px; width: 60px;">
            <div class="progress-bar bg-${getReadinessColor(athlete.readiness_score)}" style="width: ${athlete.readiness_score || 0}%"></div>
          </div>
          <small>${athlete.readiness_score || 'N/A'}${athlete.readiness_score && athlete.readiness_score !== 'No Data' ? '%' : ''}</small>
        </div>
      </td>
      <td><span class="badge bg-${getRiskColor(athlete.injury_risk)}">${athlete.injury_risk || 'No Data'}</span></td>
      <td><small>${athlete.last_activity}</small></td>
      <td onclick="event.stopPropagation();">
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-warning" onclick="editAthlete(${athlete.id})">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-outline-danger" onclick="unassignAthlete(${athlete.id})">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Get filtered athletes based on current filters (unchanged)
function getFilteredAthletes() {
  let filtered = [...athletes];
  
  // Search filter
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (searchTerm) {
    filtered = filtered.filter(a => 
      a.name.toLowerCase().includes(searchTerm) || 
      a.email.toLowerCase().includes(searchTerm)
    );
  }
  
  // Status filter
  const statusFilter = document.getElementById('statusFilter').value;
  if (statusFilter) {
    filtered = filtered.filter(a => a.status === statusFilter);
  }
  
  // Risk filter
  const riskFilter = document.getElementById('riskFilter').value;
  if (riskFilter) {
    filtered = filtered.filter(a => a.injury_risk && a.injury_risk.toLowerCase() === riskFilter.toLowerCase());
  }
  
  // Readiness filter
  const readinessFilter = document.getElementById('readinessFilter').value;
  if (readinessFilter) {
    filtered = filtered.filter(a => {
      const score = a.readiness_score;
      if (readinessFilter === 'high') return score && score >= 80;
      if (readinessFilter === 'medium') return score && score >= 50 && score < 80;
      if (readinessFilter === 'low') return score && score < 50;
      return true;
    });
  }
  
  return filtered;
}

// Filter athletes (unchanged)
function filterAthletes() {
  displayAthletes();
}

// Toggle between grid and list view (unchanged)
function toggleView(view) {
  currentView = view;
  
  // Update buttons
  document.querySelectorAll('.btn-group .btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.closest('.btn').classList.add('active');
  
  // Toggle visibility
  if (view === 'grid') {
    document.getElementById('athletesGrid').style.display = '';
    document.getElementById('athletesList').style.display = 'none';
  } else {
    document.getElementById('athletesGrid').style.display = 'none';
    document.getElementById('athletesList').style.display = '';
  }
  
  displayAthletes();
}

// Update dashboard stats (unchanged)
function updateStats() {
  const totalAthletes = athletes.length;
  const activeAthletes = athletes.filter(a => a.status === 'active').length;
  
  const athletesWithReadiness = athletes.filter(a => a.readiness_score != null && a.readiness_score !== 'No Data');
  const avgReadiness = athletesWithReadiness.length > 0 ? 
    Math.round(athletesWithReadiness.reduce((sum, a) => sum + a.readiness_score, 0) / athletesWithReadiness.length) : 0;
  
  const highRiskCount = athletes.filter(a => a.injury_risk === 'High').length;
  
  const needAttention = athletes.filter(a => 
      !a.readiness_score || a.readiness_score === 'No Data' || a.readiness_score < 50
  ).length;
  
  document.getElementById('totalAthletes').textContent = totalAthletes;
  document.getElementById('activeAthletes').textContent = `${activeAthletes} active`;
  document.getElementById('avgReadiness').textContent = `${avgReadiness}%`;
  document.getElementById('highRiskCount').textContent = highRiskCount;
  document.getElementById('needAttention').textContent = needAttention;
}

// Add new athlete
function addAthlete() {
  document.getElementById('athleteForm').reset();
  document.getElementById('athleteId').value = '';
  document.getElementById('passwordField').style.display = '';
  document.getElementById('athleteModalLabel').textContent = 'Add New Athlete';
  
  // Ensure ML-related fields are visible for a new athlete
  document.getElementById('athletePreviousInjuries').closest('.row').style.display = 'flex';
  
  new bootstrap.Modal(document.getElementById('athleteModal')).show();
}

// Edit athlete (now fetches all profile data, including ML-related)
function editAthlete(id) {
  fetch(`/coach/athlete/${id}`, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token')
    }
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('athleteId').value = data.id;
    document.getElementById('athleteName').value = data.name;
    document.getElementById('athleteEmail').value = data.email;
    document.getElementById('athleteAge').value = data.age || '';
    document.getElementById('athleteGender').value = data.gender || '';
    document.getElementById('athleteWeight').value = data.weight || '';
    document.getElementById('athleteHeight').value = data.height || '';
    document.getElementById('athleteTeam').value = data.team || '';
    document.getElementById('athletePreviousInjuries').value = data.previous_injuries || '';
    document.getElementById('athleteTrainingIntensity').value = data.training_intensity || '';
    document.getElementById('athleteRecoveryTime').value = data.recovery_time || '';

    document.getElementById('passwordField').style.display = 'none';
    document.getElementById('athleteModalLabel').textContent = 'Edit Athlete';
    
    new bootstrap.Modal(document.getElementById('athleteModal')).show();
  })
  .catch(error => {
    showAlert('Failed to load athlete data', 'danger');
  });
}

// Save athlete (now sends all data, including ML-related)
function saveAthlete() {
  const id = document.getElementById('athleteId').value;
  const password = document.getElementById('athletePassword').value;
  const passwordConfirm = document.getElementById('athletePasswordConfirm').value;
  
  if (!id && password !== passwordConfirm) {
    showAlert('Passwords do not match', 'warning');
    return;
  }
  
  const data = {
    name: document.getElementById('athleteName').value,
    email: document.getElementById('athleteEmail').value,
    age: document.getElementById('athleteAge').value || null,
    gender: document.getElementById('athleteGender').value || null,
    weight: document.getElementById('athleteWeight').value || null,
    height: document.getElementById('athleteHeight').value || null,
    team: document.getElementById('athleteTeam').value || null,
    previous_injuries: document.getElementById('athletePreviousInjuries').value || null,
    training_intensity: document.getElementById('athleteTrainingIntensity').value || null,
    recovery_time: document.getElementById('athleteRecoveryTime').value || null
  };
  
  if (!id) {
    data.password = password;
  }
  
  document.getElementById('saveButtonText').textContent = 'Saving...';
  document.getElementById('saveSpinner').classList.remove('d-none');
  
  const url = id ? `/coach/athlete/${id}` : '/coach/athlete/add';
  const method = id ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.msg) {
      showAlert(data.msg, 'success');
      bootstrap.Modal.getInstance(document.getElementById('athleteModal')).hide();
      loadAthletes();
    }
  })
  .catch(error => {
    showAlert('Failed to save athlete', 'danger');
  })
  .finally(() => {
    document.getElementById('saveButtonText').textContent = 'Save Athlete';
    document.getElementById('saveSpinner').classList.add('d-none');
  });
}

// Unassign athlete (unchanged)
function unassignAthlete(id) {
  if (!confirm('Are you sure you want to unassign this athlete? The admin can reassign them to another coach later.')) {
    return;
  }
  
  fetch(`/coach/athlete/${id}`, {
    method: 'DELETE',
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token')
    }
  })
  .then(response => response.json())
  .then(data => {
    showAlert(data.msg, 'success');
    loadAthletes();
  })
  .catch(error => {
    showAlert('Failed to unassign athlete', 'danger');
  });
}

// View athlete details (unchanged)
function viewAthleteDetails(id) {
  currentAthleteId = id;
  
  resetDetailsModal();

  fetch(`/coach/athlete/${id}/details`, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token')
    }
  })
  .then(response => {
    if (!response.ok) {
        throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    currentAthleteName = data.name; 
    
    populateAthleteDetails(data);
    loadAthleteProgress(id);
    loadAthleteWorkouts(id);
    
    new bootstrap.Modal(document.getElementById('athleteDetailsModal')).show();
  })
  .catch(error => {
    console.error('Error loading athlete details:', error);
    showAlert('Failed to load athlete details. Please try again later.', 'danger');
  });
}

function resetDetailsModal() {
    document.getElementById('detailAthleteAvatar').src = '';
    document.getElementById('detailAthleteName').textContent = '';
    document.getElementById('detailAthleteNameFull').textContent = '';
    document.getElementById('detailAthleteEmail').textContent = '';
    document.getElementById('detailAthleteStatus').textContent = '';
    document.getElementById('detailAge').textContent = '-';
    document.getElementById('detailWeight').textContent = '-';
    document.getElementById('detailHeight').textContent = '-';
    document.getElementById('detailBMI').textContent = '-';
    document.getElementById('detailTrainingIntensity').textContent = '-';
    document.getElementById('detailRecoveryTime').textContent = '-';
    document.getElementById('detailPreviousInjuries').textContent = '-';

    if(progressChart) {
        progressChart.destroy();
    }
    document.getElementById('progressChart').innerHTML = '';
}

// Populate athlete details modal (now shows ML-related data)
function populateAthleteDetails(data) {
  const detailAthleteName = document.getElementById('detailAthleteName');
  if (detailAthleteName) detailAthleteName.textContent = data.name;

  const detailAthleteNameFull = document.getElementById('detailAthleteNameFull');
  if (detailAthleteNameFull) detailAthleteNameFull.textContent = data.name;

  const detailAthleteEmail = document.getElementById('detailAthleteEmail');
  if (detailAthleteEmail) detailAthleteEmail.textContent = data.email;

  const detailAthleteStatus = document.getElementById('detailAthleteStatus');
  if (detailAthleteStatus) {
      detailAthleteStatus.className = `badge bg-${getStatusColor(data.status)}`;
      detailAthleteStatus.textContent = data.status;
  }
  
  const avatar = document.getElementById('detailAthleteAvatar');
  if (avatar) avatar.src = data.profile_image || '/static/uploads/profile/default.jpg';
  
  const detailAge = document.getElementById('detailAge');
  if (detailAge) detailAge.textContent = data.age || '-';

  const detailWeight = document.getElementById('detailWeight');
  if (detailWeight) detailWeight.textContent = data.weight || '-';

  const detailHeight = document.getElementById('detailHeight');
  if (detailHeight) detailHeight.textContent = data.height || '-';
  
  const detailBMI = document.getElementById('detailBMI');
  if (detailBMI) {
    if (data.weight && data.height) {
      const bmi = (data.weight / Math.pow(data.height / 100, 2)).toFixed(1);
      detailBMI.textContent = bmi;
    } else {
      detailBMI.textContent = '-';
    }
  }

  const detailTrainingIntensity = document.getElementById('detailTrainingIntensity');
  if (detailTrainingIntensity) detailTrainingIntensity.textContent = data.training_intensity || '-';

  const detailRecoveryTime = document.getElementById('detailRecoveryTime');
  if (detailRecoveryTime) detailRecoveryTime.textContent = data.recovery_time || '-';

  const detailPreviousInjuries = document.getElementById('detailPreviousInjuries');
  if (detailPreviousInjuries) detailPreviousInjuries.textContent = data.previous_injuries || '-';
  
  const mlInsights = data.ml_insights || {};
  const readiness = data.readiness || {};
  
  const readinessScore = mlInsights.readiness_score || readiness.score || 0;
  const mlReadinessBar = document.getElementById('mlReadinessBar');
  if (mlReadinessBar) {
      mlReadinessBar.style.width = `${readinessScore || 0}%`; 
      mlReadinessBar.textContent = `${readinessScore || 'N/A'}${readinessScore && readinessScore !== 'No Data' ? '%' : ''}`;
      mlReadinessBar.className = `progress-bar bg-${getReadinessColor(readinessScore)}`;
  }
  
  const injuryRiskBadge = document.getElementById('mlInjuryRisk');
  const injuryRisk = readiness.injury_risk || 'No Data';
  if (injuryRiskBadge) {
      injuryRiskBadge.textContent = injuryRisk;
      injuryRiskBadge.className = `badge bg-${getRiskColor(injuryRisk)}`;
  }

  const injuryProbabilityBadge = document.getElementById('mlInjuryProbability');
  const injuryProbability = mlInsights.injury_probability ? `${(mlInsights.injury_probability * 100).toFixed(1)}%` : 'N/A';
  if (injuryProbabilityBadge) {
      injuryProbabilityBadge.textContent = injuryProbability;
      injuryProbabilityBadge.className = `badge bg-${getRiskColor(injuryRisk)}`;
  }
  
  const complianceBar = document.getElementById('detailComplianceBar');
  if (complianceBar) {
      complianceBar.style.width = `${data.compliance}%`;
      complianceBar.textContent = `${data.compliance}%`;
      complianceBar.className = `progress-bar bg-${getComplianceColor(data.compliance)}`;
  }
  
  const detailLastActivity = document.getElementById('detailLastActivity');
  if (detailLastActivity) detailLastActivity.textContent = data.last_activity || 'No recent activity';
  
  loadRecentActivity(data.recent_activities || []);
}


// Load athlete progress chart
function loadAthleteProgress(athleteId) {
  fetch(`/coach/athlete/${athleteId}/progress`, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token')
    }
  })
  .then(response => response.json())
  .then(data => {
    renderProgressChart(data);
  })
  .catch(error => {
    console.error('Error loading progress:', error);
  });
}

// Render progress chart with ML data
function renderProgressChart(data) {
  const ctx = document.getElementById('progressChart');
  
  if (progressChart) {
    progressChart.destroy();
  }
  
  progressChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.dates || [],
      datasets: [{
        label: 'Weight (kg)',
        data: data.weights || [],
        borderColor: '#4154f1',
        backgroundColor: 'rgba(65, 84, 241, 0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y'
      }, {
        label: 'Workouts Completed',
        data: data.workouts || [],
        borderColor: '#2eca6a',
        backgroundColor: 'rgba(46, 202, 106, 0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y1'
      }, {
        label: 'Readiness Score (%)',
        data: data.readiness_scores || [],
        borderColor: '#ff6384',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y2'
      }, {
        label: 'Injury Risk Level',
        data: data.injury_risks || [],
        borderColor: '#ff9f40',
        backgroundColor: 'rgba(255, 159, 64, 0.1)',
        tension: 0.4,
        fill: false,
        yAxisID: 'y3'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: {
            display: true,
            text: 'Weight (kg)'
          }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: {
            display: true,
            text: 'Workouts'
          },
          grid: {
            drawOnChartArea: false
          }
        },
        y2: {
          type: 'linear',
          display: false,
          min: 0,
          max: 100
        },
        y3: {
          type: 'linear',
          display: false,
          min: 0,
          max: 3
        }
      }
    }
  });
}

// Load athlete workouts
function loadAthleteWorkouts(athleteId) {
  fetch(`/coach/athlete/${athleteId}/workouts`, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('access_token')
    }
  })
  .then(response => response.json())
  .then(data => {
    displayAthleteWorkouts(data);
  })
  .catch(error => {
    console.error('Error loading workouts:', error);
  });
}

// Display athlete workouts
function displayAthleteWorkouts(workouts) {
  const container = document.getElementById('athleteWorkouts');
  
  if (container) {
    if (workouts.length === 0) {
      container.innerHTML = '<p class="text-muted text-center py-4">No workout history found</p>';
      return;
    }
    
    container.innerHTML = workouts.map(workout => `
      <div class="card mb-2">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">${workout.title || 'Workout'}</h6>
              <small class="text-muted">${workout.date} • ${workout.duration || 0} mins</small>
            </div>
            <div class="text-end">
              <span class="badge bg-${workout.completion_status === 'completed' ? 'success' : 'warning'}">
                ${workout.completion_status}
              </span>
              <br>
              <small class="text-muted">${workout.calories_burned || 0} cal</small>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// Load recent activity
function loadRecentActivity(activities) {
  const container = document.getElementById('recentActivity');
  
  if (container) {
    if (activities.length === 0) {
      container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
      return;
    }
    
    container.innerHTML = activities.map(activity => `
      <div class="d-flex align-items-start mb-3">
        <div class="activity-icon me-3">
          <i class="bi ${activity.icon} text-primary"></i>
        </div>
        <div class="flex-grow-1">
          <p class="mb-0">${activity.description}</p>
          <small class="text-muted">${activity.timestamp}</small>
        </div>
      </div>
    `).join('');
  }
}

// Edit athlete from details modal (unchanged)
function editAthleteFromDetails() {
  bootstrap.Modal.getInstance(document.getElementById('athleteDetailsModal')).hide();
  editAthlete(currentAthleteId);
}

// Utility functions (unchanged)
function getInitials(name) {
  return name.split(' ').map(n => n[0]).join('').toUpperCase();
}

function getStatusColor(status) {
  const colors = {
    'active': 'success',
    'pending': 'warning',
    'suspended': 'danger',
    'unassigned': 'secondary'
  };
  return colors[status] || 'secondary';
}

function getComplianceColor(compliance) {
  if (compliance >= 80) return 'success';
  if (compliance >= 50) return 'warning';
  return 'danger';
}

function getReadinessColor(score) {
  if (score === null || score === 'No Data' || score === 0) return 'secondary';
  if (score >= 80) return 'success';
  if (score >= 50) return 'info';
  return 'danger';
}

function getRiskColor(risk) {
  const colors = {
    'low': 'success',
    'Low': 'success',
    'medium': 'warning',
    'Medium': 'warning',
    'high': 'danger',
    'High': 'danger',
    'unknown': 'secondary',
    'No Data': 'secondary'
  };
  return colors[risk] || 'secondary';
}

function getCardBorderClass(risk) {
  if (risk && risk.toLowerCase() === 'high') return 'border-danger';
  if (risk && risk.toLowerCase() === 'medium') return 'border-warning';
  return '';
}

function showAlert(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = 'position-fixed top-0 end-0 p-3';
  alertContainer.style.zIndex = '9999';
  
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type} alert-dismissible fade show`;
  alertElement.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  alertContainer.appendChild(alertElement);
  document.body.appendChild(alertContainer);
  
  setTimeout(() => {
    if (alertContainer && alertContainer.parentNode) {
      alertContainer.parentNode.removeChild(alertContainer);
    }
  }, 4000);
}
</script>
{% endblock %}