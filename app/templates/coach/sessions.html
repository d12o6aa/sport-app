{% extends "shared/base.html" %}

{% block content %}
<section class="section dashboard">
  <!-- Header with gradient background -->
  <div class="position-relative mb-5 p-4 rounded-4 bg-gradient-primary-subtle overflow-hidden">
    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10">
      <div class="floating-shapes"></div>
    </div>
    <div class="position-relative z-1 d-flex justify-content-between align-items-center">
      <div>
        <h2 class="fw-bold text-primary mb-2">📋 Session Management</h2>
        <p class="text-muted mb-0">Review and manage athlete session requests</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary rounded-pill hover-lift" id="refreshBtn">
          <i class="bi bi-arrow-clockwise me-2"></i> Refresh
        </button>
        <button class="btn btn-primary rounded-pill shadow-lg hover-lift" data-bs-toggle="modal" data-bs-target="#availabilityModal">
          <i class="bi bi-clock-history me-2"></i> Set Availability
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Stats Cards -->
  <div class="row g-4 mb-5">
    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm hover-lift h-100 stat-card">
        <div class="card-body text-center">
          <div class="rounded-circle bg-warning bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
            <i class="bi bi-clock-history fs-3 text-warning"></i>
          </div>
          <h3 class="fw-bold mb-1 counter" id="pendingSessions">0</h3>
          <p class="text-muted small mb-0">Pending Requests</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm hover-lift h-100 stat-card">
        <div class="card-body text-center">
          <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
            <i class="bi bi-check-circle fs-3 text-success"></i>
          </div>
          <h3 class="fw-bold mb-1 counter" id="approvedSessions">0</h3>
          <p class="text-muted small mb-0">Approved Sessions</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm hover-lift h-100 stat-card">
        <div class="card-body text-center">
          <div class="rounded-circle bg-primary bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
            <i class="bi bi-calendar-event fs-3 text-primary"></i>
          </div>
          <h3 class="fw-bold mb-1 counter" id="todaySessions">0</h3>
          <p class="text-muted small mb-0">Today's Sessions</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card border-0 shadow-sm hover-lift h-100 stat-card">
        <div class="card-body text-center">
          <div class="rounded-circle bg-info bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
            <i class="bi bi-people fs-3 text-info"></i>
          </div>
          <h3 class="fw-bold mb-1 counter" id="totalAthletes">0</h3>
          <p class="text-muted small mb-0">Active Athletes</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <ul class="nav nav-pills mb-4 bg-white rounded-pill shadow-sm p-2" role="tablist">
    <li class="nav-item flex-fill" role="presentation">
      <button class="nav-link active rounded-pill w-100" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
        <i class="bi bi-clock-history me-2"></i>Pending
        <span class="badge bg-warning ms-2" id="pendingBadge">0</span>
      </button>
    </li>
    <li class="nav-item flex-fill" role="presentation">
      <button class="nav-link rounded-pill w-100" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button">
        <i class="bi bi-calendar-check me-2"></i>Approved
        <span class="badge bg-success ms-2" id="approvedBadge">0</span>
      </button>
    </li>
    <li class="nav-item flex-fill" role="presentation">
      <button class="nav-link rounded-pill w-100" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button">
        <i class="bi bi-calendar3 me-2"></i>Calendar View
      </button>
    </li>
    <li class="nav-item flex-fill" role="presentation">
      <button class="nav-link rounded-pill w-100" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button">
        <i class="bi bi-x-circle me-2"></i>Rejected
        <span class="badge bg-danger ms-2" id="rejectedBadge">0</span>
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Pending Requests -->
    <div class="tab-pane fade show active" id="pending" role="tabpanel">
      <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-bell text-warning me-2"></i>Pending Session Requests
            </h5>
            <input type="text" class="form-control form-control-sm w-auto" placeholder="🔍 Search..." id="searchPending">
          </div>
          <div id="pendingList"></div>
        </div>
      </div>
    </div>

    <!-- Approved Sessions -->
    <div class="tab-pane fade" id="approved" role="tabpanel">
      <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-check-circle text-success me-2"></i>Approved Sessions
            </h5>
            <select class="form-select form-select-sm w-auto" id="filterApproved">
              <option value="all">All Sessions</option>
              <option value="upcoming">Upcoming</option>
              <option value="past">Past</option>
            </select>
          </div>
          <div id="approvedList"></div>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div class="tab-pane fade" id="calendar" role="tabpanel">
      <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-4">
          <div id="coachCalendar"></div>
        </div>
      </div>
    </div>

    <!-- Rejected Sessions -->
    <div class="tab-pane fade" id="rejected" role="tabpanel">
      <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-x-circle text-danger me-2"></i>Rejected Sessions
            </h5>
          </div>
          <div id="rejectedList"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Session Details Modal -->
<div class="modal fade" id="sessionDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 bg-gradient-primary text-white">
        <div>
          <h5 class="modal-title mb-1">
            <i class="bi bi-info-circle me-2"></i>Session Details
          </h5>
          <p class="small mb-0 opacity-75">Review session information</p>
        </div>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4" id="sessionDetailsBody">
        <!-- Content will be populated by JS -->
      </div>
      <div class="modal-footer border-0 bg-light" id="sessionDetailsFooter">
        <!-- Buttons will be populated by JS -->
      </div>
    </div>
  </div>
</div>

<!-- Availability Modal -->
<div class="modal fade" id="availabilityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 bg-gradient-primary text-white">
        <div>
          <h5 class="modal-title mb-1">
            <i class="bi bi-clock-history me-2"></i>Set Availability
          </h5>
          <p class="small mb-0 opacity-75">Configure your available time slots</p>
        </div>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p class="text-muted mb-4">Select your working hours for each day of the week:</p>
        <div class="availability-settings">
          <!-- Days will be populated by JS -->
          <div class="day-setting mb-3">
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="monday" checked>
              <label class="form-check-label fw-semibold" for="monday">Monday</label>
            </div>
            <div class="row g-2">
              <div class="col">
                <input type="time" class="form-control form-control-sm" value="09:00">
              </div>
              <div class="col-auto align-self-center">
                <i class="bi bi-arrow-right"></i>
              </div>
              <div class="col">
                <input type="time" class="form-control form-control-sm" value="17:00">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary rounded-pill px-4 shadow hover-lift">
          <i class="bi bi-check-circle me-2"></i>Save Availability
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-x-circle me-2"></i>Reject Session
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="rejectSessionId">
        <label class="form-label fw-semibold">Reason for rejection:</label>
        <textarea class="form-control rounded-3 shadow-sm" id="rejectionReason" rows="4" placeholder="Explain why you're rejecting this session request..." required></textarea>
        <div class="mt-3">
          <p class="small text-muted mb-2">Quick reasons:</p>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-secondary rounded-pill quick-reason" data-reason="Time slot already booked">Already Booked</button>
            <button class="btn btn-sm btn-outline-secondary rounded-pill quick-reason" data-reason="Not available at this time">Not Available</button>
            <button class="btn btn-sm btn-outline-secondary rounded-pill quick-reason" data-reason="Need more notice">Need More Notice</button>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger rounded-pill px-4 shadow" id="confirmRejectBtn">
          <i class="bi bi-x-circle me-2"></i>Reject Session
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.bg-gradient-primary-subtle {
  background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 202, 240, 0.1) 100%);
}

.bg-gradient-primary {
  background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
}

.hover-lift {
  transition: all 0.3s ease;
}

.hover-lift:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
}

.stat-card {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, #0d6efd, #0dcaf0);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.stat-card:hover::before {
  transform: scaleX(1);
}

.floating-shapes {
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(13, 110, 253, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(13, 202, 240, 0.1) 0%, transparent 50%);
  animation: float 20s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

.session-request-card {
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
  cursor: pointer;
}

.session-request-card:hover {
  transform: translateX(8px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.session-request-card.pending {
  border-left-color: #ffc107;
}

.session-request-card.approved {
  border-left-color: #198754;
}

.session-request-card.rejected {
  border-left-color: #dc3545;
}

.badge-status {
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 500;
  font-size: 0.85rem;
}

.quick-reason:hover {
  background-color: #6c757d;
  color: white;
  border-color: #6c757d;
}

.nav-pills .nav-link {
  transition: all 0.3s ease;
  font-weight: 500;
}

.nav-pills .nav-link:hover {
  background-color: rgba(13, 110, 253, 0.1);
}

.nav-pills .nav-link.active {
  background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.fc-event {
  border: none !important;
  border-radius: 8px !important;
  padding: 4px 8px !important;
  font-weight: 500 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
}

.fc-event:hover {
  transform: scale(1.05) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

.empty-state {
  padding: 60px 20px;
  text-align: center;
}

.empty-state i {
  font-size: 80px;
  opacity: 0.3;
  margin-bottom: 20px;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.loading {
  animation: pulse 1.5s ease-in-out infinite;
}

.athlete-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.action-buttons .btn {
  min-width: 100px;
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
  let allSessions = [];
  let calendar;

  // Initialize Calendar
  const calendarEl = document.getElementById('coachCalendar');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    slotMinTime: '06:00:00',
    slotMaxTime: '22:00:00',
    height: 'auto',
    eventClick: function(info) {
      showSessionDetails(info.event.extendedProps);
    },
    events: function(fetchInfo, successCallback, failureCallback) {
      loadSessions(successCallback, failureCallback);
    }
  });

  // Load Sessions
  function loadSessions(successCallback, failureCallback) {
    fetch('/coach/api/sessions', {
      headers: { "Authorization": "Bearer " + localStorage.getItem("access_token") }
    })
    .then(response => response.json())
    .then(data => {
      allSessions = data;
      updateStats(data);
      renderPendingList(data.filter(s => s.status === 'pending'));
      renderApprovedList(data.filter(s => s.status === 'scheduled'));
      renderRejectedList(data.filter(s => s.status === 'rejected'));
      
      if (calendar && successCallback) {
        const events = data
          .filter(s => s.status === 'scheduled')
          .map(session => ({
            id: session.id,
            title: session.title + ' - ' + session.athlete_name,
            start: session.start,
            end: session.end,
            color: session.color || '#0d6efd',
            extendedProps: session
          }));
        successCallback(events);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      if (failureCallback) failureCallback(error);
    });
  }

  // Update Statistics
  function updateStats(sessions) {
    const pending = sessions.filter(s => s.status === 'pending').length;
    const approved = sessions.filter(s => s.status === 'scheduled').length;
    const today = sessions.filter(s => {
      const sessionDate = new Date(s.start).toDateString();
      const todayDate = new Date().toDateString();
      return sessionDate === todayDate && s.status === 'scheduled';
    }).length;

    const uniqueAthletes = new Set(sessions.map(s => s.athlete_id)).size;

    document.getElementById('pendingSessions').textContent = pending;
    document.getElementById('approvedSessions').textContent = approved;
    document.getElementById('todaySessions').textContent = today;
    document.getElementById('totalAthletes').textContent = uniqueAthletes;

    document.getElementById('pendingBadge').textContent = pending;
    document.getElementById('approvedBadge').textContent = approved;
    document.getElementById('rejectedBadge').textContent = sessions.filter(s => s.status === 'rejected').length;
  }

  // Render Pending List
  function renderPendingList(sessions) {
    const container = document.getElementById('pendingList');
    
    if (!sessions || sessions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-inbox text-muted"></i>
          <h5 class="text-muted mt-3">No pending requests</h5>
          <p class="text-muted">All caught up! No session requests waiting for approval.</p>
        </div>
      `;
      return;
    }

    let html = '<div class="row g-3">';
    sessions.forEach(session => {
      const start = new Date(session.start);
      const end = new Date(session.end);
      const duration = Math.round((end - start) / 60000);
      const timeAgo = getTimeAgo(new Date(session.created_at || session.start));

      html += `
        <div class="col-12">
          <div class="card session-request-card pending border-0 shadow-sm" onclick="showSessionDetails(${JSON.stringify(session).replace(/"/g, '&quot;')})">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center gap-3">
                  <img src="/static/images/default.jpg" alt="Athlete" class="athlete-avatar">
                  <div>
                    <h5 class="mb-1 fw-bold">${session.title}</h5>
                    <p class="text-muted small mb-0">
                      <i class="bi bi-person me-1"></i>${session.athlete_name || 'Athlete'}
                      <span class="mx-2">•</span>
                      <i class="bi bi-clock me-1"></i>${timeAgo}
                    </p>
                  </div>
                </div>
                <span class="badge bg-warning badge-status">
                  <i class="bi bi-clock-history me-1"></i>Pending
                </span>
              </div>
              
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <small class="text-muted d-block mb-1">
                    <i class="bi bi-calendar3 me-1"></i>Date
                  </small>
                  <strong>${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</strong>
                </div>
                <div class="col-md-3">
                  <small class="text-muted d-block mb-1">
                    <i class="bi bi-clock me-1"></i>Time
                  </small>
                  <strong>${start.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</strong>
                </div>
                <div class="col-md-3">
                  <small class="text-muted d-block mb-1">
                    <i class="bi bi-hourglass-split me-1"></i>Duration
                  </small>
                  <strong>${duration} min</strong>
                </div>
                <div class="col-md-3">
                  <small class="text-muted d-block mb-1">
                    <i class="bi bi-geo-alt me-1"></i>Type
                  </small>
                  <strong>${session.type === 'virtual' ? '🌐 Virtual' : '🏋️ In-Person'}</strong>
                </div>
              </div>

              <div class="d-flex gap-2 justify-content-end action-buttons">
                <button class="btn btn-outline-danger rounded-pill" onclick="event.stopPropagation(); showRejectModal(${session.id})">
                  <i class="bi bi-x-circle me-2"></i>Reject
                </button>
                <button class="btn btn-success rounded-pill shadow-sm" onclick="event.stopPropagation(); approveSession(${session.id})">
                  <i class="bi bi-check-circle me-2"></i>Approve
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // Render Approved List
  function renderApprovedList(sessions) {
    const container = document.getElementById('approvedList');
    
    if (!sessions || sessions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-calendar-check text-muted"></i>
          <h5 class="text-muted mt-3">No approved sessions</h5>
          <p class="text-muted">Approved sessions will appear here.</p>
        </div>
      `;
      return;
    }

    sessions.sort((a, b) => new Date(a.start) - new Date(b.start));

    let html = '<div class="row g-3">';
    sessions.forEach(session => {
      const start = new Date(session.start);
      const end = new Date(session.end);
      const duration = Math.round((end - start) / 60000);
      const isPast = start < new Date();

      html += `
        <div class="col-md-6">
          <div class="card session-request-card approved border-0 shadow-sm h-100">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0 fw-bold">${session.title}</h6>
                <span class="badge ${isPast ? 'bg-secondary' : 'bg-success'} badge-status">
                  ${isPast ? 'Completed' : 'Upcoming'}
                </span>
              </div>
              <p class="text-muted small mb-3">
                <i class="bi bi-person me-1"></i>${session.athlete_name || 'Athlete'}
              </p>
              <div class="d-flex flex-wrap gap-2 small text-muted mb-3">
                <span><i class="bi bi-calendar3 me-1"></i>${start.toLocaleDateString()}</span>
                <span><i class="bi bi-clock me-1"></i>${start.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>
                <span><i class="bi bi-hourglass-split me-1"></i>${duration} min</span>
              </div>
              <button class="btn btn-sm btn-outline-primary rounded-pill w-100" onclick="showSessionDetails(${JSON.stringify(session).replace(/"/g, '&quot;')})">
                <i class="bi bi-eye me-1"></i>View Details
              </button>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // Render Rejected List
  function renderRejectedList(sessions) {
    const container = document.getElementById('rejectedList');
    
    if (!sessions || sessions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-x-octagon text-muted"></i>
          <h5 class="text-muted mt-3">No rejected sessions</h5>
        </div>
      `;
      return;
    }

    let html = '<div class="list-group">';
    sessions.forEach(session => {
      const start = new Date(session.start);
      
      html += `
        <div class="list-group-item session-request-card rejected border-0 mb-2 shadow-sm">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1 fw-bold">${session.title}</h6>
              <p class="text-muted small mb-0">
                <i class="bi bi-person me-1"></i>${session.athlete_name || 'Athlete'}
                <span class="mx-2">•</span>
                ${start.toLocaleDateString()} at ${start.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
              </p>
              ${session.rejection_reason ? `<p class="text-danger small mb-0 mt-2"><i class="bi bi-info-circle me-1"></i>${session.rejection_reason}</p>` : ''}
            </div>
            <span class="badge bg-danger badge-status">Rejected</span>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // Show Session Details
  window.showSessionDetails = function(session) {
    const start = new Date(session.start);
    const end = new Date(session.end);
    const duration = Math.round((end - start) / 60000);

    const detailsHtml = `
      <div class="row g-4">
        <div class="col-12">
          <div class="d-flex align-items-center gap-3 mb-3">
            <img src="/static/images/default.jpg" alt="Athlete" class="athlete-avatar" style="width: 60px; height: 60px;">
            <div>
              <h4 class="mb-1">${session.title}</h4>
              <p class="text-muted mb-0">
                <i class="bi bi-person me-1"></i>${session.athlete_name || 'Athlete'}
              </p>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <p class="mb-2 small text-muted"><i class="bi bi-calendar3 me-2"></i>Date</p>
            <p class="fw-semibold mb-0">${start.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <p class="mb-2 small text-muted"><i class="bi bi-clock me-2"></i>Time</p>
            <p class="fw-semibold mb-0">${start.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</p>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <p class="mb-2 small text-muted"><i class="bi bi-hourglass-split me-2"></i>Duration</p>
            <p class="fw-semibold mb-0">${duration} minutes</p>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3">
            <p class="mb-2 small text-muted"><i class="bi bi-geo-alt me-2"></i>Session Type</p>
            <p class="fw-semibold mb-0">${session.type === 'virtual' ? '🌐 Virtual Session' : '🏋️ In-Person Training'}</p>
          </div>
        </div>

        ${session.notes ? `
        <div class="col-12">
          <div class="p-3 bg-light rounded-3">
            <p class="mb-2 small text-muted"><i class="bi bi-chat-left-text me-2"></i>Notes</p>
            <p class="mb-0">${session.notes}</p>
          </div>
        </div>
        ` : ''}

        <div class="col-12">
          <div class="p-3 bg-light rounded-3">
            <p class="mb-2 small text-muted"><i class="bi bi-info-circle me-2"></i>Status</p>
            <span class="badge ${session.status === 'pending' ? 'bg-warning' : session.status === 'scheduled' ? 'bg-success' : 'bg-danger'} badge-status">
              ${session.status === 'pending' ? 'Pending Approval' : session.status === 'scheduled' ? 'Approved' : 'Rejected'}
            </span>
          </div>
        </div>

        ${session.rejection_reason ? `
        <div class="col-12">
          <div class="alert alert-danger mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Rejection Reason:</strong> ${session.rejection_reason}
          </div>
        </div>
        ` : ''}
      </div>
    `;

    document.getElementById('sessionDetailsBody').innerHTML = detailsHtml;

    let footerHtml = '<button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Close</button>';
    
    if (session.status === 'pending') {
      footerHtml = `
        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-danger rounded-pill px-4" onclick="showRejectModal(${session.id})">
          <i class="bi bi-x-circle me-2"></i>Reject
        </button>
        <button class="btn btn-success rounded-pill px-4 shadow" onclick="approveSession(${session.id})">
          <i class="bi bi-check-circle me-2"></i>Approve
        </button>
      `;
    }

    document.getElementById('sessionDetailsFooter').innerHTML = footerHtml;
    new bootstrap.Modal(document.getElementById('sessionDetailsModal')).show();
  };

  // Approve Session
  window.approveSession = function(sessionId) {
    if (!confirm('Are you sure you want to approve this session?')) return;

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Approving...';

    fetch(`/coach/api/sessions/${sessionId}/approve`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success || data.msg === "Session approved successfully!") {
        showSuccessAlert('Session approved successfully!');
        loadSessions();
        const modal = bootstrap.Modal.getInstance(document.getElementById('sessionDetailsModal'));
        if (modal) modal.hide();
      } else {
        showErrorAlert(data.msg || 'Failed to approve session');
      }
    })
    .catch(error => {
      showErrorAlert('An error occurred. Please try again.');
      console.error('Error:', error);
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    });
  };

  // Show Reject Modal
  window.showRejectModal = function(sessionId) {
    document.getElementById('rejectSessionId').value = sessionId;
    document.getElementById('rejectionReason').value = '';
    
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('sessionDetailsModal'));
    if (detailsModal) detailsModal.hide();
    
    new bootstrap.Modal(document.getElementById('rejectModal')).show();
  };

  // Quick Reason Buttons
  document.querySelectorAll('.quick-reason').forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('rejectionReason').value = this.dataset.reason;
    });
  });

  // Confirm Reject
  document.getElementById('confirmRejectBtn').addEventListener('click', function() {
    const sessionId = document.getElementById('rejectSessionId').value;
    const reason = document.getElementById('rejectionReason').value.trim();

    if (!reason) {
      showErrorAlert('Please provide a reason for rejection');
      return;
    }

    const originalHtml = this.innerHTML;
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';

    fetch(`/coach/api/sessions/${sessionId}/reject`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      },
      body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success || data.msg === "Session rejected successfully!") {
        showSuccessAlert('Session rejected successfully');
        loadSessions();
        bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
      } else {
        showErrorAlert(data.msg || 'Failed to reject session');
      }
    })
    .catch(error => {
      showErrorAlert('An error occurred. Please try again.');
      console.error('Error:', error);
    })
    .finally(() => {
      this.disabled = false;
      this.innerHTML = originalHtml;
    });
  });

  // Refresh Button
  document.getElementById('refreshBtn').addEventListener('click', function() {
    const icon = this.querySelector('i');
    icon.classList.add('loading');
    loadSessions();
    setTimeout(() => icon.classList.remove('loading'), 1000);
  });

  // Calendar Tab Click
  document.getElementById('calendar-tab').addEventListener('click', function() {
    setTimeout(() => calendar.updateSize(), 100);
  });

  // Utility Functions
  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + ' years ago';
    
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + ' months ago';
    
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + ' days ago';
    
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + ' hours ago';
    
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + ' minutes ago';
    
    return 'Just now';
  }

  function showSuccessAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow-lg';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
      <i class="bi bi-check-circle me-2"></i>${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
  }

  function showErrorAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow-lg';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
      <i class="bi bi-exclamation-circle me-2"></i>${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
  }

  // Initial Load
  loadSessions();
});
</script>
{% endblock %}