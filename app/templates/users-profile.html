{% extends 'shared/base.html' %}
{% block content %}
<div class="container mt-4">
  <h4>My Profile</h4>
  <form id="profileForm" method="POST" enctype="multipart/form-data">
    <!-- صورة البروفايل -->
    <div class="row mb-3">
      <label for="profileImageInput" class="col-md-4 col-lg-3 col-form-label">Profile Image</label>
      <div class="col-md-8 col-lg-9">
        <img id="currentImage" src="{{ url_for('static', filename='uploads/' ~ (user.profile_image or 'default.jpg')) }}" alt="Profile" width="120">
        <div class="pt-2 d-flex gap-2">
          <input type="file" name="profile_image" id="profileImageInput" class="form-control d-inline w-75" />
          <button type="button" class="btn btn-danger btn-sm" id="deleteBtn" title="Remove my profile image">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- باقي البيانات -->
    <div class="mb-3">
      <label for="fullName" class="form-label">Full Name</label>
      <input type="text" class="form-control" id="fullName" name="name" value="{{ user.name }}">
    </div>
  
    <div class="mb-3">
      <label for="emailAddress" class="form-label">Email address</label>
      <input type="email" class="form-control" id="emailAddress" name="email" value="{{ user.email }}" disabled>
    </div>
  
    <div class="mb-3">
      <label for="roleField" class="form-label">Role</label>
      <input type="text" class="form-control" id="roleField" value="{{ user.role }}" disabled>
    </div>
  
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
      Change Password
    </button>
  </form>
  
  
</div>

<!-- Modal for password change -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="changePasswordForm">
        <div class="modal-header">
          <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="currentPassword">Current Password</label>
            <input type="password" class="form-control" id="currentPassword" name="current_password">

          </div>
          <div class="mb-3">
            <label for="newPassword">New Password</label>
            <input type="password" class="form-control" id="newPassword" name="new_password">

          </div>
          <div class="mb-3">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirm_password">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
  document.getElementById("profileForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = document.getElementById("profileForm");
    const formData = new FormData(form);

    const res = await fetch("/user/profile", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("access_token"),
      },
      body: formData,
    });

    const data = await res.json();

    if (res.ok) {
      alert("Profile updated");
      if (data.new_image) {
        document.getElementById("currentImage").src = "/static/uploads/" + data.new_image + "?ts=" + new Date().getTime();
      }
    } else {
      alert(data.msg || "Update failed");
    }
  });

  document.getElementById("deleteBtn").addEventListener("click", async function () {
    if (!confirm("Are you sure you want to delete your profile image?")) return;

    const res = await fetch("/user/profile/image/delete", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("access_token"),
      },
    });

    const data = await res.json();
    if (res.ok) {
      document.getElementById("currentImage").src = "/static/uploads/default.jpg?ts=" + new Date().getTime();
      alert("Image deleted");
    } else {
      alert(data.msg || "Failed to delete image");
    }
  });
</script>

  
{% endblock %}