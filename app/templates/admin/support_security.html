{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Support & Security</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Support & Security</li>
    </ol>
  </nav>
</div>

<section class="section">
  <!-- Stats Cards Row -->
  <div class="row">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card logins-card">
        <div class="card-body">
          <h5 class="card-title">Login Activity</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-person-check"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalLogins">{{ stats.total_logins }}</h6>
              <span class="text-success small pt-1 fw-bold">
                {{ stats.today_logins }}
              </span> <span class="text-muted small pt-2 ps-1">today</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card complaints-card">
        <div class="card-body">
          <h5 class="card-title">Support Tickets</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-chat-dots"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalComplaints">{{ stats.total_tickets }}</h6>
              <span class="text-warning small pt-1 fw-bold">
                {{ stats.pending_tickets }}
              </span> <span class="text-muted small pt-2 ps-1">pending</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card security-card">
        <div class="card-body">
          <h5 class="card-title">Security Alerts</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-shield-exclamation"></i>
            </div>
            <div class="ps-3">
              <h6 id="securityAlerts">{{ stats.suspicious_logins + stats.failed_logins }}</h6>
              <span class="text-danger small pt-1 fw-bold">{{ stats.high_priority_tickets }}</span> <span class="text-muted small pt-2 ps-1">high priority</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card response-card">
        <div class="card-body">
          <h5 class="card-title">Response Time</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-clock-history"></i>
            </div>
            <div class="ps-3">
              <h6 id="avgResponseTime">{{ stats.avg_response_time }}</h6>
              <span class="text-{{ 'success' if stats.response_improvement < 0 else 'danger' }} small pt-1 fw-bold">{{ stats.response_improvement }}%</span> <span class="text-muted small pt-2 ps-1">{{ 'improved' if stats.response_improvement < 0 else 'slower' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Alerts Banner -->
  {% if stats.failed_logins > 5 or stats.suspicious_logins > 0 %}
  <div class="row">
    <div class="col-12">
      <div class="alert alert-danger alert-dismissible fade show border-0 shadow-sm" role="alert">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="alert-heading mb-1">Active Security Alerts</h6>
            <p class="mb-2">{{ stats.failed_logins }} failed login attempts and {{ stats.suspicious_logins }} suspicious activities detected</p>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-danger btn-sm" onclick="viewSecurityDetails()">
                <i class="bi bi-eye"></i> View Details
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="viewSecurityReport()">
                <i class="bi bi-file-earmark-text"></i> Security Report
              </button>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Main Content Row -->
  <div class="row">
    <!-- Login Logs Section -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">
              <i class="bi bi-activity text-primary me-2"></i>Recent Login Activity
            </h5>
            <div class="dropdown">
              <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-funnel"></i> Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterLogins('all')">All Logins</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterLogins('suspicious')">Suspicious Only</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterLogins('failed')">Failed Attempts</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterLogins('success')">Successful Only</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="exportLogs('login')">
                  <i class="bi bi-download me-1"></i>Export CSV
                </a></li>
              </ul>
            </div>
          </div>

          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" placeholder="Search by user or IP..." id="loginSearch">
            </div>
          </div>
          
          <div class="login-logs-container" style="max-height: 500px; overflow-y: auto;">
            {% for log in login_logs[:20] %}
            <div class="login-log-item d-flex align-items-center p-3 mb-2 bg-light rounded border-start border-4 border-{{ 'success' if log.status == 'success' else 'danger' }}" data-log-id="{{ log.id }}">
              <div class="log-user-info me-3">
                <div class="user-avatar bg-{{ 'success' if log.status == 'success' else 'danger' }} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                  {% if log.user %}
                    {{ log.user.name[0].upper() }}
                  {% else %}
                    <i class="bi bi-person-x"></i>
                  {% endif %}
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">
                  {% if log.user %}
                    {{ log.user.name }}
                    <small class="text-muted">({{ log.user.email }})</small>
                  {% else %}
                    <span class="text-danger">Unknown User</span>
                  {% endif %}
                </h6>
                <div class="d-flex align-items-center gap-2 mb-1">
                  <span class="badge bg-secondary">
                    <i class="bi bi-geo-alt"></i> {{ log.ip_address }}
                  </span>
                  <span class="badge bg-{{ 'success' if log.status == 'success' else 'danger' }}">
                    {{ log.status|title }}
                  </span>
                  {% if log.is_suspicious %}
                  <span class="badge bg-warning">
                    <i class="bi bi-exclamation-triangle"></i> Suspicious
                  </span>
                  {% endif %}
                </div>
                <small class="text-muted">
                  <i class="bi bi-clock"></i> {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </small>
              </div>
              <div class="log-actions">
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-primary btn-sm" onclick="viewLoginDetails({{ log.id }})" title="View Details">
                    <i class="bi bi-eye"></i>
                  </button>
                  {% if log.status != 'success' or log.is_suspicious %}
                  <button class="btn btn-outline-danger btn-sm" onclick="blockUserIP('{{ log.ip_address }}')" title="Block IP">
                    <i class="bi bi-ban"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
            
            {% if login_logs|length == 0 %}
            <div class="text-center py-4">
              <i class="bi bi-inbox fs-1 text-muted"></i>
              <p class="text-muted mt-2">No login activity found</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Complaints/Support Section -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">
              <i class="bi bi-headset text-success me-2"></i>Support Tickets
            </h5>
            <div class="d-flex gap-2">
              <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#newTicketModal">
                <i class="bi bi-plus-circle"></i> New Ticket
              </button>
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Status
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="filterComplaints('all')">All Tickets</a></li>
                  <li><a class="dropdown-item" href="#" onclick="filterComplaints('pending')">Pending</a></li>
                  <li><a class="dropdown-item" href="#" onclick="filterComplaints('in_progress')">In Progress</a></li>
                  <li><a class="dropdown-item" href="#" onclick="filterComplaints('resolved')">Resolved</a></li>
                </ul>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" placeholder="Search tickets..." id="complaintSearch">
            </div>
          </div>

          <div class="complaints-container" style="max-height: 500px; overflow-y: auto;">
            {% for complaint in complaints[:20] %}
            <div class="complaint-item card mb-2 border-start border-4 border-{{ 'warning' if complaint.status == 'pending' else 'success' if complaint.status == 'resolved' else 'info' }}" data-complaint-id="{{ complaint.id }}">
              <div class="card-body p-3">
                <div class="d-flex align-items-start justify-content-between">
                  <div class="d-flex align-items-start flex-grow-1">
                    <div class="complaint-avatar me-3">
                      <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        {{ complaint.user.name[0].upper() if complaint.user else '?' }}
                      </div>
                    </div>
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <h6 class="mb-0">{{ complaint.user.name if complaint.user else 'Anonymous' }}</h6>
                        <span class="badge bg-{{ 'warning' if complaint.status == 'pending' else 'success' if complaint.status == 'resolved' else 'info' }}">
                          {{ complaint.status|title }}
                        </span>
                        <span class="badge bg-{{ 'danger' if complaint.priority == 'high' else 'warning' if complaint.priority == 'medium' else 'secondary' }}">
                          {{ complaint.priority|title if complaint.priority else 'Normal' }} Priority
                        </span>
                      </div>
                      <p class="mb-2 text-truncate" style="max-width: 300px;" title="{{ complaint.content }}">
                        <strong>{{ complaint.subject }}</strong><br>
                        <i class="bi bi-chat-quote"></i> {{ complaint.content[:80] }}{% if complaint.content|length > 80 %}...{% endif %}
                      </p>
                      <small class="text-muted">
                        <i class="bi bi-calendar"></i> {{ complaint.created_at.strftime('%Y-%m-%d %H:%M') }}
                      </small>
                    </div>
                  </div>
                  <div class="complaint-actions">
                    <div class="btn-group-vertical" role="group">
                      <button class="btn btn-outline-primary btn-sm mb-1" onclick="viewComplaint({{ complaint.id }})" title="View Full Complaint">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button class="btn btn-outline-success btn-sm mb-1" onclick="respondToComplaint({{ complaint.id }})" title="Respond">
                        <i class="bi bi-reply"></i>
                      </button>
                      {% if complaint.status != 'resolved' %}
                      <button class="btn btn-outline-warning btn-sm" onclick="markResolved({{ complaint.id }})" title="Mark Resolved">
                        <i class="bi bi-check-circle"></i>
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            
            {% if complaints|length == 0 %}
            <div class="text-center py-4">
              <i class="bi bi-inbox fs-1 text-muted"></i>
              <p class="text-muted mt-2">No support tickets found</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Tools & Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">
              <i class="bi bi-shield-lock text-danger me-2"></i>Security Management Tools
            </h5>
            <button class="btn btn-danger btn-sm" onclick="viewSecurityReport()">
              <i class="bi bi-file-earmark-text"></i> Security Report
            </button>
          </div>

          <div class="row g-3">
            <!-- Two-Factor Authentication -->
            <div class="col-md-3">
              <div class="security-tool-card card border-primary h-100" onclick="manage2FA()">
                <div class="card-body text-center">
                  <div class="mb-3">
                    <i class="bi bi-shield-check text-primary" style="font-size: 2.5rem;"></i>
                  </div>
                  <h6 class="card-title">Two-Factor Auth</h6>
                  <p class="card-text small text-muted">Enable 2FA for enhanced security</p>
                  <div class="mt-auto">
                    <span class="badge bg-success">
                      {% if stats.total_logins > 0 %}
                        {{ ((stats.total_logins - stats.failed_logins) / stats.total_logins * 100) | round(2) }}% Success Rate
                      {% else %}
                        0% Success Rate
                      {% endif %}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Password Policies -->
            <div class="col-md-3">
              <div class="security-tool-card card border-warning h-100" onclick="managePasswordPolicies()">
                <div class="card-body text-center">
                  <div class="mb-3">
                    <i class="bi bi-key text-warning" style="font-size: 2.5rem;"></i>
                  </div>
                  <h6 class="card-title">Password Policies</h6>
                  <p class="card-text small text-muted">Configure password requirements</p>
                  <div class="mt-auto">
                    <span class="badge bg-warning">{{ stats.failed_logins }} Failed Logins</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- IP Blacklist -->
            <div class="col-md-3">
              <div class="security-tool-card card border-danger h-100" onclick="manageIPBlacklist()">
                <div class="card-body text-center">
                  <div class="mb-3">
                    <i class="bi bi-ban text-danger" style="font-size: 2.5rem;"></i>
                  </div>
                  <h6 class="card-title">IP Blacklist</h6>
                  <p class="card-text small text-muted">Manage blocked IP addresses</p>
                  <div class="mt-auto">
                    <span class="badge bg-danger">{{ stats.suspicious_logins }} Suspicious</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Session Management -->
            <div class="col-md-3">
              <div class="security-tool-card card border-info h-100" onclick="manageActiveSessions()">
                <div class="card-body text-center">
                  <div class="mb-3">
                    <i class="bi bi-person-lines-fill text-info" style="font-size: 2.5rem;"></i>
                  </div>
                  <h6 class="card-title">Active Sessions</h6>
                  <p class="card-text small text-muted">Monitor user sessions</p>
                  <div class="mt-auto">
                    <span class="badge bg-info">{{ stats.today_logins }} Today</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- New Support Ticket Modal -->
<div class="modal fade" id="newTicketModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Support Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newTicketForm">
          <div class="mb-3">
            <label class="form-label">User *</label>
            <select class="form-select" id="ticketUserId" required>
              <option value="">Select User</option>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Priority</label>
            <select class="form-select" id="ticketPriority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Subject *</label>
            <input type="text" class="form-control" id="ticketSubject" required placeholder="Brief description of the issue">
          </div>
          <div class="mb-3">
            <label class="form-label">Description *</label>
            <textarea class="form-control" id="ticketContent" rows="4" required placeholder="Detailed description of the issue..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="createSupportTicket()">
          <i class="bi bi-plus-circle"></i> Create Ticket
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Complaint Modal -->
<div class="modal fade" id="viewComplaintModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Support Ticket Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="complaintDetails">
        <!-- Dynamic content will be loaded here -->
        <div class="text-center py-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="respondToComplaintModal()">
          <i class="bi bi-reply"></i> Respond
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Login Details Modal -->
<div class="modal fade" id="loginDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Login Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="loginDetails">
        <!-- Dynamic content will be loaded here -->
        <div class="text-center py-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
    /* Nice Admin Compatible Styles */
    .logins-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
    .complaints-card .card-icon { background: linear-gradient(90deg, #ff771d, #ffb347); }
    .security-card .card-icon { background: linear-gradient(90deg, #dc3545, #c82333); }
    .response-card .card-icon { background: linear-gradient(90deg, #20c997, #17a2b8); }

    .security-tool-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .security-tool-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .login-log-item:hover,
    .complaint-item:hover {
      background-color: #f8f9fa !important;
      transform: translateX(3px);
      transition: all 0.3s ease;
    }

    .user-avatar {
      font-weight: bold;
      font-size: 0.9rem;
    }

    .complaint-avatar {
      font-weight: bold;
      font-size: 0.85rem;
    }

    .border-4 {
      border-width: 4px !important;
    }

    .btn-group-vertical .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .alert-danger {
      border-left: 4px solid #dc3545;
    }

    .login-logs-container::-webkit-scrollbar,
    .complaints-container::-webkit-scrollbar {
      width: 6px;
    }

    .login-logs-container::-webkit-scrollbar-track,
    .complaints-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }

    .login-logs-container::-webkit-scrollbar-thumb,
    .complaints-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 6px;
    }

    .login-logs-container::-webkit-scrollbar-thumb:hover,
    .complaints-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .text-truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
</style>

<script>
// Global Variables
let currentComplaintId = null;
let currentLoginId = null;

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Support & Security Dashboard loaded');
    initializeSearchFilters();
    initializeModals();
    
    // Refresh stats every 30 seconds
    setInterval(refreshDashboardStats, 30000);
});

function initializeModals() {
    // Initialize Bootstrap modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (!bootstrap.Modal.getInstance(modal)) {
            new bootstrap.Modal(modal);
        }
    });
}

function initializeSearchFilters() {
    // Login search with debouncing
    const loginSearch = document.getElementById('loginSearch');
    if (loginSearch) {
        loginSearch.addEventListener('input', debounce(function() {
            filterLoginLogs(this.value);
        }, 300));
    }

    // Complaint search with debouncing  
    const complaintSearch = document.getElementById('complaintSearch');
    if (complaintSearch) {
        complaintSearch.addEventListener('input', debounce(function() {
            filterComplaintTickets(this.value);
        }, 300));
    }
}

// Login Management Functions
function filterLogins(type) {
    console.log(`Filtering logins by: ${type}`);
    showLoadingState('.login-logs-container');
    
    fetch(`/admin/api/login-logs?filter=${type}`, {
        headers: getAuthHeaders()
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            refreshLoginLogs(data.logs);
            showToast(`Filtered to ${type} logins`, 'info');
        } else {
            throw new Error(data.error || 'Failed to filter logins');
        }
    })
    .catch(error => {
        console.error('Error filtering login logs:', error);
        showToast('Error filtering login logs: ' + error.message, 'error');
    })
    .finally(() => {
        hideLoadingState('.login-logs-container');
    });
}

function refreshLoginLogs(logs) {
    const container = document.querySelector('.login-logs-container');
    if (!container) return;
    
    if (logs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="text-muted mt-2">No login activity found</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    logs.forEach(log => {
        const logElement = createLoginLogElement(log);
        container.appendChild(logElement);
    });
}

function createLoginLogElement(log) {
    const div = document.createElement('div');
    div.className = `login-log-item d-flex align-items-center p-3 mb-2 bg-light rounded border-start border-4 border-${log.status === 'success' ? 'success' : 'danger'}`;
    div.setAttribute('data-log-id', log.id);
    
    const suspiciousBadge = log.is_suspicious ? 
        `<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Suspicious</span>` : '';
    
    div.innerHTML = `
        <div class="log-user-info me-3">
            <div class="user-avatar bg-${log.status === 'success' ? 'success' : 'danger'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                ${log.user_name ? log.user_name[0].toUpperCase() : '<i class="bi bi-person-x"></i>'}
            </div>
        </div>
        <div class="flex-grow-1">
            <h6 class="mb-1">
                ${log.user_name || '<span class="text-danger">Unknown User</span>'}
                <small class="text-muted">${log.user_email ? `(${log.user_email})` : ''}</small>
            </h6>
            <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge bg-secondary">
                    <i class="bi bi-geo-alt"></i> ${log.ip_address}
                </span>
                <span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">
                    ${log.status.charAt(0).toUpperCase() + log.status.slice(1)}
                </span>
                ${suspiciousBadge}
            </div>
            <small class="text-muted">
                <i class="bi bi-clock"></i> ${log.timestamp}
            </small>
        </div>
        <div class="log-actions">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="viewLoginDetails(${log.id})" title="View Details">
                    <i class="bi bi-eye"></i>
                </button>
                ${log.status !== 'success' || log.is_suspicious ? `
                <button class="btn btn-outline-danger btn-sm" onclick="blockUserIP('${log.ip_address}')" title="Block IP">
                    <i class="bi bi-ban"></i>
                </button>` : ''}
            </div>
        </div>
    `;
    
    return div;
}

function filterLoginLogs(searchTerm) {
    const logItems = document.querySelectorAll('.login-log-item');
    const term = searchTerm.toLowerCase().trim();
    
    if (term === '') {
        logItems.forEach(item => item.style.display = 'flex');
        return;
    }
    
    logItems.forEach(item => {
        const textContent = item.textContent.toLowerCase();
        const shouldShow = textContent.includes(term);
        item.style.display = shouldShow ? 'flex' : 'none';
    });
}

function viewLoginDetails(logId) {
    console.log(`Viewing login details for ID: ${logId}`);
    currentLoginId = logId;
    
    const modal = new bootstrap.Modal(document.getElementById('loginDetailsModal'));
    modal.show();
    
    fetch(`/admin/api/login-log/${logId}`, {
        headers: getAuthHeaders()
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            const log = data.log;
            document.getElementById('loginDetails').innerHTML = createLoginDetailsHTML(log);
        } else {
            throw new Error(data.error || 'Failed to load login details');
        }
    })
    .catch(error => {
        console.error('Error loading login details:', error);
        document.getElementById('loginDetails').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 
                Error loading login details: ${error.message}
            </div>
        `;
    });
}

function createLoginDetailsHTML(log) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6>User Information</h6>
                <p><strong>Name:</strong> ${log.user_name || 'N/A'}</p>
                <p><strong>Email:</strong> ${log.user_email || 'N/A'}</p>
                <p><strong>User ID:</strong> ${log.user_id || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Login Details</h6>
                <p><strong>IP Address:</strong> <code>${log.ip_address || 'N/A'}</code></p>
                <p><strong>Status:</strong> <span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">${log.status || 'N/A'}</span></p>
                <p><strong>Timestamp:</strong> ${log.timestamp || 'N/A'}</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <h6>Security Information</h6>
                <p><strong>Suspicious:</strong> ${log.is_suspicious ? '<span class="text-danger">Yes</span>' : '<span class="text-success">No</span>'}</p>
                <p><strong>User Agent:</strong> <small><code>${log.user_agent || 'Not recorded'}</code></small></p>
                ${log.details ? `<p><strong>Additional Details:</strong><br><small>${log.details}</small></p>` : ''}
            </div>
        </div>
    `;
}

function blockUserIP(ipAddress) {
    if (!confirm(`Are you sure you want to block IP address: ${ipAddress}?\n\nThis will mark all logins from this IP as suspicious.`)) {
        return;
    }
    
    console.log(`Blocking IP: ${ipAddress}`);
    
    fetch('/admin/api/block-ip', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({
            'ip_address': ipAddress,
            'reason': 'Blocked due to suspicious activity'
        })
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            showToast(`IP ${ipAddress} has been blocked successfully`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            throw new Error(data.error || 'Failed to block IP');
        }
    })
    .catch(error => {
        console.error('Error blocking IP address:', error);
        showToast('Error blocking IP address: ' + error.message, 'error');
    });
}

function exportLogs(logType) {
    console.log(`Exporting ${logType} logs`);
    
    const link = document.createElement('a');
    link.href = `/admin/api/export-${logType}-logs`;
    link.download = `${logType}_logs_${new Date().toISOString().split('T')[0]}.csv`;
    
    // Add auth header by opening in new window for download
    window.open(link.href, '_blank');
    
    showToast(`${logType.charAt(0).toUpperCase() + logType.slice(1)} logs export initiated`, 'info');
}

// Support Ticket Functions
function filterComplaints(status) {
    console.log(`Filtering complaints by status: ${status}`);
    showLoadingState('.complaints-container');
    
    fetch(`/admin/api/complaints?status=${status}`, {
        headers: getAuthHeaders()
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            refreshComplaintTickets(data.complaints);
            showToast(`Filtered to ${status} tickets`, 'info');
        } else {
            throw new Error(data.error || 'Failed to filter complaints');
        }
    })
    .catch(error => {
        console.error('Error filtering complaints:', error);
        showToast('Error filtering complaints: ' + error.message, 'error');
    })
    .finally(() => {
        hideLoadingState('.complaints-container');
    });
}

function refreshComplaintTickets(tickets) {
    const container = document.querySelector('.complaints-container');
    if (!container) return;
    
    if (tickets.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="text-muted mt-2">No support tickets found</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    tickets.forEach(ticket => {
        const ticketElement = createComplaintElement(ticket);
        container.appendChild(ticketElement);
    });
}

function createComplaintElement(complaint) {
    const priorityColor = complaint.priority === 'high' ? 'danger' : 
                         complaint.priority === 'medium' ? 'warning' : 'secondary';
    const statusColor = complaint.status === 'pending' ? 'warning' : 
                       complaint.status === 'resolved' ? 'success' : 'info';
    
    const div = document.createElement('div');
    div.className = `complaint-item card mb-2 border-start border-4 border-${statusColor}`;
    div.setAttribute('data-complaint-id', complaint.id);
    
    div.innerHTML = `
        <div class="card-body p-3">
            <div class="d-flex align-items-start justify-content-between">
                <div class="d-flex align-items-start flex-grow-1">
                    <div class="complaint-avatar me-3">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            ${complaint.user ? complaint.user[0].toUpperCase() : '?'}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <h6 class="mb-0">${complaint.user || 'Anonymous'}</h6>
                            <span class="badge bg-${statusColor}">
                                ${complaint.status.charAt(0).toUpperCase() + complaint.status.slice(1)}
                            </span>
                            <span class="badge bg-${priorityColor}">
                                ${complaint.priority ? complaint.priority.charAt(0).toUpperCase() + complaint.priority.slice(1) : 'Normal'} Priority
                            </span>
                        </div>
                        <p class="mb-2 text-truncate" style="max-width: 300px;" title="${complaint.content}">
                            <strong>${complaint.subject}</strong><br>
                            <i class="bi bi-chat-quote"></i> ${complaint.content.length > 80 ? complaint.content.substring(0, 80) + '...' : complaint.content}
                        </p>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> ${complaint.created_at}
                        </small>
                    </div>
                </div>
                <div class="complaint-actions">
                    <div class="btn-group-vertical" role="group">
                        <button class="btn btn-outline-primary btn-sm mb-1" onclick="viewComplaint(${complaint.id})" title="View Full Complaint">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm mb-1" onclick="respondToComplaint(${complaint.id})" title="Respond">
                            <i class="bi bi-reply"></i>
                        </button>
                        ${complaint.status !== 'resolved' ? `
                        <button class="btn btn-outline-warning btn-sm" onclick="markResolved(${complaint.id})" title="Mark Resolved">
                            <i class="bi bi-check-circle"></i>
                        </button>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function filterComplaintTickets(searchTerm) {
    const complaintItems = document.querySelectorAll('.complaint-item');
    const term = searchTerm.toLowerCase().trim();
    
    if (term === '') {
        complaintItems.forEach(item => item.style.display = 'block');
        return;
    }
    
    complaintItems.forEach(item => {
        const textContent = item.textContent.toLowerCase();
        const shouldShow = textContent.includes(term);
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

function createSupportTicket() {
    const form = document.getElementById('newTicketForm');
    const formData = new FormData(form);
    
    const ticketData = {
        user_id: document.getElementById('ticketUserId').value,
        priority: document.getElementById('ticketPriority').value,
        subject: document.getElementById('ticketSubject').value.trim(),
        content: document.getElementById('ticketContent').value.trim()
    };
    
    // Validation
    if (!ticketData.user_id || !ticketData.subject || !ticketData.content) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    console.log('Creating support ticket...', ticketData);
    
    const button = event.target;
    setLoadingState(button, true);
    
    fetch('/admin/api/create-support-ticket', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(ticketData)
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            showToast('Support ticket created successfully', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('newTicketModal'));
            if (modal) modal.hide();
            resetSupportTicketForm();
            setTimeout(() => location.reload(), 1500);
        } else {
            throw new Error(data.error || 'Failed to create ticket');
        }
    })
    .catch(error => {
        console.error('Error creating support ticket:', error);
        showToast('Error creating support ticket: ' + error.message, 'error');
    })
    .finally(() => {
        setLoadingState(button, false);
    });
}

function resetSupportTicketForm() {
    document.getElementById('ticketUserId').value = '';
    document.getElementById('ticketPriority').value = 'medium';
    document.getElementById('ticketSubject').value = '';
    document.getElementById('ticketContent').value = '';
}

function viewComplaint(complaintId) {
    console.log(`Viewing complaint ID: ${complaintId}`);
    currentComplaintId = complaintId;
    
    const modal = new bootstrap.Modal(document.getElementById('viewComplaintModal'));
    modal.show();
    
    fetch(`/admin/api/complaints/${complaintId}`, {
        headers: getAuthHeaders()
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            const complaint = data.complaint;
            document.getElementById('complaintDetails').innerHTML = createComplaintDetailsHTML(complaint);
        } else {
            throw new Error(data.error || 'Failed to load complaint details');
        }
    })
    .catch(error => {
        console.error('Error loading complaint details:', error);
        document.getElementById('complaintDetails').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 
                Error loading complaint details: ${error.message}
            </div>
        `;
    });
}

function createComplaintDetailsHTML(complaint) {
    const priorityColor = complaint.priority === 'high' ? 'danger' : 
                         complaint.priority === 'medium' ? 'warning' : 'secondary';
    const statusColor = complaint.status === 'pending' ? 'warning' : 
                       complaint.status === 'resolved' ? 'success' : 'info';

    return `
        <div class="row">
            <div class="col-md-6">
                <h6>User Information</h6>
                <p><strong>Name:</strong> ${complaint.user || 'N/A'}</p>
                <p><strong>Email:</strong> ${complaint.user_email || 'N/A'}</p>
                <p><strong>User ID:</strong> ${complaint.user_id || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <h6>Ticket Information</h6>
                <p><strong>Status:</strong> <span class="badge bg-${statusColor}">${complaint.status || 'N/A'}</span></p>
                <p><strong>Priority:</strong> <span class="badge bg-${priorityColor}">${complaint.priority || 'N/A'}</span></p>
                <p><strong>Created:</strong> ${complaint.created_at || 'N/A'}</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <h6>Subject</h6>
                <p class="bg-light p-3 rounded">${complaint.subject || 'N/A'}</p>
                
                <h6>Description</h6>
                <div class="border p-3 bg-light rounded" style="min-height: 100px; white-space: pre-wrap;">
                    ${complaint.content || 'N/A'}
                </div>
            </div>
        </div>
    `;
}

function respondToComplaint(complaintId) {
    showToast(`Opening response interface for ticket #${complaintId}`, 'info');
    // TODO: Implement response interface - could open a modal with response form
    console.log(`Would open response modal for complaint ${complaintId}`);
}

function respondToComplaintModal() {
    if (currentComplaintId) {
        respondToComplaint(currentComplaintId);
    }
}

function markResolved(complaintId) {
    if (!confirm(`Mark ticket #${complaintId} as resolved?`)) {
        return;
    }
    
    console.log(`Marking complaint ${complaintId} as resolved`);
    
    fetch(`/admin/api/complaints/${complaintId}/resolve`, {
        method: 'POST',
        headers: getAuthHeaders()
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            showToast('Ticket marked as resolved', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            throw new Error(data.error || 'Failed to resolve ticket');
        }
    })
    .catch(error => {
        console.error('Error resolving complaint:', error);
        showToast('Error resolving complaint: ' + error.message, 'error');
    });
}

// Security Management Functions
function viewSecurityDetails() { 
    showToast('Loading detailed security information...', 'info'); 
    // TODO: Implement security details view
}

function viewSecurityReport() { 
    showToast('Generating comprehensive security report...', 'info'); 
    // TODO: Implement security report generation
}

function manage2FA() { 
    showToast('Opening Two-Factor Authentication settings...', 'info'); 
    // TODO: Implement 2FA management
}

function managePasswordPolicies() { 
    showToast('Opening password policy configuration...', 'info'); 
    // TODO: Implement password policy management
}

function manageIPBlacklist() { 
    showToast('Opening IP blacklist management...', 'info'); 
    // TODO: Implement IP blacklist management
}

function manageActiveSessions() { 
    showToast('Opening active sessions monitor...', 'info'); 
    // TODO: Implement session management
}

// Dashboard Statistics Refresh
function refreshDashboardStats() {
    fetch('/admin/api/dashboard-stats', {
        headers: getAuthHeaders()
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            updateDashboardStats(data.stats);
        }
    })
    .catch(error => {
        console.error('Error refreshing dashboard stats:', error);
    });
}

function updateDashboardStats(stats) {
    // Update login stats
    const totalLogins = document.getElementById('totalLogins');
    if (totalLogins) totalLogins.textContent = stats.login_stats?.total || 'N/A';

    // Update ticket stats  
    const totalComplaints = document.getElementById('totalComplaints');
    if (totalComplaints) totalComplaints.textContent = stats.ticket_stats?.total || 'N/A';

    // Update security alerts
    const securityAlerts = document.getElementById('securityAlerts');
    if (securityAlerts) {
        securityAlerts.textContent = (stats.login_stats?.suspicious || 0) + (stats.login_stats?.failed || 0);
    }

    console.log('Dashboard stats updated');
}

// Utility Functions
function getAuthHeaders() {
    return {
        'Authorization': 'Bearer ' + getJWTToken(),
        'Content-Type': 'application/json'
    };
}

function getJWTToken() {
    // Prioritize localStorage, then sessionStorage, then cookie
    return localStorage.getItem('access_token') || 
           sessionStorage.getItem('access_token') ||
           getCookie('access_token') || '';
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
}

function handleResponse(response) {
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
}

function showToast(message, type = 'info', duration = 5000) {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.temp-toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toastContainer = document.createElement('div');
    toastContainer.className = 'temp-toast position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'error' ? 'bg-danger' : 
                   type === 'success' ? 'bg-success' : 
                   type === 'warning' ? 'bg-warning' : 'bg-info';
    
    toastContainer.innerHTML = `
        <div class="toast show ${bgClass} text-white" id="${toastId}" role="alert">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-${getToastIcon(type)} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.appendChild(toastContainer);
    
    // Auto remove after duration
    setTimeout(() => {
        toastContainer.remove();
    }, duration);
    
    console.log(`Toast: [${type.toUpperCase()}] ${message}`);
}

function getToastIcon(type) {
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-triangle', 
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function setLoadingState(element, isLoading) {
    if (!element) return;
    
    if (isLoading) {
        element.disabled = true;
        const originalText = element.innerHTML;
        element.setAttribute('data-original-text', originalText);
        element.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Loading...';
    } else {
        element.disabled = false;
        const originalText = element.getAttribute('data-original-text');
        if (originalText) {
            element.innerHTML = originalText;
            element.removeAttribute('data-original-text');
        }
    }
}

function showLoadingState(containerSelector) {
    const container = document.querySelector(containerSelector);
    if (container) {
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-2">Loading...</p>
            </div>
        `;
    }
}

function hideLoadingState(containerSelector) {
    // Loading state will be replaced by actual content
    // This function exists for consistency but actual content replacement handles hiding
}

// Error handling
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.error);
    showToast('A JavaScript error occurred. Please refresh the page.', 'error');
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled Promise Rejection:', e.reason);
    showToast('A network error occurred. Please check your connection.', 'error');
    e.preventDefault();
});

console.log('Support & Security JavaScript initialized successfully');
</script>
{% endblock %}