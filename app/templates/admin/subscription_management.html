{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
    <h1><i class="bi bi-crown me-2"></i>Subscription Management</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Home</a></li>
            <li class="breadcrumb-item active">Subscriptions</li>
        </ol>
    </nav>
</div>

<section class="section">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card members-card">
                <div class="card-body">
                    <h5 class="card-title">Total Subscribers</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="totalSubscribers">{{ num_subscribers|default(0) }}</h6>
                            <span class="text-success small pt-1 fw-bold">{{ subscription_metrics.total_change|format_change }}</span>
                            <span class="text-muted small pt-2 ps-1">vs last month</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <h5 class="card-title">Monthly Revenue</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="monthlyRevenue">${{ "{:,.2f}".format(revenue|default(0)) }}</h6>
                            <span class="text-success small pt-1 fw-bold">{{ subscription_metrics.revenue_change|format_change }}</span>
                            <span class="text-muted small pt-2 ps-1">vs last month</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card expiring-card">
                <div class="card-body">
                    <h5 class="card-title">Expiring Soon</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="expiringSoon">{{ expiring_soon|default(0) }}</h6>
                            <span class="text-warning small pt-1 fw-bold">{{ subscription_metrics.expiring_change|format_change }}</span>
                            <span class="text-muted small pt-2 ps-1">this month</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card failed-card">
                <div class="card-body">
                    <h5 class="card-title">Failed Payments</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="failedPayments">{{ failed_payments|default(0) }}</h6>
                            <span class="text-danger small pt-1 fw-bold">{{ subscription_metrics.failed_change|format_change }}</span>
                            <span class="text-muted small pt-2 ps-1">this month</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Membership Types Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Membership Types Distribution</h5>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="chartStartDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">End Date</label>
                            <input type="date" id="chartEndDate" class="form-control">
                        </div>
                        <div class="col-md-3 align-self-end">
                            <button class="btn btn-primary btn-sm" onclick="updateMembershipChart()">Update Chart</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="membershipChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="row mb-4">
        
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title"><i class="bi bi-funnel me-2"></i>Filters & Actions</h5>
                        <div class="filter-actions">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="resetFilters()">
                                <i class="bi bi-arrow-clockwise"></i> Reset
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="exportData()">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="trial">Trial</option>
                                <option value="expired">Expired</option>
                                <option value="canceled">Canceled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="planFilter">
                                <option value="">All Plans</option>
                                <option value="basic">Basic</option>
                                <option value="premium">Premium</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSubscriptionModal">
                                    <i class="bi bi-plus me-2"></i>Add Subscription
                                </button>
                                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#bulkActionsModal">
                                    <i class="bi bi-tasks me-2"></i>Bulk Actions
                                </button>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#managePlansModal">
                                    <i class="bi bi-gear me-2"></i>Manage Plans
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriptions Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Subscriptions List</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="subscriptionsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>User</th>
                                    <th>Plan</th>
                                    <th>Status</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Revenue</th>
                                    <th>Usage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sub in subscriptions %}
                                <tr>
                                    <td><input type="checkbox" class="row-select" data-id="{{ sub.id }}"></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ sub.user.profile_image|default(url_for('static', filename='images/default.jpg')) }}" 
                                                 class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
                                            <div>
                                                <div class="fw-bold">{{ sub.user.name|default('Unknown User') }}</div>
                                                <small class="text-muted">{{ sub.user.email|default('N/A') }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ sub.plan.name|default('N/A') }}</div>
                                        <small class="text-muted">${{ "{:.2f}".format(sub.plan.price|default(0)) }}/month</small>
                                    </td>
                                    <td>
                                        <span class="status-badge {{ 'status-active' if sub.status == 'active' else 'status-trial' if sub.status == 'trial' else 'status-expired' if sub.status == 'expired' else 'status-canceled' }}">
                                            {{ sub.status|capitalize|default('N/A') }}
                                        </span>
                                    </td>
                                    <td>{{ sub.start_date.strftime('%b %d, %Y')|default('N/A') }}</td>
                                    <td>{{ sub.end_date.strftime('%b %d, %Y')|default('N/A') }}</td>
                                    <td class="fw-bold {{ 'text-success' if sub.status == 'active' else 'text-muted' }}">
                                        ${{ "{:.2f}".format(sub.total_paid|default(0)) }}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-primary" style="width: {{ sub.usage_records.filter_by(feature='athletes').first().usage_percentage|default(0) }}%;"></div>
                                        </div>
                                        <small class="text-muted">{{ sub.usage_records.filter_by(feature='athletes').first().usage_percentage|default(0) }}% used</small>
                                    </td>
                                    <td>
                                        <div class="quick-actions">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewSubscription({{ sub.id }})">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            {% if sub.status == 'active' or sub.status == 'expired' %}
                                            <button class="btn btn-sm btn-outline-success" onclick="renewSubscription({{ sub.id }})">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                            {% endif %}
                                            {% if sub.status == 'trial' %}
                                            <button class="btn btn-sm btn-outline-success" onclick="convertTrial({{ sub.id }})">
                                                <i class="bi bi-arrow-up"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="editSubscription({{ sub.id }})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="cancelSubscription({{ sub.id }})">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Subscription Modal -->
    <div class="modal fade" id="addSubscriptionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus me-2"></i>Add New Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSubscriptionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-person me-2"></i>Select User</label>
                                    <select name="user_id" class="form-select" required>
                                        <option value="">Choose user...</option>
                                        {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-crown me-2"></i>Subscription Plan</label>
                                      <select name="plan_id" class="form-select" required onchange="updatePlanDetails()">
                                        <option value="">Choose plan...</option>
                                        {% for plan in plans %}
                                        <option value="{{ plan.id }}" 
                                                data-price="{{ plan.price }}" 
                                                data-features='{{ plan.features|tojson }}'>
                                            {{ plan.name }} - ${{ "{:.2f}".format(plan.price) }}/month
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="planDetails" class="plan-features" style="display: none;">
                            <h6><i class="bi bi-list me-2"></i>Plan Features</h6>
                            <div id="featuresList"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-calendar me-2"></i>Start Date</label>
                                    <input type="date" name="start_date" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-arrow-repeat me-2"></i>Billing Cycle</label>
                                    <select name="billing_cycle" class="form-select">
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly (-10%)</option>
                                        <option value="yearly">Yearly (-20%)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="trial_enabled" id="trialEnabled">
                                        <label class="form-check-label" for="trialEnabled">
                                            <i class="bi bi-gift me-2"></i>Include Free Trial
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3" id="trialDaysContainer" style="display: none;">
                                    <label class="form-label">Trial Days</label>
                                    <input type="number" name="trial_days" class="form-control" value="14" min="1" max="90">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="auto_renew" id="autoRenew" checked>
                                <label class="form-check-label" for="autoRenew">
                                    <i class="bi bi-arrow-repeat me-2"></i>Enable Auto-renewal
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-sticky me-2"></i>Notes (Optional)</label>
                            <textarea name="notes" class="form-control" rows="3" placeholder="Add any additional notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="addSubscriptionForm" class="btn btn-primary">
                        <i class="bi bi-plus me-2"></i>Create Subscription
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div class="modal fade" id="bulkActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-tasks me-2"></i>Bulk Actions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Action</label>
                        <select class="form-select" id="bulkAction">
                            <option value="">Choose action...</option>
                            <option value="extend">Extend Subscriptions</option>
                            <option value="cancel">Cancel Subscriptions</option>
                            <option value="change_plan">Change Plan</option>
                            <option value="send_notification">Send Notification</option>
                        </select>
                    </div>
                    <div id="bulkExtendOptions" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Extend by</label>
                            <select class="form-select">
                                <option value="30">1 Month</option>
                                <option value="90">3 Months</option>
                                <option value="365">1 Year</option>
                            </select>
                        </div>
                    </div>
                    <div id="bulkPlanOptions" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">New Plan</label>
                            <select class="form-select">
                                {% for plan in plans %}
                                <option value="{{ plan.id }}">{{ plan.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div id="bulkNotificationOptions" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" rows="4" placeholder="Enter notification message..."></textarea>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <span id="selectedCount">0</span> subscription(s) selected
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="executeBulkAction()">
                        <i class="bi bi-check me-2"></i>Execute Action
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Plans Modal -->
    <div class="modal fade" id="managePlansModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Manage Subscription Plans</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPlanForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-crown me-2"></i>Plan Name</label>
                                    <input type="text" name="name" class="form-control" required placeholder="e.g., Premium">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-currency-dollar me-2"></i>Price ($/month)</label>
                                    <input type="number" name="price" class="form-control" required min="0" step="0.01" placeholder="29.99">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-people me-2"></i>Max Athletes</label>
                                    <input type="number" name="max_athletes" class="form-control" required min="0" placeholder="10">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-list-task me-2"></i>Max Workouts</label>
                                    <input type="number" name="max_workouts" class="form-control" required min="0" placeholder="100">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-hdd me-2"></i>Storage (GB)</label>
                                    <input type="number" name="storage_gb" class="form-control" required min="0" placeholder="50">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-list-check me-2"></i>Features (one per line)</label>
                            <textarea name="features" class="form-control" rows="4" placeholder="Full access\nAnalytics\nSupport"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-calendar me-2"></i>Duration (Months)</label>
                            <input type="number" name="duration_months" class="form-control" required min="1" value="1">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    <i class="bi bi-toggle-on me-2"></i>Active Plan
                                </label>
                            </div>
                        </div>
                        <input type="hidden" name="plan_id" id="planId">
                    </form>
                    <div class="mt-4">
                        <h6><i class="bi bi-list-ul me-2"></i>Current Plans</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="plansTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Price</th>
                                        <th>Max Athletes</th>
                                        <th>Max Workouts</th>
                                        <th>Storage</th>
                                        <th>Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for plan in plans %}
                                    <tr>
                                        <td>{{ plan.name }}</td>
                                        <td>${{ "{:.2f}".format(plan.price) }}</td>
                                        <td>{{ plan.max_athletes }}</td>
                                        <td>{{ plan.max_workouts }}</td>
                                        <td>{{ plan.storage_gb }} GB</td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if plan.is_active else 'bg-secondary' }}">
                                                {{ 'Active' if plan.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-warning" onclick="editPlan({{ plan.id }})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deletePlan({{ plan.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="addPlanForm" class="btn btn-primary" id="savePlanBtn">
                        <i class="bi bi-save me-2"></i>Save Plan
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- View Subscription Modal -->
    <div class="modal fade" id="viewSubscriptionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Subscription Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="subscriptionDetails">
                        <!-- Details will be loaded dynamically via JavaScript -->
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-credit-card me-2"></i>Payment History</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Method</th>
                                                    <th>Status</th>
                                                    <th>Invoice</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentHistory">
                                                <!-- Payment history will be loaded dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="editSubscription(currentSubscriptionId)">
                        <i class="bi bi-pencil me-2"></i>Edit Subscription
                    </button>
                    <button type="button" class="btn btn-danger" onclick="cancelSubscription(currentSubscriptionId)">
                        <i class="bi bi-x me-2"></i>Cancel Subscription
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  {{ super() }}

  <style>
  .members-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
  .revenue-card .card-icon { background: linear-gradient(90deg, #ffc107, #fd7e14); }
  .expiring-card .card-icon { background: linear-gradient(90deg, #f39c12, #f7dc6f); }
  .failed-card .card-icon { background: linear-gradient(90deg, #dc3545, #e91e63); }
  .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
  .status-active { background: rgba(39, 174, 96, 0.1); color: #27ae60; }
  .status-trial { background: rgba(52, 152, 219, 0.1); color: #3498db; }
  .status-expired { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
  .status-canceled { background: rgba(149, 165, 166, 0.1); color: #95a5a6; }
  .quick-actions .btn { margin: 0 2px; }
  .quick-actions .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  .plan-features { background: #f8f9fa; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
  .feature-item { display: flex; align-items: center; margin-bottom: 0.5rem; }
  .feature-item i { color: #27ae60; margin-right: 0.5rem; }
  @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
  }
  .chart-container { max-width: 600px; margin: 0 auto; }
  </style>

  <script>
  // Initialize DataTable
  $(document).ready(function() {
      const table = $('#subscriptionsTable').DataTable({
          responsive: true,
          pageLength: 25,
          order: [[4, 'desc']],
          columnDefs: [{ orderable: false, targets: [0, 8] }],
          language: {
              search: "Search subscriptions:",
              lengthMenu: "Show _MENU_ subscriptions per page",
              info: "Showing _START_ to _END_ of _TOTAL_ subscriptions",
              paginate: {
                  first: '<i class="bi bi-chevron-double-left"></i>',
                  previous: '<i class="bi bi-chevron-left"></i>',
                  next: '<i class="bi bi-chevron-right"></i>',
                  last: '<i class="bi bi-chevron-double-right"></i>'
              }
          }
      });

      // Filter functionality
      $('#statusFilter, #planFilter').on('change', function() {
          const statusFilter = $('#statusFilter').val();
          const planFilter = $('#planFilter').val();
          table.columns(3).search(statusFilter);
          table.columns(2).search(planFilter);
          table.draw();
          updateSelectedCount();
      });

      // Select all functionality
      $('#selectAll').on('change', function() {
          $('.row-select').prop('checked', this.checked);
          updateSelectedCount();
      });

      $('.row-select').on('change', updateSelectedCount);

      // Trial checkbox functionality
      $('#trialEnabled').on('change', function() {
          $('#trialDaysContainer').toggle(this.checked);
      });

      // Bulk action options
      $('#bulkAction').on('change', function() {
          const action = $(this).val();
          $('#bulkExtendOptions, #bulkPlanOptions, #bulkNotificationOptions').hide();
          if (action === 'extend') $('#bulkExtendOptions').show();
          else if (action === 'change_plan') $('#bulkPlanOptions').show();
          else if (action === 'send_notification') $('#bulkNotificationOptions').show();
      });

      // Initialize membership chart
      updateMembershipChart();
  });

  // Update plan details
  function updatePlanDetails() {
      const select = document.querySelector('select[name="plan_id"]');
      const selectedOption = select.options[select.selectedIndex];
      const featuresList = document.getElementById('featuresList');
      const planDetails = document.getElementById('planDetails');

      if (selectedOption.value) {
          const features = JSON.parse(selectedOption.dataset.features || '[]');
          featuresList.innerHTML = features.map(feature => 
              `<div class="feature-item"><i class="bi bi-check-circle"></i>${feature}</div>`
          ).join('');
          planDetails.style.display = 'block';
      } else {
          planDetails.style.display = 'none';
      }
  }

  // Update selected count
  function updateSelectedCount() {
      const count = $('.row-select:checked').length;
      $('#selectedCount').text(count);
  }

  // Update membership chart
  function updateMembershipChart() {
      const startDate = $('#chartStartDate').val();
      const endDate = $('#chartEndDate').val();
      const url = startDate && endDate ? 
          `/admin/api/membership_types?start_date=${startDate}&end_date=${endDate}` : 
          '/admin/api/membership_types';

      fetch(url, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
      })
      .then(response => {
          if (!response.ok) {
              return response.text().then(text => { throw new Error(`Server error: ${text}`); });
          }
          return response.json();
      })
      .then(data => {
          if (data.success && data.membership_types && data.membership_types.length > 0) {
              const labels = data.membership_types.map(type => type.name);
              const counts = data.membership_types.map(type => type.count);
              const colors = data.membership_types.map(type => type.color);

              const ctx = document.getElementById('membershipChart').getContext('2d');
              // Safely destroy existing chart if it exists and is a Chart instance
              if (window.membershipChart && typeof window.membershipChart.destroy === 'function') {
                  window.membershipChart.destroy();
              }
              window.membershipChart = new Chart(ctx, {
                  type: 'pie',
                  data: {
                      labels: labels,
                      datasets: [{
                          data: counts,
                          backgroundColor: colors,
                          borderColor: '#ffffff',
                          borderWidth: 2
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: { position: 'top' },
                          title: { display: true, text: 'Membership Types Distribution' }
                      }
                  }
              });
              showAlert('Membership chart updated', 'success');
          } else {
              showAlert('No membership types data available or failed to load: ' + (data.error || 'No data'), 'warning');
              // Clear the canvas if no data
              const ctx = document.getElementById('membershipChart').getContext('2d');
              ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          }
      })
      .catch(error => {
          showAlert('Error loading membership types: ' + error.message, 'danger');
          console.error('Error:', error);
          // Clear the canvas on error
          const ctx = document.getElementById('membershipChart').getContext('2d');
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      });
  }

  // Action functions
  function viewSubscription(id) {
      fetch(`/admin/api/subscriptions/${id}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
      })
      .then(response => {
          if (!response.ok) {
              return response.text().then(text => { throw new Error(`Server error: ${text}`); });
          }
          return response.json();
      })
      .then(data => {
          if (data.success) {
              currentSubscriptionId = id;
              const sub = data.subscription;
              const detailsHtml = `
                  <div class="col-md-4">
                      <div class="card h-100">
                          <div class="card-body">
                              <h5 class="card-title"><i class="bi bi-person me-2"></i>User Information</h5>
                              <div class="text-center mb-3">
                                  <img src="${sub.user.profile_image || '/static/images/default.jpg'}" 
                                      class="rounded-circle" width="80" height="80" style="object-fit: cover;">
                                  <h6 class="mt-2 mb-0">${sub.user.name || 'Unknown User'}</h6>
                                  <small class="text-muted">${sub.user.email || 'N/A'}</small>
                              </div>
                              <div class="mb-2"><strong>Role:</strong> <span class="badge bg-primary">${sub.user.role || 'N/A'}</span></div>
                              <div class="mb-2"><strong>Member Since:</strong> ${sub.user.created_at || 'N/A'}</div>
                              <div class="mb-2"><strong>Total Subscriptions:</strong> ${sub.user.subscription_count || 0}</div>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card h-100">
                          <div class="card-body">
                              <h5 class="card-title"><i class="bi bi-crown me-2"></i>Subscription Details</h5>
                              <div class="mb-3">
                                  <strong>Plan:</strong> ${sub.plan_name || 'N/A'}
                                  <span class="badge bg-${sub.status === 'active' ? 'success' : sub.status === 'trial' ? 'info' : sub.status === 'expired' ? 'danger' : 'secondary'}">${sub.status || 'N/A'}</span>
                              </div>
                              <div class="mb-2"><strong>Price:</strong> $${sub.price.toFixed(2)}/month</div>
                              <div class="mb-2"><strong>Start Date:</strong> ${sub.start_date || 'N/A'}</div>
                              <div class="mb-2"><strong>End Date:</strong> ${sub.end_date || 'N/A'}</div>
                              <div class="mb-2"><strong>Auto Renew:</strong> ${sub.auto_renew ? '✅ Enabled' : '❌ Disabled'}</div>
                              <div class="mb-3"><strong>Days Remaining:</strong> <span class="badge bg-info">${sub.days_remaining || 0} days</span></div>
                              <h6 class="mb-2">Plan Features</h6>
                              <ul class="list-unstyled">
                                  ${sub.features.map(f => `<li><i class="bi bi-check-circle text-success me-2"></i>${f}</li>`).join('')}
                              </ul>
                          </div>
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="card h-100">
                          <div class="card-body">
                              <h5 class="card-title"><i class="bi bi-graph-up me-2"></i>Usage & Analytics</h5>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between mb-1">
                                      <span>Athletes Used</span>
                                      <span>${sub.athletes_used || 0}/${sub.athletes_limit || 0}</span>
                                  </div>
                                  <div class="progress" style="height: 8px;">
                                      <div class="progress-bar bg-primary" style="width: ${sub.athletes_used / sub.athletes_limit * 100 || 0}%"></div>
                                  </div>
                              </div>
                              <div class="mb-3">
                                  <div class="d-flex justify-content-between mb-1">
                                      <span>Storage Used</span>
                                      <span>${sub.storage_used || 0}/${sub.storage_limit || 0} GB</span>
                                  </div>
                                  <div class="progress" style="height: 8px;">
                                      <div class="progress-bar bg-primary" style="width: ${sub.storage_used / sub.storage_limit * 100 || 0}%"></div>
                                  </div>
                              </div>
                              <div class="mb-2"><strong>Total Revenue:</strong> $${sub.revenue.toFixed(2)}</div>
                              <div class="mb-2"><strong>Last Activity:</strong> ${sub.last_activity || 'N/A'}</div>
                              <div class="mb-2"><strong>Login Count:</strong> ${sub.login_count || 0} times</div>
                          </div>
                      </div>
                  </div>
              `;
              document.getElementById('subscriptionDetails').innerHTML = detailsHtml;
              document.getElementById('paymentHistory').innerHTML = sub.payment_history.map(p => `
                  <tr>
                      <td>${p.date || 'N/A'}</td>
                      <td>$${p.amount.toFixed(2)}</td>
                      <td><i class="bi bi-credit-card me-1"></i>${p.method || 'N/A'}</td>
                      <td><span class="badge bg-${p.status === 'paid' ? 'success' : 'danger'}">${p.status || 'N/A'}</span></td>
                      <td><a href="${p.invoice_url || '#'}" class="btn btn-sm btn-outline-primary">View</a></td>
                  </tr>
              `).join('');
              $('#viewSubscriptionModal').modal('show');
              showAlert('Subscription details loaded', 'success');
          } else {
              showAlert('Failed to load subscription: ' + data.error, 'danger');
          }
      })
      .catch(error => {
          showAlert('Error loading subscription: ' + error.message, 'danger');
          console.error('Error:', error);
      });
  }

  let currentSubscriptionId = null;

  function renewSubscription(id) {
      if (confirm('Are you sure you want to renew this subscription?')) {
          fetch(`/admin/api/subscriptions/${id}/renew`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showAlert('Subscription renewed successfully!', 'success');
                  updateTable();
              } else {
                  showAlert('Failed to renew subscription: ' + data.error, 'danger');
              }
          })
          .catch(error => {
              showAlert('Error renewing subscription', 'danger');
              console.error('Error:', error);
          });
      }
  }

  function editSubscription(id) {
      fetch(`/admin/api/subscriptions/${id}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              showAlert('Edit subscription feature coming soon!', 'warning');
          } else {
              showAlert('Failed to load subscription for editing: ' + data.error, 'danger');
          }
      })
      .catch(error => {
          showAlert('Error loading subscription for editing', 'danger');
          console.error('Error:', error);
      });
  }

  function cancelSubscription(id) {
      if (confirm('Are you sure you want to cancel this subscription?')) {
          fetch(`/admin/api/subscriptions/${id}/cancel`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showAlert('Subscription canceled successfully!', 'warning');
                  updateTable();
              } else {
                  showAlert('Failed to cancel subscription: ' + data.error, 'danger');
              }
          })
          .catch(error => {
              showAlert('Error canceling subscription', 'danger');
              console.error('Error:', error);
          });
      }
  }

  function convertTrial(id) {
      if (confirm('Convert trial to paid subscription?')) {
          fetch(`/admin/api/subscriptions/${id}/convert`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showAlert('Trial converted to paid subscription!', 'success');
                  updateTable();
              } else {
                  showAlert('Failed to convert trial: ' + data.error, 'danger');
              }
          })
          .catch(error => {
              showAlert('Error converting trial', 'danger');
              console.error('Error:', error);
          });
      }
  }

  function executeBulkAction() {
      const selectedIds = $('.row-select:checked').map(function() {
          return $(this).data('id');
      }).get();
      const action = $('#bulkAction').val();
      const extendDays = $('#bulkExtendOptions select').val();
      const newPlanId = $('#bulkPlanOptions select').val();
      const message = $('#bulkNotificationOptions textarea').val();

      if (selectedIds.length === 0) {
          showAlert('Please select at least one subscription.', 'warning');
          return;
      }
      if (!action) {
          showAlert('Please select an action.', 'warning');
          return;
      }
  document.getElementById('addSubscriptionForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      // Convert checkbox values to booleans
      data.auto_renew = data.auto_renew === 'on';
      data.trial_enabled = data.trial_enabled === 'on';
      
      fetch('/admin/api/subscriptions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              showAlert('Subscription created successfully!', 'success');
              $('#addSubscriptionModal').modal('hide');
              this.reset();
              document.getElementById('planDetails').style.display = 'none';
              updateTable();
          } else {
              showAlert('Failed to create subscription: ' + data.error, 'danger');
          }
      })
      .catch(error => {
          showAlert('Error creating subscription: ' + error.message, 'danger');
          console.error('Error:', error);
      });
  });

      fetch('/admin/api/subscriptions/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
              ids: selectedIds,
              action: action,
              extend_days: extendDays,
              new_plan_id: newPlanId,
              message: message
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              showAlert(`Bulk action ${action} executed successfully!`, 'success');
              $('#bulkActionsModal').modal('hide');
              updateTable();
          } else {
              showAlert('Failed to execute bulk action: ' + data.error, 'danger');
          }
      })
      .catch(error => {
          showAlert('Error executing bulk action', 'danger');
          console.error('Error:', error);
      });
  }

  function exportData() {
      const statusFilter = $('#statusFilter').val();
      const planFilter = $('#planFilter').val();
      fetch(`/admin/api/subscriptions/export?status=${statusFilter}&plan=${planFilter}`, {
          method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              showAlert('Export started! Check downloads.', 'success');
          } else {
              showAlert('Export failed: ' + data.error, 'danger');
          }
      })
      .catch(error => {
          showAlert('Export failed', 'danger');
          console.error('Error:', error);
      });
  }

  function resetFilters() {
      $('#statusFilter').val('');
      $('#planFilter').val('');
      $('#subscriptionsTable').DataTable().columns([3, 2]).search('').draw();
      showAlert('Filters reset', 'info');
  }

  function updateTable() {
      fetch('/admin/api/subscriptions', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              $('#subscriptionsTable').DataTable().clear();
              data.subscriptions.forEach(sub => {
                  $('#subscriptionsTable').DataTable().row.add([
                      `<input type="checkbox" class="row-select" data-id="${sub.id}">`,
                      `
                          <div class="d-flex align-items-center">
                              <img src="${sub.user.profile_image || '/static/images/default.jpg'}" 
                                  class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
                              <div>
                                  <div class="fw-bold">${sub.user.name || 'Unknown User'}</div>
                                  <small class="text-muted">${sub.user.email || 'N/A'}</small>
                              </div>
                          </div>
                      `,
                      `
                          <div class="fw-bold">${sub.plan_name || 'N/A'}</div>
                          <small class="text-muted">$${sub.price.toFixed(2)}/month</small>
                      `,
                      `<span class="status-badge status-${sub.status || 'canceled'}">${sub.status.charAt(0).toUpperCase() + sub.status.slice(1)}</span>`,
                      sub.start_date || 'N/A',
                      sub.end_date || 'N/A',
                      `<span class="fw-bold ${sub.status === 'active' ? 'text-success' : 'text-muted'}">$${sub.revenue.toFixed(2)}</span>`,
                      `
                          <div class="progress" style="height: 8px;">
                              <div class="progress-bar bg-primary" style="width: ${sub.usage_percentage || 0}%"></div>
                          </div>
                          <small class="text-muted">${sub.usage_percentage || 0}% used</small>
                      `,
                      `
                          <div class="quick-actions">
                              <button class="btn btn-sm btn-outline-primary" onclick="viewSubscription(${sub.id})"><i class="bi bi-eye"></i></button>
                              ${sub.status === 'active' || sub.status === 'expired' ? 
                                  `<button class="btn btn-sm btn-outline-success" onclick="renewSubscription(${sub.id})"><i class="bi bi-arrow-repeat"></i></button>` : 
                                  sub.status === 'trial' ? 
                                  `<button class="btn btn-sm btn-outline-success" onclick="convertTrial(${sub.id})"><i class="bi bi-arrow-up"></i></button>` : ''}
                              <button class="btn btn-sm btn-outline-warning" onclick="editSubscription(${sub.id})"><i class="bi bi-pencil"></i></button>
                              <button class="btn btn-sm btn-outline-danger" onclick="cancelSubscription(${sub.id})"><i class="bi bi-x"></i></button>
                          </div>
                      `
                  ]);
              });
              $('#subscriptionsTable').DataTable().draw();
              updateSelectedCount();
              showAlert('Table updated successfully!', 'success');
          } else {
              showAlert('Failed to update table: ' + data.error, 'danger');
          }
      })
      .catch(error => {
          showAlert('Error updating table', 'danger');
          console.error('Error:', error);
      });
  }

  function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 3000);
  }


  </script>
  <script>
    // Initialize Plans Table
    $(document).ready(function() {
        $('#plansTable').DataTable({
            responsive: true,
            pageLength: 10,
            searching: false,
            ordering: false,
            lengthChange: false,
            language: {
                info: "Showing _START_ to _END_ of _TOTAL_ plans",
                paginate: {
                    previous: '<i class="bi bi-chevron-left"></i>',
                    next: '<i class="bi bi-chevron-right"></i>'
                }
            }
        });

        // Reset form when modal is closed
        $('#managePlansModal').on('hidden.bs.modal', function() {
            $('#addPlanForm')[0].reset();
            $('#planId').val('');
            $('#savePlanBtn').html('<i class="bi bi-save me-2"></i>Save Plan');
            $('#isActive').prop('checked', true);
        });
    });

    // Add or Edit Plan
    document.getElementById('addPlanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const planId = formData.get('plan_id');
        const features = formData.get('features').split('\n').filter(f => f.trim());
        const url = planId ? `/admin/api/plans/${planId}` : '/admin/api/plans';
        const method = planId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                max_athletes: parseInt(formData.get('max_athletes')),
                max_workouts: parseInt(formData.get('max_workouts')),
                storage_gb: parseInt(formData.get('storage_gb')),
                features: features,
                duration_months: parseInt(formData.get('duration_months')),
                is_active: formData.get('is_active') === 'on'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`Plan ${planId ? 'updated' : 'created'} successfully!`, 'success');
                $('#managePlansModal').modal('hide');
                updatePlansTable();
                updateSubscriptionPlanSelect();
            } else {
                showAlert(`Failed to ${planId ? 'update' : 'create'} plan: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            showAlert(`Error ${planId ? 'updating' : 'creating'} plan: ${error.message}`, 'danger');
            console.error('Error:', error);
        });
    });

    // Edit Plan
    function editPlan(id) {
        fetch(`/admin/api/plans/${id}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const plan = data.plan;
                $('#addPlanForm [name="name"]').val(plan.name);
                $('#addPlanForm [name="price"]').val(plan.price);
                $('#addPlanForm [name="max_athletes"]').val(plan.max_athletes);
                $('#addPlanForm [name="max_workouts"]').val(plan.max_workouts);
                $('#addPlanForm [name="storage_gb"]').val(plan.storage_gb);
                $('#addPlanForm [name="features"]').val(plan.features.join('\n'));
                $('#addPlanForm [name="duration_months"]').val(plan.duration_months);
                $('#addPlanForm [name="is_active"]').prop('checked', plan.is_active);
                $('#planId').val(plan.id);
                $('#savePlanBtn').html('<i class="bi bi-save me-2"></i>Update Plan');
                $('#managePlansModal').modal('show');
            } else {
                showAlert('Failed to load plan: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error loading plan: ' + error.message, 'danger');
            console.error('Error:', error);
        });
    }

    // Delete Plan
    function deletePlan(id) {
        if (confirm('Are you sure you want to delete this plan?')) {
            fetch(`/admin/api/plans/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Plan deleted successfully!', 'success');
                    updatePlansTable();
                    updateSubscriptionPlanSelect();
                } else {
                    showAlert('Failed to delete plan: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error deleting plan: ' + error.message, 'danger');
                console.error('Error:', error);
            });
        }
    }

    // Update Plans Table
    function updatePlansTable() {
        fetch('/admin/api/plans', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const table = $('#plansTable').DataTable();
                table.clear();
                data.plans.forEach(plan => {
                    table.row.add([
                        plan.name,
                        `$${plan.price.toFixed(2)}`,
                        plan.max_athletes,
                        plan.max_workouts,
                        `${plan.storage_gb} GB`,
                        `<span class="badge ${plan.is_active ? 'bg-success' : 'bg-secondary'}">${plan.is_active ? 'Active' : 'Inactive'}</span>`,
                        `
                            <button class="btn btn-sm btn-outline-warning" onclick="editPlan(${plan.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePlan(${plan.id})"><i class="bi bi-trash"></i></button>
                        `
                    ]);
                });
                table.draw();
            } else {
                showAlert('Failed to load plans: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error loading plans: ' + error.message, 'danger');
            console.error('Error:', error);
        });
    }

    // Update Subscription Plan Select
    function updateSubscriptionPlanSelect() {
        fetch('/admin/api/plans', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.querySelector('select[name="plan_id"]');
                select.innerHTML = '<option value="">Choose plan...</option>';
                data.plans.forEach(plan => {
                    if (plan.is_active) {
                        const option = document.createElement('option');
                        option.value = plan.id;
                        option.dataset.price = plan.price;
                        option.dataset.features = JSON.stringify(plan.features);
                        option.textContent = `${plan.name} - $${plan.price.toFixed(2)}/month`;
                        select.appendChild(option);
                    }
                });
            } else {
                showAlert('Failed to load plans for subscription form: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error loading plans for subscription form: ' + error.message, 'danger');
            console.error('Error:', error);
        });
    }
  </script>
{% endblock %}