{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Gym Management</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Gym Management</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="row">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card equipment-card">
        <div class="card-body">
          <h5 class="card-title">Equipment</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-tools"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalEquipment">{{ equipments|length }}</h6>
              <span class="text-success small pt-1 fw-bold">
                {{ equipments|selectattr("status", "equalto", "available")|list|length }}
              </span> <span class="text-muted small pt-2 ps-1">available</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card events-card">
        <div class="card-body">
          <h5 class="card-title">Events</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-calendar-event"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalEvents">{{ events|length }}</h6>
              <span class="text-primary small pt-1 fw-bold">upcoming</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card sessions-card">
        <div class="card-body">
          <h5 class="card-title">Sessions</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-person-check"></i>
            </div>
            <div class="ps-3">
              <h6 id="upcomingSessions">{{ sessions_count }}</h6>
              <span class="text-info small pt-1 fw-bold">upcoming</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card workout-types-card">
        <div class="card-body">
          <h5 class="card-title">Workout Types</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-activity"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalWorkoutTypes">{{ workout_types|length }}</h6>
              <span class="text-warning small pt-1 fw-bold">active</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Equipment Management</h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#equipmentModal" onclick="resetEquipmentForm()">
              <i class="bi bi-plus-circle"></i> Add Equipment
            </button>
          </div>
          
          <div class="equipment-list" style="max-height: 400px; overflow-y: auto;">
            {% for equip in equipments %}
            <div class="equipment-item d-flex align-items-center p-3 mb-2 bg-light rounded">
              <div class="equipment-icon me-3">
                <i class="bi bi-tools text-primary"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ equip.name }}</h6>
                <p class="mb-1 text-muted small">{{ equip.description[:50] }}...</p>
                <span class="badge bg-{{ 'success' if equip.status == 'available' else 'warning' }}">
                  {{ equip.status.title() }}
                </span>
              </div>
              <div class="equipment-actions">
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editEquipment({{ equip.id }})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleEquipmentStatus({{ equip.id }})">
                  <i class="bi bi-gear"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteItem('equipment', {{ equip.id }})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Events & Promotions</h5>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#eventModal" onclick="resetEventForm()">
              <i class="bi bi-plus-circle"></i> Add Event
            </button>
          </div>

          <div class="events-list" style="max-height: 400px; overflow-y: auto;">
            {% for event in events %}
            <div class="event-item d-flex align-items-center p-3 mb-2 bg-light rounded">
              <div class="event-date me-3 text-center">
                <div class="fw-bold text-primary">{{ event.date.strftime('%d') }}</div>
                <small class="text-muted">{{ event.date.strftime('%b') }}</small>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ event.title }}</h6>
                <p class="mb-1 text-muted small">{{ event.description[:40] }}...</p>
                <small class="text-muted">{{ event.date.strftime('%A') }}</small>
              </div>
              <div class="event-actions">
                <button class="btn btn-outline-info btn-sm me-1" onclick="notifyAllUsers({{ event.id }})">
                  <i class="bi bi-bell"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteItem('event', {{ event.id }})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Session & Booking Management</h5>
            <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#sessionModal" onclick="resetSessionForm()">
              <i class="bi bi-plus-circle"></i> Add Session
            </button>
          </div>
          <div class="sessions-list" style="max-height: 400px; overflow-y: auto;">
            {% for session in all_sessions %}
            <div class="session-item d-flex align-items-center p-3 mb-2 bg-light rounded">
                <div class="session-icon me-3">
                    <i class="bi bi-person-check text-info"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">{{ session.title }}</h6>
                    <p class="mb-1 text-muted small">
                        Coach: {{ session.coach.name if session.coach else 'N/A' }} | 
                        Athlete: {{ session.athlete.name if session.athlete else 'N/A' }}
                    </p>
                    <small class="text-muted">
                        {{ session.scheduled_at.strftime('%Y-%m-%d %H:%M') }} | 
                        {{ session.duration }} mins
                    </small>
                </div>
                <div class="session-actions">
                    {% if session.status == 'scheduled' %}
                    <button class="btn btn-outline-warning btn-sm me-1" onclick="editSession({{ session.id }})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="cancelSession({{ session.id }})">
                        <i class="bi bi-x-circle"></i>
                    </button>
                    {% else %}
                    <span class="badge bg-secondary">{{ session.status.title() }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Workout Types</h5>
            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#workoutTypeModal" onclick="resetWorkoutTypeForm()">
              <i class="bi bi-plus-circle"></i> Add Type
            </button>
          </div>

          <div class="workout-types-list" style="max-height: 400px; overflow-y: auto;">
            {% for wt in workout_types %}
            <div class="workout-type-item d-flex align-items-center p-3 mb-2 bg-light rounded">
              <div class="workout-type-icon me-3">
                <i class="bi bi-activity text-warning"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ wt.name }}</h6>
                <p class="mb-0 text-muted small">{{ wt.description[:40] }}...</p>
              </div>
              <div class="workout-type-actions">
                <button class="btn btn-outline-primary btn-sm me-1" onclick="editWorkoutType({{ wt.id }})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteItem('workoutType', {{ wt.id }})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="equipmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="equipmentModalTitle">Add Equipment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="equipmentForm">
          <input type="hidden" id="equipmentId">
          <div class="mb-3">
            <label class="form-label">Equipment Name</label>
            <input type="text" id="equipmentName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="equipmentDescription" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select id="equipmentStatus" class="form-select">
              <option value="available">Available</option>
              <option value="maintenance">Under Maintenance</option>
              <option value="out_of_order">Out of Order</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Equipment Type</label>
            <input type="text" id="equipmentType" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Maintenance Notes</label>
            <textarea id="maintenanceNotes" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEquipment()">Save Equipment</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalTitle">Create Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="eventForm">
          <input type="hidden" id="eventId">
          <div class="mb-3">
            <label class="form-label">Event Title</label>
            <input type="text" id="eventTitle" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="eventDescription" class="form-control" rows="3"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Event Date</label>
                <input type="date" id="eventDate" class="form-control" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Start Time</label>
                <input type="time" id="eventTime" class="form-control">
              </div>
            </div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="notifyMembers" checked>
            <label class="form-check-label" for="notifyMembers">
              Send notification to all members
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="saveEvent()">Create Event</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="workoutTypeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="workoutTypeModalTitle">Add Workout Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="workoutTypeForm">
          <input type="hidden" id="workoutTypeId">
          <div class="mb-3">
            <label class="form-label">Type Name</label>
            <input type="text" id="workoutTypeName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="workoutTypeDescription" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="saveWorkoutType()">Save Type</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="sessionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sessionModalTitle">Add New Session</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="sessionForm">
          <input type="hidden" id="sessionId">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Session Title</label>
                <input type="text" id="sessionTitle" class="form-control" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Type</label>
                <select id="sessionType" class="form-select" required>
                  <option value="in_person">In-person</option>
                  <option value="virtual">Virtual</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Coach</label>
                <select id="sessionCoach" class="form-select" required>
                  <option value="">Select Coach</option>
                  {% for coach in coaches %}
                    <option value="{{ coach.id }}">{{ coach.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Athlete</label>
                <select id="sessionAthlete" class="form-select" required>
                  <option value="">Select Athlete</option>
                  {% for athlete in athletes %}
                    <option value="{{ athlete.id }}">{{ athlete.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Scheduled At</label>
                <input type="datetime-local" id="sessionScheduledAt" class="form-control" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Duration (mins)</label>
                <input type="number" id="sessionDuration" class="form-control" min="15" max="180" value="60" required>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
              <label class="form-label">Location / Meeting Link</label>
              <input type="text" id="sessionLocation" class="form-control" placeholder="Gym Hall 1 / Google Meet Link">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" id="saveSessionBtn" onclick="saveSession()">Add Session</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4 text-center">
        <i class="bi bi-trash display-1 text-danger mb-3"></i>
        <p class="mb-0">Are you sure you want to delete this item?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-2"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

{{ super() }}
<style>
/* CSS styles */
.equipment-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
.events-card .card-icon { background: linear-gradient(90deg, #27a844, #20c997); }
.sessions-card .card-icon { background: linear-gradient(90deg, #17a2b8, #6f42c1); }
.workout-types-card .card-icon { background: linear-gradient(90deg, #ffc107, #fd7e14); }

.equipment-item:hover,
.event-item:hover,
.session-item:hover,
.workout-type-item:hover {
  background-color: #f1f3ff !important;
  transform: translateX(5px);
  transition: all 0.3s ease;
}

.modal-backdrop {
  background-color: rgba(0, 0, 0, 0.5);
}
</style>

<script>
// Global Variables
let editingEquipmentId = null;
let editingEventId = null;
let editingWorkoutTypeId = null;
let editingSessionId = null;
let deleteType = null;
let deleteId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadData();
  setupModalEvents();
});

function loadData() {
    console.log('Jinja2 has rendered the initial data.');
}

function setupModalEvents() {
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (deleteType && deleteId) {
            if (deleteType === 'equipment') {
                deleteEquipment(deleteId);
            } else if (deleteType === 'event') {
                deleteEvent(deleteId);
            } else if (deleteType === 'workoutType') {
                deleteWorkoutType(deleteId);
            }
        }
    });

    // Reset forms when modals are hidden
    document.getElementById('equipmentModal').addEventListener('hidden.bs.modal', resetEquipmentForm);
    document.getElementById('eventModal').addEventListener('hidden.bs.modal', resetEventForm);
    document.getElementById('workoutTypeModal').addEventListener('hidden.bs.modal', resetWorkoutTypeForm);
    document.getElementById('sessionModal').addEventListener('hidden.bs.modal', resetSessionForm);
}

// ===================================
// Equipment Management Functions
// ===================================

function resetEquipmentForm() {
  document.getElementById('equipmentModalTitle').textContent = 'Add Equipment';
  document.getElementById('equipmentForm').reset();
  editingEquipmentId = null;
}

function editEquipment(id) {
  editingEquipmentId = id;
  document.getElementById('equipmentModalTitle').textContent = 'Edit Equipment';
  
  fetch(`/admin/api/equipment/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('equipmentName').value = data.equipment.name;
        document.getElementById('equipmentDescription').value = data.equipment.description;
        document.getElementById('equipmentStatus').value = data.equipment.status;
        document.getElementById('equipmentType').value = data.equipment.equipment_type;
        document.getElementById('maintenanceNotes').value = data.equipment.maintenance_notes;
        new bootstrap.Modal(document.getElementById('equipmentModal')).show();
      } else {
        showAlert(data.error || 'Failed to load equipment data', 'danger');
      }
    })
    .catch(error => {
      showAlert('Error fetching equipment details', 'danger');
      console.error('Error:', error);
    });
}

function saveEquipment() {
  const name = document.getElementById('equipmentName').value;
  const description = document.getElementById('equipmentDescription').value;
  const status = document.getElementById('equipmentStatus').value;
  const equipment_type = document.getElementById('equipmentType').value;
  const maintenance_notes = document.getElementById('maintenanceNotes').value;

  if (!name.trim()) {
    showAlert('Equipment name is required', 'warning');
    return;
  }
  
  const payload = {
    name,
    description,
    status,
    equipment_type,
    maintenance_notes
  };

  const url = editingEquipmentId ? 
    `/admin/api/equipment/${editingEquipmentId}` : 
    '/admin/add_equipment';
  
  const method = editingEquipmentId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('Equipment saved successfully!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('equipmentModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert(data.error || 'Failed to save equipment', 'danger');
    }
  })
  .catch(error => {
    showAlert('Error saving equipment', 'danger');
    console.error('Error:', error);
  });
}

function toggleEquipmentStatus(id) {
  if (confirm('Are you sure you want to change the status of this equipment?')) {
    fetch(`/admin/api/equipment/${id}/toggle-status`, {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAlert('Equipment status updated!', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showAlert(data.error || 'Failed to update status', 'danger');
      }
    })
    .catch(error => {
      showAlert('Error updating equipment status', 'danger');
      console.error('Error:', error);
    });
  }
}

function deleteItem(type, id) {
    deleteType = type;
    deleteId = id;
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
}

function deleteEquipment(id) {
    fetch(`/admin/delete_equipment/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Equipment deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to delete equipment', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error deleting equipment', 'danger');
            console.error('Error:', error);
        });
}

// ===================================
// Events Management Functions
// ===================================

function resetEventForm() {
    document.getElementById('eventModalTitle').textContent = 'Create Event';
    document.getElementById('eventForm').reset();
    editingEventId = null;
}

function saveEvent() {
  const title = document.getElementById('eventTitle').value;
  const description = document.getElementById('eventDescription').value;
  const date = document.getElementById('eventDate').value;
  const time = document.getElementById('eventTime').value;
  
  if (!title.trim() || !date) {
    showAlert('Title and date are required', 'warning');
    return;
  }
  
  const payload = {
    title,
    description,
    date,
    start_time: time
  };
  
  const url = editingEventId ? `/admin/api/event/${editingEventId}` : '/admin/add_event';
  const method = editingEventId ? 'PUT' : 'POST';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('Event saved successfully!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert(data.error || 'Failed to save event', 'danger');
    }
  })
  .catch(error => {
    showAlert('Error saving event', 'danger');
    console.error('Error:', error);
  });
}

function deleteEvent(id) {
    fetch(`/admin/delete_event/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Event deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to delete event', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error deleting event', 'danger');
            console.error('Error:', error);
        });
}

function notifyAllUsers(eventId) {
  fetch(`/admin/api/send-event-notification/${eventId}`, {
    method: 'POST'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert(`Notification sent to ${data.recipients_count || 'all'} members!`, 'success');
    } else {
      showAlert(data.error || 'Failed to send notification', 'danger');
    }
  })
  .catch(error => {
    showAlert('Error sending notification', 'danger');
    console.error('Error:', error);
  });
}

// ===================================
// Workout Type Management Functions
// ===================================

function resetWorkoutTypeForm() {
    document.getElementById('workoutTypeModalTitle').textContent = 'Add Workout Type';
    document.getElementById('workoutTypeForm').reset();
    editingWorkoutTypeId = null;
}

function editWorkoutType(id) {
  editingWorkoutTypeId = id;
  document.getElementById('workoutTypeModalTitle').textContent = 'Edit Workout Type';
  
  fetch(`/admin/api/workout_type/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('workoutTypeName').value = data.workout_type.name;
        document.getElementById('workoutTypeDescription').value = data.workout_type.description;
        new bootstrap.Modal(document.getElementById('workoutTypeModal')).show();
      } else {
        showAlert(data.error || 'Failed to load workout type data', 'danger');
      }
    })
    .catch(error => {
      showAlert('Error fetching workout type details', 'danger');
      console.error('Error:', error);
    });
}

function saveWorkoutType() {
  const name = document.getElementById('workoutTypeName').value;
  const description = document.getElementById('workoutTypeDescription').value;
  
  if (!name.trim()) {
    showAlert('Workout type name is required', 'warning');
    return;
  }
  
  const payload = { name, description };
  const url = editingWorkoutTypeId ? `/admin/api/workout_type/${editingWorkoutTypeId}` : '/admin/add_workout_type';
  const method = editingWorkoutTypeId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('Workout type saved successfully!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('workoutTypeModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert(data.error || 'Failed to save workout type', 'danger');
    }
  })
  .catch(error => {
    showAlert('Error saving workout type', 'danger');
    console.error('Error:', error);
  });
}

function deleteWorkoutType(id) {
    fetch(`/admin/delete_workout_type/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Workout type deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to delete workout type', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error deleting workout type', 'danger');
            console.error('Error:', error);
        });
}

// ===================================
// Session & Booking Functions
// ===================================

function resetSessionForm() {
  document.getElementById('sessionModalTitle').textContent = 'Add New Session';
  document.getElementById('sessionForm').reset();
  document.getElementById('saveSessionBtn').textContent = 'Add Session';
  editingSessionId = null;
}

function editSession(id) {
  editingSessionId = id;
  document.getElementById('sessionModalTitle').textContent = 'Edit Session';
  document.getElementById('saveSessionBtn').textContent = 'Save Changes';
  
  fetch(`/admin/api/sessions/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const session = data.session;
        document.getElementById('sessionId').value = session.id;
        document.getElementById('sessionTitle').value = session.title;
        document.getElementById('sessionType').value = session.type;
        document.getElementById('sessionCoach').value = session.coach_id;
        document.getElementById('sessionAthlete').value = session.athlete_id;
        document.getElementById('sessionScheduledAt').value = session.scheduled_at.slice(0, 16);
        document.getElementById('sessionDuration').value = session.duration;
        document.getElementById('sessionLocation').value = session.location || session.meeting_link;
        new bootstrap.Modal(document.getElementById('sessionModal')).show();
      } else {
        showAlert(data.error || 'Failed to load session data', 'danger');
      }
    })
    .catch(error => {
      showAlert('Error fetching session details', 'danger');
      console.error('Error:', error);
    });
}

function saveSession() {
  const title = document.getElementById('sessionTitle').value;
  const type = document.getElementById('sessionType').value;
  const coachId = document.getElementById('sessionCoach').value;
  const athleteId = document.getElementById('sessionAthlete').value;
  const scheduledAt = document.getElementById('sessionScheduledAt').value;
  const duration = document.getElementById('sessionDuration').value;
  const location = document.getElementById('sessionLocation').value;

  if (!title || !type || !coachId || !athleteId || !scheduledAt || !duration) {
    showAlert('Please fill all required fields.', 'warning');
    return;
  }
  
  const payload = {
    title,
    type,
    coach_id: coachId,
    athlete_id: athleteId,
    scheduled_at: scheduledAt,
    duration: parseInt(duration),
    location: (type === 'in_person') ? location : null,
    meeting_link: (type === 'virtual') ? location : null
  };
  
  const url = editingSessionId ? `/admin/api/sessions/${editingSessionId}` : '/admin/api/sessions/add';
  const method = editingSessionId ? 'PUT' : 'POST';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('Session saved successfully!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('sessionModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showAlert(data.error || 'Failed to save session', 'danger');
    }
  })
  .catch(error => {
    showAlert('Error saving session', 'danger');
    console.error('Error:', error);
  });
}

function cancelSession(id) {
  if (confirm('Are you sure you want to cancel this session?')) {
    fetch(`/admin/api/sessions/${id}/cancel`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Session cancelled successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to cancel session', 'danger');
            }
        })
        .catch(error => {
            showAlert('Error cancelling session', 'danger');
            console.error('Error:', error);
        });
  }
}

// ===================================
// Generic Utility Functions
// ===================================

function showAlert(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = 'position-fixed top-0 end-0 p-3';
  alertContainer.style.zIndex = '9999';
  
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type} alert-dismissible fade show`;
  alertElement.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  alertContainer.appendChild(alertElement);
  document.body.appendChild(alertContainer);
  
  setTimeout(() => {
    if (alertContainer && alertContainer.parentNode) {
      alertContainer.parentNode.removeChild(alertContainer);
    }
  }, 5000);
}
</script>
{% endblock %}