{% extends "shared/base.html" %}

{% block content %}
<main class="col-lg-10 bg-light min-vh-100 p-4">

  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">Manage Admins</h4>
    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdminModal">
      <i class="bi bi-plus-lg me-1"></i> Add Admin
    </a>
  </div>

  <!-- Stats -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-person-badge-fill fs-2 text-primary"></i>
          <h5 class="card-title mt-2">{{ admin_count }}</h5>
          <p class="card-text">Total Admins</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-check-circle-fill fs-2 text-success"></i>
          <h5 class="card-title mt-2">{{ active_count }}</h5>
          <p class="card-text">Active</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-x-circle-fill fs-2 text-danger"></i>
          <h5 class="card-title mt-2">{{ suspended_count }}</h5>
          <p class="card-text">Suspended</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email...">
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select">
        <option value="">Filter by Status</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="roleFilter" class="form-select">
        <option value="">Filter by Role</option>
        <option value="admin">Admin</option>
        <option value="super_admin">Super Admin</option>
      </select>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">Delete Selected</button>
    <select id="bulkRoleSelect" class="form-select form-select-sm" style="width: 150px; display:inline-block;">
      <option value="">Change Role...</option>
      <option value="admin">Admin</option>
      <option value="coach">Coach</option>
      <option value="athlete">Athlete</option>
    </select>
    <button class="btn btn-outline-secondary btn-sm" onclick="bulkChangeRole()">Apply</button>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-hover" id="adminTable">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Profile</th>
            <th>Email</th>
            <th>Status</th>
            <th>Role</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for admin in admins %}
          <tr>
            <td><input type="checkbox" class="row-checkbox" value="{{ admin.id }}"></td>
            <td class="d-flex align-items-center">
              <img src="{{ url_for('static', filename='uploads/' ~ (admin.profile_image or 'default.jpg')) }}"
                  class="rounded-circle me-2" width="40" height="40" alt="Profile">
              <span class="fw-semibold name">{{ admin.name }}</span>
            </td>
            <td class="email">{{ admin.email }}</td>
            <td class="status">
              {% if admin.status == 'active' %}
                <button class="btn btn-sm btn-outline-success" onclick="toggleActive({{ admin.id }})">Active</button>
              {% else %}
                <button class="btn btn-sm btn-outline-danger" onclick="toggleActive({{ admin.id }})">Suspended</button>
              {% endif %}
            </td>
            <td class="role" data-role="{{ 'super_admin' if admin.admin_profile.is_superadmin else 'admin' }}">
              {% if admin.admin_profile.is_superadmin %}
                <span class="badge bg-primary">Super Admin</span>
              {% else %}
                <span class="badge bg-secondary">Admin</span>
              {% endif %}
            </td>
            <td>{{ admin.created_at.strftime('%Y-%m-%d') if admin.created_at else 'N/A' }}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ admin.id }}"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ admin.id }}"><i class="bi bi-trash"></i></button>
              <button class="btn btn-sm btn-outline-warning" onclick="resetPassword({{ admin.id }})">Reset Password</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>


  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this admin?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Admin Form -->
    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="addAdminForm">
          <div class="modal-header">
            <h5 class="modal-title" id="addAdminModalLabel">Add New Admin</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Form Inputs -->
            <div class="mb-3">
              <label for="name" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="name" name="name" required>
            </div>
    
            <div class="mb-3">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="email" name="email" required>
            </div>
    
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
    
            <input type="hidden" id="role" name="role" value="admin">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Admin</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Admin Modal -->
    <div class="modal fade" id="editAdminModal" tabindex="-1" aria-labelledby="editAdminModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editAdminForm">
            <div class="modal-header">
              <h5 class="modal-title" id="editAdminModalLabel">Edit User</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <!-- Permissions -->
              <div class="mb-3">
                <label class="form-label">Permissions</label>
                <div class="d-flex flex-wrap gap-2">
                  <button type="button" class="btn btn-outline-secondary perm-btn" data-perm="manage_users">Manage Users</button>
                  <button type="button" class="btn btn-outline-secondary perm-btn" data-perm="view_reports">View Reports</button>
                  <button type="button" class="btn btn-outline-secondary perm-btn" data-perm="edit_coaches">Edit Coaches</button>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Role</label>
                <select class="form-select" id="editRole">
                  <option value="" disabled selected>Change Role</option>
                  <option value="admin">Admin</option>
                  <option value="super_admin">Super Admin</option>
                  <option value="coach">Coach</option>
                  <option value="athlete">Athlete</option>
                </select>
              </div>

              <input type="hidden" id="editUserId">
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save Changes</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>



  <nav aria-label="Page navigation example">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.manage_admins', page=pagination.prev_num) }}" aria-label="Previous">
              <i class="bi bi-chevron-double-left"></i>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-double-left"></i></span></li>
        {% endif %}

        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
          {% if p %}
            {% if p == pagination.page %}
              <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="{{ url_for('admin.manage_admins', page=p) }}">{{ p }}</a></li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.manage_admins', page=pagination.next_num) }}" aria-label="Next">
              <i class="bi bi-chevron-double-right"></i>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-double-right"></i></span></li>
        {% endif %}
      </ul>
    </nav>
</main>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script>
function showAlert(message, type="info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}
</script>
<script>
let deleteId = null;
let currentEditId = null;
let selectedPermissions = [];

// ---- Add Admin ----
document.getElementById("addAdminForm").addEventListener("submit", async e => {
  e.preventDefault();
  
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const role = "admin";

  const res = await fetch("/admin/add_admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, email, password, role })
  });

  const data = await res.json();
  if (res.ok) {
    location.reload();
  } else {
    showAlert(data.msg, "danger");
  }
});


// ---- Delete ----
document.querySelectorAll(".delete-btn").forEach(btn=>{
  btn.onclick = ()=> {
    deleteId = btn.dataset.id;
    new bootstrap.Modal(document.getElementById("confirmDeleteModal")).show();
  }
});
document.getElementById("confirmDeleteBtn").onclick = async ()=>{
  if (!deleteId) return;
  const res = await fetch(`/admin/delete_admin/${deleteId}`, {
    method:"DELETE", headers:{ Authorization:`Bearer ${localStorage.getItem("access_token")}` }
  });
  if (res.ok) location.reload(); else showAlert("Delete failed","danger");
};

// Toggle permissions
function togglePermission(btn) {
  const perm = btn.dataset.perm;

  if (selectedPermissions.includes(perm)) {
    selectedPermissions = selectedPermissions.filter(p => p !== perm);
    btn.classList.remove("btn-success");
    btn.classList.add("btn-outline-secondary");
  } else {
    selectedPermissions.push(perm);
    btn.classList.remove("btn-outline-secondary");
    btn.classList.add("btn-success");
  }
}

// Reset / Apply permissions visually
function updatePermissionButtons() {
  document.querySelectorAll(".perm-btn").forEach(btn => {
    const perm = btn.dataset.perm;
    if (selectedPermissions.includes(perm)) {
      btn.classList.remove("btn-outline-secondary");
      btn.classList.add("btn-success");
    } else {
      btn.classList.remove("btn-success");
      btn.classList.add("btn-outline-secondary");
    }
  });
}

// Load data into modal
document.querySelectorAll(".edit-btn").forEach((btn) => {
  btn.addEventListener("click", async function () {
    const userId = this.dataset.id;
    currentEditId = userId;
    document.getElementById("editUserId").value = userId;

    const token = localStorage.getItem("access_token");
    const response = await fetch(`/user/${userId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await response.json();

    selectedPermissions = Array.isArray(data.permissions) ? data.permissions : [];
    updatePermissionButtons();

    document.getElementById("editRole").value = 
      (data.role === "admin" && data.is_superadmin) ? "super_admin" : data.role || "";

    const modal = new bootstrap.Modal(document.getElementById("editAdminModal"));
    modal.show();
  });
});


// Handle role change live
document.getElementById("editRole").addEventListener("change", function () {
  const newRole = this.value;

  if (newRole === "super_admin") {
    // ✅ Super Admin → كل الصلاحيات + disable buttons
    selectedPermissions = ["manage_users", "view_reports", "edit_coaches"];
    updatePermissionButtons();
    document.querySelectorAll(".perm-btn").forEach(btn => btn.disabled = true);
  } else if (newRole === "admin") {
    // ✅ Admin → reset permissions (محتاج يحددها السوبر أدمن)
    selectedPermissions = [];
    updatePermissionButtons();
    document.querySelectorAll(".perm-btn").forEach(btn => btn.disabled = false);
  } else {
    // ✅ Coach / Athlete → مفيش permissions
    selectedPermissions = [];
    updatePermissionButtons();
    document.querySelectorAll(".perm-btn").forEach(btn => btn.disabled = true);
  }
});
document.getElementById("editAdminForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const userId = document.getElementById("editUserId").value;
  const token = localStorage.getItem("access_token");
  let newRole = document.getElementById("editRole").value;

  // Map super_admin → admin + is_superadmin flag
  let is_superadmin = false;
  if (newRole === "super_admin") {
    newRole = "admin";
    is_superadmin = true;
  }

  const res = await fetch(`/user/update/${userId}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ 
      permissions: selectedPermissions, 
      role: newRole,
      is_superadmin: is_superadmin
    })
  });

  if (res.ok) {
    location.reload();
  } else {
    const err = await res.json();
    alert(err.msg || "Failed to update user");
  }
});

// ---- Filters ----
function filterTable(){
  const s=searchInput.value.toLowerCase();
  const st=statusFilter.value;
  const r=roleFilter.value;
  rows.forEach(row=>{
    const name=row.querySelector(".name").textContent.toLowerCase();
    const email=row.querySelector(".email").textContent.toLowerCase();
    const status=row.querySelector(".status").textContent.toLowerCase();
    const role=row.querySelector(".role").dataset.role;
    const ok=( (!s||name.includes(s)||email.includes(s)) &&
              (!st||status.includes(st)) &&
              (!r||role===r) );
    row.style.display=ok?"":"none";
  });
}
const rows=document.querySelectorAll("#adminTable tbody tr");
searchInput.oninput=filterTable; statusFilter.onchange=filterTable; roleFilter.onchange=filterTable;

// ---- Bulk ----
function getSelectedIds(){ return [...document.querySelectorAll(".row-checkbox:checked")].map(cb=>cb.value); }
async function bulkDelete(){ const ids=getSelectedIds(); if(!ids.length) return showAlert("Select at least one","warning"); if(!confirm("Delete selected?")) return;
  const res=await fetch("/admin/bulk_delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({ids})});
  if(res.ok) location.reload(); else showAlert("Bulk delete failed","danger");
}
async function bulkChangeRole(){ const ids=getSelectedIds(); const role=bulkRoleSelect.value; if(!ids.length) return showAlert("Select users","warning"); if(!role) return showAlert("Choose role","warning");
  const res=await fetch("/admin/bulk_change_role",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({ids,role})});
  if(res.ok){ showAlert("Roles updated","success"); setTimeout(()=>location.reload(),1000);} else showAlert("Bulk change failed","danger");
}
document.getElementById("selectAll").onchange=function(){ document.querySelectorAll(".row-checkbox").forEach(cb=>cb.checked=this.checked); };

// ---- Reset Password ----
async function resetPassword(id){
  if(!confirm("Reset password?")) return;
  const res=await fetch(`/admin/reset_password/${id}`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});
  if(res.ok) showAlert("Password reset","success"); else showAlert("Failed","danger");
}
</script>




{% endblock %}
