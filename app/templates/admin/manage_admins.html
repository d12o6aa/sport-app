{% extends "shared/base.html" %}

{% block content %}
<main class="col-lg-10 bg-light min-vh-100 p-4">

  <!-- Page Title and Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">Manage Admins</h4>
    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdminModal">
      <i class="bi bi-plus-lg me-1"></i> Add Admin
    </a>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-person-badge-fill fs-2 text-primary"></i>
          <h5 class="card-title mt-2">{{ admin_count }}</h5>
          <p class="card-text">Total Admins</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-check-circle-fill fs-2 text-success"></i>
          <h5 class="card-title mt-2">{{ active_count }}</h5>
          <p class="card-text">Active</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-x-circle-fill fs-2 text-danger"></i>
          <h5 class="card-title mt-2">{{ suspended_count }}</h5>
          <p class="card-text">Suspended</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="row mb-3">
    <div class="col-md-6">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email...">
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select">
        <option value="">Filter by Status</option>
        <option value="active">Active</option>
        <option value="inactive">Suspended</option>
      </select>
    </div>
  </div>
  
  <!-- Add Admin Form -->
  <div class="modal fade" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="addAdminForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addAdminModalLabel">Add New Admin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form Inputs -->
          <div class="mb-3">
            <label for="name" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
  
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="email" name="email" required>
          </div>
  
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" name="password" required>
          </div>
  
          <input type="hidden" id="role" name="role" value="admin">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Admin</button>
        </div>
      </form>
    </div>
  </div>
  


  <!-- Admins Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-hover" class="table" id="adminTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Joined</th>
            <th>Actions</th>
            <th>Change Role</th>
          </tr>
        </thead>
        <tbody>
            {% for admin in admins %}
            <tr>
              <td>{{ loop.index }}</td>
              <td class="name">{{ admin.name }}</td>
              <td class="email">{{ admin.email }}</td>
              <td class="status">
                {% if admin.status == 'active' %}
                  <button class="btn btn-sm badge bg-success" onclick="toggleActive({{ admin.id }})">Active</button>
                {% else %}
                  <button class="btn btn-sm badge bg-danger" onclick="toggleActive({{ admin.id }})">Suspended</button>
                {% endif %}
              </td>
              <td>{{ admin.created_at.strftime('%Y-%m-%d') if admin.created_at else 'N/A' }}</td>
                <td>
                  <button class="btn btn-sm btn-light edit-btn" data-id="{{ admin.id }}"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-light delete-btn" data-id="{{ admin.id }}"><i class="bi bi-trash"></i></button>
                </td>
                <td>
                  <select class="form-select form-select-sm" onchange="changeUserRole('{{ admin.id }}', this.value)">
                    <option value="" disabled selected>Change Role</option>
                    <option value="admin">Admin</option>
                    <option value="coach">Coach</option>
                    <option value="athlete">Athlete</option>
                  </select>
                </td>
            </tr>

            {% endfor %}
          </tbody>
      </table>
    </div>
  </div>


  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this admin?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Edit Admin Modal -->
  <div class="modal fade" id="editAdminModal" tabindex="-1" aria-labelledby="editAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editAdminForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editAdminModalLabel">Edit Admin</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- صلاحيات -->
            <div class="mb-3">
              <label class="form-label">Permissions</label>
              <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-secondary perm-btn" data-perm="manage_users">Manage Users</button>
                <button type="button" class="btn btn-outline-secondary perm-btn" data-perm="view_reports">View Reports</button>
                <button type="button" class="btn btn-outline-secondary perm-btn" data-perm="edit_coaches">Edit Coaches</button>
              </div>
            </div>
            
            <input type="hidden" id="editUserId">
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById("addAdminForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const role = "admin";

    const response = await fetch("/admin/add_admin", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name, email, password, role })
    });

    const result = await response.json();
    if (response.ok) {
      location.reload(); 
    } else {
      alert(result.msg || "Something went wrong");
    }
  });

  async function toggleActive(adminId) {
    const token = localStorage.getItem("access_token");
    const res = await fetch(`/admin/toggle_active/${adminId}`, {
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (res.ok) {

      window.location.reload();
    }
  }
  let deleteId = null;

  // Handle Delete Button Click
  document.querySelectorAll(".delete-btn").forEach(button => {
    button.addEventListener("click", function () {
      deleteId = this.dataset.id;
      const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
      modal.show();
    });
  });

  // Handle Confirm Delete
  document.getElementById("confirmDeleteBtn").addEventListener("click", async function () {
    if (!deleteId) return;

    const token = localStorage.getItem("access_token");

    const res = await fetch(`/admin/delete_admin/${deleteId}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    const result = await res.json();
    if (res.ok) {
      window.location.reload(); // reload to reflect changes
    } else {
      alert(result.msg || "Failed to delete admin.");
    }
  });


  ////////////////////////
  
  let currentEditId = null;
  let selectedPermissions = [];

  // Toggle button
  function togglePermission(btn) {
    const perm = btn.dataset.perm;

    if (selectedPermissions.includes(perm)) {
      selectedPermissions = selectedPermissions.filter(p => p !== perm);
      btn.classList.remove("btn-success");
      btn.classList.add("btn-outline-secondary");
    } else {
      selectedPermissions.push(perm);
      btn.classList.remove("btn-outline-secondary");
      btn.classList.add("btn-success");
    }
  }

  document.querySelectorAll(".perm-btn").forEach((btn) => {
    btn.addEventListener("click", () => togglePermission(btn));
  });

  // Load current user info into modal
  document.querySelectorAll(".edit-btn").forEach((btn) => {
    btn.addEventListener("click", async function () {
      const userId = this.dataset.id;
      currentEditId = userId;
      document.getElementById("editUserId").value = userId;

      const token = localStorage.getItem("access_token");
      const response = await fetch(`/admin/get_admin/${userId}`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const data = await response.json();
      selectedPermissions = data.permissions || [];

      document.querySelectorAll(".perm-btn").forEach((btn) => {
        const perm = btn.dataset.perm;
        if (selectedPermissions.includes(perm)) {
          btn.classList.remove("btn-outline-secondary");
          btn.classList.add("btn-success");
        } else {
          btn.classList.remove("btn-success");
          btn.classList.add("btn-outline-secondary");
        }
      });

      const modal = new bootstrap.Modal(document.getElementById("editAdminModal"));
      modal.show();
    });
  });

  // Submit form
  document.getElementById("editAdminForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const userId = document.getElementById("editUserId").value;
    const token = localStorage.getItem("access_token");

    const res = await fetch(`/admin/update_admin/${userId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ permissions: selectedPermissions })
    });

    if (res.ok) {
      location.reload();
    } 
  });

  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const table = document.getElementById("adminTable");
  const rows = table.querySelectorAll("tbody tr");

  function filterTable() {
    const searchValue = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;

    rows.forEach(row => {
      const name = row.querySelector(".name").textContent.toLowerCase();
      const email = row.querySelector(".email").textContent.toLowerCase();
      const status = row.querySelector(".status").textContent.toLowerCase();

      const matchesSearch = name.includes(searchValue) || email.includes(searchValue);
      const matchesStatus = !statusValue || status.includes(statusValue);

      if (matchesSearch && matchesStatus) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  searchInput.addEventListener("input", filterTable);
  statusFilter.addEventListener("change", filterTable);

</script>
<script>
function changeUserRole(userId, newRole) {
    if (!confirm(`Are you sure you want to change this user's role to ${newRole}?`)) return;

    fetch(`/admin/change_role/${userId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("access_token")
        },
        body: JSON.stringify({ role: newRole })
    })
    .then(response => {
        const isOk = response.ok; // نخزن قيمة ok
        return response.json().then(data => ({ isOk, data }));
    })
    .then(({ isOk, data }) => {
        if (isOk) {
            alert(data.msg);
            location.reload();
        } else {
            alert(data.msg || "Error changing role");
        }
    })
    .catch(err => {
        console.error("Error:", err);
        alert("Something went wrong");
    });
}
</script>



{% endblock %}
