{% extends "shared/base.html" %}

{% block content %}
<main class="container mt-4">
  <h4 class="fw-bold mb-4">Unassigned Athletes</h4>

  {% if athletes %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Registered At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for athlete in athletes %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ athlete.name }}</td>
          <td>{{ athlete.email }}</td>
          <td>{{ athlete.created_at.strftime('%Y-%m-%d') if athlete.created_at else "N/A" }}</td>
          <td>
            <form id="assignCoachForm{{ athlete.id }}" onsubmit="assignCoach(event, '{{ athlete.id }}')">
                <input type="hidden" name="athlete_id" value="{{ athlete.id }}">
                <select id="coachSelect{{ athlete.id }}" name="coach_id" class="form-select mb-2" required>
                    <option disabled selected>Select a coach</option>
                    {% for coach in coaches %}
                    <option value="{{ coach.id }}">{{ coach.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-sm btn-primary" type="submit">Assign</button>
            </form>
                
            </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p>No unassigned athletes found.</p>
  {% endif %}

  

</main>
{% endblock %}

{% block scripts %}
<script>
    // Function to assign a coach to an athlete

  async function assignCoach(event, athleteId) {
    event.preventDefault();
    const form = event.target;
    const coachId = form.querySelector("select[name='coach_id']").value;

    console.log("Assigning coach", coachId, "to athlete", athleteId);

    const res = await fetch("/athlete/assign_coach", {
        method: "POST",
        headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + localStorage.getItem("access_token")
        },
        body: JSON.stringify({ athlete_id: athleteId, coach_id: coachId })
    });

    const data = await res.json();
    console.log("Response:", data);

    if (res.ok) {
        location.reload();
    } else {
        alert(data.msg || "Assignment failed");
    }
}

</script>
{% endblock %}
