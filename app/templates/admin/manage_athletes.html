{% extends "shared/base.html" %}

{% block content %}
<main class="col-lg-10 bg-light min-vh-100 p-4">
  

  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">Manage Athletes</h4>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAthleteModal">
      <i class="bi bi-plus-lg me-1"></i> Add Athlete
    </button>
  </div>

  <!-- Stats -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-person-badge-fill fs-2 text-primary"></i>
          <h5 class="card-title mt-2">{{ athlete_count }}</h5>
          <p class="card-text">Total Athlete</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-check-circle-fill fs-2 text-success"></i>
          <h5 class="card-title mt-2">{{ active_count }}</h5>
          <p class="card-text">Active</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-x-circle-fill fs-2 text-danger"></i>
          <h5 class="card-title mt-2">{{ suspended_count }}</h5>
          <p class="card-text">Suspended</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email...">
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select">
        <option value="">Filter by Status</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="roleFilter" class="form-select">
        <option value="">Filter by Role</option>
        <option value="admin">Admin</option>
        <option value="super_admin">Super Admin</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-hover" id="adminTable">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Profile</th>
            <th>Email</th>
            <th>Status</th>
            <th>Registered At</th>
            <th>Coach</th>
            <th>Actions</th>
            <th>Change Role</th>
          </tr>
        </thead>
        <tbody>
          {% for athlete in athletes %}
          <tr>
            <td><input type="checkbox" class="row-checkbox" value="{{ athlete.id }}"></td>
            <td class="d-flex align-items-center">
              <img src="{{ url_for('static', filename='uploads/' ~ (athlete.profile_image or 'default.jpg')) }}"
                  class="rounded-circle me-2" width="40" height="40" alt="Profile">
              <span class="fw-semibold name">{{ athlete.name }}</span>
            </td>
            <td class="email">{{ athlete.email }}</td>
            <td class="status">
              {% if athlete.status == 'active' %}
                <button class="btn btn-sm btn-outline-success" onclick="toggleActive({{ athlete.id }})">Active</button>
              {% else %}
                <button class="btn btn-sm btn-outline-danger" onclick="toggleActive({{ athlete.id }})">Suspended</button>
              {% endif %}
            </td>
            
            <td>{{ athlete.created_at.strftime('%Y-%m-%d') if athlete.created_at else 'N/A' }}</td>
            <td>
              {% set coach_link = athlete.coach_links.first() %}
              {{ coach_link.coach.name if coach_link else 'Unassigned' }}
            </td>

            <td>
              <button class="btn btn-sm btn-light" onclick="openEditModal('{{ athlete.id }}', '{{ athlete.name }}', '{{ athlete.email }}', '{{ coach_link.coach.id if coach_link else '' }}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-light text-danger" onclick="confirmDelete('{{ athlete.id }}')"><i class="bi bi-trash"></i></button>
              <button class="btn btn-sm btn-outline-secondary" onclick="resetPassword({{ athlete.id }})">Reset Password</button>
            </td>
            <td>
              <select class="form-select form-select-sm" onchange="changeUserRole('{{ athlete.id }}', this.value)">
                <option value="" disabled selected>Change Role</option>
                <option value="admin">Admin</option>
                <option value="coach">Coach</option>
                <option value="athlete">Athlete</option>
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal fade" id="addAthleteModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="addAthleteForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Athlete</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" class="form-control mb-3" placeholder="Name" required>
          <input type="email" name="email" class="form-control mb-3" placeholder="Email" required>
          <input type="password" name="password" class="form-control mb-3" placeholder="Password" required>
          <select name="coach_id" class="form-select">
            <option value="">Unassigned</option>
            {% for coach in coaches %}
              <option value="{{ coach.id }}">{{ coach.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editAthleteModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="editAthleteForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Athlete</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editAthleteId">
          <input type="text" id="editAthleteName" class="form-control" placeholder="Name" required>
          <input type="email" id="editAthleteEmail" class="form-control mt-3" disabled>
          <select id="editAthleteCoach" class="form-select mt-3">
            <option value="">Unassigned</option>
            {% for coach in coaches %}
              <option value="{{ coach.id }}">{{ coach.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ================== Show Alert ==================
function showAlert(message, type="info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}

// ================== Add Athlete ==================
document.getElementById("addAthleteForm").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const payload = Object.fromEntries(formData.entries());

  const res = await fetch("/athlete/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (res.ok) {
    location.reload();
  } else {
    showAlert(data.msg || "Failed to add athlete", "danger");
  }
});

// ================== Edit Athlete ==================
function openEditModal(id, name, email, coachId) {
  document.getElementById("editAthleteId").value = id;
  document.getElementById("editAthleteName").value = name;
  document.getElementById("editAthleteEmail").value = email;
  document.getElementById("editAthleteCoach").value = coachId || "";
  new bootstrap.Modal(document.getElementById("editAthleteModal")).show();
}

document.getElementById("editAthleteForm").addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("editAthleteId").value;
  const name = document.getElementById("editAthleteName").value;
  const coach_id = document.getElementById("editAthleteCoach").value;

  const res = await fetch(`/athlete/update/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, coach_id })
  });

  const data = await res.json();
  if (res.ok) {
    location.reload();
  } else {
    showAlert(data.msg || "Failed to update athlete", "danger");
  }
});

// ================== Delete Athlete ==================
let deleteId = null;
function confirmDelete(id) {
  deleteId = id;
  if (confirm("Are you sure you want to delete this athlete?")) {
    deleteAthlete();
  }
}

async function deleteAthlete() {
  if (!deleteId) return;
  const res = await fetch(`/athlete/delete/${deleteId}`, { method: "DELETE" });
  if (res.ok) {
    location.reload();
  } else {
    showAlert("Failed to delete athlete", "danger");
  }
}

// ================== Toggle Active ==================
async function toggleActive(id) {
  fetch(`/athlete/toggle_status/${id}`, {
      method: "PATCH",
      headers: { Authorization: "Bearer " + localStorage.getItem("access_token") }
    })
    .then(res => res.json().catch(() => null))
    .then(data => {
      if (data?.msg) {
        showAlert(data.msg, "success");
        setTimeout(() => location.reload(), 1200);
      } else {
        showAlert("Status toggle failed", "danger");
      }
    });
}

// ================== Reset Password ==================
async function resetPassword(id) {
  const res = await fetch(`/athlete/reset_password/${id}`, { method: "POST" });
  const data = await res.json();
  if (res.ok) {
    showAlert("Password has been reset successfully", "success");
  } else {
    showAlert(data.msg || "Failed to reset password", "danger");
  }
}

// ================== Change Role ==================
async function changeUserRole(id, role) {
  const res = await fetch(`/athlete/change_role/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ role })
  });
  if (res.ok) {
    showAlert("Role updated successfully", "success");
  } else {
    showAlert("Failed to update role", "danger");
  }
}

// ================== Search & Filters ==================
document.getElementById("searchInput").addEventListener("keyup", filterTable);
document.getElementById("statusFilter").addEventListener("change", filterTable);
document.getElementById("roleFilter").addEventListener("change", filterTable);

function filterTable() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const status = document.getElementById("statusFilter").value;
  const role = document.getElementById("roleFilter").value;
  const rows = document.querySelectorAll("#adminTable tbody tr");

  rows.forEach(row => {
    const name = row.querySelector(".name").textContent.toLowerCase();
    const email = row.querySelector(".email").textContent.toLowerCase();
    const statusText = row.querySelector(".status button").textContent.toLowerCase();
    const roleSelect = row.querySelector("select")?.value || "";

    let visible = true;
    if (search && !(name.includes(search) || email.includes(search))) visible = false;
    if (status && statusText !== status) visible = false;
    if (role && roleSelect !== role) visible = false;

    row.style.display = visible ? "" : "none";
  });
}

// ================== Select All Checkboxes ==================
document.getElementById("selectAll").addEventListener("change", e => {
  document.querySelectorAll(".row-checkbox").forEach(cb => {
    cb.checked = e.target.checked;
  });
});
</script>


{% endblock %}
