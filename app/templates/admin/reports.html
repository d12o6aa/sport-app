{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Reports & Analytics</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Reports & Analytics</li>
    </ol>
  </nav>
</div>

<section class="section">
  <!-- Filter Controls -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">
              <i class="bi bi-funnel text-primary"></i> Report Filters
            </h5>
            <div class="filter-actions">
              <button class="btn btn-outline-primary btn-sm me-2" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> Reset
              </button>
              <button class="btn btn-primary btn-sm" onclick="exportReport()">
                <i class="bi bi-download"></i> Export
              </button>
            </div>
          </div>
          
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Date Range</label>
              <select id="dateRange" class="form-select" onchange="updateCharts()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 3 Months</option>
                <option value="365">Last Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Report Type</label>
              <select id="reportType" class="form-select" onchange="updateCharts()">
                <option value="overview" selected>Overview</option>
                <option value="members">Member Analytics</option>
                <option value="performance">Performance</option>
                <option value="financial">Financial</option>
                <option value="equipment">Equipment Usage</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Group By</label>
              <select id="groupBy" class="form-select" onchange="updateCharts()">
                <option value="day">Daily</option>
                <option value="week" selected>Weekly</option>
                <option value="month">Monthly</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Compare</label>
              <select id="compareWith" class="form-select" onchange="updateCharts()">
                <option value="none" selected>No Comparison</option>
                <option value="previous">Previous Period</option>
                <option value="last_year">Same Period Last Year</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="row mb-4">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card members-card">
        <div class="card-body">
          <h5 class="card-title">Total Members</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-people"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalMembers">{{ num_members }}</h6>
              <span class="text-success small pt-1 fw-bold">+12.5%</span>
              <span class="text-muted small pt-2 ps-1">vs last month</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card progress-card">
        <div class="card-body">
          <h5 class="card-title">Average Progress</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-graph-up-arrow"></i>
            </div>
            <div class="ps-3">
              <h6 id="avgProgress">{{ "%.1f"|format(avg_progress) }}%</h6>
              <span class="text-success small pt-1 fw-bold">+5.2%</span>
              <span class="text-muted small pt-2 ps-1">improvement</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card revenue-card">
        <div class="card-body">
          <h5 class="card-title">Monthly Revenue</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <div class="ps-3">
              <h6 id="monthlyRevenue">${{ "{:,.0f}".format(revenues) }}</h6>
              <span class="text-success small pt-1 fw-bold">+8.1%</span>
              <span class="text-muted small pt-2 ps-1">vs last month</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card retention-card">
        <div class="card-body">
          <h5 class="card-title">Retention Rate</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="ps-3">
              <h6 id="retentionRate">{{ retention_rate|default(92.3) }}%</h6>
              <span class="text-success small pt-1 fw-bold">+2.1%</span>
              <span class="text-muted small pt-2 ps-1">retention</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Revenue & Member Growth</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="toggleChartType('revenueChart')">
              <i class="bi bi-arrow-repeat"></i> Toggle View
            </button>
          </div>
          <canvas id="revenueChart" style="max-height: 400px;"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Membership Distribution</h5>
          <canvas id="membershipChart" style="max-height: 400px;"></canvas>
          <div class="membership-legend mt-3">
            {% for membership in membership_types|default([]) %}
            <div class="legend-item d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center">
                <span class="legend-color me-2" style="background: {{ membership.color }};"></span>
                <span>{{ membership.name }}</span>
              </div>
              <strong>{{ membership.count }}</strong>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Analytics -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Coach Performance Ranking</h5>
            <button class="btn btn-outline-warning btn-sm" onclick="refreshCoachData()">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
          
          <div class="performance-list" style="max-height: 400px; overflow-y: auto;">
            {% for coach in coaches_performance %}
            <div class="performance-item d-flex align-items-center p-3 mb-2 bg-light rounded">
              <div class="performer-rank me-3">
                <div class="rank-badge {{ 'top-performer' if loop.index <= 3 else '' }}">
                  {{ loop.index }}
                </div>
              </div>
              <div class="performer-avatar me-3">
                <img src="{{ coach.profile_image|default(url_for('static', filename='images/default.jpg')) }}"
                  alt="Coach" class="rounded-circle"
                  style="width: 40px; height: 40px; object-fit: cover;">
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ coach.coach_name|default('Coach ' + coach.coach_id|string) }}</h6>
                <small class="text-muted">{{ coach.athlete_count|default(0) }} Athletes</small>
              </div>
              <div class="performer-score">
                <span class="score-value fw-bold">{{ "%.1f"|format(coach.avg_progress) }}%</span>
                <div class="progress mt-1" style="height: 4px; width: 80px;">
                  <div class="progress-bar bg-warning" style="width: {{ coach.avg_progress }}%;"></div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Equipment Usage Analytics</h5>
            <button class="btn btn-outline-info btn-sm" onclick="refreshEquipmentData()">
              <i class="bi bi-arrow-clockwise"></i> Update
            </button>
          </div>
          <canvas id="equipmentChart" style="max-height: 400px;"></canvas>
          
          <div class="equipment-usage-list mt-3">
            {% for equip in equipment_usage|default([]) %}
            <div class="usage-item d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center">
                <i class="bi bi-tools me-2 text-info"></i>
                <span>{{ equip.name }}</span>
              </div>
              <div class="usage-stats">
                <span class="badge bg-info">{{ equip.usage_hours }}h</span>
                <small class="text-muted ms-1">{{ equip.usage_percentage }}%</small>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Tracking -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Member Activity Timeline</h5>
            <div class="timeline-controls">
              <button class="btn btn-outline-primary btn-sm" onclick="changeTimelineView('week')">Week</button>
              <button class="btn btn-primary btn-sm" onclick="changeTimelineView('month')">Month</button>
              <button class="btn btn-outline-primary btn-sm" onclick="changeTimelineView('year')">Year</button>
            </div>
          </div>
          <canvas id="activityTimeline" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Reports Table -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Detailed Analytics Report</h5>
            <div class="table-actions">
              <button class="btn btn-success btn-sm me-2" onclick="exportTableData('excel')">
                <i class="bi bi-file-earmark-excel"></i> Excel
              </button>
              <button class="btn btn-danger btn-sm" onclick="exportTableData('pdf')">
                <i class="bi bi-file-earmark-pdf"></i> PDF
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table id="analyticsTable" class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Metric</th>
                  <th>Current</th>
                  <th>Previous</th>
                  <th>Change</th>
                  <th>Trend</th>
                  <th>Target</th>
                  <th>Achievement</th>
                </tr>
              </thead>
              <tbody>
                {% for metric in detailed_metrics|default([]) %}
                <tr>
                  <td>
                    <strong>{{ metric.name }}</strong>
                    <small class="d-block text-muted">{{ metric.description }}</small>
                  </td>
                  <td><strong>{{ metric.current_value }}</strong></td>
                  <td>{{ metric.previous_value }}</td>
                  <td class="{{ 'text-success' if metric.change > 0 else 'text-danger' }}">
                    <i class="bi bi-arrow-{{ 'up' if metric.change > 0 else 'down' }}"></i>
                    {{ "%.1f"|format(metric.change) }}%
                  </td>
                  <td>
                    <i class="bi bi-{{ metric.trend_icon }} text-{{ metric.trend_color }}"></i>
                  </td>
                  <td>{{ metric.target }}</td>
                  <td>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-{{ metric.achievement_color }}" 
                           style="width: {{ metric.achievement_percentage }}%;"></div>
                    </div>
                    <small>{{ "%.1f"|format(metric.achievement_percentage) }}%</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-lightning"></i> Quick Actions
          </h5>
          <div class="row g-3">
            <div class="col-md-3">
              <button class="btn btn-primary w-100" onclick="generateCustomReport()">
                <i class="bi bi-file-text"></i>
                <div>Generate Custom Report</div>
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-success w-100" onclick="scheduleReport()">
                <i class="bi bi-clock"></i>
                <div>Schedule Report</div>
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-warning w-100" onclick="shareReport()">
                <i class="bi bi-share"></i>
                <div>Share Report</div>
              </button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-info w-100" onclick="printReport()">
                <i class="bi bi-printer"></i>
                <div>Print Report</div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Custom Report Modal -->
<div class="modal fade" id="customReportModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate Custom Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="customReportForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Report Name</label>
                <input type="text" id="reportName" class="form-control" placeholder="Enter report name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Report Format</label>
                <select id="reportFormat" class="form-select">
                  <option value="pdf">PDF</option>
                  <option value="excel">Excel</option>
                  <option value="csv">CSV</option>
                  <option value="html">HTML</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Include Metrics</label>
            <div class="row g-2">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeMemberStats" checked>
                  <label class="form-check-label" for="includeMemberStats">Member Statistics</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeRevenue" checked>
                  <label class="form-check-label" for="includeRevenue">Revenue Analysis</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeCoachPerf" checked>
                  <label class="form-check-label" for="includeCoachPerf">Coach Performance</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeEquipment">
                  <label class="form-check-label" for="includeEquipment">Equipment Usage</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeActivity">
                  <label class="form-check-label" for="includeActivity">Activity Timeline</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeGoals">
                  <label class="form-check-label" for="includeGoals">Goals Achievement</label>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Date From</label>
                <input type="date" id="customDateFrom" class="form-control">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Date To</label>
                <input type="date" id="customDateTo" class="form-control">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="generateReport()">
          <i class="bi bi-download"></i> Generate Report
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

{{ super() }}
<style>
/* NiceAdmin Compatible Styles */
.members-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
.progress-card .card-icon { background: linear-gradient(90deg, #2eca6a, #20c997); }
.revenue-card .card-icon { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.retention-card .card-icon { background: linear-gradient(90deg, #dc3545, #e91e63); }

.performance-item:hover {
  background-color: #f1f3ff !important;
  transform: translateX(5px);
  transition: all 0.3s ease;
}

.rank-badge {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #6c757d;
  color: white;
  font-weight: bold;
  font-size: 14px;
}

.rank-badge.top-performer {
  background: linear-gradient(135deg, #ffd700, #ff6b35);
  animation: pulse 2s infinite;
}

.legend-item {
  padding: 5px 0;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  display: inline-block;
}

.usage-item:hover {
  background-color: #f8f9fa;
  border-radius: 5px;
  padding: 5px;
  transition: all 0.2s ease;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
}

.timeline-controls .btn {
  margin: 0 2px;
}

.table-actions .btn {
  margin: 0 2px;
}

.quick-action-btn {
  height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  border-radius: 10px;
  transition: all 0.3s ease;
}

.quick-action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
</style>

<script>
// Global variables for charts
let revenueChart, membershipChart, equipmentChart, activityChart;
let currentChartType = 'line';

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
  initializeCharts();
  loadRealtimeData();
  setupEventListeners();
});

// Initialize all charts
function initializeCharts() {
  initRevenueChart();
  initMembershipChart();
  initEquipmentChart();
  initActivityChart();
}

// Revenue & Growth Chart
function initRevenueChart() {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ revenue_chart_labels|default([])|tojson }},
            datasets: [
                {
                    label: 'Revenue ($)',
                    data: {{ revenue_data|default([])|tojson }},
                    borderColor: '#4154f1',
                    backgroundColor: 'rgba(65, 84, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'New Members',
                    data: {{ member_growth_data|default([])|tojson }},
                    borderColor: '#2eca6a',
                    backgroundColor: 'rgba(46, 202, 106, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top' } },
            scales: {
                y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Revenue ($)' } },
                y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Members' }, grid: { drawOnChartArea: false } }
            }
        }
    });
}
// Membership Distribution Chart
function initMembershipChart() {
  const ctx = document.getElementById('membershipChart').getContext('2d');
  membershipChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: {{ membership_labels|default(['Premium', 'Standard', 'Basic'])|tojson }},
      datasets: [{
        data: {{ membership_data|default([45, 35, 20])|tojson }},
        backgroundColor: [
          '#4154f1',
          '#2eca6a', 
          '#ff771d'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

// Equipment Usage Chart
function initEquipmentChart() {
  const ctx = document.getElementById('equipmentChart').getContext('2d');
  equipmentChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ equipment_labels|default(['Treadmill', 'Weights', 'Bike', 'Rowing'])|tojson }},
      datasets: [{
        label: 'Usage Hours',
        data: {{ equipment_usage_data|default([120, 95, 80, 65])|tojson }},
        backgroundColor: [
          'rgba(65, 84, 241, 0.8)',
          'rgba(46, 202, 106, 0.8)',
          'rgba(255, 119, 29, 0.8)',
          'rgba(220, 53, 69, 0.8)'
        ],
        borderColor: [
          '#4154f1',
          '#2eca6a',
          '#ff771d', 
          '#dc3545'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Hours'
          }
        }
      }
    }
  });
}

// Activity Timeline Chart  
function initActivityChart() {
  const ctx = document.getElementById('activityTimeline').getContext('2d');
  activityChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ activity_labels|default([])|tojson }},
      datasets: [{
        label: 'Active Members',
        data: {{ activity_data|default([])|tojson }},
        borderColor: '#17a2b8',
        backgroundColor: 'rgba(23, 162, 184, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

// Filter Functions
function updateCharts() {
  const dateRange = document.getElementById('dateRange').value;
  const reportType = document.getElementById('reportType').value;
  const groupBy = document.getElementById('groupBy').value;
  
  // Update charts based on filters
  fetch('/admin/api/reports/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      date_range: dateRange,
      report_type: reportType,
      group_by: groupBy
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateChartsWithData(data);
      showAlert('Reports updated successfully!', 'success');
    }
  })
  .catch(error => {
    showAlert('Error updating reports', 'danger');
    console.error('Error:', error);
  });
}

// ... (الكود السابق حتى update)

// Update charts with new data
function updateChartsWithData(data) {
  revenueChart.data.labels = data.revenue_chart_labels || [];
  revenueChart.data.datasets[0].data = data.revenue_data || [];
  revenueChart.data.datasets[1].data = data.member_growth_data || [];
  revenueChart.update();

  membershipChart.data.labels = data.membership_labels || ['Premium', 'Standard', 'Basic'];
  membershipChart.data.datasets[0].data = data.membership_data || [45, 35, 20];
  membershipChart.update();

  equipmentChart.data.labels = data.equipment_labels || ['Treadmill', 'Weights', 'Bike', 'Rowing'];
  equipmentChart.data.datasets[0].data = data.equipment_usage_data || [120, 95, 80, 65];
  equipmentChart.update();

  activityChart.data.labels = data.activity_labels || [];
  activityChart.data.datasets[0].data = data.activity_data || [];
  activityChart.update();

  // Update stats
  document.getElementById('totalMembers').textContent = data.num_members || 0;
  document.getElementById('avgProgress').textContent = (data.avg_progress || 0).toFixed(1) + '%';
  document.getElementById('monthlyRevenue').textContent = '$' + (data.revenues || 0).toLocaleString();
  document.getElementById('retentionRate').textContent = (data.retention_rate || 92.3) + '%';
}

// Toggle chart type (line/bar)
function toggleChartType(chartId) {
  const chart = chartId === 'revenueChart' ? revenueChart : null;
  if (chart) {
    currentChartType = currentChartType === 'line' ? 'bar' : 'line';
    chart.config.type = currentChartType;
    chart.update();
  }
}

// Refresh coach performance data
function refreshCoachData() {
  fetch('/admin/api/reports/coach-performance', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update UI with new coach data (assuming handled by Jinja template reload)
      showAlert('Coach data refreshed!', 'success');
    }
  })
  .catch(error => {
    showAlert('Error refreshing coach data', 'danger');
    console.error('Error:', error);
  });
}

// Refresh equipment data
function refreshEquipmentData() {
  fetch('/admin/api/reports/equipment-usage', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      equipmentChart.data.labels = data.equipment_labels || [];
      equipmentChart.data.datasets[0].data = data.equipment_usage_data || [];
      equipmentChart.update();
      // Update equipment usage list (assuming handled by Jinja reload)
      showAlert('Equipment data updated!', 'info');
    }
  })
  .catch(error => {
    showAlert('Error updating equipment data', 'danger');
    console.error('Error:', error);
  });
}

// Change timeline view
function changeTimelineView(period) {
  fetch(`/admin/api/reports/activity-timeline?period=${period}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      activityChart.data.labels = data.activity_labels || [];
      activityChart.data.datasets[0].data = data.activity_data || [];
      activityChart.update();
      showAlert(`Timeline updated to ${period}`, 'success');
    }
  })
  .catch(error => {
    showAlert('Error updating timeline', 'danger');
    console.error('Error:', error);
  });
}

// Reset filters
function resetFilters() {
  document.getElementById('dateRange').value = '30';
  document.getElementById('reportType').value = 'overview';
  document.getElementById('groupBy').value = 'week';
  document.getElementById('compareWith').value = 'none';
  updateCharts();
  showAlert('Filters reset', 'info');
}

// Export report
function exportReport() {
  const dateRange = document.getElementById('dateRange').value;
  const reportType = document.getElementById('reportType').value;
  window.location.href = `/admin/api/reports/export?type=${reportType}&range=${dateRange}`;
  showAlert('Export started, check downloads', 'success');
}

// Export table data
function exportTableData(format) {
  window.location.href = `/admin/api/reports/export-table?format=${format}`;
  showAlert(`Exporting to ${format.toUpperCase()}`, 'success');
}

// Generate custom report
function generateCustomReport() {
  $('#customReportModal').modal('show');
}

// Schedule report
function scheduleReport() {
  // Placeholder for scheduling logic
  showAlert('Scheduling feature coming soon!', 'warning');
}

// Share report
function shareReport() {
  // Placeholder for sharing logic
  showAlert('Sharing feature coming soon!', 'warning');
}

// Print report
function printReport() {
  window.print();
  showAlert('Printing report...', 'info');
}

// Generate report from modal
function generateReport() {
  const reportName = document.getElementById('reportName').value;
  const reportFormat = document.getElementById('reportFormat').value;
  const dateFrom = document.getElementById('customDateFrom').value;
  const dateTo = document.getElementById('customDateTo').value;
  const includeMemberStats = document.getElementById('includeMemberStats').checked;
  const includeRevenue = document.getElementById('includeRevenue').checked;
  const includeCoachPerf = document.getElementById('includeCoachPerf').checked;
  const includeEquipment = document.getElementById('includeEquipment').checked;
  const includeActivity = document.getElementById('includeActivity').checked;
  const includeGoals = document.getElementById('includeGoals').checked;

  fetch('/admin/api/reports/custom', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: reportName,
      format: reportFormat,
      date_from: dateFrom,
      date_to: dateTo,
      include: {
        member_stats: includeMemberStats,
        revenue: includeRevenue,
        coach_perf: includeCoachPerf,
        equipment: includeEquipment,
        activity: includeActivity,
        goals: includeGoals
      }
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('Custom report generated, check downloads', 'success');
      $('#customReportModal').modal('hide');
    }
  })
  .catch(error => {
    showAlert('Error generating custom report', 'danger');
    console.error('Error:', error);
  });
}

// Helper function to show alerts
function showAlert(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.role = 'alert';
  alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  document.body.appendChild(alertDiv);
  setTimeout(() => alertDiv.remove(), 3000);
}

// Realtime data update (placeholder)
function loadRealtimeData() {
  setInterval(() => {
    updateCharts();
  }, 300000); // Update every 5 minutes
}

// Setup event listeners
function setupEventListeners() {
  document.querySelectorAll('select, button').forEach(el => {
    el.addEventListener('change', updateCharts);
  });
}
</script>
{% endblock %}