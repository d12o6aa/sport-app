{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Reports & Analytics</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Reports</li>
    </ol>
  </nav>
</div>

<section class="section dashboard">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Date Range</label>
              <select id="dateRange" class="form-select" onchange="updateReports()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 3 Months</option>
                <option value="365">Last Year</option>
                
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Report Type</label>
              <select id="reportType" class="form-select" onchange="updateReports()">
                <option value="overview" selected>Overview</option>
                <option value="members">Members</option>
                <option value="performance">Performance</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Export Format</label>
              <select id="exportFormat" class="form-select">
                <option value="pdf">PDF Report</option>
                <option value="excel">Excel</option>
                <option value="csv">CSV</option>
              </select>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" onclick="exportReport()">
                <i class="bi bi-download"></i> Export Report
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row" id="statsCardsContainer">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card members-card">
        <div class="card-body">
          <h5 class="card-title">Total Members <span id="membersChange" class="text-success">| 0%</span></h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-people"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalMembers">0</h6>
              <span class="text-success small pt-1 fw-bold">
                <span id="newMembers">+0</span> new
              </span>
              <span class="text-muted small pt-2 ps-1">this month</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card progress-card">
        <div class="card-body">
          <h5 class="card-title">Avg Progress</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-graph-up"></i>
            </div>
            <div class="ps-3">
              <h6 id="avgProgress">0.0%</h6>
              <span class="text-info small pt-1 fw-bold">improvement</span>
              <span class="text-muted small pt-2 ps-1">vs last month</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card workouts-card">
        <div class="card-body">
          <h5 class="card-title">Active Plans</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-clipboard-check"></i>
            </div>
            <div class="ps-3">
              <h6 id="activePlans">0</h6>
              <span class="text-warning small pt-1 fw-bold">
                <span id="completedWorkouts">0</span> completed
              </span>
              <span class="text-muted small pt-2 ps-1">this week</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card equipment-card">
        <div class="card-body">
          <h5 class="card-title">Equipment <span class="text-info">| <span id="availableEquipment">0</span> available</span></h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-bicycle"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalEquipment">0</h6>
              <span class="text-danger small pt-1 fw-bold">
                <span id="maintenanceEquipment">0</span> in maintenance
              </span>
              <span class="text-muted small pt-2 ps-1">total equipment</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12" id="coachTableContainer">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Coach Performance Rankings</h5>
          <div class="coaches-performance" style="max-height: 400px; overflow-y: auto;">
            <div id="coachesList">
              </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-12" id="memberTableContainer">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Member Activity Analysis</h5>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary active" onclick="filterActivity('all')">All</button>
              <button class="btn btn-outline-primary" onclick="filterActivity('active')">Active</button>
              <button class="btn btn-outline-primary" onclick="filterActivity('inactive')">Inactive</button>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-borderless datatable" id="memberActivityTable">
              <thead>
                <tr>
                  <th>Member</th>
                  <th>Workouts</th>
                  <th>Progress</th>
                  <th>Last Active</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="memberActivityBody">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Global variables
let currentDateRange = 30;
let currentReportType = 'overview';
let allMembersData = [];

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
    updateReports();
});

// Update reports based on filters
function updateReports() {
    const dateRange = document.getElementById('dateRange').value;
    const reportType = document.getElementById('reportType').value;
    
    currentDateRange = dateRange;
    currentReportType = reportType;
    
    const statsCardsContainer = document.getElementById('statsCardsContainer');
    const coachTableContainer = document.getElementById('coachTableContainer');
    const memberTableContainer = document.getElementById('memberTableContainer');

    // Hide all sections first
    statsCardsContainer.style.display = 'none';
    coachTableContainer.style.display = 'none';
    memberTableContainer.style.display = 'none';
    
    // Show sections based on report type
    if (reportType === 'overview') {
        statsCardsContainer.style.display = 'flex';
        coachTableContainer.style.display = 'block';
        memberTableContainer.style.display = 'block';
        fetchStats(dateRange);
        fetchMemberActivity();
    } else if (reportType === 'members') {
        memberTableContainer.style.display = 'block';
        fetchMemberActivity();
    } else if (reportType === 'performance') {
        coachTableContainer.style.display = 'block';
        fetchCoachesPerformance(dateRange);
    }
}

// Fetch main statistics dynamically
async function fetchStats(days) {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/admin/api/reports/stats?days=${days}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('totalMembers').textContent = stats.total_members;
            document.getElementById('newMembers').textContent = `+${stats.new_members}`;
            document.getElementById('membersChange').textContent = `| ${stats.member_change.toFixed(0)}%`;
            document.getElementById('avgProgress').textContent = `${stats.avg_progress.toFixed(1)}%`;
            document.getElementById('activePlans').textContent = stats.active_plans;
            document.getElementById('completedWorkouts').textContent = stats.completed_workouts;
            document.getElementById('totalEquipment').textContent = stats.equipment_stats.total;
            document.getElementById('availableEquipment').textContent = stats.equipment_stats.available;
            document.getElementById('maintenanceEquipment').textContent = stats.equipment_stats.maintenance;
        }
    } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        showAlert('Failed to load dashboard data. Please try again.', 'danger');
    }
}

// Fetch member activity data dynamically
async function fetchMemberActivity() {
    const tbody = document.getElementById('memberActivityBody');
    if (!tbody) return;
  
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/admin/api/reports/member-activity', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
    
        const data = await response.json();
    
        if (data.success) {
            allMembersData = data.members;
            renderMemberActivityTable(allMembersData);
        }
    } catch (error) {
        console.error('Error fetching member activity:', error);
        showAlert('Failed to load member activity data.', 'danger');
    }
}

// Render member activity table from global data
function renderMemberActivityTable(members) {
    const tbody = document.getElementById('memberActivityBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    members.forEach(member => {
        const row = `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="member-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                  ${member.name.split(' ').map(n => n[0]).join('')}
                </div>
                ${member.name}
              </div>
            </td>
            <td><span class="badge bg-info">${member.workouts}</span></td>
            <td>
              <div class="progress" style="height: 8px; width: 80px;">
                <div class="progress-bar bg-success" style="width: ${member.progress}%"></div>
              </div>
              <small class="text-muted">${member.progress}%</small>
            </td>
            <td><small class="text-muted">${member.last_active}</small></td>
            <td>
              <span class="badge bg-${member.status === 'active' ? 'success' : 'warning'}">
                ${member.status.charAt(0).toUpperCase() + member.status.slice(1)}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewMember('${member.name}')"><i class="bi bi-eye"></i></button>
                <button class="btn btn-outline-info" onclick="contactMember('${member.name}')"><i class="bi bi-envelope"></i></button>
              </div>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// Filter member activity table based on status
function filterActivity(status) {
    document.querySelectorAll('.btn-group-sm .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    let filteredData = [];
    if (status === 'all') {
        filteredData = allMembersData;
    } else {
        filteredData = allMembersData.filter(member => member.status === status);
    }
    renderMemberActivityTable(filteredData);
}

// Fetch coaches performance data
async function fetchCoachesPerformance(days) {
    const coachesList = document.getElementById('coachesList');
    if (!coachesList) return;
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/admin/api/reports/coaches-performance?days=${days}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            coachesList.innerHTML = '';
            data.coaches_performance.forEach((coach, index) => {
                const item = `
                    <div class="coach-performance-item d-flex align-items-center p-3 mb-2 bg-light rounded">
                      <div class="rank-badge me-3">
                        <span class="badge bg-primary rounded-pill">#${index + 1}</span>
                      </div>
                      <div class="coach-avatar me-3">
                        <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                          <i class="bi bi-person"></i>
                        </div>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-1">Coach ${coach.coach_name}</h6>
                        <div class="progress" style="height: 6px;">
                          <div class="progress-bar bg-success" style="width: ${coach.avg_progress || 0}%"></div>
                        </div>
                        <small class="text-muted">${coach.avg_progress.toFixed(1) || 0}% avg progress</small>
                      </div>
                      <div class="performance-score">
                        <span class="badge bg-success">${coach.avg_progress.toFixed(0) || 0}%</span>
                      </div>
                    </div>
                `;
                coachesList.insertAdjacentHTML('beforeend', item);
            });
        } else {
             showAlert(data.error || 'Failed to load coaches performance', 'danger');
        }
    } catch (error) {
        console.error('Error fetching coaches performance:', error);
        showAlert('Failed to load coaches performance data.', 'danger');
    }
}


// Export function to call the backend API
function exportReport() {
    const format = document.getElementById('exportFormat').value;
    const dateRange = document.getElementById('dateRange').value;
    const reportType = document.getElementById('reportType').value;
    const token = localStorage.getItem('access_token');

    showAlert(`Exporting report as ${format.toUpperCase()}...`, 'info');

    fetch('/admin/api/reports/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            format: format,
            report_type: reportType,
            date_range: dateRange
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error || 'Network response was not ok');
            });
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gym_report_${new Date().toISOString().slice(0,10)}.${format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        showAlert(`Report exported successfully as ${format.toUpperCase()}!`, 'success');
    })
    .catch(error => {
        console.error('Export failed:', error);
        showAlert(`Export failed: ${error.message}`, 'danger');
    });
}

function viewMember(name) {
  showAlert(`Opening profile for ${name}`, 'info');
}

function contactMember(name) {
  showAlert(`Opening message composer for ${name}`, 'info');
}

function showAlert(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = 'position-fixed top-0 end-0 p-3';
  alertContainer.style.zIndex = '9999';
  
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type} alert-dismissible fade show`;
  alertElement.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  alertContainer.appendChild(alertElement);
  document.body.appendChild(alertContainer);
  
  setTimeout(() => {
    if (alertContainer && alertContainer.parentNode) {
      alertContainer.parentNode.removeChild(alertContainer);
    }
  }, 4000);
}
</script>

<style>
/* Nice Admin Compatible Styles */
.members-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
.progress-card .card-icon { background: linear-gradient(90deg, #17a2b8, #20c997); }
.workouts-card .card-icon { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.equipment-card .card-icon { background: linear-gradient(90deg, #6c757d, #343a40); }

.coach-performance-item:hover {
  background-color: #f1f3ff !important;
  transform: translateX(5px);
  transition: all 0.3s ease;
}

.insight-item {
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #4154f1;
}

.alerts-container .alert {
  border-left: 4px solid;
  border-radius: 0.375rem;
}

.member-avatar {
  font-weight: 600;
}

.stat-item {
  padding: 0.5rem;
}

.table th {
  font-weight: 600;
  color: #4154f1;
  border-bottom: 2px solid #eee;
}

.btn-group-sm .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}
</style>
{% endblock %}