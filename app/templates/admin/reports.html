{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Reports & Analytics</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Reports</li>
    </ol>
  </nav>
</div>

<section class="section dashboard">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Date Range</label>
              <select id="dateRange" class="form-select" onchange="updateReports()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 3 Months</option>
                <option value="365">Last Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Report Type</label>
              <select id="reportType" class="form-select" onchange="updateReports()">
                <option value="overview" selected>Overview</option>
                <option value="members">Members</option>
                <option value="performance">Performance</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Export Format</label>
              <select id="exportFormat" class="form-select">
                <option value="pdf">PDF Report</option>
                <option value="excel">Excel</option>
                <option value="csv">CSV</option>
              </select>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" onclick="exportReport()">
                <i class="bi bi-download"></i> Export Report
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card members-card">
        <div class="card-body">
          <h5 class="card-title">Total Members <span id="membersChange" class="text-success">| {{ "%.0f"|format(stats.member_change) }}%</span></h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-people"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalMembers">{{ stats.total_members or 0 }}</h6>
              <span class="text-success small pt-1 fw-bold">
                <span id="newMembers">+{{ stats.new_members or 0 }}</span> new
              </span>
              <span class="text-muted small pt-2 ps-1">this month</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card progress-card">
        <div class="card-body">
          <h5 class="card-title">Avg Progress</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-graph-up"></i>
            </div>
            <div class="ps-3">
              <h6 id="avgProgress">{{ "%.1f"|format(stats.avg_progress or 0) }}%</h6>
              <span class="text-info small pt-1 fw-bold">improvement</span>
              <span class="text-muted small pt-2 ps-1">vs last month</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card workouts-card">
        <div class="card-body">
          <h5 class="card-title">Active Plans</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-clipboard-check"></i>
            </div>
            <div class="ps-3">
              <h6 id="activePlans">{{ stats.active_plans or 0 }}</h6>
              <span class="text-warning small pt-1 fw-bold">
                <span id="completedWorkouts">{{ stats.completed_workouts or 0 }}</span> completed
              </span>
              <span class="text-muted small pt-2 ps-1">this week</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card equipment-card">
        <div class="card-body">
          <h5 class="card-title">Equipment <span class="text-info">| {{ stats.equipment_stats.available or 0 }} available</span></h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-bicycle"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalEquipment">{{ stats.equipment_stats.total or 0 }}</h6>
              <span class="text-danger small pt-1 fw-bold">
                <span id="maintenanceEquipment">{{ stats.equipment_stats.maintenance or 0 }}</span> in maintenance
              </span>
              <span class="text-muted small pt-2 ps-1">total equipment</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6" id="coachTableContainer">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Coach Performance Rankings</h5>
          <div class="coaches-performance" style="max-height: 400px; overflow-y: auto;">
            {% for perf in coaches_performance %}
            <div class="coach-performance-item d-flex align-items-center p-3 mb-2 bg-light rounded">
              <div class="rank-badge me-3">
                <span class="badge bg-primary rounded-pill">#{{ loop.index }}</span>
              </div>
              <div class="coach-avatar me-3">
                <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                  <i class="bi bi-person"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">Coach {{ perf.coach_name }}</h6>
                <div class="progress" style="height: 6px;">
                  <div class="progress-bar bg-success" style="width: {{ perf.avg_progress or 0 }}%"></div>
                </div>
                <small class="text-muted">{{ "%.1f"|format(perf.avg_progress or 0) }}% avg progress</small>
              </div>
              <div class="performance-score">
                <span class="badge bg-success">{{ "%.0f"|format(perf.avg_progress or 0) }}%</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6" id="memberTableContainer">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">Member Activity Analysis</h5>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary active" onclick="filterActivity('all')">All</button>
              <button class="btn btn-outline-primary" onclick="filterActivity('active')">Active</button>
              <button class="btn btn-outline-primary" onclick="filterActivity('inactive')">Inactive</button>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-borderless datatable" id="memberActivityTable">
              <thead>
                <tr>
                  <th>Member</th>
                  <th>Workouts</th>
                  <th>Progress</th>
                  <th>Last Active</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="memberActivityBody">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">System Alerts & Recommendations</h5>
          
          <div class="alerts-container">
            <div class="alert alert-warning d-flex align-items-center" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <div>
                <strong>Low Equipment Usage:</strong> Treadmill #3 has only 15% utilization this week. Consider maintenance or relocation.
              </div>
              <button type="button" class="btn btn-sm btn-outline-warning ms-auto">Review</button>
            </div>

            <div class="alert alert-info d-flex align-items-center" role="alert">
              <i class="bi bi-info-circle me-2"></i>
              <div>
                <strong>High Demand Period:</strong> 6-8 PM shows consistent high usage. Consider extending hours or adding equipment.
              </div>
              <button type="button" class="btn btn-sm btn-outline-info ms-auto">Plan</button>
            </div>

            <div class="alert alert-success d-flex align-items-center" role="alert">
              <i class="bi bi-check-circle me-2"></i>
              <div>
                <strong>Revenue Growth:</strong> Monthly revenue increased by 18% compared to last month. Great job!
              </div>
              <button type="button" class="btn btn-sm btn-outline-success ms-auto">Details</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Global variables
let currentDateRange = 30;
let currentReportType = 'overview';

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
  updateReports();
});

// Update reports based on filters
function updateReports() {
    const dateRange = document.getElementById('dateRange').value;
    const reportType = document.getElementById('reportType').value;
    
    currentDateRange = dateRange;
    currentReportType = reportType;
    
    const coachTableContainer = document.getElementById('coachTableContainer');
    const memberTableContainer = document.getElementById('memberTableContainer');
    
    // Conditionally hide/show the containers
    coachTableContainer.style.display = 'none';
    memberTableContainer.style.display = 'none';
    
    if (reportType === 'members') {
        memberTableContainer.style.display = 'block';
        // Add a small delay to ensure the DOM has updated
        setTimeout(fetchMemberActivity, 50);
    } else if (reportType === 'performance') {
        coachTableContainer.style.display = 'block';
    } else { // 'overview'
        coachTableContainer.style.display = 'block';
        memberTableContainer.style.display = 'block';
        // Add a small delay for the same reason
        setTimeout(fetchMemberActivity, 50);
    }
}


// Fetch member activity data dynamically
async function fetchMemberActivity() {
  const tbody = document.getElementById('memberActivityBody');
  // ✅ The error is here. The element is not available when the function is called
  //    under certain conditions. The `if` check below handles this gracefully.
  if (!tbody) {
    console.error("Element with ID 'memberActivityBody' was not found. Skipping data fetch.");
    return;
  }
  
  try {
    const token = localStorage.getItem('access_token');
    const response = await fetch('/admin/api/reports/member-activity', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      tbody.innerHTML = ''; // Clear existing data
      data.members.forEach(member => {
        const row = `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="member-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                  ${member.name.split(' ').map(n => n[0]).join('')}
                </div>
                ${member.name}
              </div>
            </td>
            <td><span class="badge bg-info">${member.workouts}</span></td>
            <td>
              <div class="progress" style="height: 8px; width: 80px;">
                <div class="progress-bar bg-success" style="width: ${member.progress}%"></div>
              </div>
              <small class="text-muted">${member.progress}%</small>
            </td>
            <td><small class="text-muted">${member.last_active}</small></td>
            <td>
              <span class="badge bg-${member.status === 'active' ? 'success' : 'warning'}">
                ${member.status.charAt(0).toUpperCase() + member.status.slice(1)}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewMember('${member.name}')"><i class="bi bi-eye"></i></button>
                <button class="btn btn-outline-info" onclick="contactMember('${member.name}')"><i class="bi bi-envelope"></i></button>
              </div>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }
  } catch (error) {
    console.error('Error fetching member activity:', error);
    showAlert('Failed to load member activity data.', 'danger');
  }
}

// Export function to call the backend API
function exportReport() {
    const format = document.getElementById('exportFormat').value;
    const dateRange = document.getElementById('dateRange').value;
    const reportType = document.getElementById('reportType').value;
    const token = localStorage.getItem('access_token');

    showAlert(`Exporting report as ${format.toUpperCase()}...`, 'info');

    fetch('/admin/api/reports/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            format: format,
            report_type: reportType,
            date_range: dateRange
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gym_report_${new Date().toISOString().slice(0,10)}.${format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        showAlert(`Report exported successfully as ${format.toUpperCase()}!`, 'success');
    })
    .catch(error => {
        console.error('Export failed:', error);
        showAlert(`Export failed: ${error.message}`, 'danger');
    });
}

function filterActivity(status) {
  event.target.parentElement.querySelectorAll('.btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  const rows = document.querySelectorAll('#memberActivityBody tr');
  rows.forEach(row => {
    if (status === 'all') {
      row.style.display = '';
    } else {
      const statusCell = row.querySelector('td:nth-child(5) .badge');
      const memberStatus = statusCell.textContent.toLowerCase();
      row.style.display = memberStatus === status ? '' : 'none';
    }
  });
}

function viewMember(name) {
  showAlert(`Opening profile for ${name}`, 'info');
}

function contactMember(name) {
  showAlert(`Opening message composer for ${name}`, 'info');
}

function showAlert(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = 'position-fixed top-0 end-0 p-3';
  alertContainer.style.zIndex = '9999';
  
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type} alert-dismissible fade show`;
  alertElement.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  alertContainer.appendChild(alertElement);
  document.body.appendChild(alertContainer);
  
  setTimeout(() => {
    if (alertContainer && alertContainer.parentNode) {
      alertContainer.parentNode.removeChild(alertContainer);
    }
  }, 4000);
}
</script>

<style>
/* Nice Admin Compatible Styles */
.members-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
.progress-card .card-icon { background: linear-gradient(90deg, #17a2b8, #20c997); }
.workouts-card .card-icon { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.equipment-card .card-icon { background: linear-gradient(90deg, #6c757d, #343a40); }

.coach-performance-item:hover {
  background-color: #f1f3ff !important;
  transform: translateX(5px);
  transition: all 0.3s ease;
}

.insight-item {
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #4154f1;
}

.alerts-container .alert {
  border-left: 4px solid;
  border-radius: 0.375rem;
}

.member-avatar {
  font-weight: 600;
}

.stat-item {
  padding: 0.5rem;
}

.table th {
  font-weight: 600;
  color: #4154f1;
  border-bottom: 2px solid #eee;
}

.btn-group-sm .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}
</style>
{% endblock %}