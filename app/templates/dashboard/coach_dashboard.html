{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Coach Dashboard</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Coach Dashboard</li>
    </ol>
  </nav>
</div>

<section class="section dashboard">
  <div class="row">

    <!-- Total Athletes Card -->
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card athletes-card">
        <div class="card-body">
          <h5 class="card-title">Total Athletes</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-people"></i>
            </div>
            <div class="ps-3">
              <h6>{{ total_athletes }}</h6>
              <span class="text-success small pt-1 fw-bold">{{ active_athletes }} active</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Avg. Readiness Card -->
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card readiness-card">
        <div class="card-body">
          <h5 class="card-title">Avg. Readiness</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="ps-3">
              <h6>
                {% if avg_readiness == "N/A" %}
                  N/A
                {% else %}
                  {{ avg_readiness }}%
                {% endif %}
              </h6>
              <span class="text-info small pt-1">Team average</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Workouts Card -->
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card risk-card">
        <div class="card-body">
          <h5 class="card-title">Total Workouts</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-person-walking"></i>
            </div>
            <div class="ps-3">
              <h6>{{ total_workouts }}</h6>
              <span class="text-primary small pt-1 fw-bold">All-time logs</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Training Plans Card -->
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card alerts-card">
        <div class="card-body">
          <h5 class="card-title">Training Plans</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-calendar-check"></i>
            </div>
            <div class="ps-3">
              <h6>{{ total_plans }}</h6>
              <span class="text-info small pt-1 fw-bold">Total plans created</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Athletes Needing Attention -->
    <div class="col-12">
      <div class="card">
        <div class="card-body pb-0">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="card-title mb-0">Athletes Needing Attention</h5>
              <p class="small fst-italic text-muted mb-0">Players with low readiness or high injury risk</p>
            </div>
            <span class="badge bg-danger rounded-pill">{{ attention_needed_athletes|length }}</span>
          </div>
          
          {% if attention_needed_athletes|length > 0 %}
          <div class="list-group list-group-flush">
            {% for athlete in attention_needed_athletes %}
            <a href="{{ url_for('coach.manage_athletes') }}#athlete-{{ athlete.id }}" 
               class="list-group-item list-group-item-action border-0 px-0">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="bi bi-person-circle fs-2 text-primary"></i>
                  </div>
                  <div>
                    <h6 class="mb-1">{{ athlete.name }}</h6>
                    <div class="d-flex gap-2">
                      <small class="text-muted">
                        Readiness: 
                        {% if athlete.readiness_score != "No Data" and athlete.readiness_score != "N/A" %}
                          <span class="badge bg-{{ 'danger' if athlete.readiness_score < 50 else 'warning' if athlete.readiness_score < 80 else 'success' }}">
                            {{ athlete.readiness_score }}%
                          </span>
                        {% else %}
                          <span class="badge bg-secondary">No Data</span>
                        {% endif %}
                      </small>
                      <small class="text-muted">
                        Injury Risk: 
                        {% if athlete.injury_risk != "No Data" %}
                          <span class="badge bg-{{ 'danger' if athlete.injury_risk == 'High' else 'warning' if athlete.injury_risk == 'Medium' else 'success' }}">
                            {{ athlete.injury_risk }}
                          </span>
                        {% else %}
                          <span class="badge bg-secondary">No Data</span>
                        {% endif %}
                      </small>
                    </div>
                  </div>
                </div>
                <i class="bi bi-arrow-right-circle fs-5"></i>
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-check-circle display-1 text-success"></i>
            <h5 class="mt-3">All Clear!</h5>
            <p class="text-muted">All athletes are in good standing</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Recent Activity <span class="text-muted fw-normal">| Last 7 days</span></h5>
          
          <div class="activity">
            {% if recent_activities and recent_activities|length > 0 %}
              {% for activity in recent_activities %}
              <div class="activity-item d-flex">
                <div class="activite-label">{{ activity.time_ago }}</div>
                <i class='bi bi-circle-fill activity-badge text-{{ activity.type }} align-self-start'></i>
                <div class="activity-content">
                  {{ activity.message }}
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="text-center text-muted py-4">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-2">No recent activity</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions & Team Performance -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Quick Actions</h5>
          
          <div class="d-grid gap-2">
            <a href="{{ url_for('coach.manage_athletes') }}" class="btn btn-primary">
              <i class="bi bi-people me-2"></i>Manage Athletes
            </a>
            <a href="{{ url_for('coach.training_plans_management') }}" class="btn btn-outline-primary">
              <i class="bi bi-calendar-plus me-2"></i>Create Training Plan
            </a>
            <a href="{{ url_for('coach.workout_management') }}" class="btn btn-outline-primary">
              <i class="bi bi-graph-up me-2"></i>Create Workouts
            </a>
          </div>

          <hr class="my-4">

          <h6 class="mb-3">Team Performance</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Workout Completion</span>
              <span class="small fw-bold">{{ team_completion_rate|default(0) }}%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: {{ team_completion_rate|default(0) }}%"></div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Team Readiness</span>
              <span class="small fw-bold">{{ avg_readiness if avg_readiness != "N/A" else "0" }}%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-info" role="progressbar" 
                   style="width: {{ avg_readiness if avg_readiness != 'N/A' else '0' }}%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Auto-refresh dashboard every 5 minutes
setTimeout(function() {
  location.reload();
}, 300000);

// Add smooth scroll to athlete links
document.querySelectorAll('a[href^="#athlete-"]').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const targetId = this.getAttribute('href').substring(1);
    window.location.href = "{{ url_for('coach.manage_athletes') }}" + '#' + targetId;
  });
});
</script>
{% endblock %}