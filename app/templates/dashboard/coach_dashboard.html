{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Coach Dashboard</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Coach Dashboard</li>
    </ol>
  </nav>
</div><!-- End Page Title -->

<section class="section dashboard">
  <div class="row">

    <!-- Filters Bar -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Filters</h5>
          <form id="filtersForm" class="row g-3 align-items-center">
            <div class="col-md-5">
              <label for="athleteSelect" class="form-label">Select Athlete</label>
              <select id="athleteSelect" class="form-select"></select>
            </div>
            <div class="col-md-5">
              <label for="dateRange" class="form-label">Time Range</label>
              <select id="dateRange" class="form-select">
                <option value="week">Last Week</option>
                <option value="month" selected>Last Month</option>
                <option value="3months">Last 3 Months</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">Apply</button>
            </div>
          </form>
        </div>
      </div>
    </div><!-- End Filters Bar -->

    <!-- Left side columns -->
    <div class="col-lg-8">
      <div class="row">

        <!-- Quick Stats Cards -->
        <div class="col-xxl-3 col-md-6">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">Workouts <span>| Selected Period</span></h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-activity"></i>
                </div>
                <div class="ps-3">
                  <h6 id="workoutsCount">-</h6>
                  <span class="text-muted small pt-1">Total Sessions</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xxl-3 col-md-6">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">Compliance <span>| %</span></h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-check2-circle"></i>
                </div>
                <div class="ps-3">
                  <h6 id="complianceRate">-</h6>
                  <span id="complianceLabel" class="text-muted small pt-1">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xxl-3 col-md-6">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">Readiness <span>| Avg</span></h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                  <i class="bi bi-heart-pulse"></i>
                </div>
                <div class="ps-3">
                  <h6 id="avgReadiness">-</h6>
                  <span class="text-muted small pt-1">Avg. Score</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-xxl-3 col-md-6">
          <div class="card info-card">
            <div class="card-body">
              <h5 class="card-title">Injury Risk</h5>
              <div class="d-flex align-items-center">
                <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-danger">
                  <i class="bi bi-exclamation-triangle text-white"></i>
                </div>
                <div class="ps-3">
                  <h6 id="injuryAlerts">-</h6>
                  <span class="text-danger small pt-1 fw-bold">High Risk Alerts</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End Quick Stats Cards -->

        <!-- Progress Monitoring: Graphs -->
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Performance & Readiness Analytics</h5>
              <canvas id="performanceChart" style="max-height: 400px;"></canvas>
            </div>
          </div>
        </div>

        <!-- History Table (Workout Logs) -->
        <div class="col-12">
          <div class="card recent-sales overflow-auto">
            <div class="card-body">
              <h5 class="card-title">Workout Logs</h5>
              <table id="logsTable" class="table table-borderless datatable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Session Type</th>
                    <th>Duration</th>
                    <th>Key Metric</th>
                    <th>Status</th>
                    <th>Feedback</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div><!-- End History Table -->

      </div>
    </div><!-- End Left side columns -->

    <!-- Right side columns -->
    <div class="col-lg-4">

      <!-- Workout Plans Section (Calendar View) -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Workout Plans & Calendar</h5>
          <div id="calendar-placeholder" class="text-center">
            <p class="text-muted"><i>[Interactive Calendar View]</i></p>
          </div>
          <div class="d-grid gap-2 mt-3">
            <button onclick="createPlan()" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Create New Plan</button>
            <button onclick="duplicatePlan()" class="btn btn-secondary"><i class="bi bi-files"></i> Duplicate Plan</button>
          </div>
        </div>
      </div><!-- End Calendar Card -->

      <!-- Interaction / Feedback Section -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Recent Activity & Feedback</h5>
          <div id="activityFeed" class="activity"></div>
        </div>
      </div><!-- End Feedback Section -->

    </div><!-- End Right side columns -->

  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let chart;

document.addEventListener("DOMContentLoaded", () => {
  loadAthletes();

  document.getElementById("filtersForm").addEventListener("submit", e => {
    e.preventDefault();
    loadDashboardData();
  });
});

function loadAthletes() {
  fetch("/coach/athletes", { headers: authHeader() })
    .then(r => r.json())
    .then(data => {
      const select = document.getElementById("athleteSelect");
      select.innerHTML = "";
      data.forEach(a => {
        select.innerHTML += `<option value="${a.id}">${a.name}</option>`;
      });
    });
}

function loadDashboardData() {
  const athleteId = document.getElementById("athleteSelect").value;
  const range = document.getElementById("dateRange").value;

  fetch(`/coach/athlete/${athleteId}/progress?range=${range}`, { headers: authHeader() })
    .then(r => r.json())
    .then(data => {
      // Stats
      document.getElementById("workoutsCount").textContent = data.total_sessions;
      document.getElementById("complianceRate").textContent = data.compliance + "%";
      document.getElementById("complianceLabel").textContent = data.compliance_label;
      document.getElementById("avgReadiness").textContent = data.avg_readiness + "/10";
      document.getElementById("injuryAlerts").textContent = data.injury_alerts;

      // Chart
      updateChart(data.performance_labels, data.performance_values, data.readiness_values);

      // Logs
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";
      data.logs.forEach(log => {
        tbody.innerHTML += `
          <tr>
            <td>${log.date}</td>
            <td>${log.session_type}</td>
            <td>${log.duration}</td>
            <td>${log.metric}</td>
            <td><span class="badge bg-${log.status_color}">${log.status}</span></td>
            <td><a href="#">${log.feedback_action}</a></td>
          </tr>`;
      });

      // Activity
      const feed = document.getElementById("activityFeed");
      feed.innerHTML = "";
      data.activities.forEach(act => {
        feed.innerHTML += `
          <div class="activity-item d-flex">
            <div class="activite-label">${act.time}</div>
            <i class='bi bi-circle-fill activity-badge text-${act.color} align-self-start'></i>
            <div class="activity-content">${act.text}</div>
          </div>`;
      });
    });
}

function updateChart(labels, perf, readiness) {
  if (chart) chart.destroy();
  chart = new Chart(document.querySelector('#performanceChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Performance', data: perf, borderColor: 'rgb(75, 192, 192)', fill: true },
        { label: 'Readiness Score', data: readiness, borderColor: 'rgb(255, 99, 132)', fill: true }
      ]
    }
  });
}

function authHeader() {
  return { "Authorization": "Bearer " + localStorage.getItem("access_token") };
}

function createPlan() {
  alert("TODO: Call POST /coach/athlete/:id/plans");
}
function duplicatePlan() {
  alert("TODO: Call Duplicate Plan API");
}
</script>
{% endblock %}
