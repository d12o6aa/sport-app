{% extends "shared/base.html" %}

{% block content %}
<section class="section dashboard">
  <div class="row g-3">
    <!-- Summary Cards -->
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card sales-card"><div class="card-body">
        <h5 class="card-title">Active Goals</h5>
        <div class="d-flex align-items-center">
          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-bullseye"></i>
          </div>
          <div class="ps-3">
            <h6 id="dashGoals">0</h6>
            <span class="text-muted small">In progress</span>
          </div>
        </div>
      </div></div>
    </div>
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card revenue-card"><div class="card-body">
        <h5 class="card-title">Assigned Plans</h5>
        <div class="d-flex align-items-center">
          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-journal-check"></i>
          </div>
          <div class="ps-3">
            <h6 id="dashPlans">0</h6>
            <span class="text-muted small">Active</span>
          </div>
        </div>
      </div></div>
    </div>
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card customers-card"><div class="card-body">
        <h5 class="card-title">This Week Workouts</h5>
        <div class="d-flex align-items-center">
          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-activity"></i>
          </div>
          <div class="ps-3">
            <h6 id="dashWorkouts">0</h6>
            <span class="text-muted small">Scheduled</span>
          </div>
        </div>
      </div></div>
    </div>
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card customers-card"><div class="card-body">
        <h5 class="card-title">Readiness Score</h5>
        <div class="d-flex align-items-center">
          <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
            <i class="bi bi-thermometer-half"></i>
          </div>
          <div class="ps-3">
            <h6 id="dashReadiness">--</h6>
            <span class="text-muted small">Today</span>
          </div>
        </div>
      </div></div>
    </div>

    <!-- Recent workouts & goals -->
    <div class="col-lg-7">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Recent Workouts</h6>
          <canvas id="workoutsChart" style="min-height: 300px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="card-title">Active Goals</h6>
          <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
            <canvas id="goalsChart" style="max-height: 250px;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function showAlert(message, type="info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}

// ---- Load Dashboard Data ----
async function loadDashboard() {
  try {
    const token = localStorage.getItem("access_token");

    const res = await fetch("/athlete/api/dashboard_data", {
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    
    // Check if the response is valid
    if (!res.ok) {
        throw new Error(data.msg || "Failed to load dashboard data.");
    }
    
    // Update summary cards
    document.getElementById("dashGoals").textContent = data.summary.active_goals ?? 0;
    document.getElementById("dashPlans").textContent = data.summary.assigned_plans ?? 0;
    document.getElementById("dashWorkouts").textContent = data.summary.week_workouts ?? 0;
    document.getElementById("dashReadiness").textContent = data.summary.readiness ?? "--";

    // Create workouts chart
    const workoutLabels = data.workouts.map(w => w.session_type + ' (' + new Date(w.date).toLocaleDateString() + ')');
    const workoutDurations = data.workouts.map(w => w.duration);
    
    new Chart(document.getElementById('workoutsChart'), {
        type: 'bar',
        data: {
            labels: workoutLabels,
            datasets: [{
                label: 'Duration (min)',
                data: workoutDurations,
                backgroundColor: ['#0d6efd', '#28a745', '#ffc107', '#dc3545', '#6c757d'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // Create goals chart
    const goalLabels = data.goals.map(g => g.title);
    const goalProgress = data.goals.map(g => g.progress);
    
    new Chart(document.getElementById('goalsChart'), {
        type: 'doughnut',
        data: {
            labels: goalLabels,
            datasets: [{
                data: goalProgress,
                backgroundColor: ['#0d6efd', '#28a745', '#ffc107', '#dc3545', '#6c757d'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

  } catch (err) {
    console.error(err);
    showAlert("Failed to load dashboard: " + err.message, "danger");
  }
}

// ---- Init ----
document.addEventListener("DOMContentLoaded", loadDashboard);
</script>
{% endblock %}
