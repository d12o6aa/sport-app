{% extends "shared/base.html" %}

{% block style %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
    --danger-gradient: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
    --glass-bg: rgba(255, 255, 255, 0.15);
    --glass-border: rgba(255, 255, 255, 0.2);
    --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.37);
    --shadow-hover: 0 15px 35px rgba(31, 38, 135, 0.4);
  }

  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }

  .glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--shadow-soft);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .glass-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
  }

  .chart-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 1.5rem;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
    height: 100%;
  }

  .chart-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  }

  .metric-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    transition: all 0.4s ease;
    position: relative;
    height: 100%;
  }

  .metric-value {
    font-size: 3rem;
    font-weight: 700;
    color: white;
    margin: 1rem 0;
  }

  .metric-label {
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .progress-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    position: relative;
    margin: 0 auto 1rem;
    background: conic-gradient(from 0deg, var(--color-start) 0deg, var(--color-end) var(--progress-angle), rgba(255,255,255,0.2) var(--progress-angle));
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .progress-circle::before {
    content: '';
    position: absolute;
    width: 90px;
    height: 90px;
    background: rgba(255,255,255,0.9);
    border-radius: 50%;
    backdrop-filter: blur(10px);
  }

  .progress-circle-text {
    position: relative;
    z-index: 2;
    font-weight: 700;
    font-size: 1.4rem;
    color: #333;
    text-align: center;
  }

  .chart-container {
    height: 300px;
    position: relative;
  }

  .chart-container.small {
    height: 200px;
  }

  .chart-container.large {
    height: 400px;
  }

  .header-section {
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid rgba(255,255,255,0.2);
  }

  .btn {
    border-radius: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-outline-secondary {
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    backdrop-filter: blur(10px);
  }

  .btn-outline-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
    transform: translateY(-2px);
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
  }

  .status-excellent {
    background: #4caf50;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
  }

  .status-good {
    background: #2196f3;
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
  }

  .status-warning {
    background: #ff9800;
    box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
  }

  .status-danger {
    background: #f44336;
    box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .slide-in {
    animation: slideIn 0.6s ease-out;
  }

  .text-white {
    color: white !important;
  }

  .text-white-50 {
    color: rgba(255, 255, 255, 0.5) !important;
  }

  h2, h3, h4, h5, h6 {
    color: white;
  }

  .loading-skeleton {
    background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
    height: 20px;
    margin: 0.5rem 0;
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .trend-up {
    color: #4caf50;
  }

  .trend-down {
    color: #f44336;
  }

  .trend-stable {
    color: #ff9800;
  }
</style>
{% endblock %}

{% block content %}
<section class="section dashboard">
  <!-- Header -->
  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="m-0 text-white fw-bold">Health Analytics</h2>
        <p class="text-white-50 mb-0">Data-driven insights</p>
      </div>
      <button id="refreshHealth" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-repeat me-1"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Main Metrics -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="metric-card slide-in">
        <div class="progress-circle" id="healthScoreCircle" style="--color-start: #4facfe; --color-end: #00f2fe; --progress-angle: 306deg;">
          <div class="progress-circle-text">
            <div id="overallScore">85</div>
            <small>Score</small>
          </div>
        </div>
        <div class="status-indicator status-excellent"></div>
        <span class="text-white">Overall Health</span>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="metric-card slide-in" style="animation-delay: 0.1s;">
        <div class="metric-value" id="restingHR">58</div>
        <div class="metric-label">Resting HR</div>
        <div class="status-indicator status-excellent"></div>
        <span class="text-white trend-down">
          <i class="bi bi-arrow-down"></i> -2 bpm
        </span>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card slide-in" style="animation-delay: 0.2s;">
        <div class="metric-value" id="sleepScore">8.2</div>
        <div class="metric-label">Sleep Quality</div>
        <div class="status-indicator status-good"></div>
        <span class="text-white trend-up">
          <i class="bi bi-arrow-up"></i> +0.3
        </span>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card slide-in" style="animation-delay: 0.3s;">
        <div class="metric-value" id="recoveryScore">92</div>
        <div class="metric-label">Recovery %</div>
        <div class="status-indicator status-excellent"></div>
        <span class="text-white trend-stable">
          <i class="bi bi-dash"></i> Stable
        </span>
      </div>
    </div>
  </div>

  <!-- Primary Charts -->
  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="chart-card slide-in">
        <h6 class="text-white fw-bold mb-3">Performance Prediction</h6>
        <div class="chart-container">
          <canvas id="predictionChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="chart-card slide-in" style="animation-delay: 0.1s;">
        <h6 class="text-white fw-bold mb-3">Risk Analysis</h6>
        <div class="chart-container small">
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Secondary Charts -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="chart-card slide-in">
        <h6 class="text-white fw-bold mb-3">Heart Rate Trend</h6>
        <div class="chart-container small">
          <canvas id="hrChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="chart-card slide-in" style="animation-delay: 0.1s;">
        <h6 class="text-white fw-bold mb-3">Sleep Pattern</h6>
        <div class="chart-container small">
          <canvas id="sleepChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="chart-card slide-in" style="animation-delay: 0.2s;">
        <h6 class="text-white fw-bold mb-3">HRV Analysis</h6>
        <div class="chart-container small">
          <canvas id="hrvChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Charts -->
  <div class="row g-4">
    <div class="col-md-6">
      <div class="chart-card slide-in">
        <h6 class="text-white fw-bold mb-3">Weekly Activity</h6>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="chart-card slide-in" style="animation-delay: 0.1s;">
        <h6 class="text-white fw-bold mb-3">Body Composition</h6>
        <div class="chart-container">
          <canvas id="bodyChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>

<script>
// Alert function
function alertShow(message, type = "info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrapper = document.createElement("div");
  const icon = type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle';
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-lg" role="alert" style="z-index:1055; border-radius: 15px; backdrop-filter: blur(10px);">
      <i class="bi bi-${icon} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}

let charts = {};
let healthData = {};

// Chart configurations
const chartConfig = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      display: true,
      labels: { color: 'white', font: { size: 11 } }
    },
    tooltip: {
      backgroundColor: 'rgba(0,0,0,0.8)',
      titleColor: 'white',
      bodyColor: 'white'
    }
  },
  scales: {
    y: {
      grid: { color: 'rgba(255,255,255,0.1)' },
      ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } }
    },
    x: {
      grid: { color: 'rgba(255,255,255,0.1)' },
      ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } }
    }
  }
};

// Initialize all charts
function initCharts() {
  // Performance Prediction Chart
  charts.prediction = new Chart(document.getElementById('predictionChart'), {
    type: 'line',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [
        {
          label: 'Performance',
          data: [78, 85, 82, 89, 76, 83, 87],
          borderColor: '#4facfe',
          backgroundColor: 'rgba(79, 172, 254, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3
        },
        {
          label: 'Recovery',
          data: [85, 70, 75, 65, 88, 82, 78],
          borderColor: '#00f2fe',
          backgroundColor: 'rgba(0, 242, 254, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 2
        }
      ]
    },
    options: chartConfig
  });

  // Risk Analysis Chart
  charts.risk = new Chart(document.getElementById('riskChart'), {
    type: 'doughnut',
    data: {
      labels: ['Low Risk', 'Medium', 'High Risk'],
      datasets: [{
        data: [75, 20, 5],
        backgroundColor: ['#4caf50', '#ff9800', '#f44336'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: 'white', font: { size: 10 } }
        }
      }
    }
  });

  // Heart Rate Chart
  charts.hr = new Chart(document.getElementById('hrChart'), {
    type: 'line',
    data: {
      labels: ['6AM', '12PM', '6PM', '12AM'],
      datasets: [{
        label: 'HR',
        data: [58, 72, 68, 62],
        borderColor: '#f093fb',
        backgroundColor: 'rgba(240, 147, 251, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      ...chartConfig,
      scales: {
        ...chartConfig.scales,
        y: { ...chartConfig.scales.y, beginAtZero: false, min: 50, max: 80 }
      }
    }
  });

  // Sleep Chart
  charts.sleep = new Chart(document.getElementById('sleepChart'), {
    type: 'bar',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [{
        label: 'Sleep Hours',
        data: [7.5, 8.2, 7.8, 8.5, 7.2, 9.1, 8.8],
        backgroundColor: 'rgba(79, 172, 254, 0.7)',
        borderColor: '#4facfe',
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: chartConfig
  });

  // HRV Chart
  charts.hrv = new Chart(document.getElementById('hrvChart'), {
    type: 'line',
    data: {
      labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
      datasets: [{
        label: 'HRV (ms)',
        data: [42, 45, 38, 48, 52, 44, 46],
        borderColor: '#ffa726',
        backgroundColor: 'rgba(255, 167, 38, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: chartConfig
  });

  // Activity Chart
  charts.activity = new Chart(document.getElementById('activityChart'), {
    type: 'radar',
    data: {
      labels: ['Cardio', 'Strength', 'Flexibility', 'Balance', 'Endurance', 'Recovery'],
      datasets: [{
        label: 'This Week',
        data: [85, 78, 65, 72, 88, 92],
        borderColor: '#4facfe',
        backgroundColor: 'rgba(79, 172, 254, 0.2)',
        pointBackgroundColor: '#4facfe',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: 'white', font: { size: 11 } }
        }
      },
      scales: {
        r: {
          grid: { color: 'rgba(255,255,255,0.1)' },
          angleLines: { color: 'rgba(255,255,255,0.1)' },
          ticks: { color: 'rgba(255,255,255,0.7)', backdropColor: 'transparent' }
        }
      }
    }
  });

  // Body Composition Chart
  charts.body = new Chart(document.getElementById('bodyChart'), {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [
        {
          label: 'Weight (kg)',
          data: [75, 74.5, 74, 73.8, 73.5, 73.2],
          borderColor: '#4facfe',
          yAxisID: 'y'
        },
        {
          label: 'Body Fat %',
          data: [15.5, 15.2, 14.8, 14.5, 14.2, 14.0],
          borderColor: '#f093fb',
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: 'white', font: { size: 11 } }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(255,255,255,0.1)' },
          ticks: { color: 'rgba(255,255,255,0.7)' }
        },
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          grid: { color: 'rgba(255,255,255,0.1)' },
          ticks: { color: 'rgba(255,255,255,0.7)' }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: { color: 'rgba(255,255,255,0.7)' }
        }
      }
    }
  });
}

// Fetch and update data
async function fetchHealthAnalytics() {
  try {
    showLoadingState();
    
    // Simulate API call
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Mock data from user's stored health records
    const response = {
      overall_score: 85 + Math.floor(Math.random() * 10) - 5,
      resting_hr: 58 + Math.floor(Math.random() * 6) - 3,
      sleep_quality: 8.2 + (Math.random() * 1 - 0.5),
      recovery_score: 92 + Math.floor(Math.random() * 8) - 4,
      hrv_trend: [42, 45, 38, 48, 52, 44, 46].map(v => v + Math.random() * 4 - 2),
      performance_prediction: [78, 85, 82, 89, 76, 83, 87].map(v => v + Math.random() * 6 - 3)
    };
    
    updateDashboard(response);
    updateCharts(response);
    hideLoadingState();
    
  } catch (error) {
    console.error('Failed to fetch health analytics:', error);
    alertShow('Failed to load analytics', 'danger');
    hideLoadingState();
  }
}

function showLoadingState() {
  document.getElementById('overallScore').innerHTML = '<div class="loading-skeleton"></div>';
  document.getElementById('restingHR').innerHTML = '<div class="loading-skeleton"></div>';
  document.getElementById('sleepScore').innerHTML = '<div class="loading-skeleton"></div>';
  document.getElementById('recoveryScore').innerHTML = '<div class="loading-skeleton"></div>';
}

function hideLoadingState() {
  // Values will be updated by updateDashboard
}

function updateDashboard(data) {
  document.getElementById('overallScore').textContent = data.overall_score;
  document.getElementById('restingHR').textContent = data.resting_hr;
  document.getElementById('sleepScore').textContent = data.sleep_quality.toFixed(1);
  document.getElementById('recoveryScore').textContent = data.recovery_score;
  
  // Update progress circle
  const scoreAngle = (data.overall_score / 100) * 360;
  document.getElementById('healthScoreCircle').style.setProperty('--progress-angle', scoreAngle + 'deg');
}

function updateCharts(data) {
  // Update HRV chart with real data
  if (charts.hrv && data.hrv_trend) {
    charts.hrv.data.datasets[0].data = data.hrv_trend;
    charts.hrv.update('none');
  }
  
  // Update performance prediction with real data
  if (charts.prediction && data.performance_prediction) {
    charts.prediction.data.datasets[0].data = data.performance_prediction;
    charts.prediction.update('none');
  }
}

// Event handlers
document.getElementById('refreshHealth').addEventListener('click', () => {
  alertShow('Refreshing analytics...', 'info');
  fetchHealthAnalytics();
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  fetchHealthAnalytics();
  
  // Auto-refresh every 5 minutes
  setInterval(fetchHealthAnalytics, 300000);
});

// Real-time updates simulation
setInterval(() => {
  const elements = ['restingHR', 'sleepScore', 'recoveryScore'];
  elements.forEach(id => {
    const element = document.getElementById(id);
    if (element && !element.innerHTML.includes('loading')) {
      const currentValue = parseFloat(element.textContent);
      if (!isNaN(currentValue)) {
        const variation = id === 'restingHR' ? 1 : 0.1;
        const newValue = currentValue + (Math.random() * variation * 2 - variation);
        element.textContent = id === 'restingHR' ? Math.round(newValue) : newValue.toFixed(1);
      }
    }
  });
}, 30000);
</script>
{% endblock %}