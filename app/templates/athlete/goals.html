{% extends "shared/base.html" %}

{% block style %}
<style>
  .progress-bar {
    transition: width 0.5s ease;
  }
</style>
{% endblock %}

{% block content %}
<section class="section dashboard">
  <div class="row g-3">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="m-0">Goals</h5>
      <div>
        <button class="btn btn-outline-secondary me-2" id="refreshGoals">
          <i class="bi bi-arrow-repeat me-1"></i> Refresh
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#goalModal">
          <i class="bi bi-plus-lg me-1"></i> Add Goal
        </button>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card sales-card">
        <div class="card-body">
          <h5 class="card-title">Active Goals</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-bullseye"></i>
            </div>
            <div class="ps-3">
              <h6 id="activeGoalsCount">0</h6>
              <span class="text-muted small">Currently in progress</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card revenue-card">
        <div class="card-body">
          <h5 class="card-title">Completed</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-check2-circle"></i>
            </div>
            <div class="ps-3">
              <h6 id="completedGoalsCount">0</h6>
              <span class="text-muted small">All time</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-2 align-items-end mb-3">
            <div class="col-md-4">
              <label class="form-label small text-muted">Search</label>
              <input id="goalSearch" type="text" class="form-control" placeholder="Search by title or tag">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Status</label>
              <select id="goalStatusFilter" class="form-select">
                <option value="">All</option>
                <option value="in progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="not started">Not Started</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted">Sort by</label>
              <select id="goalSort" class="form-select">
                <option value="due_asc">Due Date ↑</option>
                <option value="due_desc">Due Date ↓</option>
                <option value="progress_desc">Progress ↓</option>
                <option value="progress_asc">Progress ↑</option>
              </select>
            </div>
          </div>
          <div id="goalsList" class="row g-3"></div>
          <div id="goalsEmpty" class="text-center py-5 d-none">
            <i class="bi bi-emoji-neutral fs-1 text-muted"></i>
            <p class="mt-2 text-muted">No goals yet. Start by adding your first goal!</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="goalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="goalForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="goalModalTitle">Add Goal</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="goalId">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input id="goalTitle" type="text" class="form-control" required maxlength="120">
        </div>
        <div class="mb-3">
          <label class="form-label">Target</label>
          <input id="goalTarget" type="number" class="form-control" placeholder="e.g. 5" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Unit</label>
          <input id="goalUnit" type="text" class="form-control" placeholder="e.g. km, kg, reps">
        </div>
        <div class="mb-3">
          <label class="form-label">Due Date</label>
          <input id="goalDue" type="date" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Image URL</label>
          <input id="goalImage" type="text" class="form-control" placeholder="Optional URL for a background image">
        </div>
        <div class="mb-0">
          <label class="form-label">Tags (comma separated)</label>
          <input id="goalTags" type="text" class="form-control" placeholder="fat-loss, endurance">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ... (alertShow and state variables are the same)
function alertShow(message, type="info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}
let GOALS = [];
let editingId = null;
let charts = {}; // To store Chart.js instances

const goalsList = document.getElementById('goalsList');
const goalsEmpty = document.getElementById('goalsEmpty');
const activeGoalsCount = document.getElementById('activeGoalsCount');
const completedGoalsCount = document.getElementById('completedGoalsCount');

/* ---------- Templates ---------- */
function goalCardTpl(g) {
  const due = g.due_date ? new Date(g.due_date).toLocaleDateString() : '';
  const badge = g.status === "completed" ? "bg-success"
              : g.status === "in progress" ? "bg-primary"
              : "bg-secondary";
  const tags = (g.tags || []).map(t => `<span class="badge rounded-pill text-bg-light me-1">${t}</span>`).join('');
  
  const imageStyle = g.image_url ? `background-image: url('${g.image_url}'); background-size: cover; background-position: center;` : '';
  
  return `
    <div class="col-md-6 col-xl-4">
      <div class="card h-100" style="${imageStyle}">
        <div class="card-body bg-white rounded shadow-sm">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${g.title}</h6>
              <div class="small text-muted">Target: ${g.target} ${g.unit}</div>
            </div>
            <span class="badge ${badge}">${g.status}</span>
          </div>
          <div class="my-3">
            <div class="d-flex justify-content-between small">
              <span>Progress</span><span>${g.progress}%</span>
            </div>
            <div class="progress">
              <div class="progress-bar" style="width:${g.progress}%" role="progressbar"></div>
            </div>
          </div>
          
          <div class="chart-container mb-3">
            <canvas id="goalChart-${g.id}"></canvas>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <div class="small text-muted"><i class="bi bi-calendar2-week me-1"></i>Due: ${due}</div>
            <div>
              <button class="btn btn-sm btn-light me-1" onclick="openEdit(${g.id})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-light text-danger" onclick="removeGoal(${g.id})"><i class="bi bi-trash"></i></button>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <input type="number" id="updateValueInput-${g.id}" class="form-control form-control-sm me-2" placeholder="+ Add ${g.unit}">
            <button class="btn btn-sm btn-primary" onclick="updateGoalValue(${g.id})">Add</button>
          </div>
          ${tags ? `<div class="mt-2">${tags}</div>` : ``}
        </div>
      </div>
    </div>
  `;
}

/* ---------- Render and Charting ---------- */
function renderGoals() {
  const q = document.getElementById('goalSearch').value.trim().toLowerCase();
  const st = document.getElementById('goalStatusFilter').value;
  const sortBy = document.getElementById('goalSort').value;

  let list = [...GOALS];
  if (q) {
    list = list.filter(g =>
      g.title.toLowerCase().includes(q) ||
      (g.tags || []).some(t => t.toLowerCase().includes(q))
    );
  }
  if (st) list = list.filter(g => g.status === st);

  list.sort((a,b)=>{
    if (sortBy === 'due_asc') return new Date(a.due_date) - new Date(b.due_date);
    if (sortBy === 'due_desc') return new Date(b.due_date) - new Date(a.due_date);
    if (sortBy === 'progress_desc') return b.progress - a.progress;
    if (sortBy === 'progress_asc') return a.progress - b.progress;
    return 0;
  });

  goalsList.innerHTML = list.map(goalCardTpl).join('');
  goalsEmpty.classList.toggle('d-none', list.length > 0);
  activeGoalsCount.textContent = GOALS.filter(g => g.status!=='completed').length;
  completedGoalsCount.textContent = GOALS.filter(g => g.status==='completed').length;
  
  // Destroy old charts to prevent memory leaks
  Object.values(charts).forEach(chart => chart.destroy());
  charts = {};

  // Render new charts
  list.forEach(g => {
    const ctx = document.getElementById(`goalChart-${g.id}`);
    if (ctx) {
      charts[g.id] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: g.log_data.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [{
            label: 'Progress',
            data: g.log_data.map(d => d.value),
            borderColor: '#0d6efd',
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, max: g.target },
            x: { display: false }
          },
          plugins: { legend: { display: false } }
        }
      });
    }
  });
}


/* ---------- API Calls ---------- */
async function fetchGoals() {
  try {
    const res = await fetch('/athlete/api/goals', { headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }});
    const data = res.ok ? await res.json() : [];
    GOALS = Array.isArray(data) ? data : [];
  } catch(e) {
    console.error(e);
    alertShow('Failed to load goals', 'danger');
  } finally {
    renderGoals();
  }
}

// In your <script> block

async function createGoal(payload) {
  const res = await fetch('/athlete/api/goals', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${localStorage.getItem('access_token')}` },
    body: JSON.stringify(payload)
  });
  
  // Await the JSON parsing only if the response is OK
  const data = res.ok ? await res.json() : { msg: 'Failed to connect to the server.' }; 
  
  // Return a consistent object for the caller to check
  return { ok: res.ok, d: data };
}

async function updateGoal(id, payload) {
  const res = await fetch(`/athlete/api/goals/${id}`, {
    method:'PUT',
    headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${localStorage.getItem('access_token')}` },
    body: JSON.stringify(payload)
  });
  return res.json().then(d => ({ ok: res.ok, d }));
}

async function updateGoalValue(id) {
  const input = document.getElementById(`updateValueInput-${id}`);
  const valueToAdd = Number(input.value);
  if (isNaN(valueToAdd) || valueToAdd <= 0) {
    alertShow('Please enter a valid number', 'warning');
    return;
  }
  const res = await fetch(`/athlete/api/goals/${id}/update_value`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${localStorage.getItem('access_token')}` },
    body: JSON.stringify({ value_to_add: valueToAdd })
  });
  const data = await res.json();
  if (res.ok) {
    alertShow('Goal updated successfully', 'success');
    input.value = '';
    await fetchGoals();
  } else {
    alertShow(data.msg || 'Failed to update goal', 'danger');
  }
}

async function removeGoal(id) {
  if (!confirm('Delete this goal?')) return;
  const { ok, d } = await deleteGoal(id);
  if (ok) { alertShow('Goal deleted', 'success'); fetchGoals(); }
  else { alertShow(d?.msg || 'Delete failed', 'danger'); }
}

async function deleteGoal(id) {
  const res = await fetch(`/athlete/api/goals/${id}`, {
    method:'DELETE',
    headers:{ Authorization:`Bearer ${localStorage.getItem('access_token')}` }
  });
  return res.json().then(d => ({ ok: res.ok, d }));
}

/* ---------- Modal and Listeners ---------- */
const goalModalEl = document.getElementById('goalModal');
const goalModal = new bootstrap.Modal(goalModalEl);

document.getElementById('refreshGoals').onclick = fetchGoals;
document.getElementById('goalSearch').addEventListener('input', renderGoals);
document.getElementById('goalStatusFilter').addEventListener('change', renderGoals);
document.getElementById('goalSort').addEventListener('change', renderGoals);

document.getElementById('goalForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    title: document.getElementById('goalTitle').value.trim(),
    target: Number(document.getElementById('goalTarget').value.trim()),
    unit: document.getElementById('goalUnit').value.trim(),
    due_date: document.getElementById('goalDue').value,
    image_url: document.getElementById('goalImage').value.trim(),
    tags: document.getElementById('goalTags').value.split(',').map(s=>s.trim()).filter(Boolean)
  };

  if (!payload.title || !payload.target || !payload.due_date) {
    alertShow('Please fill required fields', 'warning'); return;
  }
  let result;
  if (editingId) result = await updateGoal(editingId, payload);
  else result = await createGoal(payload);

  if (result.ok) {
    alertShow(editingId ? 'Goal updated' : 'Goal created', 'success');
    goalModal.hide();
    editingId = null;
    await fetchGoals();
    e.target.reset();
  } else {
    alertShow(result.d?.msg || 'Operation failed', 'danger');
  }
});

function openEdit(id) {
  const g = GOALS.find(x => x.id === id);
  if (!g) return;
  editingId = id;
  document.getElementById('goalModalTitle').textContent = 'Edit Goal';
  document.getElementById('goalTitle').value = g.title;
  document.getElementById('goalTarget').value = g.target;
  document.getElementById('goalUnit').value = g.unit;
  document.getElementById('goalDue').value = g.due_date;
  document.getElementById('goalImage').value = g.image_url || '';
  document.getElementById('goalTags').value = (g.tags||[]).join(', ');
  goalModal.show();
}

goalModalEl.addEventListener('hidden.bs.modal', ()=>{
  editingId = null;
  document.getElementById('goalModalTitle').textContent = 'Add Goal';
  document.getElementById('goalForm').reset();
});

fetchGoals();
</script>
{% endblock %}