{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Goals Dashboard</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Athlete Dashboard</a></li>
      <li class="breadcrumb-item active">Goals</li>
    </ol>
  </nav>
</div>

<section class="section">
  <!-- Action Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <p class="text-muted mb-0">Track your progress and achieve your dreams</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" id="refreshGoals">
        <i class="bi bi-arrow-repeat me-1"></i> Refresh
      </button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#goalModal">
        <i class="bi bi-plus-lg me-1"></i> Add Goal
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card sales-card">
        <div class="card-body">
          <h5 class="card-title">Active Goals</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-bullseye"></i>
            </div>
            <div class="ps-3">
              <h6 id="activeGoalsCount">0</h6>
              <span class="text-muted small pt-1">Currently in progress</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card revenue-card">
        <div class="card-body">
          <h5 class="card-title">Completed</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-check2-circle"></i>
            </div>
            <div class="ps-3">
              <h6 id="completedGoalsCount">0</h6>
              <span class="text-muted small pt-1">All time</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card customers-card">
        <div class="card-body">
          <h5 class="card-title">Average Progress</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-graph-up"></i>
            </div>
            <div class="ps-3">
              <h6 id="averageProgress">0%</h6>
              <span class="text-muted small pt-1">Overall completion</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card">
        <div class="card-body">
          <h5 class="card-title">This Week</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-calendar-week"></i>
            </div>
            <div class="ps-3">
              <h6 id="thisWeekUpdates">0</h6>
              <span class="text-muted small pt-1">Goals updated</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Filters & Search</h5>
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <input id="goalSearch" type="text" class="form-control" placeholder="ðŸ” Search by title or tag">
        </div>
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select id="goalStatusFilter" class="form-select">
            <option value="">All Status</option>
            <option value="in progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="not started">Not Started</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Priority</label>
          <select id="goalPriorityFilter" class="form-select">
            <option value="">All Priority</option>
            <option value="high">ðŸ”´ High</option>
            <option value="medium">ðŸŸ¡ Medium</option>
            <option value="low">ðŸŸ¢ Low</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Sort by</label>
          <select id="goalSort" class="form-select">
            <option value="due_asc">Due Date â†‘</option>
            <option value="due_desc">Due Date â†“</option>
            <option value="progress_desc">Progress â†“</option>
            <option value="progress_asc">Progress â†‘</option>
            <option value="created_desc">Newest First</option>
          </select>
        </div>
        <div class="col-md-1">
          <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Goals List -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">My Goals</h5>
      <div id="goalsList" class="row g-3"></div>
      <div id="goalsEmpty" class="text-center py-5 d-none">
        <i class="bi bi-emoji-neutral fs-1 text-muted"></i>
        <h4 class="mt-3">No goals yet</h4>
        <p class="text-muted">Start your journey by adding your first goal!</p>
        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#goalModal">
          <i class="bi bi-plus-lg me-1"></i> Create Your First Goal
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Goal Modal -->
<div class="modal fade" id="goalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form id="goalForm" class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title fw-bold" id="goalModalTitle">ðŸŽ¯ Add Goal</h5>
          <p class="text-muted small mb-0">Set your target and track your progress</p>
        </div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="goalId">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold">Goal Title <span class="text-danger">*</span></label>
            <input id="goalTitle" type="text" class="form-control" required maxlength="120" placeholder="e.g., Run 5km daily">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Target Value <span class="text-danger">*</span></label>
            <input id="goalTarget" type="number" class="form-control" placeholder="100" required step="0.1">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Unit <span class="text-danger">*</span></label>
            <input id="goalUnit" type="text" class="form-control" placeholder="km, kg, reps" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Due Date <span class="text-danger">*</span></label>
            <input id="goalDue" type="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Priority Level</label>
            <select id="goalPriority" class="form-select">
              <option value="low">ðŸŸ¢ Low Priority</option>
              <option value="medium" selected>ðŸŸ¡ Medium Priority</option>
              <option value="high">ðŸ”´ High Priority</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Tags (comma separated)</label>
            <input id="goalTags" type="text" class="form-control" placeholder="fitness, health, daily, challenge">
            <div class="form-text">Use tags to organize and filter your goals</div>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Description (Optional)</label>
            <textarea id="goalDescription" class="form-control" rows="3" placeholder="Why is this goal important to you?"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-check-lg me-1"></i> Save Goal
        </button>
      </div>
    </form>
  </div>
</div>
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold" id="confirmDeleteModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body text-dark">
        <p class="mb-2">Are you sure you want to delete the goal: <strong id="deleteGoalTitle"></strong>?</p>
        <p class="small text-muted">This action cannot be undone.</p>
        <input type="hidden" id="goalToDeleteId">
      </div>
      
      <div class="modal-footer d-flex justify-content-end bg-light">
        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger rounded-pill" id="executeDeleteBtn">Delete Permanently</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global state
let GOALS = [];
let editingId = null;
let charts = {};

const goalsList = document.getElementById('goalsList');
const goalsEmpty = document.getElementById('goalsEmpty');

// Alert function
function alertShow(message, type="info") {
  const icons = { 
    success: 'check-circle-fill', 
    danger: 'exclamation-triangle-fill', 
    warning: 'exclamation-triangle-fill', 
    info: 'info-circle-fill' 
  };
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      <i class="bi bi-${icons[type]} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  document.body.appendChild(wrap);
  setTimeout(() => wrap.remove(), 4000);
}

// Format date
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  if (isNaN(date)) return '-';
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Get priority colors
function getPriorityColor(priority) {
  const colors = {
    high: { bg: '#fff5f5', border: '#dc3545', icon: 'ðŸ”´' },
    medium: { bg: '#fff8e1', border: '#ffc107', icon: 'ðŸŸ¡' },
    low: { bg: '#f0fdf4', border: '#198754', icon: 'ðŸŸ¢' }
  };
  return colors[priority] || colors.medium;
}

// Goal card template
function goalCardTpl(g) {
  const badge = g.status === "completed" ? "bg-success"
              : g.status === "in progress" ? "bg-primary"
              : "bg-secondary";
  const tags = (g.tags || []).map(t => `<span class="badge bg-light text-dark me-1 mb-1">${t}</span>`).join('');
  
  const priorityStyle = getPriorityColor(g.priority || 'medium');
  const currentProgress = g.progress || 0;
  const targetValue = g.target || 1;
  const currentValue = g.current_value || 0;
  const progressBarWidth = Math.min(currentProgress, 100);

  return `
    <div class="col-md-6 col-xl-4">
      <div class="card goal-card h-100 ${g.status === 'completed' ? 'goal-completed' : ''}" 
           style="border-left: 4px solid ${priorityStyle.border};">
        
        <!-- Icon Header -->
        <div class="goal-icon-header" style="background: ${priorityStyle.bg};">
          <div class="goal-priority-badge">
            <span class="priority-icon">${priorityStyle.icon}</span>
            <span class="badge ${badge}">${g.status}</span>
          </div>
          <div class="goal-main-icon">
            <i class="bi bi-${g.status === 'completed' ? 'trophy-fill text-warning' : 'bullseye text-primary'}" style="font-size: 3rem;"></i>
          </div>
        </div>
        
        <div class="card-body">
          <h6 class="card-title mb-2">${g.title}</h6>
          <p class="text-muted small mb-3">
            <i class="bi bi-flag-fill me-1"></i>Target: ${targetValue} ${g.unit}
          </p>
          
          <!-- Progress Section -->
          <div class="mb-3">
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">Progress</span>
              <span class="fw-bold text-primary">${currentProgress}%</span>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar" style="width:${progressBarWidth}%" role="progressbar"></div>
            </div>
            <div class="small text-muted mt-1">
              <i class="bi bi-graph-up-arrow me-1"></i>${currentValue} / ${targetValue} ${g.unit}
            </div>
          </div>
          
          <!-- Chart Container -->
          <div class="chart-container mb-3">
            <canvas id="goalChart-${g.id}"></canvas>
          </div>

          <!-- Due Date and Actions -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="small text-muted">
              <i class="bi bi-calendar2-week me-1"></i>${formatDate(g.due_date)}
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit(${g.id})" title="Edit Goal">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteGoal(${g.id})" title="Delete Goal">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <!-- Quick Update Section -->
          <div class="update-section p-2 rounded" style="background: #f8f9fa;">
            <div class="row g-2">
              <div class="col-8">
                <input type="number" id="updateValueInput-${g.id}" class="form-control form-control-sm" 
                       placeholder="+ Add ${g.unit}" step="0.1">
              </div>
              <div class="col-4">
                <button class="btn btn-sm btn-primary w-100" onclick="updateGoalValue(${g.id})">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </div>
          </div>

          ${tags ? `<div class="mt-2">${tags}</div>` : ''}
        </div>
      </div>
    </div>
  `;
}

// Render goals
function renderGoals() {
  const q = document.getElementById('goalSearch').value.trim().toLowerCase();
  const st = document.getElementById('goalStatusFilter').value;
  const pr = document.getElementById('goalPriorityFilter').value;
  const sortBy = document.getElementById('goalSort').value;

  let list = [...GOALS];
  
  if (q) list = list.filter(g => 
    g.title.toLowerCase().includes(q) || 
    (g.tags || []).some(t => t.toLowerCase().includes(q))
  );
  if (st) list = list.filter(g => g.status === st);
  if (pr) list = list.filter(g => g.priority === pr);

  list.sort((a,b)=>{
    if (sortBy === 'due_asc') return new Date(a.due_date) - new Date(b.due_date);
    if (sortBy === 'due_desc') return new Date(b.due_date) - new Date(a.due_date);
    if (sortBy === 'progress_desc') return (b.progress || 0) - (a.progress || 0);
    if (sortBy === 'progress_asc') return (a.progress || 0) - (b.progress || 0);
    if (sortBy === 'created_desc') return new Date(b.created_at) - new Date(a.created_at);
    return 0;
  });

  goalsList.innerHTML = list.map(goalCardTpl).join('');
  goalsEmpty.classList.toggle('d-none', list.length > 0);
  
  // Update stats
  const active = GOALS.filter(g => g.status !== 'completed').length;
  const completed = GOALS.filter(g => g.status === 'completed').length;
  const avgProgress = GOALS.length > 0 ? Math.round(GOALS.reduce((sum, g) => sum + (g.progress || 0), 0) / GOALS.length) : 0;
  
  document.getElementById('activeGoalsCount').textContent = active;
  document.getElementById('completedGoalsCount').textContent = completed;
  document.getElementById('averageProgress').textContent = avgProgress + '%';
  document.getElementById('thisWeekUpdates').textContent = GOALS.filter(g => {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    return g.log_data && g.log_data.some(log => new Date(log.date) >= weekAgo);
  }).length;
  
  // Destroy old charts
  Object.values(charts).forEach(chart => chart.destroy());
  charts = {};

  // Render charts
  list.forEach(g => {
    const ctx = document.getElementById(`goalChart-${g.id}`);
    if (ctx) {
      charts[g.id] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: g.log_data.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [{
            label: 'Progress',
            data: g.log_data.map(d => d.value),
            borderColor: '#4154f1',
            backgroundColor: 'rgba(65, 84, 241, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointBackgroundColor: '#4154f1',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { 
              beginAtZero: true, 
              max: g.target,
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            x: { display: false }
          },
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 10,
              borderColor: '#4154f1',
              borderWidth: 1
            }
          }
        }
      });
    }
  });
}

// Reset filters
function resetFilters() {
  document.getElementById('goalSearch').value = '';
  document.getElementById('goalStatusFilter').value = '';
  document.getElementById('goalPriorityFilter').value = '';
  document.getElementById('goalSort').value = 'due_asc';
  renderGoals();
}

// Fetch goals
async function fetchGoals() {
  try {
    const res = await fetch('/athlete/api/goals', { 
      headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
    });
    const data = res.ok ? await res.json() : [];
    GOALS = Array.isArray(data) ? data.map(g => ({
      ...g,
      priority: g.priority || 'medium',
      progress: g.progress || 0,
      current_value: g.current_value || 0,
      log_data: g.log_data || []
    })) : [];
  } catch(e) {
    console.error(e);
    GOALS = [];
    alertShow('Failed to load goals', 'danger');
  } finally {
    renderGoals();
  }
}

// Create goal
async function createGoal(payload) {
  const res = await fetch('/athlete/api/goals', {
    method:'POST',
    headers:{ 
      'Content-Type':'application/json', 
      Authorization:`Bearer ${localStorage.getItem('access_token')}` 
    },
    body: JSON.stringify(payload)
  });
  return { ok: res.ok, d: res.ok ? await res.json() : { msg: 'Failed' } };
}

// Update goal
async function updateGoal(id, payload) {
  const res = await fetch(`/athlete/api/goals/${id}`, {
    method:'PUT',
    headers:{ 
      'Content-Type':'application/json', 
      Authorization:`Bearer ${localStorage.getItem('access_token')}` 
    },
    body: JSON.stringify(payload)
  });
  return { ok: res.ok, d: res.ok ? await res.json() : { msg: 'Failed' } };
}

// Update goal value
async function updateGoalValue(id) {
  const input = document.getElementById(`updateValueInput-${id}`);
  const valueToAdd = Number(input.value);
  if (isNaN(valueToAdd) || valueToAdd <= 0) {
    alertShow('Please enter a valid positive number', 'warning');
    return;
  }
  
  const button = input.parentElement.nextElementSibling.querySelector('button');
  const originalContent = button.innerHTML;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
  button.disabled = true;
  
  try {
    const res = await fetch(`/athlete/api/goals/${id}/update_value`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        Authorization: `Bearer ${localStorage.getItem('access_token')}` 
      },
      body: JSON.stringify({ value_to_add: valueToAdd })
    });
    const data = await res.json();
    
    if (res.ok) {
      alertShow('ðŸŽ‰ Goal updated successfully!', 'success');
      input.value = '';
      await fetchGoals();
    } else {
      alertShow(data.msg || 'Failed to update goal', 'danger');
    }
  } catch (error) {
    alertShow('Network error occurred', 'danger');
  } finally {
    button.innerHTML = originalContent;
    button.disabled = false;
  }
}

// Delete goal
function confirmDeleteGoal(id) {
    const goal = GOALS.find(g => g.id === id);
    if (!goal) return;

    // Populate the confirmation modal
    document.getElementById('deleteGoalTitle').textContent = goal.title;
    document.getElementById('goalToDeleteId').value = id;

    // Show the modal
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
}

async function executeDelete() {
    const id = document.getElementById('goalToDeleteId').value;
    if (!id) return;
    
    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();

    try {
        await fetch(`/athlete/api/goals/${id}`, {
            method:'DELETE',
            headers:{ Authorization:`Bearer ${localStorage.getItem('access_token')}` }
        });
        
        alertShow('Goal deleted successfully', 'success'); 
        fetchGoals(); 
        
    } catch (e) { 
        alertShow(e.message || 'Delete failed', 'danger'); 
    }
}
// Modal events
const goalModalEl = document.getElementById('goalModal');
const goalModal = new bootstrap.Modal(goalModalEl);

document.getElementById('refreshGoals').onclick = () => {
  alertShow('Refreshing goals...', 'info');
  fetchGoals();
};

document.getElementById('goalSearch').addEventListener('input', renderGoals);
document.getElementById('goalStatusFilter').addEventListener('change', renderGoals);
document.getElementById('goalPriorityFilter').addEventListener('change', renderGoals);
document.getElementById('goalSort').addEventListener('change', renderGoals);

// Form submit
document.getElementById('goalForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  
  const title = document.getElementById('goalTitle').value.trim();
  const target = Number(document.getElementById('goalTarget').value.trim());
  const unit = document.getElementById('goalUnit').value.trim();
  const dueDate = document.getElementById('goalDue').value;
  const tags = document.getElementById('goalTags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const priority = document.getElementById('goalPriority').value;
  const description = document.getElementById('goalDescription').value.trim();

  if (!title) { 
    alertShow('Goal title is required', 'warning'); 
    return; 
  }
  if (!target || target <= 0) { 
    alertShow('Target value must be greater than 0', 'warning'); 
    return; 
  }
  if (!unit) { 
    alertShow('Unit is required', 'warning'); 
    return; 
  }
  if (!dueDate) { 
    alertShow('Due date is required', 'warning'); 
    return; 
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const selectedDate = new Date(dueDate);
  if (selectedDate < today) { 
    alertShow('Due date cannot be in the past', 'warning'); 
    return; 
  }

  const payload = {
    title, target, unit, due_date: dueDate,
    tags: tags.join(','), priority, description
  };

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
  submitBtn.disabled = true;

  try {
    let result;
    if (editingId) {
      result = await updateGoal(editingId, payload);
    } else {
      result = await createGoal(payload);
    }

    if (result.ok) {
      alertShow(editingId ? 'âœ… Goal updated successfully!' : 'ðŸŽ¯ Goal created successfully!', 'success');
      goalModal.hide();
      editingId = null;
      await fetchGoals();
      e.target.reset();
    } else {
      alertShow(result.d?.msg || 'Operation failed', 'danger');
    }
  } catch (error) {
    alertShow('Network error occurred', 'danger');
  } finally {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Open edit
function openEdit(id) {
  const g = GOALS.find(x => x.id === id);
  if (!g) return;
  
  editingId = id;
  document.getElementById('goalModalTitle').textContent = 'âœï¸ Edit Goal';
  document.getElementById('goalTitle').value = g.title;
  document.getElementById('goalTarget').value = g.target;
  document.getElementById('goalUnit').value = g.unit;
  document.getElementById('goalDue').value = g.due_date;
  document.getElementById('goalTags').value = (g.tags||[]).join(', ');
  document.getElementById('goalPriority').value = g.priority || 'medium';
  document.getElementById('goalDescription').value = g.description || '';
  goalModal.show();
}

goalModalEl.addEventListener('hidden.bs.modal', ()=>{
  editingId = null;
  document.getElementById('goalModalTitle').textContent = 'ðŸŽ¯ Add Goal';
  document.getElementById('goalForm').reset();
});

document.addEventListener('DOMContentLoaded', () => {
  const dueDateInput = document.getElementById('goalDue');
  const today = new Date();
  const oneMonthFromNow = new Date(today.setMonth(today.getMonth() + 1));
  dueDateInput.min = new Date().toISOString().split('T')[0];
  dueDateInput.value = oneMonthFromNow.toISOString().split('T')[0];
});

fetchGoals();
</script>

<style>
/* Goal Card Styling */
.goal-card {
  transition: all 0.3s ease;
  overflow: hidden;
}

.goal-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15) !important;
}

.goal-icon-header {
  padding: 1.5rem;
  text-align: center;
  position: relative;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.goal-priority-badge {
  position: absolute;
  top: 1rem;
  right: 1rem;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.priority-icon {
  font-size: 1.2rem;
}

.goal-main-icon {
  margin-top: 0.5rem;
}

.goal-completed {
  position: relative;
  opacity: 0.95;
}

.goal-completed::after {
  content: 'âœ“';
  position: absolute;
  top: 10px;
  left: 10px;
  width: 35px;
  height: 35px;
  background: #198754;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 1.2rem;
  box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3);
  z-index: 10;
}

.chart-container {
  height: 100px;
  position: relative;
  background: #f8f9fa;
  border-radius: 0.375rem;
  padding: 0.5rem;
}

.update-section {
  border: 1px solid #dee2e6;
}

.progress {
  border-radius: 0.375rem;
}

.badge {
  font-weight: 500;
  padding: 0.35rem 0.65rem;
}

/* Card Icon Styling */
.card-icon {
  width: 64px;
  height: 64px;
  font-size: 32px;
  transition: transform 0.3s ease;
}

.info-card:hover .card-icon {
  transform: scale(1.1);
}

.sales-card .card-icon {
  color: #4154f1;
  background: #f6f6fe;
}

.revenue-card .card-icon {
  color: #2eca6a;
  background: #e0f8e9;
}

.customers-card .card-icon {
  color: #ff771d;
  background: #ffecdf;
}

.info-card .card-icon {
  color: #ffbb2c;
  background: #fff8dd;
}

/* Info Card Hover */
.info-card {
  transition: all 0.3s ease;
}

.info-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Modal Styling */
.modal-content {
  border: none;
  border-radius: 0.5rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.modal-header {
  border-bottom: 1px solid #dee2e6;
  padding: 1.5rem;
}

.modal-footer {
  border-top: 1px solid #dee2e6;
  padding: 1rem 1.5rem;
}

/* Form Elements */
.form-control:focus,
.form-select:focus {
  border-color: #4154f1;
  box-shadow: 0 0 0 0.25rem rgba(65, 84, 241, 0.25);
}

.form-label {
  color: #012970;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

/* Button Enhancements */
.btn {
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-2px);
}

.btn-primary {
  background-color: #4154f1;
  border-color: #4154f1;
}

.btn-primary:hover {
  background-color: #3142d1;
  border-color: #3142d1;
}

.btn-outline-primary:hover,
.btn-outline-danger:hover,
.btn-outline-secondary:hover {
  transform: translateY(-2px);
  box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}

/* Empty State */
#goalsEmpty {
  padding: 3rem 1rem;
}

#goalsEmpty i {
  font-size: 4rem;
  opacity: 0.5;
}

/* Alert Styling */
.alert {
  border: none;
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}

.alert-success {
  background-color: #d1e7dd;
  color: #0f5132;
}

.alert-danger {
  background-color: #f8d7da;
  color: #842029;
}

.alert-warning {
  background-color: #fff3cd;
  color: #664d03;
}

.alert-info {
  background-color: #cff4fc;
  color: #055160;
}

/* Spinner */
.spinner-border-sm {
  width: 1rem;
  height: 1rem;
  border-width: 0.15em;
}

/* Tag Badges */
.badge.bg-light {
  color: #012970 !important;
  border: 1px solid #e0e0e0;
}

/* Progress Bar Animation */
.progress-bar {
  transition: width 0.6s ease;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .goal-icon-header {
    padding: 1rem;
  }
  
  .goal-main-icon i {
    font-size: 2rem !important;
  }
  
  .card-icon {
    width: 50px;
    height: 50px;
    font-size: 24px;
  }
  
  .d-flex.justify-content-between.align-items-center.mb-4 {
    flex-direction: column;
    align-items: flex-start !important;
    gap: 1rem;
  }
  
  .d-flex.justify-content-between.align-items-center.mb-4 > div:last-child {
    width: 100%;
  }
  
  .d-flex.justify-content-between.align-items-center.mb-4 button {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .btn.me-2 {
    margin-right: 0 !important;
  }
}

@media (max-width: 576px) {
  .pagetitle h1 {
    font-size: 20px;
  }
  
  .card-title {
    font-size: 16px;
  }
  
  .info-card h6 {
    font-size: 24px;
  }
}

/* Card Title Styling */
.card-title {
  padding: 20px 0 15px 0;
  font-size: 18px;
  font-weight: 500;
  color: #012970;
}

/* Info Card Stats */
.info-card h6 {
  font-size: 28px;
  color: #012970;
  font-weight: 700;
  margin: 0;
  padding: 0;
}

/* Section Spacing */
.section {
  padding: 60px 0;
  overflow: hidden;
}

/* Breadcrumb */
.breadcrumb {
  background: transparent;
  padding: 0;
  margin-bottom: 1rem;
}

.breadcrumb-item + .breadcrumb-item::before {
  color: #899bbd;
}

/* Page Title */
.pagetitle h1 {
  font-size: 24px;
  margin-bottom: 0;
  font-weight: 600;
  color: #012970;
}

/* Card Body Padding */
.card-body {
  padding: 20px;
}

/* Text Colors */
.text-muted {
  color: #6c757d !important;
}

.small {
  font-size: 0.875rem;
}

/* Focus States for Accessibility */
.btn:focus-visible,
.form-control:focus-visible,
.form-select:focus-visible {
  outline: 2px solid #4154f1;
  outline-offset: 2px;
}

/* Prevent Text Selection on Interactive Elements */
.card-icon,
.badge,
.btn {
  user-select: none;
}

/* Animation for Cards */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.goal-card {
  animation: fadeInUp 0.5s ease-out;
}

/* Completion Checkmark Animation */
@keyframes checkmark {
  0% {
    transform: scale(0) rotate(0deg);
  }
  50% {
    transform: scale(1.2) rotate(180deg);
  }
  100% {
    transform: scale(1) rotate(360deg);
  }
}

.goal-completed::after {
  animation: checkmark 0.5s ease-out;
}

/* Chart Improvements */
.chart-container canvas {
  max-height: 100px;
}

/* Input Group Styling */
.update-section .form-control {
  border-radius: 0.375rem;
  border: 1px solid #ced4da;
}

.update-section .btn {
  border-radius: 0.375rem;
}

/* Button Size Adjustments */
.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  border-radius: 0.25rem;
}

/* Card Hover Effect Enhancement */
.card {
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Priority Visual Indicators */
.goal-card[style*="border-left-color: #dc3545"] .card-title {
  color: #dc3545;
}

.goal-card[style*="border-left-color: #ffc107"] .card-title {
  color: #fd7e14;
}

.goal-card[style*="border-left-color: #198754"] .card-title {
  color: #198754;
}

/* Filter Card Enhancement */
.card.mb-4 .card-body {
  padding: 1.5rem;
}

/* Stats Card Refinement */
.info-card .card-body {
  padding: 1.5rem;
}

/* Goal Card Content Spacing */
.goal-card .card-body > * + * {
  margin-top: 0.75rem;
}

/* Improve Contrast */
.text-primary {
  color: #4154f1 !important;
}

/* Modal Header Text Color Fix */
.modal-header h5,
.modal-header p {
  color: #012970;
}

/* Form Text Helper */
.form-text {
  color: #6c757d;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

/* Loading State */
button:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}

/* Smooth Transitions */
* {
  transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, 
              border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

/* Override for specific elements */
.progress-bar,
canvas,
input,
textarea,
select {
  transition: none;
}

input[type="number"],
input[type="date"],
input[type="text"],
textarea {
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

</style>
{% endblock %}