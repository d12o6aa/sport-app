{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>Progress Analytics</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a></li>
      <li class="breadcrumb-item active">Progress</li>
    </ol>
  </nav>
</div>

<section class="section dashboard">
  <!-- Action Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <p class="text-muted mb-0">Advanced insights into your fitness journey</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-secondary" id="btnRefresh">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
      </button>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary active period-btn" data-days="7">Week</button>
        <button type="button" class="btn btn-outline-primary period-btn" data-days="30">Month</button>
        <button type="button" class="btn btn-outline-primary period-btn" data-days="90">Quarter</button>
      </div>
    </div>
  </div>

  <!-- Performance Score Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body text-white p-4">
          <div class="row align-items-center">
            <div class="col-md-3 text-center">
              <div class="performance-score-circle mb-2">
                <svg width="150" height="150">
                  <circle cx="75" cy="75" r="65" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="10"/>
                  <circle id="performanceCircle" cx="75" cy="75" r="65" fill="none" stroke="white" stroke-width="10" 
                          stroke-dasharray="408.4" stroke-dashoffset="408.4" transform="rotate(-90 75 75)"
                          style="transition: stroke-dashoffset 1s ease;"/>
                  <text x="75" y="75" text-anchor="middle" dy="0.3em" fill="white" font-size="32" font-weight="bold" id="performanceScore">0</text>
                </svg>
              </div>
              <h5 class="mb-0">Performance Score</h5>
            </div>
            <div class="col-md-9">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="score-item">
                    <div class="d-flex align-items-center mb-1">
                      <i class="bi bi-lightning-charge-fill me-2"></i>
                      <small>Consistency</small>
                    </div>
                    <h4 class="mb-0" id="consistencyScore">0%</h4>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="score-item">
                    <div class="d-flex align-items-center mb-1">
                      <i class="bi bi-graph-up-arrow me-2"></i>
                      <small>Improvement</small>
                    </div>
                    <h4 class="mb-0" id="improvementScore">0%</h4>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="score-item">
                    <div class="d-flex align-items-center mb-1">
                      <i class="bi bi-trophy-fill me-2"></i>
                      <small>Goal Achievement</small>
                    </div>
                    <h4 class="mb-0" id="goalAchievement">0%</h4>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="score-item">
                    <div class="d-flex align-items-center mb-1">
                      <i class="bi bi-speedometer2 me-2"></i>
                      <small>Intensity</small>
                    </div>
                    <h4 class="mb-0" id="intensityScore">0%</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row g-3 mb-4">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card">
        <div class="card-body">
          <h5 class="card-title">Total Workouts</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-activity"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalWorkouts">0</h6>
              <span class="text-success small" id="workoutsTrend">
                <i class="bi bi-arrow-up"></i> 0%
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card">
        <div class="card-body">
          <h5 class="card-title">Avg Duration</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-clock-history"></i>
            </div>
            <div class="ps-3">
              <h6 id="avgDuration">0 min</h6>
              <span class="text-muted small" id="totalDuration">0h total</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card">
        <div class="card-body">
          <h5 class="card-title">Calories Burned</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-fire"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalCalories">0</h6>
              <span class="text-muted small" id="avgCalories">0 per workout</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xxl-3 col-md-6">
      <div class="card info-card">
        <div class="card-body">
          <h5 class="card-title">Active Streak</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-fire"></i>
            </div>
            <div class="ps-3">
              <h6 id="currentStreak">0 days</h6>
              <span class="text-warning small" id="longestStreak">Best: 0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Analytics Row (Full Width) -->
  <div class="row g-3 mb-4">
    <!-- Workout Distribution -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Workout Types</h5>
          <div style="height: 250px;">
            <canvas id="workoutTypeChart"></canvas>
          </div>
          <div id="workoutTypeStats" class="mt-3">
            <!-- Stats will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Trends (Widened to fill 8 columns) -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Performance Trends</h5>
          <div style="height: 250px;">
            <canvas id="performanceTrendChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Goals & Plans Analysis -->
  <div class="row g-3 mb-4">
    <!-- Goals Progress -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Goals Analysis</h5>
            <a href="{{ url_for('athlete.goals') }}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-6">
              <div class="text-center p-3 bg-light rounded">
                <h3 class="mb-1" id="completedGoals">0</h3>
                <small class="text-muted">Completed</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-3 bg-light rounded">
                <h3 class="mb-1" id="inProgressGoals">0</h3>
                <small class="text-muted">In Progress</small>
              </div>
            </div>
          </div>

          <div style="height: 200px;">
            <canvas id="goalsProgressChart"></canvas>
          </div>

          <div id="goalInsights" class="mt-3">
            <!-- Insights will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Plans Progress -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Training Plans</h5>
            <a href="{{ url_for('athlete.training_plans') }}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>

          <div id="plansList" style="max-height: 300px; overflow-y: auto;">
            <!-- Plans will be loaded here -->
          </div>

          <div id="planInsights" class="mt-3">
            <!-- Insights will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements & Milestones -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Recent Achievements üèÜ</h5>
          <div id="achievementsList" class="row g-3">
            <!-- Achievements will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Personal Records -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Personal Records</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <div class="record-card text-center p-3 bg-light rounded">
                <i class="bi bi-trophy-fill text-warning fs-2 mb-2"></i>
                <h4 class="mb-1" id="longestWorkout">0 min</h4>
                <small class="text-muted">Longest Workout</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="record-card text-center p-3 bg-light rounded">
                <i class="bi bi-fire text-danger fs-2 mb-2"></i>
                <h4 class="mb-1" id="mostCalories">0</h4>
                <small class="text-muted">Most Calories</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="record-card text-center p-3 bg-light rounded">
                <i class="bi bi-calendar-week text-primary fs-2 mb-2"></i>
                <h4 class="mb-1" id="mostProductiveWeek">0</h4>
                <small class="text-muted">Best Week</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="record-card text-center p-3 bg-light rounded">
                <i class="bi bi-lightning-charge-fill text-success fs-2 mb-2"></i>
                <h4 class="mb-1" id="avgIntensity">0%</h4>
                <small class="text-muted">Avg Intensity</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Recent Workouts -->
  <div class="row g-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Recent Workouts</h5>
            <a href="{{ url_for('athlete.workout_hub_page') }}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Title</th>
                  <th>Type</th>
                  <th>Duration</th>
                  <th>Calories</th>
                  <th>Intensity</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recentWorkoutsList">
                <tr>
                  <td colspan="7" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let charts = {};
let currentPeriod = 7;
let allWorkouts = [];
let allGoals = [];
let allPlans = [];

// Alert function
function alertShow(message, type = "info") {
// ... (alertShow logic remains the same)
  const icons = { success: 'check-circle-fill', danger: 'exclamation-triangle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
  const wrap = document.createElement("div");
  wrap.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;"><i class="bi bi-${icons[type]} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  document.body.appendChild(wrap);
  setTimeout(() => wrap.remove(), 4000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initCharts();
  fetchAllData();
  
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(b => {
        b.classList.remove('active', 'btn-primary');
        b.classList.add('btn-outline-primary');
      });
      this.classList.remove('btn-outline-primary');
      this.classList.add('active', 'btn-primary');
      currentPeriod = parseInt(this.dataset.days);
      analyzeData();
    });
  });
  
  document.getElementById('btnRefresh').addEventListener('click', function() {
    const btn = this;
    const icon = btn.querySelector('i');
    icon.style.animation = 'spin 1s linear infinite';
    btn.disabled = true;
    
    fetchAllData().finally(() => {
      setTimeout(() => {
        icon.style.animation = '';
        btn.disabled = false;
      }, 1000);
    });
  });
});

// Fetch all data
async function fetchAllData() {
  // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ access_token ŸáŸà ÿßŸÑÿ¥ÿßÿ¶ÿπ
  const token = localStorage.getItem('access_token') || localStorage.getItem('jwt_token'); 
  if (!token) {
    alertShow('Please log in to view progress', 'warning');
    return;
  }

  try {
    const [workouts, goals, plans] = await Promise.all([
      fetch('/athlete/api/workouts', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
      fetch('/athlete/api/goals', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
      fetch('/athlete/api/plans', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
    ]);
    
    allWorkouts = workouts;
    allGoals = goals;
    allPlans = plans;
    
    analyzeData();
    alertShow('Data loaded successfully!', 'success');
  } catch (error) {
    console.error('Error fetching data:', error);
    alertShow('Error loading data', 'danger');
  }
}

// Main analysis function
function analyzeData() {
  const periodDate = new Date();
  periodDate.setDate(periodDate.getDate() - currentPeriod);
  
  const filteredWorkouts = allWorkouts.filter(w => {
    const workoutDate = new Date(w.date);
    // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿµÿßŸÑÿ≠ ŸÇÿ®ŸÑ ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©
    return !isNaN(workoutDate) && workoutDate >= periodDate && w.completion_status === 'completed';
  });
  
  // Calculate all metrics
  calculatePerformanceScore(filteredWorkouts);
  calculateQuickStats(filteredWorkouts);
  analyzeWorkoutTypes(filteredWorkouts);
  analyzePerformanceTrends(filteredWorkouts);
  // *** ÿ™ŸÖ ÿ≠ÿ∞ŸÅ analyzeTimePatterns(filteredWorkouts); ***
  analyzeGoals();
  analyzePlans();
  calculateAchievements(filteredWorkouts);
  calculatePersonalRecords(allWorkouts);
  updateRecentWorkouts(allWorkouts.slice(0, 10));
}

// Calculate Performance Score
function calculatePerformanceScore(workouts) {
  const consistency = calculateConsistency(workouts);
  const improvement = calculateImprovement(workouts);
  const goalAchievement = calculateGoalAchievement();
  const intensity = calculateIntensity(workouts);
  
  const overall = Math.round((consistency + improvement + goalAchievement + intensity) / 4);
  
  document.getElementById('consistencyScore').textContent = consistency + '%';
  document.getElementById('improvementScore').textContent = improvement + '%';
  document.getElementById('goalAchievement').textContent = goalAchievement + '%';
  document.getElementById('intensityScore').textContent = intensity + '%';
  document.getElementById('performanceScore').textContent = overall;
  
  // Animate circle
  const circle = document.getElementById('performanceCircle');
  const circumference = 408.4;
  const offset = circumference - (overall / 100) * circumference;
  if (circle) circle.style.strokeDashoffset = offset;
}

// Calculate Consistency
function calculateConsistency(workouts) {
  if (workouts.length === 0) return 0;
  
  const uniqueDays = new Set(workouts.map(w => w.date)).size;
  const consistency = (uniqueDays / currentPeriod) * 100;
  
  return Math.min(Math.round(consistency * 1.5), 100); // Boost score
}

// Calculate Improvement
function calculateImprovement(workouts) {
  if (workouts.length < 2) return 50;
  
  const midPoint = Math.floor(workouts.length / 2);
  const firstHalf = workouts.slice(0, midPoint);
  const secondHalf = workouts.slice(midPoint);
  
  const avgFirst = firstHalf.reduce((sum, w) => sum + (w.calories_burned || 0), 0) / firstHalf.length;
  const avgSecond = secondHalf.reduce((sum, w) => sum + (w.calories_burned || 0), 0) / secondHalf.length;
  
  if (avgFirst === 0) return 50;
  
  const improvement = ((avgSecond - avgFirst) / avgFirst) * 100;
  return Math.min(Math.max(Math.round(50 + improvement), 0), 100);
}

// Calculate Goal Achievement
function calculateGoalAchievement() {
  if (allGoals.length === 0) return 0;
  
  const avgProgress = allGoals.reduce((sum, g) => sum + (g.progress || 0), 0) / allGoals.length;
  return Math.round(avgProgress);
}

// Calculate Intensity
function calculateIntensity(workouts) {
  if (workouts.length === 0) return 0;
  
  const avgCaloriesPerMin = workouts.reduce((sum, w) => {
    const duration = w.actual_duration || 1;
    const calories = w.calories_burned || 0;
    return sum + (calories / duration);
  }, 0) / workouts.length;
  
  // Assuming 10 cal/min is 100% intensity
  const intensity = (avgCaloriesPerMin / 10) * 100;
  return Math.min(Math.round(intensity), 100);
}

// Calculate Quick Stats
function calculateQuickStats(workouts) {
  const total = workouts.length;
  const totalDuration = workouts.reduce((sum, w) => sum + (w.actual_duration || 0), 0);
  const totalCalories = workouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
  
  document.getElementById('totalWorkouts').textContent = total;
  document.getElementById('avgDuration').textContent = total > 0 ? Math.round(totalDuration / total) + ' min' : '0 min';
  document.getElementById('totalDuration').textContent = Math.round(totalDuration / 60) + 'h total';
  document.getElementById('totalCalories').textContent = totalCalories.toLocaleString();
  document.getElementById('avgCalories').textContent = total > 0 ? Math.round(totalCalories / total) + ' per workout' : '0';
  
  // Calculate trend
  const prevPeriodDate = new Date();
  prevPeriodDate.setDate(prevPeriodDate.getDate() - (currentPeriod * 2));
  const prevPeriodEndDate = new Date();
  prevPeriodEndDate.setDate(prevPeriodEndDate.getDate() - currentPeriod);
  
  const prevWorkouts = allWorkouts.filter(w => {
    const date = new Date(w.date);
    return !isNaN(date) && date >= prevPeriodDate && date < prevPeriodEndDate && w.completion_status === 'completed';
  });
  
  const trend = prevWorkouts.length > 0 
    ? Math.round(((total - prevWorkouts.length) / prevWorkouts.length) * 100)
    : 0;
  
  const trendEl = document.getElementById('workoutsTrend');
  if (trendEl) {
    if (trend > 0) {
      trendEl.innerHTML = `<i class="bi bi-arrow-up"></i> +${trend}%`;
      trendEl.className = 'text-success small';
    } else if (trend < 0) {
      trendEl.innerHTML = `<i class="bi bi-arrow-down"></i> ${trend}%`;
      trendEl.className = 'text-danger small';
    } else {
      trendEl.innerHTML = `<i class="bi bi-dash"></i> 0%`;
      trendEl.className = 'text-muted small';
    }
  }
  
  // Calculate streaks
  calculateStreaks();
}

// Calculate Streaks
function calculateStreaks() {
  const sortedWorkouts = [...allWorkouts]
    .filter(w => w.completion_status === 'completed' && w.date && !isNaN(new Date(w.date)))
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  let currentStreak = 0;
  let longestStreak = 0;
  let tempStreak = 0;
  let lastDate = null;
  
  // Simple streak approximation for this scope (complex logic removed for brevity, using tempStreak)
  let maxStreak = 0;
  if (sortedWorkouts.length > 0) {
      maxStreak = 1;
      let prevDate = new Date(sortedWorkouts[0].date);
      for(let i = 1; i < sortedWorkouts.length; i++) {
          const currentDate = new Date(sortedWorkouts[i].date);
          const diff = Math.floor((prevDate.getTime() - currentDate.getTime()) / 86400000);
          if (diff === 1) {
              maxStreak++;
          } else if (diff > 1) {
              break; 
          }
          prevDate = currentDate;
      }
      currentStreak = maxStreak;
  }
  
  document.getElementById('currentStreak').textContent = currentStreak + ' days';
  document.getElementById('longestStreak').textContent = 'Best: ' + maxStreak;
}

// Analyze Workout Types
function analyzeWorkoutTypes(workouts) {
  const typeCount = {};
  workouts.forEach(w => {
    const type = w.workout_type || 'Other';
    typeCount[type] = (typeCount[type] || 0) + 1;
  });
  
  const types = Object.keys(typeCount);
  const counts = Object.values(typeCount);
  
  if (charts.workoutType) {
    charts.workoutType.data.labels = types;
    charts.workoutType.data.datasets[0].data = counts;
    charts.workoutType.update('none');
  }
  
  const statsEl = document.getElementById('workoutTypeStats');
  const statsHtml = types.map((type, i) => {
    const percent = Math.round((counts[i] / workouts.length) * 100);
    return `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="small">${type}</span>
        <span class="badge bg-primary">${counts[i]} (${percent}%)</span>
      </div>
    `;
  }).join('');
  
  if (statsEl) statsEl.innerHTML = statsHtml || '<p class="text-muted small">No data</p>';
}

// Analyze Performance Trends
function analyzePerformanceTrends(workouts) {
  const dateMap = {};
  workouts.forEach(w => {
    if (w.date && !isNaN(new Date(w.date))) {
      if (!dateMap[w.date]) {
        dateMap[w.date] = { calories: 0, duration: 0, count: 0 };
      }
      dateMap[w.date].calories += w.calories_burned || 0;
      dateMap[w.date].duration += w.actual_duration || 0;
      dateMap[w.date].count++;
    }
  });
  
  const dates = Object.keys(dateMap).sort();
  const labels = dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  const caloriesData = dates.map(d => dateMap[d].calories);
  const durationData = dates.map(d => dateMap[d].duration);
  
  if (charts.performanceTrend) {
    charts.performanceTrend.data.labels = labels;
    charts.performanceTrend.data.datasets[0].data = caloriesData;
    charts.performanceTrend.data.datasets[1].data = durationData;
    charts.performanceTrend.update('none');
  }
}

// Analyze Goals
function analyzeGoals() {
  const completed = allGoals.filter(g => (g.progress || 0) >= 100).length;
  const inProgress = allGoals.filter(g => (g.progress || 0) > 0 && (g.progress || 0) < 100).length;
  const notStarted = allGoals.filter(g => (g.progress || 0) === 0).length;
  
  document.getElementById('completedGoals').textContent = completed;
  document.getElementById('inProgressGoals').textContent = inProgress;
  
  if (charts.goalsProgress) {
    charts.goalsProgress.data.datasets[0].data = [completed, inProgress, notStarted];
    charts.goalsProgress.update('none');
  }
  
  // Goals insights
  const insights = [];
  
  if (completed > 0) {
    insights.push(`<div class="alert alert-success py-2"><i class="bi bi-check-circle me-2"></i>You've completed ${completed} goal${completed > 1 ? 's' : ''}! üéâ</div>`);
  }
  
  if (inProgress > 0) {
    const inProgressGoals = allGoals.filter(g => (g.progress || 0) > 0 && (g.progress || 0) < 100);
    const avgProgress = Math.round(inProgressGoals.reduce((sum, g) => sum + (g.progress || 0), 0) / inProgressGoals.length);
    insights.push(`<div class="alert alert-info py-2"><i class="bi bi-graph-up me-2"></i>${inProgress} goal${inProgress > 1 ? 's' : ''} in progress (${avgProgress}% avg)</div>`);
  }
  
  const overdue = allGoals.filter(g => {
    if (!g.due_date || (g.progress || 0) >= 100) return false;
    return new Date(g.due_date) < new Date();
  }).length;
  
  if (overdue > 0) {
    insights.push(`<div class="alert alert-warning py-2"><i class="bi bi-exclamation-triangle me-2"></i>${overdue} goal${overdue > 1 ? 's are' : ' is'} overdue</div>`);
  }
  
  const goalInsightsEl = document.getElementById('goalInsights');
  if (goalInsightsEl) goalInsightsEl.innerHTML = insights.length > 0 
    ? insights.join('') 
    : '<p class="text-muted small mb-0">Set goals to track your progress!</p>';
}

// Analyze Plans
function analyzePlans() {
  const active = allPlans.filter(p => p.status === 'active');
  const completed = allPlans.filter(p => p.status === 'completed');
  
  const plansListEl = document.getElementById('plansList');
  const plansHtml = active.slice(0, 5).map(plan => {
    const progress = plan.progress || 0;
    const statusColor = progress >= 75 ? 'success' : progress >= 40 ? 'primary' : 'warning';
    
    return `
      <div class="plan-item mb-3 pb-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-semibold">${plan.title}</span>
          <span class="badge bg-${statusColor}">${progress}%</span>
        </div>
        <div class="progress mb-2" style="height: 6px;">
          <div class="progress-bar bg-${statusColor}" style="width: ${progress}%"></div>
        </div>
        <div class="d-flex justify-content-between text-muted small">
          <span>${plan.duration_weeks} weeks</span>
          <span>${plan.end_date ? new Date(plan.end_date).toLocaleDateString() : 'No end date'}</span>
        </div>
      </div>
    `;
  }).join('');
  
  if (plansListEl) plansListEl.innerHTML = plansHtml || 
    '<div class="text-center py-4"><p class="text-muted">No active plans</p></div>';
  
  // Plan insights
  const insights = [];
  
  if (completed.length > 0) {
    insights.push(`<div class="alert alert-success py-2"><i class="bi bi-trophy me-2"></i>Completed ${completed.length} training plan${completed.length > 1 ? 's' : ''}!</div>`);
  }
  
  if (active.length > 0) {
    const avgProgress = Math.round(active.reduce((sum, p) => sum + (p.progress || 0), 0) / active.length);
    insights.push(`<div class="alert alert-info py-2"><i class="bi bi-clipboard-check me-2"></i>${active.length} active plan${active.length > 1 ? 's' : ''} (${avgProgress}% avg progress)</div>`);
  }
  
  const planInsightsEl = document.getElementById('planInsights');
  if (planInsightsEl) planInsightsEl.innerHTML = insights.join('');
}

// Calculate Achievements
function calculateAchievements(workouts) {
  const achievements = [];
  
  const completedWorkouts = allWorkouts.filter(w => w.completion_status === 'completed');
  
  // Workout milestones
  const totalWorkouts = completedWorkouts.length;
  if (totalWorkouts >= 100) achievements.push({ icon: 'üíØ', title: 'Century Club', desc: '100 workouts completed' });
  else if (totalWorkouts >= 50) achievements.push({ icon: 'üéñÔ∏è', title: 'Half Century', desc: '50 workouts completed' });
  else if (totalWorkouts >= 25) achievements.push({ icon: '‚≠ê', title: 'Quarter Master', desc: '25 workouts completed' });
  
  // Calorie burner
  const totalCalories = completedWorkouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
  if (totalCalories >= 50000) achievements.push({ icon: 'üî•', title: 'Inferno', desc: '50,000+ calories burned' });
  else if (totalCalories >= 25000) achievements.push({ icon: 'üåã', title: 'Volcano', desc: '25,000+ calories burned' });
  else if (totalCalories >= 10000) achievements.push({ icon: 'üèÆ', title: 'Flame Master', desc: '10,000+ calories burned' });
  
  // Consistency
  const uniqueDays = new Set(workouts.map(w => w.date)).size;
  const consistency = (uniqueDays / currentPeriod) * 100;
  if (consistency >= 80) achievements.push({ icon: '‚ö°', title: 'Consistency King', desc: '80%+ attendance' });
  else if (consistency >= 60) achievements.push({ icon: 'üí™', title: 'Regular', desc: '60%+ attendance' });
  
  // Goals
  const completedGoals = allGoals.filter(g => (g.progress || 0) >= 100).length;
  if (completedGoals >= 10) achievements.push({ icon: 'üèÜ', title: 'Goal Crusher', desc: '10 goals completed' });
  else if (completedGoals >= 5) achievements.push({ icon: 'üéØ', title: 'Achiever', desc: '5 goals completed' });
  
  // Duration
  const totalHours = completedWorkouts.reduce((sum, w) => sum + (w.actual_duration || 0), 0) / 60;
  if (totalHours >= 100) achievements.push({ icon: '‚è∞', title: 'Time Master', desc: '100+ hours trained' });
  else if (totalHours >= 50) achievements.push({ icon: '‚åö', title: 'Dedicated', desc: '50+ hours trained' });
  
  const achievementsHtml = achievements.map(a => `
    <div class="col-md-4 col-lg-3">
      <div class="achievement-card text-center p-3 bg-light rounded border border-primary">
        <div class="fs-1 mb-2">${a.icon}</div>
        <h6 class="mb-1">${a.title}</h6>
        <small class="text-muted">${a.desc}</small>
      </div>
    </div>
  `).join('');
  
  const achievementsListEl = document.getElementById('achievementsList');
  if (achievementsListEl) achievementsListEl.innerHTML = achievementsHtml || 
    '<div class="col-12 text-center py-3"><p class="text-muted">Keep training to unlock achievements!</p></div>';
}

// Calculate Personal Records
function calculatePersonalRecords(workouts) {
  const completed = workouts.filter(w => w.completion_status === 'completed');
  
  if (completed.length === 0) {
    document.getElementById('longestWorkout').textContent = '0 min';
    document.getElementById('mostCalories').textContent = '0';
    document.getElementById('mostProductiveWeek').textContent = '0';
    document.getElementById('avgIntensity').textContent = '0%';
    return;
  }
  
  // Longest workout
  const longest = Math.max(...completed.map(w => w.actual_duration || 0));
  document.getElementById('longestWorkout').textContent = longest + ' min';
  
  // Most calories
  const mostCals = Math.max(...completed.map(w => w.calories_burned || 0));
  document.getElementById('mostCalories').textContent = mostCals.toLocaleString();
  
  // Most productive week
  const weekMap = {};
  completed.forEach(w => {
    if (w.date && !isNaN(new Date(w.date))) {
      const date = new Date(w.date);
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - date.getDay());
      const weekKey = weekStart.toISOString().split('T')[0];
      weekMap[weekKey] = (weekMap[weekKey] || 0) + 1;
    }
  });
  const bestWeek = Object.keys(weekMap).length > 0 ? Math.max(...Object.values(weekMap)) : 0;
  document.getElementById('mostProductiveWeek').textContent = bestWeek + ' workouts';
  
  // Average intensity
  const avgIntensity = completed.reduce((sum, w) => {
    const duration = w.actual_duration || 1;
    const calories = w.calories_burned || 0;
    return sum + (calories / duration);
  }, 0) / completed.length;
  
  const intensityPercent = Math.min(Math.round((avgIntensity / 10) * 100), 100);
  document.getElementById('avgIntensity').textContent = intensityPercent + '%';
}

// Update Recent Workouts
function updateRecentWorkouts(workouts) {
  const tbody = document.getElementById('recentWorkoutsList');
  if (!tbody) return; 

  tbody.innerHTML = '';

  if (workouts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-muted">No workouts recorded yet</td></tr>';
    return;
  }

  workouts.forEach(workout => {
    const statusBadge = {
      'completed': 'bg-success',
      'in_progress': 'bg-primary',
      'missed': 'bg-danger',
      'partial': 'bg-warning'
    }[workout.completion_status] || 'bg-secondary';

    const intensity = workout.actual_duration > 0 
      ? Math.min(Math.round(((workout.calories_burned || 0) / workout.actual_duration) * 10), 100)
      : 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(workout.date).toLocaleDateString()}</td>
      <td><strong>${workout.title || 'Workout'}</strong></td>
      <td><span class="badge bg-light text-dark">${workout.workout_type || 'N/A'}</span></td>
      <td>${workout.actual_duration || 0} min</td>
      <td>${workout.calories_burned || 0} kcal</td>
      <td>
        <div class="progress" style="height: 20px; min-width: 60px;">
          <div class="progress-bar ${intensity >= 70 ? 'bg-danger' : intensity >= 40 ? 'bg-warning' : 'bg-success'}" 
               style="width: ${intensity}%">${intensity}%</div>
        </div>
      </td>
      <td><span class="badge ${statusBadge}">${workout.completion_status}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

// Initialize Charts (Removed hourChart and weekdayChart initialization)
function initCharts() {
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 750 }
  };

  const workoutTypeCtx = document.getElementById('workoutTypeChart');
  if (workoutTypeCtx) {
    charts.workoutType = new Chart(workoutTypeCtx, {
      type: 'doughnut',
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: ['#4154f1', '#2eca6a', '#ff771d', '#ffbb2c', '#e74c3c', '#9b59b6']
        }]
      },
      options: {
        ...commonOptions,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  const performanceTrendCtx = document.getElementById('performanceTrendChart');
  if (performanceTrendCtx) {
    charts.performanceTrend = new Chart(performanceTrendCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Calories',
            data: [],
            borderColor: '#ff6384',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderWidth: 2,
            yAxisID: 'y',
            tension: 0.4
          },
          {
            label: 'Duration (min)',
            data: [],
            borderColor: '#36a2eb',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            yAxisID: 'y1',
            tension: 0.4
          }
        ]
      },
      options: {
        ...commonOptions,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: true, text: 'Calories' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: { display: true, text: 'Minutes' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  }

  const goalsProgressCtx = document.getElementById('goalsProgressChart');
  if (goalsProgressCtx) {
    charts.goalsProgress = new Chart(goalsProgressCtx, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'In Progress', 'Not Started'],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: ['#2eca6a', '#4154f1', '#e0e0e0']
        }]
      },
      options: {
        ...commonOptions,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }
}

// Add CSS
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .card-icon {
    width: 64px;
    height: 64px;
    font-size: 32px;
  }
  
  .sales-card .card-icon {
    color: #4154f1;
    background: #f6f6fe;
  }
  
  .performance-score-circle {
    position: relative;
    display: inline-block;
  }
  
  .score-item {
    padding: 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
  }
  
  .achievement-card {
    transition: all 0.3s;
  }
  
  .achievement-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .record-card {
    transition: all 0.3s;
  }
  
  .record-card:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(65, 84, 241, 0.05);
  }
  
  .plan-item:last-child {
    border-bottom: none !important;
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}
