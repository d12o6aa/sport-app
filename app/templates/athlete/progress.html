{% extends "shared/base.html" %}

{% block style %}
<style>
  body {
    background: #f8f9fc;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  /* [Previous CSS styles remain unchanged] */
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 0 0.5rem;
  }

  .header-stats {
    display: flex;
    gap: 2rem;
    color: #64748b;
    font-size: 0.9rem;
  }

  .period-tabs {
    display: flex;
    background: white;
    border-radius: 8px;
    padding: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .period-tab {
    padding: 8px 16px;
    border: none;
    background: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
  }

  .period-tab.active {
    background: #10b981;
    color: white;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 280px 280px 1fr 280px;
    gap: 20px;
    margin-bottom: 24px;
  }

  .card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: none;
    position: relative;
    overflow: hidden;
  }

  .health-score-card {
    background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
    color: white;
  }

  .heart-card {
    background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%);
    color: #2d3748;
  }

  .weight-card {
    background: linear-gradient(135deg, #ffd3a5 0%, #fd9853 100%);
    color: #2d3748;
  }

  .workout-goals-card {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #2d3748;
  }

  .card-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
    opacity: 0.8;
  }

  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0.5rem 0;
    line-height: 1;
  }

  .metric-subtitle {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .metric-description {
    font-size: 0.8rem;
    opacity: 0.8;
    line-height: 1.3;
  }

  .progress-circle {
    width: 100px;
    height: 100px;
    margin: 16px auto;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .progress-circle svg {
    transform: rotate(-90deg);
    width: 100%;
    height: 100%;
  }

  .progress-circle .circle-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.2);
    stroke-width: 8;
  }

  .progress-circle .circle-progress {
    fill: none;
    stroke: #10b981;
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dasharray 1s ease;
  }

  .progress-text {
    position: absolute;
    text-align: center;
    font-weight: 700;
  }

  .progress-text .percentage {
    font-size: 1.5rem;
    display: block;
  }

  .progress-text .label {
    font-size: 0.7rem;
    opacity: 0.8;
  }

  .mini-chart {
    height: 40px;
    margin-top: 12px;
  }

  .weight-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }

  .weight-stat {
    text-align: center;
  }

  .weight-stat-label {
    font-size: 0.7rem;
    opacity: 0.8;
    margin-bottom: 4px;
  }

  .weight-stat-value {
    font-size: 1.1rem;
    font-weight: 700;
  }

  .second-row {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  .goals-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .goal-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f1f5f9;
  }

  .goal-item:last-child {
    border-bottom: none;
  }

  .goal-icon {
    width: 32px;
    height: 32px;
    background: #e2e8f0;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 0.9rem;
  }

  .goal-content {
    flex: 1;
  }

  .goal-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 2px;
  }

  .goal-subtitle {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 6px;
  }

  .goal-progress {
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 4px;
  }

  .goal-progress-bar {
    height: 100%;
    background: #10b981;
    transition: width 0.8s ease;
  }

  .goal-percentage {
    font-size: 0.75rem;
    font-weight: 600;
    color: #10b981;
  }

  .activity-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: relative;
  }

  .chart-container {
    height: 200px;
    margin-top: 16px;
  }

  .third-row {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
  }

  .calories-card {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    position: relative;
  }

  .nutrition-bars {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
  }

  .nutrition-bar {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 12px;
    backdrop-filter: blur(10px);
  }

  .nutrition-bar-label {
    font-size: 0.7rem;
    opacity: 0.9;
    margin-bottom: 4px;
  }

  .nutrition-bar-value {
    font-size: 0.9rem;
    font-weight: 600;
  }

  .sidebar-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    height: fit-content;
  }

  .body-metric {
    text-align: center;
    padding: 16px;
    margin: 8px 0;
    background: #f8fafc;
    border-radius: 12px;
  }

  .body-metric-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1e293b;
  }

  .body-metric-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 4px;
  }

  .body-metric-status {
    font-size: 0.75rem;
    color: #10b981;
    font-weight: 500;
  }

  @media (max-width: 1200px) {
    .dashboard-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .second-row, .third-row {
      grid-template-columns: 1fr;
    }
  }

  .subscription-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    max-width: 400px;
  }
</style>
{% endblock %}

{% block content %}
<section class="section dashboard">
  <div class="container-fluid">
    <!-- Header -->
    <div class="dashboard-header">
      <div>
        <h5 class="mb-1" style="color: #1e293b; font-weight: 600;">Progress & Insights</h5>
        <div class="header-stats">
          <span><strong>Workout Time</strong> <span id="workoutTime">0 Hours 0 Minutes</span></span>
          <span><strong>Total Workout</strong> <span id="totalWorkouts">0 Exercises</span></span>
        </div>
      </div>
      <div class="period-tabs">
        <button class="period-tab active" data-period="week">This Week</button>
        <button class="period-tab" data-period="month">This Month</button>
        <button class="period-tab" data-period="3months">3 Months</button>
      </div>
    </div>

    <!-- Subscription Status Alert -->
    <div id="subscriptionAlert" class="subscription-alert" style="display: none;"></div>

    <!-- Top Row - Main Metrics -->
    <div class="dashboard-grid">
      <!-- Health Score -->
      <div class="card health-score-card">
        <div class="card-title">Health Score</div>
        <div class="metric-value" id="healthScore">0%</div>
        <div class="metric-subtitle" id="healthStatus">N/A</div>
        <div class="metric-description" id="healthAdvice">Loading health data...</div>
      </div>

      <!-- Heart Beat -->
      <div class="card heart-card">
        <div class="card-title">Heart Beat</div>
        <div class="metric-value" id="heartRate">0 <small style="font-size: 0.6em;">bpm</small></div>
        <div class="metric-subtitle" id="heartStatus">N/A</div>
        <div class="metric-description">Loading heart rate data...</div>
        <canvas class="mini-chart" id="heartRateChart"></canvas>
      </div>

      <!-- Weight Data -->
      <div class="card weight-card">
        <div class="card-title">Weight Data</div>
        <div class="weight-stats">
          <div class="weight-stat">
            <div class="weight-stat-label">Current Weight</div>
            <div class="weight-stat-value" id="currentWeight">0 kg</div>
          </div>
          <div class="weight-stat">
            <div class="weight-stat-label">Weight Goal</div>
            <div class="weight-stat-value" id="weightGoal">0 kg</div>
          </div>
        </div>
        <div class="weight-stat">
          <div class="weight-stat-label">Progress</div>
          <div class="weight-stat-value" id="weightProgress">0%</div>
        </div>
        <canvas class="mini-chart" id="weightChart"></canvas>
      </div>

      <!-- Workout Goals -->
      <div class="card workout-goals-card">
        <div class="card-title">Workout Goals</div>
        <div class="progress-circle">
          <svg>
            <circle class="circle-bg" cx="50" cy="50" r="40"></circle>
            <circle class="circle-progress" cx="50" cy="50" r="40" 
                    stroke-dasharray="251.2" stroke-dashoffset="251.2" id="goalProgressCircle"></circle>
          </svg>
          <div class="progress-text">
            <span class="percentage" id="goalsPercentage">0%</span>
            <span class="label" id="goalsCompleted">0/0 Completed</span>
          </div>
        </div>
        <div class="metric-description" id="goalsDescription">Loading goals...</div>
      </div>
    </div>

    <!-- Second Row -->
    <div class="second-row">
      <!-- Goals List -->
      <div class="goals-card">
        <h6 style="margin-bottom: 20px; color: #1e293b; font-weight: 600;">Goals List</h6>
        <div id="goalsList">
          <!-- Goals will be loaded dynamically -->
        </div>
      </div>

      <!-- Workout Activity -->
      <div class="card activity-card">
        <div class="card-title">Workout Activity</div>
        <div class="chart-container">
          <canvas id="workoutActivityChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Third Row -->
    <div class="third-row">
      <!-- Calories Statistic -->
      <div class="card calories-card">
        <div class="card-title">Calories Statistic</div>
        <div class="chart-container" style="height: 240px;">
          <canvas id="caloriesChart"></canvas>
        </div>
        
        <div class="nutrition-bars">
          <div class="nutrition-bar">
            <div class="nutrition-bar-label">Calories</div>
            <div class="nutrition-bar-value" id="caloriesValue">0/0 cal</div>
          </div>
          <div class="nutrition-bar">
            <div class="nutrition-bar-label">Protein</div>
            <div class="nutrition-bar-value" id="proteinValue">0/0 gr</div>
          </div>
          <div class="nutrition-bar">
            <div class="nutrition-bar-label">Carbs</div>
            <div class="nutrition-bar-value" id="carbsValue">0/0 gr</div>
          </div>
          <div class="nutrition-bar">
            <div class="nutrition-bar-label">Fats</div>
            <div class="nutrition-bar-value" id="fatsValue">0/0 gr</div>
          </div>
        </div>
      </div>

      <!-- Body Analytics Sidebar -->
      <div class="sidebar-card">
        <h6 style="margin-bottom: 20px; color: #1e293b; font-weight: 600;">Body Analytics</h6>
        
        <div class="body-metric">
          <div class="body-metric-label">BMI Index</div>
          <div class="body-metric-value" id="bmiValue">0</div>
          <div class="body-metric-status">N/A</div>
        </div>
        
        <div class="body-metric">
          <div class="body-metric-label">Body Fat</div>
          <div class="body-metric-value" id="bodyFatValue">0%</div>
          <div class="body-metric-status">N/A</div>
        </div>
        
        <div class="body-metric">
          <div class="body-metric-label">Muscle Mass</div>
          <div class="body-metric-value" id="muscleMassValue">0 kg</div>
          <div class="body-metric-status">N/A</div>
        </div>
      </div>
    </div>

    <!-- Subscribe Modal -->
    <div class="modal fade" id="subscribeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-plus me-2"></i>Subscribe to Continue</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="subscribeForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Selected Plan</label>
                  <div class="selected-plan-info p-3 bg-light rounded">
                    <h6 id="selectedPlanName">-</h6>
                    <div class="price">
                      <span class="h4 text-primary" id="selectedPlanPrice">$0.00</span>
                      <span class="text-muted">/month</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Billing Cycle</label>
                  <select name="billing_cycle" class="form-select" onchange="updatePricing()">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly (10% off)</option>
                    <option value="yearly">Yearly (20% off)</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-12">
                  <label class="form-label">Payment Method</label>
                  <div class="payment-methods">
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="payment_method" value="card" checked disabled>
                      <label class="form-check-label">
                        <i class="bi bi-credit-card me-2"></i>Credit/Debit Card (via Paymob)
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div id="paymob-iframe-container" style="width: 100%; height: 400px; border: 1px solid #ccc; display: none;">
                <iframe id="paymob-iframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="trial_enabled" id="trialEnabled">
                <label class="form-check-label" for="trialEnabled">
                  <i class="bi bi-gift me-2"></i>Start with 14-day free trial
                </label>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="auto_renew" id="autoRenew" checked>
                <label class="form-check-label" for="autoRenew">
                  <i class="bi bi-arrow-repeat me-2"></i>Enable auto-renewal
                </label>
              </div>

              <input type="hidden" name="plan_id" id="subscriptionPlanId">
            </form>

            <div class="subscription-summary p-3 bg-light rounded">
              <div class="d-flex justify-content-between">
                <span>Subtotal:</span>
                <span id="subtotalAmount">$0.00</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Discount:</span>
                <span id="discountAmount" class="text-success">$0.00</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span id="totalAmount">$0.00</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" form="subscribeForm" class="btn btn-success">
              <i class="bi bi-credit-card me-2"></i>Pay via Paymob
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
let charts = {};
let currentPlanPrice = 0;
let currentPlanId = null;
const athleteId = {{ athlete_id | tojson }}; // Passed from the backend

// Fetch athlete progress data
function fetchProgressData(period = 'week') {
  if (!athleteId) {
    showAlert('User not authenticated. Please log in.', 'danger');
    window.location.href = '/login';
    return;
  }

  fetch(`/athlete/${athleteId}/progress?period=${period}`, {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
    }
  })
  .then(response => {
    if (response.status === 401) {
      showAlert('Session expired. Please log in again.', 'danger');
      window.location.href = '/login';
      return;
    }
    return response.json();
  })
  .then(data => {
    if (data) {
      updateDashboard(data);
      updateCharts(data);
    }
  })
  .catch(error => {
    showAlert('Error loading progress data: ' + error.message, 'danger');
  });
}

// Check subscription status
function checkSubscriptionStatus() {
  fetch('/athlete/api/subscription_status', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
    }
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success || data.status !== 'active') {
      showSubscriptionAlert();
      loadAvailablePlans();
    }
  })
  .catch(error => {
    showAlert('Error checking subscription status: ' + error.message, 'danger');
  });
}

// Load available plans for subscription modal
function loadAvailablePlans() {
  fetch('/athlete/api/available_plans', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.plans.length > 0) {
      const plan = data.plans[0]; // Default to first plan
      currentPlanId = plan.id;
      currentPlanPrice = plan.price;
      $('#selectedPlanName').text(plan.name);
      $('#selectedPlanPrice').text(`$${plan.price.toFixed(2)}`);
      $('#subscriptionPlanId').val(plan.id);
      updatePricing();
    }
  })
  .catch(error => {
    showAlert('Error loading plans: ' + error.message, 'danger');
  });
}

// Update dashboard with progress data
function updateDashboard(data) {
  const latest = data.length > 0 ? data[data.length - 1] : {};
  
  // Update header stats
  const totalWorkouts = data.reduce((sum, record) => sum + (record.workouts || 0), 0);
  const totalMinutes = totalWorkouts * 30; // Assuming average 30 min per workout
  $('#workoutTime').text(`${Math.floor(totalMinutes / 60)} Hours ${totalMinutes % 60} Minutes`);
  $('#totalWorkouts').text(`${totalWorkouts} Exercises`);

  // Update health score
  const healthScore = calculateHealthScore(data);
  $('#healthScore').text(`${healthScore}%`);
  $('#healthStatus').text(healthScore > 80 ? 'Very Healthy' : healthScore > 60 ? 'Healthy' : 'Needs Improvement');
  $('#healthAdvice').text(healthScore > 80 ? 'Keep up your good work!' : 'Consider increasing workout intensity.');

  // Update heart rate (using static value since not in AthleteProgress)
  $('#heartRate').html(`${latest.heart_rate || 0} <small style="font-size: 0.6em;">bpm</small>`);
  $('#heartStatus').text(latest.heart_rate ? (latest.heart_rate < 100 ? 'Normal' : 'Elevated') : 'N/A');

  // Update weight data
  $('#currentWeight').text(`${latest.weight || 0} kg`);
  $('#weightGoal').text(`${latest.weight_goal || 65} kg`);
  const weightProgress = latest.weight && latest.weight_goal ? 
    Math.round(((latest.weight_goal - latest.weight) / latest.weight_goal) * 100) : 0;
  $('#weightProgress').text(`${weightProgress}%`);

  // Update workout goals
  const totalGoals = 20; // Example total
  const completedGoals = data.reduce((sum, record) => sum + (record.workouts || 0), 0);
  const goalsPercentage = Math.round((completedGoals / totalGoals) * 100);
  $('#goalsPercentage').text(`${goalsPercentage}%`);
  $('#goalsCompleted').text(`${completedGoals}/${totalGoals} Completed`);
  $('#goalsDescription').text(goalsPercentage > 75 ? 'Almost there! Keep pushing!' : 'Keep working towards your goals!');
  const offset = 251.2 * (1 - goalsPercentage / 100);
  $('#goalProgressCircle').attr('stroke-dashoffset', offset);

  // Update nutrition (using static values since not in AthleteProgress)
  $('#caloriesValue').text(`${latest.calories || 0}/2500 cal`);
  $('#proteinValue').text(`${latest.protein || 0}/52 gr`);
  $('#carbsValue').text(`${latest.carbs || 0}/120 gr`);
  $('#fatsValue').text(`${latest.fats || 0}/68 gr`);

  // Update body analytics (using static values since not in AthleteProgress)
  $('#bmiValue').text(latest.bmi || 0);
  $('#bmiValue').next().text(latest.bmi ? (latest.bmi < 25 ? 'Normal Weight' : 'Overweight') : 'N/A');
  $('#bodyFatValue').text(`${latest.body_fat || 0}%`);
  $('#bodyFatValue').next().text(latest.body_fat ? (latest.body_fat < 20 ? 'Athletic Range' : 'Normal') : 'N/A');
  $('#muscleMassValue').text(`${latest.muscle_mass || 0} kg`);
  $('#muscleMassValue').next().text(latest.muscle_mass ? 'Increasing' : 'N/A');
}

// Update charts with progress data
function updateCharts(data) {
  // Heart Rate Chart (using static data)
  charts.heart.data.labels = data.map(record => record.date.split('T')[0]);
  charts.heart.data.datasets[0].data = data.map(record => record.heart_rate || 65); // Fallback
  charts.heart.update();

  // Weight Chart
  charts.weight.data.labels = data.map(record => record.date.split('T')[0]);
  charts.weight.data.datasets[0].data = data.map(record => record.weight || 0);
  charts.weight.update();

  // Workout Activity Chart
  charts.activity.data.labels = data.map(record => record.date.split('T')[0]);
  charts.activity.data.datasets = data.map((record, index) => ({
    label: record.date.split('T')[0],
    data: Array(data.length).fill(0).map((_, i) => i === index ? (record.workouts || 0) * 30 : 0),
    backgroundColor: '#ffa726',
    borderRadius: 4
  }));
  charts.activity.update();

  // Calories Chart
  charts.calories.data.labels = data.map(record => record.date.split('T')[0]);
  charts.calories.data.datasets[0].data = data.map(record => record.calories || 0);
  charts.calories.data.datasets[1].data = data.map(record => (record.calories || 0) * 0.3); // Example resting
  charts.calories.update();
}

// Calculate health score (example logic)
function calculateHealthScore(data) {
  if (!data.length) return 0;
  const latest = data[data.length - 1];
  let score = 50; // Base score
  if (latest.weight && latest.weight_goal) {
    score += (latest.weight <= latest.weight_goal) ? 20 : 10;
  }
  if (latest.workouts > 5) score += 20;
  if (latest.heart_rate && latest.heart_rate < 100) score += 10;
  return Math.min(score, 100);
}

// Initialize charts
function initCharts() {
  // Heart Rate Mini Chart
  const heartCtx = document.getElementById('heartRateChart');
  charts.heart = new Chart(heartCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        data: [],
        borderColor: '#e74c3c',
        borderWidth: 2,
        fill: false,
        tension: 0.4,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { display: false }, x: { display: false } },
      elements: { point: { radius: 0 } }
    }
  });

  // Weight Mini Chart
  const weightCtx = document.getElementById('weightChart');
  charts.weight = new Chart(weightCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        data: [],
        borderColor: '#2d3748',
        backgroundColor: 'rgba(45, 55, 72, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 2,
        pointBackgroundColor: '#2d3748'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { display: false },
        x: { 
          ticks: { color: '#2d3748', font: { size: 9 } },
          grid: { display: false }
        }
      }
    }
  });

  // Workout Activity Chart
  const activityCtx = document.getElementById('workoutActivityChart');
  charts.activity = new Chart(activityCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          display: false,
          stacked: false
        },
        x: {
          stacked: false,
          ticks: { color: 'white', font: { size: 11 } },
          grid: { display: false }
        }
      }
    }
  });

  // Calories Chart
  const caloriesCtx = document.getElementById('caloriesChart');
  charts.calories = new Chart(caloriesCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Active',
          data: [],
          backgroundColor: '#4dd0e1',
          borderRadius: 4
        },
        {
          label: 'Resting',
          data: [],
          backgroundColor: '#80deea',
          borderRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { 
            color: 'white',
            font: { size: 11 },
            usePointStyle: true,
            padding: 15
          }
        }
      },
      scales: {
        y: {
          stacked: true,
          ticks: { color: 'white', font: { size: 10 } },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          stacked: true,
          ticks: { color: 'white', font: { size: 10 } },
          grid: { display: false }
        }
      }
    }
  });
}

// Show subscription alert
function showSubscriptionAlert() {
  const alertHtml = `
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      Your subscription is not active. Please subscribe to access all features.
      <button class="btn btn-sm btn-primary ms-2" onclick="showSubscribeModal()">Subscribe Now</button>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;
  $('#subscriptionAlert').html(alertHtml).show();
}

// Show subscribe modal
function showSubscribeModal() {
  $('#subscribeModal').modal('show');
}

// Update pricing in subscribe modal
function updatePricing() {
  const billingCycle = $('select[name="billing_cycle"]').val();
  const isTrialEnabled = $('#trialEnabled').is(':checked');
  let price = currentPlanPrice;
  let discount = 0;
  if (billingCycle === 'quarterly') {
    price = currentPlanPrice * 3 * 0.9;
    discount = currentPlanPrice * 3 * 0.1;
  } else if (billingCycle === 'yearly') {
    price = currentPlanPrice * 12 * 0.8;
    discount = currentPlanPrice * 12 * 0.2;
  }
  const subtotal = isTrialEnabled ? 0 : price;
  const total = subtotal;
  $('#subtotalAmount').text(isTrialEnabled ? '$0.00 (Trial)' : `$${price.toFixed(2)}`);
  $('#discountAmount').text(`$${discount.toFixed(2)}`);
  $('#totalAmount').text(`$${total.toFixed(2)}`);
}

// Subscribe form submission
$('#subscribeForm').on('submit', function(e) {
  e.preventDefault();
  if (!currentPlanId) {
    showAlert('Please select a plan to subscribe to', 'danger');
    return;
  }
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  data.auto_renew = data.auto_renew === 'on';
  data.trial_enabled = data.trial_enabled === 'on';
  data.plan_id = currentPlanId;
  fetch('/athlete/api/subscribe', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert(data.message, 'success');
      if (data.payment_url && data.iframe_id) {
        const iframe = $('#paymob-iframe');
        iframe.attr('src', data.payment_url);
        $('#paymob-iframe-container').show();
        $('#subscribeForm').hide();
      } else if (data.payment_url) {
        window.location.href = data.payment_url;
      } else {
        $('#subscribeModal').modal('hide');
        location.reload();
      }
    } else {
      showAlert(data.error, 'danger');
    }
  })
  .catch(error => {
    showAlert('Error creating subscription: ' + error.message, 'danger');
  });
}

// Show alert
function showAlert(message, type) {
  const alertContainer = $('<div>').addClass(`alert alert-${type} alert-dismissible fade show`)
    .attr('role', 'alert')
    .css({
      'position': 'fixed',
      'top': '20px',
      'right': '20px',
      'z-index': '1050',
      'min-width': '300px'
    });
  alertContainer.html(`
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `);
  $('body').append(alertContainer);
  setTimeout(() => {
    alertContainer.alert('close');
  }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initCharts();
  fetchProgressData('week');
  checkSubscriptionStatus();

  // Period tabs
  document.querySelectorAll('.period-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const period = this.dataset.period;
      fetchProgressData(period);
    });
  });

  // Trial checkbox handler
  $('#trialEnabled').change(function() {
    updatePricing();
  });
});
</script>
{% endblock %}