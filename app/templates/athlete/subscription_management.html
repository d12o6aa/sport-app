{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
    <h1><i class="bi bi-crown me-2"></i>My Subscription</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('athlete.dashboard') }}">Home</a></li>
            <li class="breadcrumb-item active">Subscription</li>
        </ol>
    </nav>
</div>

<section class="section">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card subscription-card">
                <div class="card-body">
                    <h5 class="card-title">Current Plan</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-star"></i>
                        </div>
                        <div class="ps-3">
                            <h6>{{ current_subscription.plan.name | e if current_subscription else 'No Active Plan' }}</h6>
                            <span class="text-{{ 'success' if is_active_subscription else 'muted' }} small pt-1 fw-bold">
                                {{ current_subscription.status.title() | e if current_subscription else 'Inactive' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card days-card">
                <div class="card-body">
                    <h5 class="card-title">Days Remaining</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-calendar"></i>
                        </div>
                        <div class="ps-3">
                            <h6 id="daysRemaining">{{ days_remaining if current_subscription else 0 }}</h6>
                            <span class="text-muted small pt-2 ps-1">days left</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card spending-card">
                <div class="card-body">
                    <h5 class="card-title">Total Spent</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div class="ps-3">
                            <h6>${{ "{:,.2f}".format(total_spent|default(0)) }}</h6>
                            <span class="text-muted small pt-2 ps-1">lifetime</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xxl-3 col-md-6">
            <div class="card info-card payments-card">
                <div class="card-body">
                    <h5 class="card-title">Recent Payments</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-credit-card"></i>
                        </div>
                        <div class="ps-3">
                            <h6>{{ recent_payments|default(0) }}</h6>
                            <span class="text-muted small pt-2 ps-1">this month</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Subscription Card -->
    {% if current_subscription %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-crown me-2"></i>Current Subscription
                        </h5>
                        <div class="subscription-actions">
                            {% if current_subscription.status == 'trial' %}
                            <button class="btn btn-success btn-sm me-2" onclick="convertTrial()">
                                <i class="bi bi-arrow-up me-1"></i>Convert to Paid
                            </button>
                            {% endif %}
                            <button class="btn btn-primary btn-sm me-2" onclick="showUpgradeModal()">
                                <i class="bi bi-arrow-up me-1"></i>Upgrade
                            </button>
                            <button class="btn btn-warning btn-sm me-2" onclick="toggleAutoRenew()" id="autoRenewStatus" data-status="{{ 'true' if current_subscription.auto_renew else 'false' }}">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                {{ 'Disable' if current_subscription.auto_renew else 'Enable' }} Auto-Renew
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="showCancelModal()">
                                <i class="bi bi-x me-1"></i>Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="subscription-details">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-1">Plan Name</h6>
                                        <p class="mb-3">{{ current_subscription.plan.name | e }}</p>
                                        
                                        <h6 class="text-muted mb-1">Status</h6>
                                        <span class="status-badge status-{{ current_subscription.status }} mb-3">
                                            {{ current_subscription.status.title() | e }}
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-1">Price</h6>
                                        <p class="mb-3" id="currentPlanPrice" data-price="{{ current_subscription.plan.price }}">${{ "{:.2f}".format(current_subscription.plan.price) }}/month</p>
                                        
                                        <h6 class="text-muted mb-1">Auto Renew</h6>
                                        <span class="badge {{ 'bg-success' if current_subscription.auto_renew else 'bg-secondary' }} mb-3">
                                            {{ 'Enabled' if current_subscription.auto_renew else 'Disabled' }}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-1">Start Date</h6>
                                        <p class="mb-3">{{ current_subscription.start_date.strftime('%b %d, %Y') }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-1">End Date</h6>
                                        <p class="mb-3">{{ current_subscription.end_date.strftime('%b %d, %Y') }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="usage-summary">
                                <h6 class="text-muted mb-3">Usage Summary</h6>
                                {% if usage_data %}
                                    {% for usage in usage_data %}
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-sm">{{ usage.feature.title() | e }}</span>
                                            <span class="text-sm">{{ usage.used }}/{{ usage.limit }}</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-{{ 'danger' if usage.percentage > 80 else 'warning' if usage.percentage > 60 else 'success' }}" 
                                                 style="width: {{ usage.percentage }}%"></div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No usage data available.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if current_subscription.plan.features %}
                    <div class="plan-features mt-4">
                        <h6 class="text-muted mb-2">Plan Features</h6>
                        <div class="row">
                            {% for feature in current_subscription.plan.features %}
                            <div class="col-md-6 mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>{{ feature | e }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Available Plans -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-grid me-2"></i>Available Plans
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshPlans()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div class="row" id="plansContainer">
                        {% for plan in available_plans %}
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card plan-card h-100 {{ 'border-primary' if current_subscription and current_subscription.plan_id == plan.id else '' }}">
                                <div class="card-body d-flex flex-column">
                                    <div class="text-center mb-3">
                                        <h5 class="card-title">{{ plan.name | e }}</h5>
                                        <div class="price">
                                            <h2 class="text-primary">${{ "{:.2f}".format(plan.price) }}</h2>
                                            <span class="text-muted">/month</span>
                                        </div>
                                    </div>
                                    
                                    {% if plan.description %}
                                    <p class="card-text text-muted mb-3 small">{{ plan.description | e }}</p>
                                    {% endif %}
                                    
                                    <div class="plan-specs mb-3">
                                        <div class="spec-item mb-2">
                                            <i class="bi bi-people me-2 text-primary"></i>
                                            <small>{{ plan.max_athletes }} Athletes</small>
                                        </div>
                                        <div class="spec-item mb-2">
                                            <i class="bi bi-list-task me-2 text-primary"></i>
                                            <small>{{ plan.max_workouts }} Workouts</small>
                                        </div>
                                        <div class="spec-item mb-2">
                                            <i class="bi bi-hdd me-2 text-primary"></i>
                                            <small>{{ plan.storage_gb }} GB Storage</small>
                                        </div>
                                    </div>
                                    
                                    {% if plan.features %}
                                    <div class="plan-features mb-3">
                                        <h6 class="text-muted mb-2 small">Features:</h6>
                                        {% for feature in plan.features[:3] %}
                                        <div class="feature-item mb-1">
                                            <i class="bi bi-check text-success me-1"></i>
                                            <small>{{ feature | e }}</small>
                                        </div>
                                        {% endfor %}
                                        {% if plan.features|length > 3 %}
                                        <small class="text-muted">+{{ plan.features|length - 3 }} more</small>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-auto">
                                        {% if current_subscription and current_subscription.plan_id == plan.id %}
                                        <button class="btn btn-outline-success w-100" disabled>
                                            <i class="bi bi-check me-1"></i>Current Plan
                                        </button>
                                        {% elif current_subscription and plan.price > current_subscription.plan.price %}
                                        <button class="btn btn-primary w-100" onclick="upgradeToPlan({{ plan.id }}, '{{ plan.name | e }}')">
                                            <i class="bi bi-arrow-up me-1"></i>Upgrade
                                        </button>
                                        {% elif not current_subscription %}
                                        <button class="btn btn-success w-100" onclick="subscribeToPlan({{ plan.id }}, '{{ plan.name | e }}')">
                                            <i class="bi bi-plus me-1"></i>Subscribe
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-secondary w-100" disabled>
                                            <i class="bi bi-arrow-down me-1"></i>Lower Tier
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-credit-card me-2"></i>Recent Payments
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadPaymentHistory()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="paymentHistoryTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Plan</th>
                                    <th>Status</th>
                                    <th>Method</th>
                                    <th>Transaction ID</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistoryBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Subscribe Modal -->
<div class="modal fade" id="subscribeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus me-2"></i>Subscribe to Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="subscribeForm">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% endif %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Selected Plan</label>
                            <div class="selected-plan-info p-3 bg-light rounded">
                                <h6 id="selectedPlanName">-</h6>
                                <div class="price">
                                    <span class="h4 text-primary" id="selectedPlanPrice">$0.00</span>
                                    <span class="text-muted">/month</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Billing Cycle</label>
                            <select name="billing_cycle" class="form-select">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly (10% off)</option>
                                <option value="yearly">Yearly (20% off)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <div class="payment-method-options">
                            <div class="form-check payment-option mb-2">
                                <input class="form-check-input" type="radio" name="payment_method" value="card" id="payCard" checked>
                                <label class="form-check-label w-100" for="payCard">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-credit-card fs-5 me-3 text-primary"></i>
                                        <div>
                                            <strong>Credit/Debit Card</strong>
                                            <small class="d-block text-muted">Secure payment via Paymob</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="form-check payment-option">
                                <input class="form-check-input" type="radio" name="payment_method" value="paypal" id="payPaypal">
                                <label class="form-check-label w-100" for="payPaypal">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-paypal fs-5 me-3 text-primary"></i>
                                        <div>
                                            <strong>PayPal</strong>
                                            <small class="d-block text-muted">Fast and secure checkout</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="trial_enabled" id="trialEnabled">
                        <label class="form-check-label" for="trialEnabled">
                            <i class="bi bi-gift me-2"></i>Start with 14-day free trial
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="auto_renew" id="autoRenew" checked>
                        <label class="form-check-label" for="autoRenew">
                            <i class="bi bi-arrow-repeat me-2"></i>Enable auto-renewal
                        </label>
                    </div>

                    <input type="hidden" name="plan_id" id="subscriptionPlanId">
                </form>

                <div class="subscription-summary p-3 bg-light rounded mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="subtotalAmount">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Discount:</span>
                        <span id="discountAmount" class="text-success">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span id="totalAmount">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="subscribeForm" class="btn btn-success">
                    <i class="bi bi-credit-card me-2"></i>Subscribe Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upgrade Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-up me-2"></i>Upgrade Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="upgradeForm">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% endif %}
                    <div class="upgrade-comparison mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="current-plan p-3 border rounded bg-light">
                                    <h6 class="text-muted">Current Plan</h6>
                                    <h5>{{ current_subscription.plan.name | e if current_subscription else 'N/A' }}</h5>
                                    <div class="price text-muted">
                                        ${{ "{:.2f}".format(current_subscription.plan.price if current_subscription else 0) }}/month
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="new-plan p-3 border border-primary rounded">
                                    <h6 class="text-muted">New Plan</h6>
                                    <h5 id="newPlanName">-</h5>
                                    <div class="price text-primary">
                                        <span id="newPlanPrice">$0.00</span>/month
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle me-2"></i>Prorated Billing</h6>
                        <p class="mb-1">You have <strong><span id="remainingDays">{{ days_remaining if current_subscription else 0 }}</span> days</strong> remaining.</p>
                        <p class="mb-0">Prorated charge: <strong id="proratedAmount">$0.00</strong></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <div class="payment-method-options">
                            <div class="form-check payment-option mb-2">
                                <input class="form-check-input" type="radio" name="upgrade_payment_method" value="card" checked>
                                <label class="form-check-label w-100">
                                    <i class="bi bi-credit-card me-2"></i>Credit/Debit Card
                                </label>
                            </div>
                            <div class="form-check payment-option">
                                <input class="form-check-input" type="radio" name="upgrade_payment_method" value="paypal">
                                <label class="form-check-label w-100">
                                    <i class="bi bi-paypal me-2"></i>PayPal
                                </label>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="plan_id" id="upgradePlanId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="upgradeForm" class="btn btn-primary">
                    <i class="bi bi-arrow-up me-2"></i>Upgrade Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Convert Trial Modal -->
<div class="modal fade" id="convertTrialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-up-circle me-2"></i>Convert Trial
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Convert your trial to continue using all features.
                </div>
                
                <form id="convertTrialForm">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% endif %}
                    <div class="payment-method-options">
                        <div class="form-check payment-option mb-2">
                            <input class="form-check-input" type="radio" name="convert_payment_method" value="card" checked>
                            <label class="form-check-label w-100">
                                <i class="bi bi-credit-card me-2"></i>Credit/Debit Card
                            </label>
                        </div>
                        <div class="form-check payment-option">
                            <input class="form-check-input" type="radio" name="convert_payment_method" value="paypal">
                            <label class="form-check-label w-100">
                                <i class="bi bi-paypal me-2"></i>PayPal
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="convertTrialForm" class="btn btn-success">
                    <i class="bi bi-check-circle me-2"></i>Convert Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Cancel Subscription
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Are you sure you want to cancel?</strong>
                </div>
                
                <form id="cancelForm">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">Reason (optional)</label>
                        <select name="reason" class="form-select mb-2">
                            <option value="">Select a reason...</option>
                            <option value="too_expensive">Too expensive</option>
                            <option value="not_using">Not using enough</option>
                            <option value="missing_features">Missing features</option>
                            <option value="found_alternative">Found alternative</option>
                            <option value="other">Other</option>
                        </select>
                        <textarea name="reason_details" class="form-control" rows="2" placeholder="Additional details..."></textarea>
                    </div>

                    <div class="cancellation-options">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="cancel_type" value="end_of_period" checked>
                            <label class="form-check-label">
                                <strong>Cancel at period end</strong><br>
                                <small class="text-muted">Access until {{ current_subscription.end_date.strftime('%b %d, %Y') if current_subscription else 'N/A' }}</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancel_type" value="immediate">
                            <label class="form-check-label">
                                <strong class="text-danger">Cancel immediately</strong><br>
                                <small class="text-muted">Lose access now (no refund)</small>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Subscription</button>
                <button type="submit" form="cancelForm" class="btn btn-danger">
                    <i class="bi bi-x me-2"></i>Cancel Subscription
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Processing Modal -->
<div class="modal fade" id="paymentProcessingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <h5>Processing Payment</h5>
                <p class="text-muted">Redirecting to payment gateway...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>

<style>
    /* Card Icons */
    .subscription-card .card-icon { background: linear-gradient(90deg, #4154f1, #2678c7); }
    .days-card .card-icon { background: linear-gradient(90deg, #ffc107, #fd7e14); }
    .spending-card .card-icon { background: linear-gradient(90deg, #28a745, #20c997); }
    .payments-card .card-icon { background: linear-gradient(90deg, #dc3545, #e91e63); }
    
    .card-icon { width: 48px; height: 48px; color: white; }

    /* Status Badges */
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    .status-active { background: rgba(39, 174, 96, 0.15); color: #27ae60; }
    .status-trial { background: rgba(52, 152, 219, 0.15); color: #3498db; }
    .status-expired { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
    .status-canceled { background: rgba(149, 165, 166, 0.15); color: #95a5a6; }
    .status-pending { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
    .status-completed { background: rgba(39, 174, 96, 0.15); color: #27ae60; }
    .status-failed { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }

    /* Plan Cards */
    .plan-card {
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
    }
    .plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    .plan-card.border-primary {
        background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
    }

    /* Payment Options */
    .payment-option {
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .payment-option:hover {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    .payment-option input:checked ~ label {
        color: #007bff;
        font-weight: 500;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .subscription-actions {
            width: 100%;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .subscription-actions .btn {
            display: block;
            width: 100%;
            margin: 0 !important;
            padding: 0.75rem;
            font-size: 0.9rem;
        }
    }
</style>

<script>
    $(document).ready(function() {
        // Initialize DataTables
        $('#paymentHistoryTable').DataTable({
            responsive: true,
            pageLength: 10,
            order: [[0, 'desc']],
            language: {
                emptyTable: "No payments yet"
            }
        });

        // Load payment history
        loadPaymentHistory();

        // Billing cycle change
        $('select[name="billing_cycle"]').change(function() {
            updatePricing();
        });

        // Trial toggle
        $('#trialEnabled').change(function() {
            updatePricing();
        });
    });

    let currentPlanId = null;
    let currentPlanPrice = 0;

    // Utility function for price formatting
    function formatPrice(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount);
    }

    // Get authentication token with validation
    function getAuthToken() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            showAlert('Please log in to continue.', 'danger');
            setTimeout(() => window.location.href = '/login', 2000);
            throw new Error('No authentication token found');
        }
        return token;
    }

    // Get CSRF token if available
    function getCsrfToken() {
        return $('input[name="csrf_token"]').val() || null;
    }

    // Show alert
    function showAlert(message, type) {
        const alert = $(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('body').append(alert);
        setTimeout(() => alert.alert('close'), 5000);
    }

    // Subscribe to Plan
    function subscribeToPlan(planId, planName) {
        currentPlanId = planId;
        const planCard = $(`.plan-card:has(button[onclick*="subscribeToPlan(${planId}"])`);
        const planPrice = parseFloat(planCard.find('.price h2').text().replace(',', ''));
        
        $('#selectedPlanName').text(planName);
        $('#selectedPlanPrice').text(formatPrice(planPrice));
        $('#subscriptionPlanId').val(planId);
        currentPlanPrice = planPrice;
        
        updatePricing();
        $('#subscribeModal').modal('show');
    }

    // Update Pricing
    function updatePricing() {
        const billingCycle = $('select[name="billing_cycle"]').val();
        const isTrialEnabled = $('#trialEnabled').is(':checked');
        
        let price = currentPlanPrice;
        let discount = 0;
        
        if (billingCycle === 'quarterly') {
            price = currentPlanPrice * 3 * 0.9;
            discount = currentPlanPrice * 3 * 0.1;
        } else if (billingCycle === 'yearly') {
            price = currentPlanPrice * 12 * 0.8;
            discount = currentPlanPrice * 12 * 0.2;
        }
        
        const subtotal = isTrialEnabled ? 0 : price;
        
        $('#subtotalAmount').text(isTrialEnabled ? '$0.00 (Trial)' : formatPrice(price));
        $('#discountAmount').text(formatPrice(-discount));
        $('#totalAmount').text(formatPrice(subtotal));
    }

    // Submit Subscribe Form
    $('#subscribeForm').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).closest('.modal').find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Processing...');
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/subscribe', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                plan_id: parseInt($('#subscriptionPlanId').val()),
                billing_cycle: $('select[name="billing_cycle"]').val(),
                payment_method: $('input[name="payment_method"]:checked').val(),
                auto_renew: $('#autoRenew').is(':checked'),
                trial_enabled: $('#trialEnabled').is(':checked')
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.payment_url) {
                    $('#subscribeModal').modal('hide');
                    $('#paymentProcessingModal').modal('show');
                    setTimeout(() => window.location.href = data.payment_url, 1500);
                } else {
                    showAlert(data.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            } else {
                showAlert(data.error || 'Subscription failed', 'danger');
                submitBtn.prop('disabled', false).html(originalText);
            }
        })
        .catch(error => {
            showAlert(`Error: ${error.message}`, 'danger');
            submitBtn.prop('disabled', false).html(originalText);
        });
    });

    // Upgrade Plan
    function upgradeToPlan(planId, planName) {
        const planCard = $(`.plan-card:has(button[onclick*="upgradeToPlan(${planId}"])`);
        const planPrice = parseFloat(planCard.find('.price h2').text().replace(',', ''));
        
        $('#newPlanName').text(planName);
        $('#newPlanPrice').text(formatPrice(planPrice));
        $('#upgradePlanId').val(planId);
        
        const currentPrice = parseFloat($('#currentPlanPrice').data('price') || 0);
        const daysRemaining = parseInt($('#daysRemaining').text() || 0);
        let prorated = 0;
        if (daysRemaining > 0 && planPrice > currentPrice) {
            prorated = ((planPrice - currentPrice) / 30) * daysRemaining;
        }
        
        $('#proratedAmount').text(formatPrice(Math.max(0, prorated)));
        $('#upgradeModal').modal('show');
    }

    function showUpgradeModal() {
        $('#upgradeModal').modal('show');
    }

    $('#upgradeForm').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).closest('.modal').find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Processing...');
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/upgrade_plan', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                plan_id: parseInt($('#upgradePlanId').val()),
                payment_method: $('input[name="upgrade_payment_method"]:checked').val()
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.payment_url) {
                    $('#upgradeModal').modal('hide');
                    $('#paymentProcessingModal').modal('show');
                    setTimeout(() => window.location.href = data.payment_url, 1500);
                } else {
                    showAlert(data.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            } else {
                showAlert(data.error || 'Upgrade failed', 'danger');
                submitBtn.prop('disabled', false).html(originalText);
            }
        })
        .catch(error => {
            showAlert(`Error: ${error.message}`, 'danger');
            submitBtn.prop('disabled', false).html(originalText);
        });
    });

    // Convert Trial
    function convertTrial() {
        $('#convertTrialModal').modal('show');
    }

    $('#convertTrialForm').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).closest('.modal').find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Processing...');
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/convert_trial', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                payment_method: $('input[name="convert_payment_method"]:checked').val()
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.payment_url) {
                    $('#convertTrialModal').modal('hide');
                    $('#paymentProcessingModal').modal('show');
                    setTimeout(() => window.location.href = data.payment_url, 1500);
                } else {
                    showAlert(data.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            } else {
                showAlert(data.error || 'Conversion failed', 'danger');
                submitBtn.prop('disabled', false).html(originalText);
            }
        })
        .catch(error => {
            showAlert(`Error: ${error.message}`, 'danger');
            submitBtn.prop('disabled', false).html(originalText);
        });
    });

    // Cancel Subscription
    function showCancelModal() {
        $('#cancelModal').modal('show');
    }

    $('#cancelForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!confirm('Are you sure you want to cancel your subscription?')) return;
        
        const submitBtn = $(this).closest('.modal').find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Canceling...');
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/cancel_subscription', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                reason: $('select[name="reason"]').val() || $('textarea[name="reason_details"]').val(),
                cancel_type: $('input[name="cancel_type"]:checked').val()
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert(data.error || 'Cancellation failed', 'danger');
                submitBtn.prop('disabled', false).html(originalText);
            }
        })
        .catch(error => {
            showAlert(`Error: ${error.message}`, 'danger');
            submitBtn.prop('disabled', false).html(originalText);
        });
    });

    // Toggle Auto-Renew
    function toggleAutoRenew() {
        const current = $('#autoRenewStatus').data('status') === 'true';
        const newStatus = !current;
        
        if (!confirm(`${newStatus ? 'Enable' : 'Disable'} auto-renewal?`)) return;
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/update_auto_renew', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ auto_renew: newStatus })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.error || 'Update failed', 'danger');
            }
        })
        .catch(error => showAlert(`Error: ${error.message}`, 'danger'));
    }

    // Load Payment History
    function loadPaymentHistory() {
        const table = $('#paymentHistoryTable').DataTable();
        table.clear().draw();
        table.row.add(['<td colspan="6" class="text-center text-muted">Loading...</td>']).draw();
        
        const headers = {
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/payment_history', {
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            table.clear();
            if (data.success) {
                if (data.payments.length === 0) {
                    table.row.add(['<td colspan="6" class="text-center text-muted">No payments yet</td>']).draw();
                    return;
                }
                data.payments.forEach(payment => {
                    const statusClass = payment.status === 'completed' ? 'success' : 
                                    payment.status === 'failed' ? 'danger' : 'warning';
                    table.row.add([
                        payment.date,
                        `<span class="fw-bold text-${statusClass}">${formatPrice(payment.amount)}</span>`,
                        payment.plan_name,
                        `<span class="status-badge status-${payment.status}">${payment.status}</span>`,
                        `<i class="bi bi-${payment.provider === 'paypal' ? 'paypal' : 'credit-card'} me-1"></i>${payment.provider || 'N/A'}`,
                        `<small class="text-muted">${payment.provider_transaction_id || 'N/A'}</small>`
                    ]).draw();
                });
            } else {
                showAlert(data.error || 'Failed to load payment history', 'danger');
                table.row.add(['<td colspan="6" class="text-center text-muted">No payments yet</td>']).draw();
            }
        })
        .catch(error => {
            showAlert('Error loading payments: ' + error.message, 'danger');
            table.clear().row.add(['<td colspan="6" class="text-center text-muted">Error loading payments</td>']).draw();
        });
    }

    // Refresh Plans
    function refreshPlans() {
        const headers = {
            'Authorization': `Bearer ${getAuthToken()}`
        };
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/athlete/api/available_plans', {
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const plansContainer = $('#plansContainer');
                plansContainer.empty();
                data.plans.forEach(plan => {
                    const isCurrentPlan = {{ 'current_subscription.plan_id' if current_subscription else 'null' }} === plan.id;
                    const buttonHtml = isCurrentPlan ? 
                        `<button class="btn btn-outline-success w-100" disabled><i class="bi bi-check me-1"></i>Current Plan</button>` :
                        ({{ 'current_subscription' if current_subscription else 'null' }} && plan.price > {{ 'current_subscription.plan.price' if current_subscription else '0' }}) ?
                        `<button class="btn btn-primary w-100" onclick="upgradeToPlan(${plan.id}, '${plan.name}')"><i class="bi bi-arrow-up me-1"></i>Upgrade</button>` :
                        (!{{ 'current_subscription' if current_subscription else 'null' }}) ?
                        `<button class="btn btn-success w-100" onclick="subscribeToPlan(${plan.id}, '${plan.name}')"><i class="bi bi-plus me-1"></i>Subscribe</button>` :
                        `<button class="btn btn-outline-secondary w-100" disabled><i class="bi bi-arrow-down me-1"></i>Lower Tier</button>`;
                    const featuresHtml = plan.features.slice(0, 3).map(feature => `
                        <div class="feature-item mb-1">
                            <i class="bi bi-check text-success me-1"></i>
                            <small>${feature}</small>
                        </div>
                    `).join('') + (plan.features.length > 3 ? `<small class="text-muted">+${plan.features.length - 3} more</small>` : '');
                    plansContainer.append(`
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card plan-card h-100 ${isCurrentPlan ? 'border-primary' : ''}">
                                <div class="card-body d-flex flex-column">
                                    <div class="text-center mb-3">
                                        <h5 class="card-title">${plan.name}</h5>
                                        <div class="price">
                                            <h2 class="text-primary">${formatPrice(plan.price)}</h2>
                                            <span class="text-muted">/month</span>
                                        </div>
                                    </div>
                                    ${plan.description ? `<p class="card-text text-muted mb-3 small">${plan.description}</p>` : ''}
                                    <div class="plan-specs mb-3">
                                        <div class="spec-item mb-2">
                                            <i class="bi bi-people me-2 text-primary"></i>
                                            <small>${plan.max_athletes} Athletes</small>
                                        </div>
                                        <div class="spec-item mb-2">
                                            <i class="bi bi-list-task me-2 text-primary"></i>
                                            <small>${plan.max_workouts} Workouts</small>
                                        </div>
                                        <div class="spec-item mb-2">
                                            <i class="bi bi-hdd me-2 text-primary"></i>
                                            <small>${plan.storage_gb} GB Storage</small>
                                        </div>
                                    </div>
                                    <div class="plan-features mb-3">
                                        <h6 class="text-muted mb-2 small">Features:</h6>
                                        ${featuresHtml}
                                    </div>
                                    <div class="mt-auto">
                                        ${buttonHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                });
            } else {
                showAlert(data.error || 'Failed to load plans', 'danger');
            }
        })
        .catch(error => showAlert(`Error loading plans: ${error.message}`, 'danger'));
    }

</script>

{% endblock %}