{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
      <h1>OVERVIEW</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Home</a></li>
          <li class="breadcrumb-item active">Profile</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section dashboard">
      <div class="row">

        <!-- Left side columns -->
        <div class="col-lg-8">
          <div class="row">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                  <i class="bi bi-plus-lg me-1"></i> Edit Profile
                </button>
              </div>
            </div>
            <!-- User Stats Cards -->
            <div class="col-xxl-4 col-md-6">
              <div class="card info-card sales-card">
                <div class="card-body">
                  <h5 class="card-title">{{ user.name  or "--" }}</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-person"></i>
                    </div>
                    <div class="ps-3">
                      <h6>{{ profile.weight if profile else "--"  }}</h6>
                      <span class="text-muted small pt-1">Weight</span>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- End User Stats Card -->

            <!-- Height Card -->
            <div class="col-xxl-4 col-md-6">
              <div class="card info-card revenue-card">
                <div class="card-body">
                  <h5 class="card-title">Height</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-rulers"></i>
                    </div>
                    <div class="ps-3">
                      <h6>{{profile.height if profile else "--" }}</h6>
                      <span class="text-muted small pt-1">Height</span>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- End Height Card -->

            <!-- Age Card -->
            <div class="col-xxl-4 col-xl-12">
              <div class="card info-card customers-card">
                <div class="card-body">
                  <h5 class="card-title">Age</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-calendar"></i>
                    </div>
                    <div class="ps-3">
                      <h6>{{profile.age if profile else "--" }}</h6>
                      <span class="text-muted small pt-1">Age</span>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- End Age Card -->

            <!-- User Details -->
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Account</h5>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="profile-info">
                        <div class="info-item d-flex justify-content-between py-2">
                          <span class="text-muted">Name</span>
                          <span>{{ user.name  or "--" }} <i class="bi bi-chevron-right"></i></span>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span class="text-muted">Gender</span>
                          <span>{{ profile.gender if profile else "--" }} <i class="bi bi-chevron-right"></i></span>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span class="text-muted">Date of birth</span>
                          <span>{{ profile.age if profile else "--" }} <i class="bi bi-chevron-right"></i></span>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span class="text-muted">Height</span>
                          <span>{{ profile.height if profile else "--" }} <i class="bi bi-chevron-right"></i></span>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span class="text-muted">Weight</span>
                          <span>{{ profile.weight if profile else "--"  }} <i class="bi bi-chevron-right"></i></span>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span class="text-muted">Max heart rate</span>
                          <span>{{ hr.heart_rate if hr else "--"  }} <i class="bi bi-chevron-right"></i></span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6">
                      <div class="account-actions">
                        <div class="info-item d-flex justify-content-between py-2">
                          <span>Account</span>
                          <i class="bi bi-chevron-right"></i>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span>My Workouts</span>
                          <i class="bi bi-chevron-right"></i>
                        </div>
                        <div class="info-item d-flex justify-content-between py-2">
                          <span>Workout reminders</span>
                          <i class="bi bi-chevron-right"></i>
                        </div>
                        <div class="text-center mt-3">
                          <button class="btn btn-primary">Log out</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- End User Details -->

          </div>
        </div><!-- End Left side columns -->

        <!-- Right side columns -->
        <div class="col-lg-4">

          <!-- Settings Card -->
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Settings</h5>
              <form id="settingsForm">
                <div class="settings-list">
                  <div class="setting-item d-flex justify-content-between align-items-center py-2">
                    <span>Notification</span>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="notifications" {{ 'checked' if settings and settings.notifications }}>
                    </div>
                  </div>
                  <div class="setting-item d-flex justify-content-between align-items-center py-2">
                    <span>Pin Lock</span>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="pin_lock" {{ 'checked' if settings and settings.pin_lock }}>
                    </div>
                  </div>
                  <div class="setting-item d-flex justify-content-between align-items-center py-2">
                    <span>Apple Health</span>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="apple_health" {{ 'checked' if settings and settings.apple_health }}>
                    </div>
                  </div>
                  <div class="setting-item d-flex justify-content-between align-items-center py-2">
                    <span>Dark Mode</span>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="dark_mode" {{ 'checked' if settings and settings.dark_mode }}>
                    </div>
                  </div>
                </div>
                <button class="btn btn-primary mt-3" type="submit">Save</button>
              </form>
            </div>
          </div><!-- End Settings Card -->

          <!-- Weight Tracking -->
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Weight tracking</h5>
              <div class="weight-entries">
                {% for entry in weight_history %}
                <div class="weight-entry d-flex justify-content-between align-items-center py-2">
                  <div>
                    <div class="date">{{ entry.recorded_at.strftime('%b %d, %Y') }}</div>
                    <div class="weight">{{ entry.weight }} kg</div>
                  </div>
                  <div class="change {{ 'text-success' if entry.change >= 0 else 'text-danger' }}">
                    {{ entry.change }} kg
                  </div>
                </div>
                {% else %}
                <p class="text-muted small">No weight records yet.</p>
                {% endfor %}
              </div>
            </div>
          </div>




        </div><!-- End Right side columns -->

      </div>
    </section>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="profileForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Profile</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- ØµÙˆØ±Ø© -->
        <div class="mb-3 text-center">
          <img id="previewImage" src="{{ url_for('static', filename='uploads/' ~ (user.profile_image or 'default.jpg')) }}" 
              class="rounded-circle mb-2" width="100" alt="Profile">
          <input type="file" class="form-control" name="profile_image" id="profileImageInput">
        </div>

        <!-- Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" name="full_name" class="form-control" value="{{ user.name }}">
        </div>

        <div class="mb-3">
          <label class="form-label">Age</label>
          <input type="number" name="age" class="form-control" value="{{ profile.age if profile else '' }}">
        </div>

        <div class="mb-3">
          <label class="form-label">Gender</label>
          <select name="gender" class="form-select">
            <option value="Male" {{ 'selected' if profile and profile.gender == 'Male' }}>Male</option>
            <option value="Female" {{ 'selected' if profile and profile.gender == 'Female' }}>Female</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Weight (kg)</label>
          <input type="number" step="0.1" name="weight" class="form-control" value="{{ profile.weight if profile else '' }}">
        </div>

        <div class="mb-3">
          <label class="form-label">Height (cm)</label>
          <input type="number" step="0.1" name="height" class="form-control" value="{{ profile.height if profile else '' }}">
        </div>

        <div class="mb-3">
          <label class="form-label">Max Heart Rate (bpm)</label>
          <input type="number" name="max_hr" class="form-control" value="{{ hr.heart_rate if hr else '' }}">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script>
function alertShow(m,t="info"){const c=document.getElementById("alert-container")||document.body,w=document.createElement("div");w.innerHTML=`<div class="alert alert-${t} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">${m}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;c.appendChild(w);setTimeout(()=>w.remove(),4e3);}

document.getElementById("profileForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  let formData = new FormData(this);

  const res = await fetch("/athlete/profile/update", {
    method: "POST",
    headers: { Authorization: "Bearer " + localStorage.getItem("access_token") },
    body: formData
  });

  const data = await res.json();
  if (res.ok) {
    alertShow("Profile updated successfully!",'success');
    location.reload();
  } else {
    alertShow(data.error || "Update failed",'danger');
  }
});

// ðŸŸ¢ ØµÙˆØ±Ø© live preview
document.getElementById("profileImageInput").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (file) {
    document.getElementById("previewImage").src = URL.createObjectURL(file);
  }
});

document.getElementById("settingsForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  let formData = new FormData(this);

  const res = await fetch("/athlete/settings/update", {
    method: "POST",
    headers: { Authorization: "Bearer " + localStorage.getItem("access_token") },
    body: formData
  });

  const data = await res.json();
  if (res.ok) {
    alertShow("Settings saved!",'success');
  } else {
    alertShow(data.error || "Update failed",'danger');
  }
});

</script>

{% endblock%}
