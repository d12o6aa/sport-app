{% extends "shared/base.html" %}

{% block style %}
<style>
  /* Base Styles for a Unified Look */
  .workout-card, .list-group-item, .body-part-card, .exercise-item {
    transition: all 0.2s ease;
    border-radius: 8px;
  }
  .workout-card:hover, .list-group-item:hover, .body-part-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .bg-gradient-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
  .bg-gradient-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
  .bg-gradient-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
  .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
  .btn-primary:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
  .form-select:focus, .form-control:focus { box-shadow: 0 0 0 0.25rem rgba(102,126,234,0.25); border-color: #667eea; }

  /* Body Workout Specific Styles */
  .body-part-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .body-part-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  .body-part-card.selected { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); transform: scale(1.05); }
  .body-part-icon { font-size: 2rem; margin-bottom: 0.5rem; }
  .body-part-name { font-weight: 600; font-size: 0.9rem; }
  .exercise-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .exercise-item:hover { background-color: #f8f9fa; }
  .exercise-thumb { width: 40px; height: 40px; border-radius: 8px; margin-right: 1rem; object-fit: cover; }
  .exercise-details { flex-grow: 1; }
  .exercise-name { font-weight: 500; font-size: 0.9rem; }
  .exercise-duration { color: #6c757d; font-size: 0.8rem; }
  
  /* Top Workouts Specific Styles */
  .rank-badge {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; margin-right: 1rem;
    color: white;
  }
  .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; }
  .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #333; }
  .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); color: white; }
  .rank-default { background: #6c757d; color: white; }
  
  .achievement-badge {
    display: inline-block; padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white; border-radius: 20px; font-size: 0.8rem; margin: 0.25rem;
  }

  .nav-pills .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
  }
</style>
{% endblock %}

{% block content %}
<section class="section">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="m-0">My Workouts Hub</h5>
    <ul class="nav nav-pills" id="workoutHubTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Summary</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="body-workout-tab" data-bs-toggle="tab" data-bs-target="#body-workout" type="button" role="tab" aria-controls="body-workout" aria-selected="false">Body Workout</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="filter-tab" data-bs-toggle="tab" data-bs-target="#filter" type="button" role="tab" aria-controls="filter" aria-selected="false">Filter</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="top-workouts-tab" data-bs-toggle="tab" data-bs-target="#top-workouts" type="button" role="tab" aria-controls="top-workouts" aria-selected="false">Top Workouts</button>
      </li>
    </ul>
  </div>

  <div class="tab-content" id="workoutHubTabContent">
    
    <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <h5 class="m-0 me-3">Workout Summary Tracker</h5>
          <div class="btn-group" role="group">
            <button class="btn btn-sm btn-outline-secondary" onclick="changeWeek(-1)">
              <i class="bi bi-chevron-left"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="goToToday()">Today</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="changeWeek(1)">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
        <button class="btn btn-primary" onclick="openAddWorkout()">
          <i class="bi bi-plus-lg me-1"></i> Add Workout
        </button>
      </div>

      <div class="card mb-4">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted" id="weekRange">Loading...</small>
            <div class="d-flex gap-2">
              <span class="badge bg-success">● Completed</span>
              <span class="badge bg-warning">● In Progress</span>
              <span class="badge bg-danger">● Missed</span>
            </div>
          </div>
          <div class="row g-1" id="weeklyCalendar">
            </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card bg-light text-center p-3 h-100" id="currentWorkoutCard">
            <div id="workoutImageContainer">
              <img id="currentWorkoutImage" src="" class="mx-auto mb-2 rounded" style="width:80px;height:60px;object-fit:cover;display:none;">
              <div id="workoutImagePlaceholder" class="mx-auto mb-2 rounded bg-secondary d-flex align-items-center justify-content-center" style="width:80px;height:60px;">
                <i class="bi bi-dumbbell text-white"></i>
              </div>
            </div>
            <h6 class="text-muted small mb-1" id="currentWorkoutTitle">No Recent Workout</h6>
            <div class="d-flex justify-content-between small text-muted">
              <span id="currentWorkoutDuration">00:00:00</span>
              <span>Total Time</span>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card bg-light text-center p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="small text-muted">Heart Rate Zone</span>
              <span class="fs-4 fw-bold" id="avgHeartRate">-- bpm</span>
            </div>
            <div class="small text-muted">Avg Heart Rate</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card bg-light text-center p-3 h-100">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold fs-5" id="totalCalories">0 Kcal</div>
                <div class="small text-muted">Total Calories</div>
              </div>
              <div>
                <div class="fw-bold fs-5" id="currentCalories">0 Kcal</div>
                <div class="small text-muted">Recent Workout</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-4">
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Heart Rate</h6>
              <span class="small text-muted"><span id="maxHeartRateDisplay">--</span> max</span>
            </div>
            <div class="card-body">
              <canvas id="heartRateChart" width="100" height="60"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Training Effect</h6>
              <small class="text-muted">Recovery: <span id="recoveryTime">--</span></small>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="progress mb-1" style="height: 12px;" id="trainingEffectBar">
                  </div>
                <div class="d-flex justify-content-between small mt-2">
                  <span class="text-success">● Minor</span>
                  <span class="text-primary">● Recovery</span>
                </div>
                <div class="d-flex justify-content-between small">
                  <span class="text-warning">● Maintaining</span>
                  <span class="text-danger">● Overreaching</span>
                </div>
                <div class="d-flex justify-content-between small">
                  <span class="text-info">● Improving</span>
                  <span class="text-secondary">● Highly Improving</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0" id="calendarMonth">Sep 2025</h6>
            </div>
            <div class="card-body p-2">
              <div id="monthlyCalendar" class="text-center">
                </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">My Progress</h6>
            </div>
            <div class="card-body">
              <div id="progressSection">
                <div class="text-center text-muted py-3">
                  <i class="bi bi-activity fs-1"></i>
                  <p class="mt-2">Start a workout to see progress</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Finished Workout</h6>
            </div>
            <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
              <div id="finishedWorkouts">
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="body-workout" role="tabpanel" aria-labelledby="body-workout-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="m-0">Body Workout</h5>
        <button class="btn btn-primary" onclick="startQuickWorkout()">
          <i class="bi bi-play-circle"></i> Quick Workout
        </button>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h6 class="card-title">Target Body Parts</h6>
          <div class="row g-3">
            <div class="col-md-2 col-sm-3 col-4">
              <div class="body-part-card" onclick="selectBodyPart('chest', event)">
                <div class="body-part-icon">💪</div>
                <div class="body-part-name">Chest</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-3 col-4">
              <div class="body-part-card" onclick="selectBodyPart('back', event)">
                <div class="body-part-icon">🏋️</div>
                <div class="body-part-name">Back</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-3 col-4">
              <div class="body-part-card" onclick="selectBodyPart('legs', event)">
                <div class="body-part-icon">🦵</div>
                <div class="body-part-name">Legs</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-3 col-4">
              <div class="body-part-card" onclick="selectBodyPart('arms', event)">
                <div class="body-part-icon">💪</div>
                <div class="body-part-name">Arms</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-3 col-4">
              <div class="body-part-card" onclick="selectBodyPart('core', event)">
                <div class="body-part-icon">🎯</div>
                <div class="body-part-name">Core</div>
              </div>
            </div>
            <div class="col-md-2 col-sm-3 col-4">
              <div class="body-part-card" onclick="selectBodyPart('shoulders', event)">
                <div class="body-part-icon">🤸</div>
                <div class="body-part-name">Shoulders</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Recommended Exercises</h6>
          <span class="badge bg-info" id="selectedBodyPartBadge">Select body part</span>
        </div>
        <div class="card-body">
          <div id="recommendedExercises" class="row g-3">
            <div class="col-12 text-center text-muted py-5">
              <i class="bi bi-cursor-text fs-1"></i>
              <p class="mt-2">Select a body part to see recommended exercises</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="filter" role="tabpanel" aria-labelledby="filter-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="m-0">Workout Filter</h5>
        <button class="btn btn-outline-primary" onclick="clearAllFilters()">
          <i class="bi bi-arrow-clockwise"></i> Clear All
        </button>
      </div>
    
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Workout Type</label>
              <select id="typeFilter" class="form-select" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="strength">Strength Training</option>
                <option value="cardio">Cardio</option>
                <option value="yoga">Yoga</option>
                <option value="crossfit">CrossFit</option>
                <option value="running">Running</option>
                <option value="cycling">Cycling</option>
                <option value="swimming">Swimming</option>
                <option value="mobility">Mobility</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Duration</label>
              <select id="durationFilter" class="form-select" onchange="applyFilters()">
                <option value="">Any Duration</option>
                <option value="0-15">0-15 minutes</option>
                <option value="15-30">15-30 minutes</option>
                <option value="30-45">30-45 minutes</option>
                <option value="45-60">45-60 minutes</option>
                <option value="60+">60+ minutes</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Difficulty</label>
              <select id="difficultyFilter" class="form-select" onchange="applyFilters()">
                <option value="">All Levels</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select id="statusFilter" class="form-select" onchange="applyFilters()">
                <option value="">All Status</option>
                <option value="completed">Completed</option>
                <option value="in_progress">In Progress</option>
                <option value="partial">Partial</option>
                <option value="missed">Missed</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Filtered Workouts</h6>
          <span class="badge bg-primary" id="resultCount">0 results</span>
        </div>
        <div class="card-body">
          <div id="filteredWorkouts" class="row g-3">
            </div>
        </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="top-workouts" role="tabpanel" aria-labelledby="top-workouts-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="m-0">Top Workouts</h5>
        <div class="btn-group">
          <button class="btn btn-outline-primary active" onclick="showTopWorkouts('calories', event)">Most Calories</button>
          <button class="btn btn-outline-primary" onclick="showTopWorkouts('duration', event)">Longest</button>
          <button class="btn btn-outline-primary" onclick="showTopWorkouts('recent', event)">Most Recent</button>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header bg-warning text-dark">
              <h6 class="mb-0"><i class="bi bi-trophy"></i> Top Performers</h6>
            </div>
            <div class="card-body" id="topPerformers">
              </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0"><i class="bi bi-heart"></i> Recent Favorites</h6>
            </div>
            <div class="card-body" id="recentFavorites">
              </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0"><i class="bi bi-star"></i> Achievements</h6>
            </div>
            <div class="card-body" id="achievements">
              </div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">
          <h6 class="mb-0">All Time Best Workouts</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Workout</th>
                  <th>Type</th>
                  <th>Duration</th>
                  <th>Calories</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="topWorkoutsTable">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</section>

<div class="modal fade" id="workoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="workoutForm" class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="workoutModalTitle">Add Workout</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="workoutId">
        
        <div class="row">
          <div class="col-md-8">
            <div class="mb-3">
              <label class="form-label">Workout Title</label>
              <input id="workoutTitle" type="text" class="form-control" required maxlength="150" 
                     placeholder="e.g., Morning Strength Training">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input id="workoutDate" type="date" class="form-control" required>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Workout Type</label>
              <select id="workoutType" class="form-select" required onchange="handleWorkoutTypeChange()">
                <option value="strength">💪 Strength Training</option>
                <option value="cardio">🏃 Cardio</option>
                <option value="yoga">🧘 Yoga</option>
                <option value="crossfit">🏋️ CrossFit</option>
                <option value="running">🏃‍♂️ Running</option>
                <option value="cycling">🚴 Cycling</option>
                <option value="swimming">🏊 Swimming</option>
                <option value="mobility">🤸 Mobility</option>
                <option value="pilates">🤸‍♀️ Pilates</option>
                <option value="boxing">🥊 Boxing</option>
                <option value="other">✍️ Other (Specify)</option>
              </select>
            </div>
          </div>
          <div class="col-md-8" id="customWorkoutTypeContainer" style="display: none;">
             <div class="mb-3">
                <label class="form-label">Custom Type Name</label>
                <input id="customWorkoutType" type="text" class="form-control" placeholder="e.g., Agility Drills">
              </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Duration (minutes)</label>
              <input id="plannedDuration" type="number" class="form-control" min="1" max="300" required 
                     placeholder="30" onchange="updateCaloriesEstimate()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Difficulty</label>
              <select id="difficultyLevel" class="form-select" onchange="updateCaloriesEstimate()">
                <option value="beginner">🟢 Beginner</option>
                <option value="intermediate">🟡 Intermediate</option>
                <option value="advanced">🔴 Advanced</option>
              </select>
            </div>
          </div>
           <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select id="completionStatus" class="form-select">
                <option value="completed">✅ Completed</option>
                <option value="in_progress">⏳ In Progress</option>
                <option value="partial">⚠️ Partial</option>
                <option value="missed">❌ Missed</option>
              </select>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label">Workout Image</label>
              <div class="text-center p-3 border rounded" id="imagePreview">
                <img id="generatedImage" src="" style="width: 200px; height: 120px; object-fit: cover; border-radius: 8px; display: none;">
                <div id="imagePlaceholder" class="bg-light d-flex align-items-center justify-content-center rounded" 
                     style="width: 200px; height: 120px; margin: 0 auto;">
                  <i class="bi bi-image fs-1 text-muted"></i>
                </div>
                <small class="text-muted d-block mt-2">Image will be generated based on workout type</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Calories Burned (estimated)</label>
              <input id="caloriesBurned" type="number" class="form-control" min="0" readonly>
              <small class="text-muted">Auto-calculated based on type, duration, and difficulty</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Actual Duration (minutes)</label>
              <input id="actualDuration" type="number" class="form-control" min="0" placeholder="e.g., 35">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Average Heart Rate</label>
              <input id="avgHeartRateInput" type="number" class="form-control" min="0" max="220" placeholder="150">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Max Heart Rate</label>
              <input id="maxHeartRateInput" type="number" class="form-control" min="0" max="220" placeholder="180">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Aerobic Effect (0-5)</label>
              <input id="aerobicEffect" type="number" class="form-control" min="0" max="5" step="0.1" placeholder="2.5">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Anaerobic Effect (0-5)</label>
              <input id="anaerobicEffect" type="number" class="form-control" min="0" max="5" step="0.1" placeholder="1.2">
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Recovery Time (hours)</label>
          <input id="recoveryTimeInput" type="number" class="form-control" min="0" max="72" placeholder="24">
        </div>
        
        <div class="mb-3 mt-3">
          <label class="form-label">Notes</label>
          <textarea id="workoutNotes" class="form-control" rows="3" 
                    placeholder="How did the workout feel? Any observations..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit" id="saveWorkoutBtn">
          <span id="saveButtonText">Save Workout</span>
          <div class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner"></div>
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="workoutDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalTitle">Workout Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="workoutDetailContent">
        </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" onclick="editWorkoutFromDetail()">Edit Workout</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let WORKOUTS = [];
let currentWeek = new Date();
let editingWorkoutId = null;
let selectedWorkout = null;
let heartRateChart = null;
let progressChart = null;

// Workout type images and calorie rates
const WORKOUT_CONFIGS = {
  strength: { 
    emoji: '💪', 
    color: '#dc3545',
    caloriesPerMinute: 8,
    bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  },
  cardio: { 
    emoji: '🏃', 
    color: '#fd7e14',
    caloriesPerMinute: 12,
    bgGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
  },
  yoga: { 
    emoji: '🧘', 
    color: '#20c997',
    caloriesPerMinute: 4,
    bgGradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
  },
  crossfit: { 
    emoji: '🏋️', 
    color: '#6f42c1',
    caloriesPerMinute: 15,
    bgGradient: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
  },
  running: { 
    emoji: '🏃‍♂️', 
    color: '#0d6efd',
    caloriesPerMinute: 14,
    bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  },
  cycling: { 
    emoji: '🚴', 
    color: '#198754',
    caloriesPerMinute: 10,
    bgGradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
  },
  swimming: { 
    emoji: '🏊', 
    color: '#0dcaf0',
    caloriesPerMinute: 13,
    bgGradient: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
  },
  mobility: { 
    emoji: '🤸', 
    color: '#ffc107',
    caloriesPerMinute: 3,
    bgGradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
  },
  pilates: { 
    emoji: '🤸‍♀️', 
    color: '#e91e63',
    caloriesPerMinute: 5,
    bgGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
  },
  boxing: { 
    emoji: '🥊', 
    color: '#795548',
    caloriesPerMinute: 16,
    bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  },
  other: { 
    emoji: '📝',
    color: '#6c757d',
    caloriesPerMinute: 7,
    bgGradient: 'linear-gradient(135deg, #e2e2e2 0%, #c1c1c1 100%)'
  }
};

// Utility functions
function alertShow(message, type = "info") {
  const container = document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-lg" role="alert" style="z-index:1060; min-width: 300px;">
      <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'info-circle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}

function formatTime(minutes) {
  if (!minutes) return "0h 0m";
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
}

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('en-US', { 
    weekday: 'short', 
    month: 'short', 
    day: 'numeric' 
  });
}

function generateWorkoutImage() {
  const workoutType = document.getElementById('workoutType').value;
  const customWorkoutType = document.getElementById('customWorkoutType').value;
  const finalType = workoutType === 'other' ? customWorkoutType || 'Other' : workoutType;
  
  const config = WORKOUT_CONFIGS[finalType] || WORKOUT_CONFIGS.other;
  
  const canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');
  
  const gradient = ctx.createLinearGradient(0, 0, 400, 240);
  gradient.addColorStop(0, config.color + '80');
  gradient.addColorStop(1, config.color + '40');
  
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 400, 240);
  
  ctx.font = '80px Arial';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(config.emoji, 200, 140);
  
  ctx.font = 'bold 24px Arial';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(finalType.charAt(0).toUpperCase() + finalType.slice(1), 200, 200);
  
  const dataURL = canvas.toDataURL('image/png');
  document.getElementById('generatedImage').src = dataURL;
  document.getElementById('generatedImage').style.display = 'block';
  document.getElementById('imagePlaceholder').style.display = 'none';
  
  return dataURL;
}

function updateCaloriesEstimate() {
  const workoutType = document.getElementById('workoutType').value;
  const duration = parseInt(document.getElementById('plannedDuration').value) || 0;
  const difficulty = document.getElementById('difficultyLevel').value;
  
  if (workoutType && duration > 0) {
    const config = WORKOUT_CONFIGS[workoutType] || WORKOUT_CONFIGS.other;
    let caloriesPerMinute = config.caloriesPerMinute;
    
    const difficultyMultiplier = {
      beginner: 0.8,
      intermediate: 1.0,
      advanced: 1.3
    };
    
    const estimatedCalories = Math.round(duration * caloriesPerMinute * difficultyMultiplier[difficulty]);
    document.getElementById('caloriesBurned').value = estimatedCalories;
  }
}

// Calendar functions
function changeWeek(direction) {
  currentWeek.setDate(currentWeek.getDate() + (direction * 7));
  generateWeeklyCalendar();
}

function goToToday() {
  currentWeek = new Date();
  generateWeeklyCalendar();
}

function generateWeeklyCalendar() {
  const startOfWeek = new Date(currentWeek);
  startOfWeek.setDate(currentWeek.getDate() - startOfWeek.getDay());
  
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  
  document.getElementById('weekRange').textContent = 
    `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
  
  const calendarContainer = document.getElementById('weeklyCalendar');
  calendarContainer.innerHTML = '';
  
  const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);
    
    const isToday = date.toDateString() === new Date().toDateString();
    const dayWorkouts = WORKOUTS.filter(w => 
      new Date(w.date).toDateString() === date.toDateString()
    );
    
    const dayElement = document.createElement('div');
    dayElement.className = 'col text-center';
    dayElement.innerHTML = `
      <div class="calendar-day p-2 rounded ${isToday ? 'bg-primary text-white' : 'bg-light'}" 
           style="cursor: pointer; min-height: 80px; position: relative;" 
           onclick="selectDate('${date.toISOString().split('T')[0]}', ${JSON.stringify(dayWorkouts).replace(/"/g, '&quot;')})">
        <div class="small">${days[i]}</div>
        <div class="fw-bold">${date.getDate()}</div>
        <div class="mt-1">
          ${dayWorkouts.map(w => {
            const statusColor = w.completion_status === 'completed' ? 'success' : 
                               w.completion_status === 'in_progress' ? 'warning' : 'secondary';
            return `<div class="badge bg-${statusColor} mb-1" style="font-size: 8px;" 
                         onclick="event.stopPropagation(); showWorkoutDetails(${w.id})" 
                         title="${w.title}">●</div>`;
          }).join('')}
        </div>
      </div>
    `;
    calendarContainer.appendChild(dayElement);
  }
}

function generateMonthlyCalendar() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
  
  let calendarHTML = `
    <div class="row g-0 small text-center mb-2">
      <div class="col fw-bold">S</div><div class="col fw-bold">M</div><div class="col fw-bold">T</div>
      <div class="col fw-bold">W</div><div class="col fw-bold">T</div><div class="col fw-bold">F</div><div class="col fw-bold">S</div>
    </div>
  `;
  
  let week = '<div class="row g-0">';
  
  // Empty cells for days before month starts
  for (let i = 0; i < firstDay; i++) {
    week += '<div class="col p-1"><div style="height: 32px;"></div></div>';
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = day === today;
    const dateString = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    const dayWorkouts = WORKOUTS.filter(w => w.date === dateString);
    const hasWorkout = dayWorkouts.length > 0;
    
    week += `
      <div class="col p-1">
        <div class="calendar-mini-day ${isToday ? 'bg-primary text-white' : ''} 
                    ${hasWorkout ? 'border border-success' : ''} rounded text-center d-flex align-items-center justify-content-center" 
             style="cursor: pointer; font-size: 12px; height: 32px; position: relative;"
             onclick="selectDate('${dateString}', ${JSON.stringify(dayWorkouts).replace(/"/g, '&quot;')})">
          ${day}
          ${hasWorkout ? '<div class="position-absolute" style="top: -2px; right: -2px; width: 8px; height: 8px; background: #28a745; border-radius: 50%;"></div>' : ''}
        </div>
      </div>
    `;
    
    if ((firstDay + day) % 7 === 0) {
      week += '</div><div class="row g-0">';
    }
  }
  
  week += '</div>';
  calendarHTML += week;
  
  document.getElementById('monthlyCalendar').innerHTML = calendarHTML;
}

// Workout functions
async function fetchWorkouts() {
  try {
    const response = await fetch('/athlete/api/workouts', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      }
    });
    
    if (!response.ok) throw new Error(await response.text() || 'Network error');
    
    WORKOUTS = await response.json();
    updateDashboard();
    generateWeeklyCalendar();
    generateMonthlyCalendar();
    
  } catch (error) {
    console.error('Fetch error:', error);
    WORKOUTS = [];
    alertShow(`Failed to load workouts: ${error.message}`, 'danger');
  }
}

// Date selection and workout display
function selectDate(dateString, dayWorkouts = []) {
  if (dayWorkouts && dayWorkouts.length > 0) {
    showWorkoutDetails(dayWorkouts[0].id);
  } else {
    openAddWorkout(dateString);
  }
}

function openAddWorkout(selectedDate = null) {
  resetForm();
  if (selectedDate) {
    document.getElementById('workoutDate').value = selectedDate;
  } else {
    document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  }
  const modal = new bootstrap.Modal(document.getElementById('workoutModal'));
  modal.show();
  
  setTimeout(() => generateWorkoutImage(), 100);
}

function showWorkoutDetails(workoutId) {
  const workout = WORKOUTS.find(w => w.id === workoutId);
  if (!workout) {
    alertShow('Workout not found', 'error');
    return;
  }
  
  selectedWorkout = workout;
  
  const detailModal = new bootstrap.Modal(document.getElementById('workoutDetailModal'));
  detailModal.show();
  
  document.getElementById('detailModalTitle').textContent = workout.title;
  
  const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.other;
  
  document.getElementById('workoutDetailContent').innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <div class="text-center mb-3">
          <div style="width: 200px; height: 120px; background: ${config.bgGradient}; 
                      border-radius: 12px; display: flex; align-items: center; 
                      justify-content: center; margin: 0 auto;">
            <span style="font-size: 48px;">${config.emoji}</span>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <h5 class="text-primary">${workout.title}</h5>
        <div class="mb-2">
          <strong>Type:</strong> 
          <span class="badge" style="background-color: ${config.color}">
            ${workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1)}
          </span>
        </div>
        <div class="mb-2"><strong>Date:</strong> ${formatDate(workout.date)}</div>
        <div class="mb-2"><strong>Duration:</strong> ${workout.actual_duration || workout.planned_duration || 0} minutes</div>
        <div class="mb-2"><strong>Calories:</strong> ${workout.calories_burned || 0} kcal</div>
        <div class="mb-2">
          <strong>Status:</strong> 
          <span class="badge ${workout.completion_status === 'completed' ? 'bg-success' : 
                              workout.completion_status === 'in_progress' ? 'bg-warning' : 
                              workout.completion_status === 'partial' ? 'bg-info' : 'bg-danger'}">
            ${workout.completion_status.charAt(0).toUpperCase() + workout.completion_status.slice(1)}
          </span>
        </div>
      </div>
    </div>
    
    ${workout.avg_heart_rate || workout.max_heart_rate ? `
      <hr>
      <div class="row">
        <div class="col-md-6">
          <h6>Heart Rate Data</h6>
          ${workout.avg_heart_rate ? `<div><strong>Average:</strong> ${workout.avg_heart_rate} bpm</div>` : ''}
          ${workout.max_heart_rate ? `<div><strong>Maximum:</strong> ${workout.max_heart_rate} bpm</div>` : ''}
        </div>
        <div class="col-md-6">
          <h6>Training Effects</h6>
          ${workout.training_effect?.aerobic ? `<div><strong>Aerobic:</strong> ${workout.training_effect.aerobic}</div>` : ''}
          ${workout.training_effect?.anaerobic ? `<div><strong>Anaerobic:</strong> ${workout.training_effect.anaerobic}</div>` : ''}
          ${workout.recovery_time ? `<div><strong>Recovery:</strong> ${workout.recovery_time}h</div>` : ''}
        </div>
      </div>
    ` : ''}
    
    ${workout.notes ? `
      <hr>
      <h6>Notes</h6>
      <p class="text-muted">${workout.notes}</p>
    ` : ''}
  `;
}


function updateDashboard() {
  updateStatsCards();
  updateHeartRateChart();
  updateFinishedWorkouts();
  updateTrainingEffect();
  updateProgressChart();
}

function updateStatsCards() {
  const recentWorkout = WORKOUTS.filter(w => w.completion_status === 'completed').slice(-1)[0];
  
  if (recentWorkout) {
    const config = WORKOUT_CONFIGS[recentWorkout.workout_type] || WORKOUT_CONFIGS.other;
    
    if (recentWorkout.image_url) {
      document.getElementById('currentWorkoutImage').src = recentWorkout.image_url;
      document.getElementById('currentWorkoutImage').style.display = 'block';
      document.getElementById('workoutImagePlaceholder').style.display = 'none';
    } else {
      document.getElementById('workoutImagePlaceholder').style.background = config.bgGradient;
      document.getElementById('workoutImagePlaceholder').innerHTML = `<span style="font-size: 24px;">${config.emoji}</span>`;
    }
    
    document.getElementById('currentWorkoutTitle').textContent = recentWorkout.title;
    document.getElementById('currentWorkoutDuration').textContent = formatTime(recentWorkout.actual_duration || 0);
    document.getElementById('currentCalories').textContent = `${recentWorkout.calories_burned || 0} Kcal`;

  } else {
    document.getElementById('currentWorkoutImage').style.display = 'none';
    document.getElementById('workoutImagePlaceholder').style.display = 'flex';
    document.getElementById('currentWorkoutTitle').textContent = 'No Recent Workout';
    document.getElementById('currentWorkoutDuration').textContent = '00:00:00';
    document.getElementById('currentCalories').textContent = '0 Kcal';
  }
  
  const completedWorkouts = WORKOUTS.filter(w => w.completion_status === 'completed');
  const totalCalories = completedWorkouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
  const avgHeartRate = completedWorkouts.length > 0 ? 
    Math.round(completedWorkouts.reduce((sum, w) => sum + (w.avg_heart_rate || 0), 0) / completedWorkouts.length) : 0;
  
  document.getElementById('avgHeartRate').textContent = avgHeartRate > 0 ? `${avgHeartRate} bpm` : '-- bpm';
  document.getElementById('totalCalories').textContent = `${totalCalories} Kcal`;
  
  const maxHR = Math.max(...completedWorkouts.map(w => w.max_heart_rate || 0));
  document.getElementById('maxHeartRateDisplay').textContent = maxHR > 0 ? maxHR : '--';
}

function updateHeartRateChart() {
  const ctx = document.getElementById('heartRateChart');
  if (!ctx) return;
  
  if (heartRateChart) {
    heartRateChart.destroy();
  }
  
  const recentWorkouts = WORKOUTS.filter(w => w.completion_status === 'completed').slice(0, 7).reverse();
  const heartRateData = recentWorkouts.map(w => w.avg_heart_rate || 0);
  const labels = recentWorkouts.map((w) => w.date.substring(5)); // Use MM-DD format
  
  heartRateChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: heartRateData,
        backgroundColor: 'rgba(255, 212, 59, 0.8)',
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { 
          beginAtZero: true,
          display: true,
          max: 200,
          title: {
            display: true,
            text: 'Avg Heart Rate (bpm)'
          }
        },
        x: { 
          display: true
        }
      },
      elements: {
        bar: {
          borderRadius: 4
        }
      }
    }
  });
}

function updateFinishedWorkouts() {
  const finishedWorkouts = WORKOUTS
    .filter(w => w.completion_status === 'completed')
    .slice(0, 6)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const container = document.getElementById('finishedWorkouts');
  
  if (finishedWorkouts.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-calendar-x fs-1"></i>
        <p class="mt-2">No completed workouts yet</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = finishedWorkouts.map(workout => {
    const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.other;
    const workoutDate = new Date(workout.date);
    const isRecent = (new Date() - workoutDate) < (7 * 24 * 60 * 60 * 1000);
    
    return `
      <div class="d-flex align-items-center p-2 border-bottom workout-item" 
           style="cursor: pointer;" onclick="showWorkoutDetails(${workout.id})">
        <div class="rounded me-3 d-flex align-items-center justify-content-center" 
             style="width: 40px; height: 40px; background: ${config.bgGradient};">
          <span style="font-size: 16px;">${config.emoji}</span>
        </div>
        <div class="flex-grow-1">
          <div class="fw-medium small">${workout.title}</div>
          <div class="text-muted small">
            ${formatDate(workout.date)} • ${workout.actual_duration || workout.planned_duration || 0}m
            ${isRecent ? '<span class="badge bg-success ms-1" style="font-size: 8px;">NEW</span>' : ''}
          </div>
        </div>
        <div class="text-success">
          <i class="bi bi-check-circle-fill"></i>
        </div>
      </div>
    `;
  }).join('');
}

function updateTrainingEffect() {
  const recentWorkouts = WORKOUTS.filter(w => 
    w.completion_status === 'completed' && 
    (new Date() - new Date(w.date)) < (7 * 24 * 60 * 60 * 1000)
  );
  
  const recoveryTimeDisplay = document.getElementById('recoveryTime');
  const trainingEffectBar = document.getElementById('trainingEffectBar');
  
  if (recentWorkouts.length === 0) {
    if (recoveryTimeDisplay) recoveryTimeDisplay.textContent = '--';
    if (trainingEffectBar) trainingEffectBar.innerHTML = '<div class="text-muted small">No recent data</div>';
    return;
  }
  
  const avgRecoveryTime = Math.round(
    recentWorkouts.reduce((sum, w) => sum + (w.recovery_time || 24), 0) / recentWorkouts.length
  );
  
  if (recoveryTimeDisplay) recoveryTimeDisplay.textContent = `${avgRecoveryTime}h`;
  
  const effectTypes = ['Minor', 'Maintaining', 'Improving', 'Recovery', 'Overreaching'];
  const effectColors = ['success', 'warning', 'info', 'primary', 'danger'];
  const effectWidths = [20, 25, 30, 20, 5]; // Example distribution
  
  const barHTML = effectTypes.map((type, i) => 
    `<div class="progress-bar bg-${effectColors[i]}" style="width: ${effectWidths[i]}%"></div>`
  ).join('');
  
  if (trainingEffectBar) trainingEffectBar.innerHTML = barHTML;
}

async function updateProgressChart() {
    try {
        const response = await fetch('/athlete/api/progress', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to load progress data');
        
        const data = await response.json();
        const ctx = document.getElementById('progressChart');
        
        if (progressChart) {
            progressChart.destroy();
        }
        
        if (data.labels && data.labels.length > 0) {
            document.getElementById('progressSection').innerHTML = `<canvas id="progressChart" style="max-height: 250px;"></canvas>`;
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Calories Burned (kcal)',
                        data: data.calories_burned,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Weight (kg)',
                        data: data.weights,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } else {
            document.getElementById('progressSection').innerHTML = `
                <div class="text-center text-muted py-3">
                  <i class="bi bi-activity fs-1"></i>
                  <p class="mt-2">Start a workout to see progress</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading progress data:', error);
        alertShow('Failed to load progress data.', 'danger');
    }
}


function handleWorkoutTypeChange() {
  const workoutType = document.getElementById('workoutType').value;
  const customContainer = document.getElementById('customWorkoutTypeContainer');
  if (workoutType === 'other') {
    customContainer.style.display = 'block';
  } else {
    customContainer.style.display = 'none';
  }
  generateWorkoutImage();
  updateCaloriesEstimate();
}


function resetForm() {
  document.getElementById('workoutForm').reset();
  editingWorkoutId = null;
  selectedWorkout = null;
  document.getElementById('workoutModalTitle').textContent = 'Add Workout';
  document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  
  document.getElementById('generatedImage').style.display = 'none';
  document.getElementById('imagePlaceholder').style.display = 'flex';
  document.getElementById('customWorkoutTypeContainer').style.display = 'none';
  
  const advancedCollapse = document.getElementById('collapseAdvanced');
  if (advancedCollapse) {
    if (advancedCollapse.classList.contains('show')) {
      bootstrap.Collapse.getInstance(advancedCollapse)?.hide();
    }
  }
}

function editWorkoutFromDetail() {
  if (!selectedWorkout) return;
  
  const detailModalElement = document.getElementById('workoutDetailModal');
  const detailModal = bootstrap.Modal.getInstance(detailModalElement);
  
  detailModalElement.addEventListener('hidden.bs.modal', function handler() {
    editingWorkoutId = selectedWorkout.id;
    document.getElementById('workoutModalTitle').textContent = 'Edit Workout';
    document.getElementById('saveButtonText').textContent = 'Update Workout';
    
    document.getElementById('workoutId').value = selectedWorkout.id;
    document.getElementById('workoutTitle').value = selectedWorkout.title || '';
    
    if(WORKOUT_CONFIGS[selectedWorkout.workout_type]) {
      document.getElementById('workoutType').value = selectedWorkout.workout_type;
      document.getElementById('customWorkoutTypeContainer').style.display = 'none';
    } else {
      document.getElementById('workoutType').value = 'other';
      document.getElementById('customWorkoutTypeContainer').style.display = 'block';
      document.getElementById('customWorkoutType').value = selectedWorkout.workout_type || '';
    }

    document.getElementById('plannedDuration').value = selectedWorkout.planned_duration || selectedWorkout.actual_duration || 30;
    document.getElementById('caloriesBurned').value = selectedWorkout.calories_burned || 0;
    document.getElementById('difficultyLevel').value = selectedWorkout.difficulty_level || 'beginner';
    document.getElementById('completionStatus').value = selectedWorkout.completion_status || 'completed';
    document.getElementById('workoutDate').value = selectedWorkout.date || new Date().toISOString().split('T')[0];
    document.getElementById('workoutNotes').value = selectedWorkout.notes || '';
    
    document.getElementById('actualDuration').value = selectedWorkout.actual_duration || '';
    document.getElementById('avgHeartRateInput').value = selectedWorkout.avg_heart_rate || '';
    document.getElementById('maxHeartRateInput').value = selectedWorkout.max_heart_rate || '';
    document.getElementById('aerobicEffect').value = selectedWorkout.training_effect?.aerobic || '';
    document.getElementById('anaerobicEffect').value = selectedWorkout.training_effect?.anaerobic || '';
    document.getElementById('recoveryTimeInput').value = selectedWorkout.recovery_time || '';
    
    generateWorkoutImage();
    const workoutModal = new bootstrap.Modal(document.getElementById('workoutModal'));
    workoutModal.show();
    
    detailModalElement.removeEventListener('hidden.bs.modal', handler);
  }, { once: true });
  
  if (detailModal) {
    detailModal.hide();
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  
  fetchWorkouts();
  
  document.getElementById('workoutType').addEventListener('change', () => {
    handleWorkoutTypeChange();
  });
  
  document.getElementById('plannedDuration').addEventListener('input', updateCaloriesEstimate);
  document.getElementById('difficultyLevel').addEventListener('change', updateCaloriesEstimate);
  
  document.getElementById('workoutModal').addEventListener('hidden.bs.modal', resetForm);
  
  setTimeout(() => generateWorkoutImage(), 500);
});

const additionalCSS = `
<style>
.workout-item:hover,
.workout-card:hover { background-color: #f8f9fa; transform: translateY(-2px); transition: all 0.3s ease; }
.calendar-day:hover,
.calendar-mini-day:hover { opacity: 0.8; transition: opacity 0.2s ease; }
.card { box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: none; transition: box-shadow 0.3s ease; }
.card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.12); }
#imagePreview { transition: all 0.3s ease; }
.form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
.btn-primary:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3); }
.badge { font-weight: 500; padding: 0.35em 0.65em; }
.calendar-day, .calendar-mini-day { transition: all 0.2s ease; user-select: none; }
.progress { height: 8px; border-radius: 10px; }
.progress-bar { border-radius: 10px; }
@media (max-width: 768px) { .col-md-8, .col-md-4 { margin-bottom: 1rem; } }
</style>
`;
document.head.insertAdjacentHTML('beforeend', additionalCSS);
</script>

<script>
// Body Workout Functions
function selectBodyPart(bodyPart, event) {
  const card = event.currentTarget;
  card.classList.toggle('selected');
  
  const selectedParts = Array.from(document.querySelectorAll('.body-part-card.selected'))
    .map(el => el.onclick.toString().match(/selectBodyPart\('(\w+)'/)[1]);
  
  if (selectedParts.length > 0) {
    document.getElementById('selectedBodyPartBadge').textContent = selectedParts.join(', ');
    loadRecommendedExercises(selectedParts);
  } else {
    document.getElementById('selectedBodyPartBadge').textContent = 'Select body part';
    document.getElementById('recommendedExercises').innerHTML = `
      <div class="col-12 text-center text-muted py-5">
        <i class="bi bi-cursor-text fs-1"></i>
        <p class="mt-2">Select a body part to see recommended exercises</p>
      </div>
    `;
  }
}

async function loadRecommendedExercises(bodyParts) {
  try {
    const response = await fetch(`/athlete/api/exercises?body_part=${bodyParts.join(',')}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      }
    });
    
    if (!response.ok) throw new Error('Failed to load exercises');
    
    const exercises = await response.json();
    const container = document.getElementById('recommendedExercises');
    
    if (exercises.length === 0) {
      container.innerHTML = `
        <div class="col-12 text-center text-muted py-5">
          <i class="bi bi-info-circle fs-1"></i>
          <p class="mt-2">No exercises found for selected body parts</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = exercises.map(ex => `
      <div class="col-md-6">
        <div class="exercise-item">
          <img src="${ex.gif_url || '/static/images/placeholder-exercise.png'}" 
               class="exercise-thumb" alt="${ex.name}">
          <div class="exercise-details">
            <div class="exercise-name">${ex.name}</div>
            <div class="exercise-duration">
              ${ex.body_parts} • ${ex.equipment || 'No equipment'}
            </div>
          </div>
          <button class="btn btn-sm btn-outline-primary" onclick="addExerciseToWorkout(${ex.id})">
            <i class="bi bi-plus"></i>
          </button>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Error loading exercises:', error);
    alertShow('Failed to load exercises', 'danger');
  }
}

function addExerciseToWorkout(exerciseId) {
  alertShow('Exercise added to workout plan!', 'success');
}

function startQuickWorkout() {
  const selectedParts = Array.from(document.querySelectorAll('.body-part-card.selected'))
    .map(el => el.querySelector('.body-part-name').textContent);
  
  if (selectedParts.length === 0) {
    alertShow('Please select at least one body part', 'warning');
    return;
  }
  
  openAddWorkout();
  document.getElementById('workoutTitle').value = `${selectedParts.join(' + ')} Workout`;
  document.getElementById('workoutType').value = 'strength';
  handleWorkoutTypeChange();
}

// Filter Functions
function applyFilters() {
  const filters = {
    type: document.getElementById('typeFilter').value,
    duration: document.getElementById('durationFilter').value,
    difficulty: document.getElementById('difficultyFilter').value,
    status: document.getElementById('statusFilter').value
  };
  
  loadFilteredWorkouts(filters);
}

async function loadFilteredWorkouts(filters) {
  try {
    const response = await fetch('/athlete/api/workouts/filter', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(filters)
    });
    
    if (!response.ok) throw new Error('Failed to filter workouts');
    
    const workouts = await response.json();
    const container = document.getElementById('filteredWorkouts');
    document.getElementById('resultCount').textContent = `${workouts.length} results`;
    
    if (workouts.length === 0) {
      container.innerHTML = `
        <div class="col-12 text-center text-muted py-5">
          <i class="bi bi-search fs-1"></i>
          <p class="mt-2">No workouts match your filters</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = workouts.map(workout => {
      const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.other;
      const statusClass = workout.completion_status === 'completed' ? 'success' : 
                         workout.completion_status === 'in_progress' ? 'warning' : 
                         workout.completion_status === 'partial' ? 'info' : 'danger';
      
      return `
        <div class="col-md-6 col-lg-4">
          <div class="card workout-card h-100" onclick="showWorkoutDetails(${workout.id})" style="cursor: pointer;">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <div class="rounded me-3 d-flex align-items-center justify-content-center" 
                     style="width: 50px; height: 50px; background: ${config.bgGradient};">
                  <span style="font-size: 24px;">${config.emoji}</span>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0">${workout.title}</h6>
                  <small class="text-muted">${formatDate(workout.date)}</small>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-${statusClass}">${workout.completion_status}</span>
                <span class="text-muted small">${workout.actual_duration || workout.planned_duration || 0}m</span>
                <span class="text-muted small">${workout.calories_burned || 0} kcal</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    console.error('Error filtering workouts:', error);
    alertShow('Failed to filter workouts', 'danger');
  }
}

function clearAllFilters() {
  document.getElementById('typeFilter').value = '';
  document.getElementById('durationFilter').value = '';
  document.getElementById('difficultyFilter').value = '';
  document.getElementById('statusFilter').value = '';
  applyFilters();
}

// Top Workouts Functions
function showTopWorkouts(sortBy, event) {
  // Update active button
  document.querySelectorAll('#top-workouts .btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  loadTopWorkouts(sortBy);
}

async function loadTopWorkouts(sortBy = 'calories') {
  try {
    const response = await fetch(`/athlete/api/workouts/top?sort=${sortBy}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      }
    });
    
    if (!response.ok) throw new Error('Failed to load top workouts');
    
    const workouts = await response.json();
    updateTopWorkoutsDisplay(workouts, sortBy);
    
  } catch (error) {
    console.error('Error loading top workouts:', error);
    alertShow('Failed to load top workouts', 'danger');
  }
}

function updateTopWorkoutsDisplay(workouts, sortBy) {
  // Update table
  const tableBody = document.getElementById('topWorkoutsTable');
  tableBody.innerHTML = workouts.map((workout, index) => {
    const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.other;
    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-default';
    
    return `
      <tr onclick="showWorkoutDetails(${workout.id})" style="cursor: pointer;">
        <td>
          <div class="rank-badge ${rankClass}">${index + 1}</div>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <span style="font-size: 20px; margin-right: 10px;">${config.emoji}</span>
            ${workout.title}
          </div>
        </td>
        <td><span class="badge" style="background-color: ${config.color}">${workout.workout_type}</span></td>
        <td>${workout.actual_duration || workout.planned_duration || 0}m</td>
        <td>${workout.calories_burned || 0} kcal</td>
        <td>${formatDate(workout.date)}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showWorkoutDetails(${workout.id})">
            <i class="bi bi-eye"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Update top performers (top 3)
  const topPerformers = document.getElementById('topPerformers');
  topPerformers.innerHTML = workouts.slice(0, 3).map((workout, index) => {
    const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.other;
    return `
      <div class="d-flex align-items-center mb-3 p-2 bg-light rounded" onclick="showWorkoutDetails(${workout.id})" style="cursor: pointer;">
        <div class="rank-badge ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : 'rank-3'}">${index + 1}</div>
        <div class="flex-grow-1">
          <div class="fw-medium">${workout.title}</div>
          <small class="text-muted">${workout.calories_burned || 0} kcal • ${formatDate(workout.date)}</small>
        </div>
      </div>
    `;
  }).join('');
  
  // Update recent favorites (most recent completed)
  const recentWorkouts = WORKOUTS.filter(w => w.completion_status === 'completed')
    .sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
  
  const recentFavorites = document.getElementById('recentFavorites');
  recentFavorites.innerHTML = recentWorkouts.map(workout => {
    const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.other;
    return `
      <div class="d-flex align-items-center mb-3 p-2 bg-light rounded" onclick="showWorkoutDetails(${workout.id})" style="cursor: pointer;">
        <span style="font-size: 24px; margin-right: 10px;">${config.emoji}</span>
        <div class="flex-grow-1">
          <div class="fw-medium">${workout.title}</div>
          <small class="text-muted">${formatDate(workout.date)}</small>
        </div>
      </div>
    `;
  }).join('');
  
  // Calculate achievements
  updateAchievements();
}

function updateAchievements() {
  const completedWorkouts = WORKOUTS.filter(w => w.completion_status === 'completed');
  const totalCalories = completedWorkouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
  const totalMinutes = completedWorkouts.reduce((sum, w) => sum + (w.actual_duration || 0), 0);
  
  const achievements = [];
  
  if (completedWorkouts.length >= 10) achievements.push('🏆 10+ Workouts');
  if (completedWorkouts.length >= 50) achievements.push('🌟 50+ Workouts');
  if (completedWorkouts.length >= 100) achievements.push('💎 Century Club');
  if (totalCalories >= 10000) achievements.push('🔥 10K Calories');
  if (totalMinutes >= 1000) achievements.push('⏱️ 1000+ Minutes');
  
  const achievementsContainer = document.getElementById('achievements');
  achievementsContainer.innerHTML = `
    <div class="mb-3">
      <h6 class="text-muted small">Total Stats</h6>
      <div><strong>${completedWorkouts.length}</strong> Workouts Completed</div>
      <div><strong>${totalCalories.toLocaleString()}</strong> Total Calories</div>
      <div><strong>${Math.round(totalMinutes / 60)}</strong> Hours Trained</div>
    </div>
    <div>
      <h6 class="text-muted small mb-2">Badges Earned</h6>
      ${achievements.length > 0 ? 
        achievements.map(a => `<span class="achievement-badge">${a}</span>`).join('') :
        '<p class="text-muted small">Complete more workouts to earn badges!</p>'
      }
    </div>
  `;
}

// Form submission handler
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  
  fetchWorkouts();
  
  // Initial load for top workouts
  loadTopWorkouts('calories');
  
  // Initial load for filtered workouts (all)
  applyFilters();
  
  document.getElementById('workoutType').addEventListener('change', () => {
    handleWorkoutTypeChange();
  });
  
  document.getElementById('plannedDuration').addEventListener('input', updateCaloriesEstimate);
  document.getElementById('difficultyLevel').addEventListener('change', updateCaloriesEstimate);
  
  document.getElementById('workoutModal').addEventListener('hidden.bs.modal', resetForm);
  
  // Handle form submission
  document.getElementById('workoutForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const saveBtn = document.getElementById('saveWorkoutBtn');
    const saveText = document.getElementById('saveButtonText');
    const saveSpinner = document.getElementById('saveSpinner');
    
    saveBtn.disabled = true;
    saveSpinner.classList.remove('d-none');
    saveText.textContent = 'Saving...';
    
    try {
      const formData = new FormData();
      
      // Add all form fields
      formData.append('title', document.getElementById('workoutTitle').value);
      formData.append('workout_type', document.getElementById('workoutType').value);
      formData.append('custom_workout_type', document.getElementById('customWorkoutType').value);
      formData.append('planned_duration', document.getElementById('plannedDuration').value);
      formData.append('actual_duration', document.getElementById('actualDuration').value || document.getElementById('plannedDuration').value);
      formData.append('calories_burned', document.getElementById('caloriesBurned').value);
      formData.append('difficulty_level', document.getElementById('difficultyLevel').value);
      formData.append('completion_status', document.getElementById('completionStatus').value);
      formData.append('date', document.getElementById('workoutDate').value);
      formData.append('notes', document.getElementById('workoutNotes').value);
      formData.append('avg_heart_rate', document.getElementById('avgHeartRateInput').value || '0');
      formData.append('max_heart_rate', document.getElementById('maxHeartRateInput').value || '0');
      formData.append('recovery_time', document.getElementById('recoveryTimeInput').value || '0');
      
      // Add generated image as base64
      const generatedImage = document.getElementById('generatedImage');
      if (generatedImage.src && generatedImage.src.startsWith('data:')) {
        formData.append('image_data', generatedImage.src);
      }
      
      const url = editingWorkoutId ? 
        `/athlete/api/workouts/${editingWorkoutId}` : 
        '/athlete/api/workouts/create';
      
      const method = editingWorkoutId ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.msg || 'Failed to save workout');
      }
      
      const result = await response.json();
      alertShow(result.msg, 'success');
      
      bootstrap.Modal.getInstance(document.getElementById('workoutModal')).hide();
      await fetchWorkouts();
      
    } catch (error) {
      console.error('Error saving workout:', error);
      alertShow(error.message || 'Failed to save workout', 'danger');
    } finally {
      saveBtn.disabled = false;
      saveSpinner.classList.add('d-none');
      saveText.textContent = editingWorkoutId ? 'Update Workout' : 'Save Workout';
    }
  });
  
  setTimeout(() => generateWorkoutImage(), 500);
});
</script>
{% endblock %}