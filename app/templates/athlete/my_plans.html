{% extends "shared/base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>My Training Journey</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item active">Training Plans</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="row g-3 mt-1 mb-4">
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card revenue-card">
        <div class="card-body">
          <h5 class="card-title">Active Plans</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-primary text-white">
              <i class="bi bi-clipboard-check"></i>
            </div>
            <div class="ps-3">
              <h6 id="activePlansCount">0</h6>
              <span class="text-success small pt-1 fw-bold">Currently tracking</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card customers-card">
        <div class="card-body">
          <h5 class="card-title">Completed Plans</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-success text-white">
              <i class="bi bi-trophy"></i>
            </div>
            <div class="ps-3">
              <h6 id="completedPlansCount">0</h6>
              <span class="text-primary small pt-1 fw-bold">All-time success</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card sales-card">
        <div class="card-body">
          <h5 class="card-title">Total Weeks</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-warning text-white">
              <i class="bi bi-calendar-week"></i>
            </div>
            <div class="ps-3">
              <h6 id="totalWeeksCount">0</h6>
              <span class="text-muted small pt-1">Planned duration</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xxl-3 col-md-6">
      <div class="card info-card revenue-card">
        <div class="card-body">
          <h5 class="card-title">Overall Progress</h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-info text-white">
              <i class="bi bi-graph-up"></i>
            </div>
            <div class="ps-3">
              <h6 id="progressPercentage">0%</h6>
              <span class="text-info small pt-1 fw-bold">Average completion</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label small text-muted">Search Plans</label>
          <input id="planSearch" type="text" class="form-control" placeholder="Search by title or goal..." oninput="renderPlans()">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Duration</label>
          <select id="planDuration" class="form-select" onchange="renderPlans()">
            <option value="">All Durations</option>
            <option value="<=4">Short (≤4 weeks)</option>
            <option value="5-8">Medium (5-8 weeks)</option>
            <option value=">8">Long (>8 weeks)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Status</label>
          <select id="planStatus" class="form-select" onchange="renderPlans()">
            <option value="">All Status</option>
            <option value="active">🟢 Active</option>
            <option value="completed">🏆 Completed</option>
            <option value="archived">📦 Archived</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Sort By</label>
          <select id="planSort" class="form-select" onchange="renderPlans()">
            <option value="created_desc">Newest First</option>
            <option value="progress_desc">Progress High-Low</option>
            <option value="duration_desc">Longest Duration</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="view-toggle">
      <button class="btn btn-sm btn-outline-primary active me-2" data-view="grid" onclick="toggleView('grid')">
        <i class="bi bi-grid-3x3-gap"></i> Grid
      </button>
      <button class="btn btn-sm btn-outline-primary" data-view="list" onclick="toggleView('list')">
        <i class="bi bi-list-ul"></i> List
      </button>
    </div>
    <div class="text-end">
       <span class="badge bg-primary fs-6 px-3 py-2">
          <span id="plansCount">0</span> Plans Found
       </span>
       <button class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#planModal">
        <i class="bi bi-plus-circle me-1"></i> New Plan
      </button>
    </div>
  </div>

  <div id="plansList" class="row g-3">
    </div>

  <div id="plansEmpty" class="empty-state d-none text-center py-5">
    <div class="empty-content">
      <i class="bi bi-inbox fs-1 text-muted"></i>
      <h5 class="mt-4 mb-2">No Training Plans Yet</h5>
      <p class="text-muted mb-4">Start your fitness journey by creating your first training plan!</p>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planModal">
        <i class="bi bi-plus-circle me-2"></i> Create Your First Plan
      </button>
    </div>
  </div>
</section>

<div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form id="planForm" class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="planModalTitle">Create Training Plan</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="planId">
        
        <div class="mb-4 text-center p-3 border rounded">
          <img id="imagePreview" src="/static/images/default-plan.jpg" alt="Plan Preview" class="img-fluid rounded mb-2" style="max-height: 150px; object-fit: cover;">
          <label for="planImageInput" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-upload me-1"></i> Upload Image
          </label>
          <input type="file" id="planImageInput" class="d-none" accept="image/*" onchange="previewImage(event)">
        </div>

        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">Title <span class="text-danger">*</span></label>
            <input id="planTitle" type="text" class="form-control" required maxlength="120" placeholder="e.g., Summer Body Transformation">
          </div>
          <div class="col-md-4">
            <label class="form-label">Duration (weeks) <span class="text-danger">*</span></label>
            <input id="planDurationInput" type="number" min="1" max="52" class="form-control" required>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Description & Goals</label>
          <textarea id="planDesc" rows="4" class="form-control" maxlength="2000" placeholder="Describe your training goals..."></textarea>
          <div class="text-end mt-1">
            <small class="text-muted"><span id="charCount">0</span>/2000</small>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">Status</label>
            <select id="planStatusInput" class="form-select">
              <option value="active">🟢 Active</option>
              <option value="completed">🏆 Completed</option>
              <option value="archived">📦 Archived</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Difficulty Level</label>
            <select id="planDifficulty" class="form-select">
              <option value="beginner">🟢 Beginner</option>
              <option value="intermediate">🟡 Intermediate</option>
              <option value="advanced">🔴 Advanced</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Tags (comma separated)</label>
            <input id="planTags" type="text" class="form-control" placeholder="e.g., strength, cardio">
          </div>
        </div>

        <div id="progressSection" class="d-none mt-4 border-top pt-3">
          <label class="form-label">Current Progress</label>
          <input type="range" class="form-range" id="planProgress" min="0" max="100" value="0" oninput="updateProgressLabel(this.value)">
          <div class="d-flex justify-content-between mt-2">
            <span class="fw-bold text-primary" id="progressLabel">0%</span>
            <span class="text-muted">Max: 100%</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Cancel
        </button>
        <button class="btn btn-danger me-auto d-none" id="deletePlanBtn" type="button" onclick="removePlan(editingPlanId)">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button class="btn btn-primary" type="submit" id="savePlanBtn">
          <i class="bi bi-check-circle me-1"></i> Save Plan
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="planDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsPlanTitle">Plan Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-lg-5">
            <img id="detailsPlanImage" src="/static/images/default-plan.jpg" class="img-fluid rounded-4 shadow-sm w-100" alt="Plan" style="object-fit: cover; height: 300px;">
            
            <div class="card mt-3">
              <div class="card-body pt-3">
                <h6 class="fw-bold mb-3">Plan Statistics</h6>
                <div class="d-flex justify-content-between mb-2">
                  <span><i class="bi bi-calendar-week text-primary me-2"></i>Duration</span>
                  <strong id="detailsPlanDuration">-</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span><i class="bi bi-flag text-success me-2"></i>Status</span>
                  <span id="detailsPlanStatus">-</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span><i class="bi bi-calendar-check text-info me-2"></i>Start Date</span>
                  <strong id="detailsPlanStartDate">-</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span><i class="bi bi-calendar-x text-danger me-2"></i>End Date</span>
                  <strong id="detailsPlanEndDate">-</strong>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-7">
            <div class="mb-4">
              <h6 class="fw-bold text-muted small mb-2">DESCRIPTION</h6>
              <p id="detailsPlanDescription" class="lead">-</p>
            </div>

            <div class="mb-4">
              <h6 class="fw-bold text-muted small mb-3">PROGRESS TRACKING</h6>
              <div class="progress" style="height: 30px;">
                <div class="progress-bar" id="detailsProgressBar" style="width: 0%;" role="progressbar">
                  <span id="detailsProgressText">0%</span>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <h6 class="fw-bold text-muted small mb-3">QUICK ACTIONS</h6>
              <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-warning" onclick="openEditPlanFromDetails()">
                  <i class="bi bi-pencil me-2"></i>Edit Plan
                </button>
                <button class="btn btn-outline-success" onclick="markAsCompleted()">
                  <i class="bi bi-check-circle me-2"></i>Mark Complete
                </button>
                <button class="btn btn-outline-info" onclick="duplicatePlan(currentDetailsId)">
                  <i class="bi bi-files me-2"></i>Duplicate
                </button>
                <button class="btn btn-outline-danger" onclick="archivePlan()">
                  <i class="bi bi-archive me-2"></i>Archive
                </button>
              </div>
            </div>

            <div id="detailsTags" class="mb-4 d-none">
              <h6 class="fw-bold text-muted small mb-2">TAGS</h6>
              <div id="tagsContainer"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

<script>
// Global variables
let PLANS = [];
let editingPlanId = null;
let currentView = 'grid';
let currentDetailsId = null;

// API Fetch Utility
async function apiFetch(url, options = {}) {
    const token = localStorage.getItem('access_token');
    const defaultHeaders = {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json',
    };

    const finalOptions = {
        ...options,
        headers: {
            ...defaultHeaders,
            ...options.headers,
        },
    };

    try {
        const res = await fetch(url, finalOptions);
        
        const contentType = res.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.msg || data.error || `HTTP error! Status: ${res.status}`);
            }
            return data;
        } else {
            if (!res.ok) {
                 throw new Error(`HTTP error! Status: ${res.status}`);
            }
            return {};
        }
    } catch (error) {
        console.error("API Fetch Error:", error);
        throw error;
    }
}

// Alert function
function alertShow(message, type = "info") {
  const icons = {
    success: 'check-circle-fill',
    danger: 'exclamation-circle-fill',
    warning: 'exclamation-triangle-fill',
    info: 'info-circle-fill'
  };
  
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:9999; max-width: 400px;">
      <i class="bi bi-${icons[type]} me-2"></i>
      <span>${message}</span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  document.body.appendChild(wrap);
  
  setTimeout(() => wrap.remove(), 4000);
}

// Utility functions
function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  if (isNaN(date)) return '-';
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Update statistics
function updateStats() {
  const active = PLANS.filter(p => p.status === 'active').length;
  const completed = PLANS.filter(p => p.status === 'completed').length;
  const totalWeeks = PLANS.reduce((sum, p) => sum + (Number(p.duration_weeks) || 0), 0);
  const avgProgress = PLANS.length ? Math.round(PLANS.reduce((sum, p) => sum + (Number(p.progress) || 0), 0) / PLANS.length) : 0;
  
  document.getElementById('activePlansCount').textContent = active;
  document.getElementById('completedPlansCount').textContent = completed;
  document.getElementById('totalWeeksCount').textContent = totalWeeks;
  document.getElementById('progressPercentage').textContent = avgProgress + '%';
}

// Plan card template
function planCardTpl(p) {
  const difficultyColors = {
    beginner: 'success',
    intermediate: 'warning',
    advanced: 'danger'
  };
  
  const progress = p.progress || 0;
  const daysLeft = p.end_date ? Math.ceil((new Date(p.end_date) - new Date()) / (1000 * 60 * 60 * 24)) : 0;
  const diff = p.difficulty || 'intermediate';
  const statusClass = p.status === 'active' ? 'primary' : p.status === 'completed' ? 'success' : 'secondary';
  
  return `
  <div class="col-md-6 col-lg-4 col-xxl-3">
    <div class="card h-100 shadow-sm" onclick="showPlanDetails(${p.id})" style="cursor: pointer;">
      <img src="${p.image_url || '/static/images/default-plan.jpg'}" class="card-img-top" alt="Plan" style="height: 180px; object-fit: cover;">
      
      <div class="card-body">
        <h5 class="card-title">${p.title}</h5>
        <div class="mb-2">
            <span class="badge bg-${difficultyColors[diff]} me-2">${diff}</span>
            <span class="badge bg-${statusClass}">${p.status}</span>
        </div>
        
        <p class="card-text small text-muted">${(p.description || 'No description').slice(0, 70)}${(p.description || '').length > 70 ? '...' : ''}</p>
        
        <div class="d-flex justify-content-between align-items-center small mt-3">
            <span><i class="bi bi-calendar-week me-1 text-primary"></i> ${p.duration_weeks} wks</span>
            ${daysLeft > 0 ? `
            <span><i class="bi bi-clock me-1 text-warning"></i> ${daysLeft} days left</span>` : ''}
        </div>
      </div>
      
      <div class="card-footer bg-white pt-3">
          <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-primary" style="width: ${progress}%" role="progressbar">${progress}%</div>
          </div>
          <div class="d-flex justify-content-end small mt-1 text-primary fw-bold">
             ${progress}% Complete
          </div>
      </div>
    </div>
  </div>`;
}

// List view template
function planListTpl(p) {
  const progress = p.progress || 0;
  const statusIcons = { active: '🟢', completed: '🏆', archived: '📦' };
  const statusClass = p.status === 'active' ? 'warning' : p.status === 'completed' ? 'success' : 'secondary';
  
  return `
  <div class="list-group-item list-group-item-action" onclick="showPlanDetails(${p.id})">
    <div class="d-flex w-100 justify-content-between align-items-center">
        <div class="d-flex align-items-center flex-grow-1">
            <img src="${p.image_url || '/static/images/default-plan.jpg'}" alt="${p.title}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
            <div>
                <h6 class="mb-0">${p.title}</h6>
                <small class="text-muted">${(p.description || 'No description').slice(0, 100)}...</small>
            </div>
        </div>
        <div class="text-end d-flex align-items-center gap-3">
            <span class="badge bg-${statusClass} me-3">${statusIcons[p.status]} ${p.status}</span>
            
            <div class="progress" style="width: 100px; height: 5px;">
                <div class="progress-bar bg-primary" style="width: ${progress}%"></div>
            </div>
            <span class="small text-primary fw-bold">${progress}%</span>
        </div>
    </div>
  </div>`;
}

// Render plans
function renderPlans() {
  const q = document.getElementById('planSearch').value.trim().toLowerCase();
  const dur = document.getElementById('planDuration').value;
  const status = document.getElementById('planStatus').value;
  const sort = document.getElementById('planSort').value;

  let list = [...PLANS];

  // Filters
  if (q) list = list.filter(p => p.title.toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q));
  if (dur) {
    list = list.filter(p => {
      const w = Number(p.duration_weeks || 0);
      if (dur === '<=4') return w <= 4;
      if (dur === '5-8') return w >= 5 && w <= 8;
      if (dur === '>8') return w > 8;
      return true;
    });
  }
  if (status) list = list.filter(p => p.status === status);

  // Sorting
  list.sort((a, b) => {
    if (sort === 'created_desc') return new Date(b.created_at) - new Date(a.created_at);
    if (sort === 'created_asc') return new Date(a.created_at) - new Date(b.created_at);
    if (sort === 'progress_desc') return (b.progress || 0) - (a.progress || 0);
    if (sort === 'duration_asc') return (a.duration_weeks || 0) - (b.duration_weeks || 0);
    if (sort === 'duration_desc') return (b.duration_weeks || 0) - (a.duration_weeks || 0);
    return 0;
  });

  const $list = document.getElementById('plansList');
  const $empty = document.getElementById('plansEmpty');
  
  if (list.length === 0) {
      $list.innerHTML = '';
      $empty.classList.remove('d-none');
      document.getElementById('plansCount').textContent = `0 Plans Found`;
      return;
  }

  $empty.classList.add('d-none');
  
  if (currentView === 'grid') {
    $list.className = 'row g-3';
    $list.innerHTML = list.map(planCardTpl).join('');
  } else {
    $list.className = 'list-group list-group-flush';
    $list.innerHTML = list.map(planListTpl).join('');
  }
  
  document.getElementById('plansCount').textContent = `${list.length} Plans Found`;
  updateStats();
}

// Fetch plans
async function fetchPlans() {
  try {
    const data = await apiFetch('/athlete/api/plans');
    
    PLANS = (Array.isArray(data) ? data : []).map(p => ({
      ...p,
      tags: p.tags ? (typeof p.tags === 'string' ? p.tags.split(',').map(t => t.trim()) : p.tags) : [],
      progress: p.progress || 0,
      difficulty: p.difficulty || 'intermediate'
    }));
  } catch (e) {
    console.error(e);
    PLANS = [];
    alertShow('Failed to load plans', 'danger');
  } finally {
    renderPlans();
  }
}

// Show plan details
function showPlanDetails(id) {
  const p = PLANS.find(x => x.id === id);
  if (!p) return;
  
  currentDetailsId = id;
  
  document.getElementById('detailsPlanTitle').textContent = p.title;
  document.getElementById('detailsPlanImage').src = p.image_url || '/static/images/default-plan.jpg';
  document.getElementById('detailsPlanDuration').textContent = `${p.duration_weeks} weeks`;
  
  const statusEl = document.getElementById('detailsPlanStatus');
  statusEl.innerHTML = `<span class="badge bg-${p.status === 'active' ? 'success' : p.status === 'completed' ? 'primary' : 'secondary'}">${p.status}</span>`;
  
  document.getElementById('detailsPlanStartDate').textContent = formatDate(p.start_date) || 'N/A';
  document.getElementById('detailsPlanEndDate').textContent = formatDate(p.end_date) || 'N/A';
  document.getElementById('detailsPlanDescription').textContent = p.description || 'No description provided';
  
  const progress = p.progress || 0;
  const progressBar = document.getElementById('detailsProgressBar');
  
  progressBar.style.width = progress + '%';
  progressBar.classList.remove('bg-primary', 'bg-warning', 'bg-success', 'bg-danger');
  if (progress >= 100) progressBar.classList.add('bg-success');
  else if (progress >= 50) progressBar.classList.add('bg-warning');
  else progressBar.classList.add('bg-primary');
  
  document.getElementById('detailsProgressText').textContent = progress + '%';
  
  const tagsContainer = document.getElementById('tagsContainer');
  tagsContainer.innerHTML = '';
  if (p.tags && p.tags.length) {
    document.getElementById('detailsTags').classList.remove('d-none');
    tagsContainer.innerHTML = p.tags.map(tag => 
      `<span class="badge bg-primary me-2 mb-2">${tag}</span>`
    ).join('');
  } else {
    document.getElementById('detailsTags').classList.add('d-none');
  }
  
  new bootstrap.Modal(document.getElementById('planDetailsModal')).show();
}

// Edit plan
function openEditPlan(id) {
  const p = PLANS.find(x => x.id === id);
  if (!p) return;
  
  editingPlanId = id;
  document.getElementById('planModalTitle').textContent = 'Edit Training Plan';
  document.getElementById('planId').value = p.id;
  document.getElementById('planTitle').value = p.title || '';
  document.getElementById('planDurationInput').value = p.duration_weeks || 1;
  document.getElementById('planDesc').value = p.description || '';
  document.getElementById('planStatusInput').value = p.status || 'active';
  document.getElementById('planDifficulty').value = p.difficulty || 'intermediate';
  document.getElementById('planTags').value = (p.tags || []).join(', ');
  document.getElementById('imagePreview').src = p.image_url || '/static/images/default-plan.jpg';
  
  document.getElementById('progressSection').classList.remove('d-none');
  document.getElementById('planProgress').value = p.progress || 0;
  updateProgressLabel(p.progress || 0);

  document.getElementById('deletePlanBtn').classList.remove('d-none');
  
  new bootstrap.Modal(document.getElementById('planModal')).show();
}

function openEditPlanFromDetails() {
  if (currentDetailsId) {
    bootstrap.Modal.getInstance(document.getElementById('planDetailsModal')).hide();
    setTimeout(() => openEditPlan(currentDetailsId), 300);
  }
}

// Form submit
document.getElementById('planForm').addEventListener('submit', async e => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("title", document.getElementById('planTitle').value.trim());
  formData.append("duration_weeks", document.getElementById('planDurationInput').value);
  formData.append("description", document.getElementById('planDesc').value.trim());
  formData.append("status", document.getElementById('planStatusInput').value);
  formData.append("difficulty", document.getElementById('planDifficulty').value);
  formData.append("tags", document.getElementById('planTags').value);
  
  // Progress is only sent during PUT (edit)
  if (editingPlanId) {
    formData.append("progress", document.getElementById('planProgress').value);
  }
  
  const fileInput = document.getElementById("planImageInput");
  if (fileInput.files[0]) {
    formData.append("image", fileInput.files[0]);
  }

  try {
    const url = editingPlanId ? `/athlete/api/plans/${editingPlanId}` : "/athlete/api/plans";
    const method = editingPlanId ? "PUT" : "POST";
    
    const res = await apiFetch(url, { method: method, body: formData, headers: {} });

    alertShow(editingPlanId ? "Plan updated successfully! 🎉" : "Plan created successfully! 🎉", "success");
    bootstrap.Modal.getInstance(document.getElementById("planModal")).hide();
    editingPlanId = null;
    e.target.reset();
    fetchPlans();
  } catch (err) {
    alertShow(err.message, "danger");
  }
});

// Delete plan
async function removePlan(id) {
  if (!confirm('⚠️ Are you sure you want to delete this plan? This action cannot be undone.')) return;
  
  try {
    await apiFetch(`/athlete/api/plans/${id}`, { method: 'DELETE' });
    
    alertShow('Plan deleted successfully! 🗑️', 'success');
    
    bootstrap.Modal.getInstance(document.getElementById('planModal'))?.hide();
    fetchPlans();
  } catch (e) { 
    alertShow(e.message, "danger"); 
  }
}

// Duplicate plan
async function duplicatePlan(id) {
  const p = PLANS.find(x => x.id === id);
  if (!p) return;
  
  if (!confirm(`Create a copy of "${p.title}"?`)) return;
  
  const formData = new FormData();
  formData.append("title", p.title + " (Copy)");
  formData.append("duration_weeks", p.duration_weeks);
  formData.append("description", p.description || '');
  formData.append("status", "active");
  
  try {
    const res = await apiFetch("/athlete/api/plans", {
      method: "POST",
      body: formData,
      headers: {}
    });

    alertShow("Plan duplicated successfully! 📋", "success");
    fetchPlans();
  } catch (err) {
    alertShow(err.message, "danger");
  }
}

// Mark as completed
async function markAsCompleted() {
  if (!currentDetailsId) return;
  
  const formData = new FormData();
  formData.append("status", "completed");
  
  try {
    await apiFetch(`/athlete/api/plans/${currentDetailsId}`, {
      method: "PUT",
      body: formData,
      headers: {}
    });

    alertShow("Congratulations! Plan marked as completed! 🏆", "success");
    bootstrap.Modal.getInstance(document.getElementById('planDetailsModal')).hide();
    fetchPlans();
  } catch (err) {
    alertShow(err.message, "danger");
  }
}

// Archive plan
async function archivePlan() {
  if (!currentDetailsId) return;
  
  if (!confirm('Archive this plan?')) return;
  
  const formData = new FormData();
  formData.append("status", "archived");
  
  try {
    await apiFetch(`/athlete/api/plans/${currentDetailsId}`, {
      method: "PUT",
      body: formData,
      headers: {}
    });

    alertShow("Plan archived successfully! 📦", "success");
    bootstrap.Modal.getInstance(document.getElementById('planDetailsModal')).hide();
    fetchPlans();
  } catch (err) {
    alertShow(err.message, "danger");
  }
}

// View toggle
function toggleView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === view);
  });
  renderPlans();
}

// Reset filters
function resetFilters() {
  document.getElementById('planSearch').value = '';
  document.getElementById('planDuration').value = '';
  document.getElementById('planStatus').value = '';
  document.getElementById('planSort').value = 'created_desc';
  renderPlans();
}

// Image preview
function previewImage(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('imagePreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

// Progress label update
function updateProgressLabel(value) {
  document.getElementById('progressLabel').textContent = value + '%';
}

// Character counter
document.getElementById('planDesc').addEventListener('input', function() {
  document.getElementById('charCount').textContent = this.value.length;
});

// Modal reset
document.getElementById('planModal').addEventListener('hidden.bs.modal', function () {
  editingPlanId = null;
  document.getElementById('planForm').reset();
  document.getElementById('planModalTitle').textContent = 'Create Training Plan';
  document.getElementById('imagePreview').src = '/static/images/default-plan.jpg';
  document.getElementById('progressSection').classList.add('d-none');
  document.getElementById('charCount').textContent = '0';
  document.getElementById('deletePlanBtn').classList.add('d-none');
});

// Event listeners
document.getElementById('planSearch').addEventListener('input', renderPlans);
document.getElementById('planDuration').addEventListener('change', renderPlans);
document.getElementById('planStatus').addEventListener('change', renderPlans);
document.getElementById('planSort').addEventListener('change', renderPlans);
document.getElementById('planImageInput').addEventListener('change', previewImage);

// Initialize
fetchPlans();
</script>

<style>
/* The style block provided previously has been modified to use 
    standard Nice Admin/Bootstrap classes instead of complex custom ones
*/

.pagetitle {
  margin-bottom: 1.5rem;
}

.info-card {
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

.info-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.info-card .card-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.2rem;
}

/* Custom progress for details modal */
.progress {
  height: 25px;
  border-radius: 5px;
  overflow: hidden;
}

.progress-bar {
  line-height: 25px;
  font-weight: bold;
  text-align: center;
}

/* Plan Card for Grid View */
.plans-grid {
  display: flex;
  flex-wrap: wrap;
}

.card-img-top {
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
}

.card-footer {
  border-top: 1px solid #f6f7f8;
}

.list-group-flush .list-group-item-action {
  padding: 1rem 1.25rem;
}

</style>
{% endblock %}