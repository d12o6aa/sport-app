{% extends "shared/base.html" %}

{% block content %}
<section class="section dashboard">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="m-0">Training Plans</h5>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planModal">
      <i class="bi bi-plus-lg me-1"></i> Add Plan
    </button>
  </div>

  <!-- Filters -->
  <div class="row g-2 align-items-end mb-3">
    <div class="col-md-4">
      <label class="form-label small text-muted">Search</label>
      <input id="planSearch" type="text" class="form-control" placeholder="Search by title">
    </div>
    <div class="col-md-3">
      <label class="form-label small text-muted">Duration</label>
      <select id="planDuration" class="form-select">
        <option value="">All</option>
        <option value="<=4">≤ 4 weeks</option>
        <option value="5-8">5–8 weeks</option>
        <option value=">8">> 8 weeks</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label small text-muted">Sort by</label>
      <select id="planSort" class="form-select">
        <option value="created_desc">Latest</option>
        <option value="created_asc">Oldest</option>
        <option value="duration_asc">Duration ↑</option>
        <option value="duration_desc">Duration ↓</option>
      </select>
    </div>
  </div>

  <!-- List -->
  <div id="plansList" class="row g-3"></div>

  <!-- Empty -->
  <div id="plansEmpty" class="text-center py-5 d-none">
    <i class="bi bi-emoji-neutral fs-1 text-muted"></i>
    <p class="mt-2 text-muted">No training plans yet. Add one to get started.</p>
  </div>
</section>

<!-- Add/Edit Modal -->
<div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="planForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="planModalTitle">Add Training Plan</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="planId">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input id="planTitle" type="text" class="form-control" required maxlength="120">
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (weeks)</label>
          <input id="planDurationInput" type="number" min="1" class="form-control" required>
        </div>
        <div class="mb-0">
          <label class="form-label">Description</label>
          <textarea id="planDesc" rows="3" class="form-control" maxlength="2000"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

<script>
function alertShow(message, type="info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrap);
  setTimeout(()=>wrap.remove(), 4000);
}

let PLANS = [];
let editingPlanId = null;

const $list = document.getElementById('plansList');
const $empty = document.getElementById('plansEmpty');

function planCardTpl(p){
  return `
  <div class="col-md-6 col-xl-4">
    <div class="card h-100">
      <div class="card-body d-flex flex-column">
        <h6 class="mb-1">${p.title}</h6>
        <div class="small text-muted mb-2">Duration: ${p.duration_weeks} weeks</div>
        <p class="flex-grow-1">${(p.description||'').slice(0,160)}</p>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small text-muted"><i class="bi bi-calendar-week me-1"></i>${new Date(p.created_at||Date.now()).toLocaleDateString()}</div>
          <div>
            <button class="btn btn-sm btn-light me-1" onclick="openEditPlan(${p.id})"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-light text-danger" onclick="removePlan(${p.id})"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderPlans(){
  // filters
  const q = document.getElementById('planSearch').value.trim().toLowerCase();
  const dur = document.getElementById('planDuration').value;
  const sort = document.getElementById('planSort').value;

  let list = [...PLANS];

  if (q) list = list.filter(p => p.title.toLowerCase().includes(q));

  if (dur){
    list = list.filter(p=>{
      const w = Number(p.duration_weeks||0);
      if (dur==='<=4') return w<=4;
      if (dur==='5-8') return w>=5 && w<=8;
      if (dur==='>8') return w>8;
      return true;
    });
  }

  list.sort((a,b)=>{
    if (sort==='created_desc') return new Date(b.created_at)-new Date(a.created_at);
    if (sort==='created_asc')  return new Date(a.created_at)-new Date(b.created_at);
    if (sort==='duration_asc') return (a.duration_weeks||0)-(b.duration_weeks||0);
    if (sort==='duration_desc')return (b.duration_weeks||0)-(a.duration_weeks||0);
    return 0;
  });

  $list.innerHTML = list.map(planCardTpl).join('');
  $empty.classList.toggle('d-none', list.length>0);
}

async function fetchPlans(){
  try{
    const res = await fetch('/athlete/api/plans', { headers:{ Authorization: `Bearer ${localStorage.getItem('access_token')}` }});
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    PLANS = Array.isArray(data) ? data : [];
  }catch(e){
    console.error(e);
    PLANS = [];
    alertShow('Failed to load plans','danger');
  }finally{
    renderPlans();
  }
}

function openEditPlan(id){
  const p = PLANS.find(x=>x.id===id);
  if (!p) return;
  editingPlanId = id;
  document.getElementById('planModalTitle').textContent = 'Edit Training Plan';
  document.getElementById('planId').value = p.id;
  document.getElementById('planTitle').value = p.title||'';
  document.getElementById('planDurationInput').value = p.duration_weeks||1;
  document.getElementById('planDesc').value = p.description||'';
  new bootstrap.Modal(document.getElementById('planModal')).show();
}

document.getElementById('planForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    title: document.getElementById('planTitle').value.trim(),
    duration_weeks: Number(document.getElementById('planDurationInput').value),
    description: document.getElementById('planDesc').value.trim()
  };
  if (!payload.title || !payload.duration_weeks) {
    alertShow('Please fill required fields','warning'); return;
  }
  try{
    let res;
    if (editingPlanId){
      res = await fetch(`/athlete/api/plans/${editingPlanId}`, {
        method:'PUT', headers:{'Content-Type':'application/json', Authorization:`Bearer ${localStorage.getItem('access_token')}`},
        body: JSON.stringify(payload)
      });
    } else {
      res = await fetch('/athlete/api/plans', {
        method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${localStorage.getItem('access_token')}`},
        body: JSON.stringify(payload)
      });
    }
    const data = await (async()=>{try{return await res.json()}catch{return {}}})();
    if (!res.ok) throw new Error(data?.msg||'Operation failed');
    alertShow(editingPlanId?'Plan updated':'Plan created','success');
    bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
    editingPlanId = null;
    e.target.reset();
    fetchPlans();
  }catch(err){
    alertShow(err.message,'danger');
  }
});

async function removePlan(id){
  if (!confirm('Delete this plan?')) return;
  try{
    const res = await fetch(`/athlete/api/plans/${id}`, { method:'DELETE', headers:{ Authorization:`Bearer ${localStorage.getItem('access_token')}` }});
    const data = await (async()=>{try{return await res.json()}catch{return {}}})();
    if (!res.ok) throw new Error(data?.msg||'Delete failed');
    alertShow('Plan deleted','success');
    fetchPlans();
  }catch(e){ alertShow(e.message,'danger'); }
}

document.getElementById('planSearch').addEventListener('input', renderPlans);
document.getElementById('planDuration').addEventListener('change', renderPlans);
document.getElementById('planSort').addEventListener('change', renderPlans);

fetchPlans();
</script>
{% endblock %}
