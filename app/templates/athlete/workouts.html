{% extends "shared/base.html" %}

{% block content %}
<section class="section dashboard">
  <!-- Header with Navigation -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <h5 class="m-0 me-3">Workout Summary Tracker</h5>
      <div class="btn-group" role="group">
        <button class="btn btn-sm btn-outline-secondary" onclick="changeWeek(-1)">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="goToToday()">Today</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="changeWeek(1)">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
    <button class="btn btn-primary" onclick="openAddWorkout()">
      <i class="bi bi-plus-lg me-1"></i> Add Workout
    </button>
  </div>

  <!-- Weekly Calendar -->
  <div class="card mb-4">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted" id="weekRange">Loading...</small>
        <div class="d-flex">
          <span class="badge bg-success me-2">‚óè Finished Workout</span>
          <span class="badge bg-warning">‚óè In Progress</span>
        </div>
      </div>
      <div class="row g-1" id="weeklyCalendar">
        <!-- Calendar days will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="row g-3 mb-4">
    <!-- Current Workout Card -->
    <div class="col-md-4">
      <div class="card bg-light text-center p-3" id="currentWorkoutCard">
        <div id="workoutImageContainer">
          <img id="currentWorkoutImage" src="" class="mx-auto mb-2 rounded" style="width:80px;height:60px;object-fit:cover;display:none;">
          <div id="workoutImagePlaceholder" class="mx-auto mb-2 rounded bg-secondary d-flex align-items-center justify-content-center" style="width:80px;height:60px;">
            <i class="bi bi-dumbbell text-white"></i>
          </div>
        </div>
        <h6 class="text-muted small mb-1" id="currentWorkoutTitle">No Recent Workout</h6>
        <div class="d-flex justify-content-between small text-muted">
          <span id="currentWorkoutDuration">00:00:00</span>
          <span>Total Time</span>
        </div>
      </div>
    </div>

    <!-- Heart Rate Card -->
    <div class="col-md-4">
      <div class="card bg-light text-center p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="small text-muted">Heart Rate Zone</span>
          <span class="fs-4 fw-bold" id="avgHeartRate">-- bpm</span>
        </div>
        <div class="small text-muted">Avg Heart Rate</div>
      </div>
    </div>

    <!-- Calories Card -->
    <div class="col-md-4">
      <div class="card bg-light text-center p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold fs-5" id="activeCalories">0 Kcal</div>
            <div class="small text-muted">Active Calories</div>
          </div>
          <div>
            <div class="fw-bold fs-5" id="totalCalories">0 Kcal</div>
            <div class="small text-muted">Total Calories</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Row -->
  <div class="row g-4">
    <!-- Left Column - Heart Rate & Training Effect -->
    <div class="col-md-4">
      <!-- Heart Rate Chart -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Heart Rate</h6>
          <span class="small text-muted"><span id="maxHeartRateDisplay">--</span> max</span>
        </div>
        <div class="card-body">
          <canvas id="heartRateChart" width="100" height="60"></canvas>
        </div>
      </div>

      <!-- Training Effect -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Training Effect</h6>
          <small class="text-success">Recovery: <span id="recoveryTime">--</span></small>
        </div>
        <div class="card-body">
          <!-- Training Effect Progress -->
          <div class="mb-3">
            <div class="progress mb-1" style="height: 12px;" id="trainingEffectBar">
              <!-- Progress bars will be dynamically generated -->
            </div>
            <div class="d-flex justify-content-between small mt-2">
              <span class="text-success">‚óè Minor</span>
              <span class="text-primary">‚óè Recovery</span>
            </div>
            <div class="d-flex justify-content-between small">
              <span class="text-warning">‚óè Maintaining</span>
              <span class="text-danger">‚óè Overreaching</span>
            </div>
            <div class="d-flex justify-content-between small">
              <span class="text-info">‚óè Improving</span>
              <span class="text-secondary">‚óè Highly Improving</span>
            </div>
          </div>

          <!-- VO2 Max & Heart Rate Zones -->
          <div class="mt-3">
            <h6 class="small mb-2">VO2 max</h6>
            <div id="hrZonesDisplay">
              <!-- Heart rate zones will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Column - Calendar -->
    <div class="col-md-4">
      <!-- Full Month Calendar -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0" id="calendarMonth">Sep 2025</h6>
        </div>
        <div class="card-body p-2">
          <div id="monthlyCalendar" class="text-center">
            <!-- Monthly calendar will be generated here -->
          </div>
        </div>
      </div>

      <!-- Progress Card -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Current Progress</h6>
        </div>
        <div class="card-body">
          <div id="progressSection">
            <div class="text-center text-muted py-3">
              <i class="bi bi-activity fs-1"></i>
              <p class="mt-2">Start a workout to see progress</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Finished Workouts -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Finished Workout</h6>
        </div>
        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
          <div id="finishedWorkouts">
            <!-- Finished workouts will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Enhanced Workout Modal -->
<div class="modal fade" id="workoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="workoutForm" class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="workoutModalTitle">Add Workout</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="workoutId">
        
        <!-- Basic Info Row -->
        <div class="row">
          <div class="col-md-8">
            <div class="mb-3">
              <label class="form-label">Workout Title</label>
              <input id="workoutTitle" type="text" class="form-control" required maxlength="150" 
                     placeholder="e.g., Morning Strength Training">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input id="workoutDate" type="date" class="form-control" required>
            </div>
          </div>
        </div>

        <!-- Workout Type & Duration Row -->
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Workout Type</label>
              <select id="workoutType" class="form-select" required onchange="generateWorkoutImage()">
                <option value="strength">üí™ Strength Training</option>
                <option value="cardio">üèÉ Cardio</option>
                <option value="yoga">üßò Yoga</option>
                <option value="crossfit">üèãÔ∏è CrossFit</option>
                <option value="running">üèÉ‚Äç‚ôÇÔ∏è Running</option>
                <option value="cycling">üö¥ Cycling</option>
                <option value="swimming">üèä Swimming</option>
                <option value="mobility">ü§∏ Mobility</option>
                <option value="pilates">ü§∏‚Äç‚ôÄÔ∏è Pilates</option>
                <option value="boxing">ü•ä Boxing</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Duration (minutes)</label>
              <input id="plannedDuration" type="number" class="form-control" min="1" max="300" required 
                     placeholder="30" onchange="updateCaloriesEstimate()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Difficulty</label>
              <select id="difficultyLevel" class="form-select" onchange="updateCaloriesEstimate()">
                <option value="beginner">üü¢ Beginner</option>
                <option value="intermediate">üü° Intermediate</option>
                <option value="advanced">üî¥ Advanced</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Generated Image Preview -->
        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label">Workout Image</label>
              <div class="text-center p-3 border rounded" id="imagePreview">
                <img id="generatedImage" src="" style="width: 200px; height: 120px; object-fit: cover; border-radius: 8px; display: none;">
                <div id="imagePlaceholder" class="bg-light d-flex align-items-center justify-content-center rounded" 
                     style="width: 200px; height: 120px; margin: 0 auto;">
                  <i class="bi bi-image fs-1 text-muted"></i>
                </div>
                <small class="text-muted d-block mt-2">Image will be generated based on workout type</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Performance Metrics Row -->
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Calories Burned (estimated)</label>
              <input id="caloriesBurned" type="number" class="form-control" min="0" readonly>
              <small class="text-muted">Auto-calculated based on type, duration, and difficulty</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select id="completionStatus" class="form-select">
                <option value="completed">‚úÖ Completed</option>
                <option value="in_progress">‚è≥ In Progress</option>
                <option value="partial">‚ö†Ô∏è Partial</option>
                <option value="missed">‚ùå Missed</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Advanced Metrics (Collapsible) -->
        <div class="accordion" id="advancedMetrics">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                      data-bs-target="#collapseAdvanced" aria-expanded="false">
                Advanced Metrics (Optional)
              </button>
            </h2>
            <div id="collapseAdvanced" class="accordion-collapse collapse">
              <div class="accordion-body">
                <!-- Heart Rate Row -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Average Heart Rate</label>
                      <input id="avgHeartRateInput" type="number" class="form-control" min="0" max="220" placeholder="150">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Max Heart Rate</label>
                      <input id="maxHeartRateInput" type="number" class="form-control" min="0" max="220" placeholder="180">
                    </div>
                  </div>
                </div>

                <!-- Training Effects Row -->
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Aerobic Effect (0-5)</label>
                      <input id="aerobicEffect" type="number" class="form-control" min="0" max="5" step="0.1" placeholder="2.5">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Anaerobic Effect (0-5)</label>
                      <input id="anaerobicEffect" type="number" class="form-control" min="0" max="5" step="0.1" placeholder="1.2">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Recovery Time (hours)</label>
                      <input id="recoveryTimeInput" type="number" class="form-control" min="0" max="72" placeholder="24">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="mb-3 mt-3">
          <label class="form-label">Notes</label>
          <textarea id="workoutNotes" class="form-control" rows="3" 
                    placeholder="How did the workout feel? Any observations..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit" id="saveWorkoutBtn">
          <span id="saveButtonText">Save Workout</span>
          <div class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner"></div>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Workout Detail Modal -->
<div class="modal fade" id="workoutDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalTitle">Workout Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="workoutDetailContent">
        <!-- Workout details will be populated here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" onclick="editWorkoutFromDetail()">Edit Workout</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let WORKOUTS = [];
let currentWeek = new Date();
let editingWorkoutId = null;
let selectedWorkout = null;
let heartRateChart = null;

// Workout type images and calorie rates
const WORKOUT_CONFIGS = {
  strength: { 
    emoji: 'üí™', 
    color: '#dc3545',
    caloriesPerMinute: 8,
    bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  },
  cardio: { 
    emoji: 'üèÉ', 
    color: '#fd7e14',
    caloriesPerMinute: 12,
    bgGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
  },
  yoga: { 
    emoji: 'üßò', 
    color: '#20c997',
    caloriesPerMinute: 4,
    bgGradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
  },
  crossfit: { 
    emoji: 'üèãÔ∏è', 
    color: '#6f42c1',
    caloriesPerMinute: 15,
    bgGradient: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
  },
  running: { 
    emoji: 'üèÉ‚Äç‚ôÇÔ∏è', 
    color: '#0d6efd',
    caloriesPerMinute: 14,
    bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  },
  cycling: { 
    emoji: 'üö¥', 
    color: '#198754',
    caloriesPerMinute: 10,
    bgGradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
  },
  swimming: { 
    emoji: 'üèä', 
    color: '#0dcaf0',
    caloriesPerMinute: 13,
    bgGradient: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
  },
  mobility: { 
    emoji: 'ü§∏', 
    color: '#ffc107',
    caloriesPerMinute: 3,
    bgGradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
  },
  pilates: { 
    emoji: 'ü§∏‚Äç‚ôÄÔ∏è', 
    color: '#e91e63',
    caloriesPerMinute: 5,
    bgGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
  },
  boxing: { 
    emoji: 'ü•ä', 
    color: '#795548',
    caloriesPerMinute: 16,
    bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  }
};

// Utility functions
function alertShow(message, type = "info") {
  const container = document.getElementById("alert-container") || document.body;
  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  container.appendChild(wrapper);
  setTimeout(() => wrapper.remove(), 4000);
}

function formatTime(minutes) {
  if (!minutes) return "00:00:00";
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  const secs = 0; // We don't store seconds, so always 0
  return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('en-US', { 
    weekday: 'short', 
    month: 'short', 
    day: 'numeric' 
  });
}

// Image generation function
function generateWorkoutImage() {
  const workoutType = document.getElementById('workoutType').value;
  const config = WORKOUT_CONFIGS[workoutType] || WORKOUT_CONFIGS.strength;
  
  const canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');
  
  // Create gradient background
  const gradient = ctx.createLinearGradient(0, 0, 400, 240);
  // Parse the CSS gradient (simplified)
  gradient.addColorStop(0, config.color + '80'); // Add transparency
  gradient.addColorStop(1, config.color + '40');
  
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 400, 240);
  
  // Add emoji
  ctx.font = '80px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(config.emoji, 200, 140);
  
  // Add workout type text
  ctx.font = 'bold 24px Arial';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(workoutType.charAt(0).toUpperCase() + workoutType.slice(1), 200, 200);
  
  // Convert to data URL and display
  const dataURL = canvas.toDataURL('image/png');
  document.getElementById('generatedImage').src = dataURL;
  document.getElementById('generatedImage').style.display = 'block';
  document.getElementById('imagePlaceholder').style.display = 'none';
  
  return dataURL;
}

// Calorie estimation
function updateCaloriesEstimate() {
  const workoutType = document.getElementById('workoutType').value;
  const duration = parseInt(document.getElementById('plannedDuration').value) || 0;
  const difficulty = document.getElementById('difficultyLevel').value;
  
  if (workoutType && duration > 0) {
    const config = WORKOUT_CONFIGS[workoutType] || WORKOUT_CONFIGS.strength;
    let caloriesPerMinute = config.caloriesPerMinute;
    
    // Adjust based on difficulty
    const difficultyMultiplier = {
      beginner: 0.8,
      intermediate: 1.0,
      advanced: 1.3
    };
    
    const estimatedCalories = Math.round(duration * caloriesPerMinute * difficultyMultiplier[difficulty]);
    document.getElementById('caloriesBurned').value = estimatedCalories;
  }
}

// Calendar functions
function changeWeek(direction) {
  currentWeek.setDate(currentWeek.getDate() + (direction * 7));
  generateWeeklyCalendar();
}

function goToToday() {
  currentWeek = new Date();
  generateWeeklyCalendar();
}

function generateWeeklyCalendar() {
  const startOfWeek = new Date(currentWeek);
  startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
  
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  
  document.getElementById('weekRange').textContent = 
    `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
  
  const calendarContainer = document.getElementById('weeklyCalendar');
  calendarContainer.innerHTML = '';
  
  const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);
    
    const isToday = date.toDateString() === new Date().toDateString();
    const dayWorkouts = WORKOUTS.filter(w => 
      new Date(w.date).toDateString() === date.toDateString()
    );
    
    const dayElement = document.createElement('div');
    dayElement.className = 'col text-center';
    dayElement.innerHTML = `
      <div class="calendar-day p-2 rounded ${isToday ? 'bg-primary text-white' : 'bg-light'}" 
           style="cursor: pointer; min-height: 80px; position: relative;" 
           onclick="selectDate('${date.toISOString().split('T')[0]}', ${JSON.stringify(dayWorkouts).replace(/"/g, '&quot;')})">
        <div class="small">${days[i]}</div>
        <div class="fw-bold">${date.getDate()}</div>
        <div class="mt-1">
          ${dayWorkouts.map(w => {
            const config = WORKOUT_CONFIGS[w.workout_type] || WORKOUT_CONFIGS.strength;
            const statusColor = w.completion_status === 'completed' ? 'success' : 
                               w.completion_status === 'in_progress' ? 'warning' : 'secondary';
            return `<div class="badge bg-${statusColor} mb-1" style="font-size: 8px;" 
                         onclick="event.stopPropagation(); showWorkoutDetails(${w.id})" 
                         title="${w.title}">‚óè</div>`;
          }).join('')}
        </div>
      </div>
    `;
    calendarContainer.appendChild(dayElement);
  }
}

function generateMonthlyCalendar() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
  
  let calendarHTML = `
    <div class="row g-0 small text-center mb-2">
      <div class="col fw-bold">S</div><div class="col fw-bold">M</div><div class="col fw-bold">T</div>
      <div class="col fw-bold">W</div><div class="col fw-bold">T</div><div class="col fw-bold">F</div><div class="col fw-bold">S</div>
    </div>
  `;
  
  let week = '<div class="row g-0">';
  
  // Empty cells for days before month starts
  for (let i = 0; i < firstDay; i++) {
    week += '<div class="col p-1"><div style="height: 32px;"></div></div>';
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = day === today;
    const dateString = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    const dayWorkouts = WORKOUTS.filter(w => w.date === dateString);
    const hasWorkout = dayWorkouts.length > 0;
    
    week += `
      <div class="col p-1">
        <div class="calendar-mini-day ${isToday ? 'bg-primary text-white' : ''} 
                    ${hasWorkout ? 'border border-success' : ''} rounded text-center d-flex align-items-center justify-content-center" 
             style="cursor: pointer; font-size: 12px; height: 32px; position: relative;"
             onclick="selectDate('${dateString}', ${JSON.stringify(dayWorkouts).replace(/"/g, '&quot;')})">
          ${day}
          ${hasWorkout ? '<div class="position-absolute" style="top: -2px; right: -2px; width: 8px; height: 8px; background: #28a745; border-radius: 50%;"></div>' : ''}
        </div>
      </div>
    `;
    
    if ((firstDay + day) % 7 === 0) {
      week += '</div><div class="row g-0">';
    }
  }
  
  week += '</div>';
  calendarHTML += week;
  
  document.getElementById('monthlyCalendar').innerHTML = calendarHTML;
}

// Workout functions
async function fetchWorkouts() {
  try {
    const response = await fetch('/athlete/api/workouts', {
      credentials: 'include'
    });
    
    if (!response.ok) throw new Error(await response.text() || 'Network error');
    
    WORKOUTS = await response.json();
    updateDashboard();
    generateWeeklyCalendar();
    generateMonthlyCalendar();
    
  } catch (error) {
    console.error('Fetch error:', error);
    WORKOUTS = [];
    alertShow(`Failed to load workouts: ${error.message}`, 'danger');
  }
}

// Date selection and workout display
function selectDate(dateString, dayWorkouts = []) {
  if (dayWorkouts && dayWorkouts.length > 0) {
    // Show existing workouts for this date
    showWorkoutDetails(dayWorkouts[0].id);
  } else {
    // Open add workout modal for this date
    openAddWorkout(dateString);
  }
}

function openAddWorkout(selectedDate = null) {
  resetForm();
  if (selectedDate) {
    document.getElementById('workoutDate').value = selectedDate;
  } else {
    document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  }
  const modal = new bootstrap.Modal(document.getElementById('workoutModal'));
  modal.show();
  
  // Generate default image
  setTimeout(() => generateWorkoutImage(), 100);
}

function showWorkoutDetails(workoutId) {
  const workout = WORKOUTS.find(w => w.id === workoutId);
  if (!workout) {
    alertShow('Workout not found', 'error');
    return;
  }
  
  selectedWorkout = workout;
  
  // Populate detail modal
  document.getElementById('detailModalTitle').textContent = workout.title;
  
  const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.strength;
  
  document.getElementById('workoutDetailContent').innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <div class="text-center mb-3">
          <div style="width: 200px; height: 120px; background: ${config.bgGradient}; 
                      border-radius: 12px; display: flex; align-items: center; 
                      justify-content: center; margin: 0 auto;">
            <span style="font-size: 48px;">${config.emoji}</span>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <h5 class="text-primary">${workout.title}</h5>
        <div class="mb-2">
          <strong>Type:</strong> 
          <span class="badge" style="background-color: ${config.color}">
            ${workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1)}
          </span>
        </div>
        <div class="mb-2"><strong>Date:</strong> ${formatDate(workout.date)}</div>
        <div class="mb-2"><strong>Duration:</strong> ${workout.actual_duration || workout.planned_duration || 0} minutes</div>
        <div class="mb-2"><strong>Calories:</strong> ${workout.calories_burned || 0} kcal</div>
        <div class="mb-2">
          <strong>Status:</strong> 
          <span class="badge ${workout.completion_status === 'completed' ? 'bg-success' : 
                              workout.completion_status === 'in_progress' ? 'bg-warning' : 
                              workout.completion_status === 'partial' ? 'bg-info' : 'bg-secondary'}">
            ${workout.completion_status.charAt(0).toUpperCase() + workout.completion_status.slice(1)}
          </span>
        </div>
      </div>
    </div>
    
    ${workout.avg_heart_rate || workout.max_heart_rate ? `
      <hr>
      <div class="row">
        <div class="col-md-6">
          <h6>Heart Rate Data</h6>
          ${workout.avg_heart_rate ? `<div><strong>Average:</strong> ${workout.avg_heart_rate} bpm</div>` : ''}
          ${workout.max_heart_rate ? `<div><strong>Maximum:</strong> ${workout.max_heart_rate} bpm</div>` : ''}
        </div>
        <div class="col-md-6">
          <h6>Training Effects</h6>
          ${workout.training_effect?.aerobic ? `<div><strong>Aerobic:</strong> ${workout.training_effect.aerobic}</div>` : ''}
          ${workout.training_effect?.anaerobic ? `<div><strong>Anaerobic:</strong> ${workout.training_effect.anaerobic}</div>` : ''}
          ${workout.recovery_time ? `<div><strong>Recovery:</strong> ${workout.recovery_time}h</div>` : ''}
        </div>
      </div>
    ` : ''}
    
    ${workout.notes ? `
      <hr>
      <h6>Notes</h6>
      <p class="text-muted">${workout.notes}</p>
    ` : ''}
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('workoutDetailModal'));
  modal.show();
}

function editWorkoutFromDetail() {
  if (!selectedWorkout) return;
  
  // Close detail modal
  bootstrap.Modal.getInstance(document.getElementById('workoutDetailModal')).hide();
  
  // Open edit modal
  editingWorkoutId = selectedWorkout.id;
  document.getElementById('workoutModalTitle').textContent = 'Edit Workout';
  
  // Populate form
  document.getElementById('workoutId').value = selectedWorkout.id;
  document.getElementById('workoutTitle').value = selectedWorkout.title || '';
  document.getElementById('workoutType').value = selectedWorkout.workout_type || 'strength';
  document.getElementById('plannedDuration').value = selectedWorkout.planned_duration || selectedWorkout.actual_duration || 30;
  document.getElementById('caloriesBurned').value = selectedWorkout.calories_burned || 0;
  document.getElementById('difficultyLevel').value = selectedWorkout.difficulty_level || 'beginner';
  document.getElementById('completionStatus').value = selectedWorkout.completion_status || 'completed';
  document.getElementById('workoutDate').value = selectedWorkout.date || new Date().toISOString().split('T')[0];
  document.getElementById('workoutNotes').value = selectedWorkout.notes || '';
  
  // Advanced metrics
  document.getElementById('avgHeartRateInput').value = selectedWorkout.avg_heart_rate || '';
  document.getElementById('maxHeartRateInput').value = selectedWorkout.max_heart_rate || '';
  document.getElementById('aerobicEffect').value = selectedWorkout.training_effect?.aerobic || '';
  document.getElementById('anaerobicEffect').value = selectedWorkout.training_effect?.anaerobic || '';
  document.getElementById('recoveryTimeInput').value = selectedWorkout.recovery_time || '';
  
  // Generate image and show modal
  generateWorkoutImage();
  const modal = new bootstrap.Modal(document.getElementById('workoutModal'));
  modal.show();
}

// Dashboard update functions
function updateDashboard() {
  updateStatsCards();
  updateHeartRateChart();
  updateFinishedWorkouts();
  updateTrainingEffect();
}

function updateStatsCards() {
  const recentWorkout = WORKOUTS.filter(w => w.completion_status === 'completed')[0];
  
  if (recentWorkout) {
    const config = WORKOUT_CONFIGS[recentWorkout.workout_type] || WORKOUT_CONFIGS.strength;
    
    // Update current workout card
    if (recentWorkout.image_url) {
      document.getElementById('currentWorkoutImage').src = recentWorkout.image_url;
      document.getElementById('currentWorkoutImage').style.display = 'block';
      document.getElementById('workoutImagePlaceholder').style.display = 'none';
    } else {
      // Generate image for workout type
      document.getElementById('workoutImagePlaceholder').style.background = config.bgGradient;
      document.getElementById('workoutImagePlaceholder').innerHTML = `<span style="font-size: 24px;">${config.emoji}</span>`;
    }
    
    document.getElementById('currentWorkoutTitle').textContent = recentWorkout.title;
    document.getElementById('currentWorkoutDuration').textContent = formatTime(recentWorkout.actual_duration || 0);
  }
  
  // Update stats
  const completedWorkouts = WORKOUTS.filter(w => w.completion_status === 'completed');
  const totalCalories = completedWorkouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
  const avgHeartRate = completedWorkouts.length > 0 ? 
    Math.round(completedWorkouts.reduce((sum, w) => sum + (w.avg_heart_rate || 0), 0) / completedWorkouts.length) : 0;
  
  document.getElementById('avgHeartRate').textContent = avgHeartRate > 0 ? `${avgHeartRate} bpm` : '-- bpm';
  document.getElementById('activeCalories').textContent = `${totalCalories} Kcal`;
  document.getElementById('totalCalories').textContent = `${Math.round(totalCalories * 1.1)} Kcal`;
  
  // Update max heart rate display
  const maxHR = Math.max(...completedWorkouts.map(w => w.max_heart_rate || 0));
  document.getElementById('maxHeartRateDisplay').textContent = maxHR > 0 ? maxHR : '--';
}

function updateHeartRateChart() {
  const ctx = document.getElementById('heartRateChart');
  if (!ctx) return;
  
  if (heartRateChart) {
    heartRateChart.destroy();
  }
  
  const recentWorkouts = WORKOUTS.slice(0, 7).reverse();
  const heartRateData = recentWorkouts.map(w => w.avg_heart_rate || 0);
  const labels = recentWorkouts.map((_, i) => `${i + 1}`);
  
  heartRateChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: heartRateData,
        backgroundColor: '#ffd43b',
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { 
          beginAtZero: true,
          display: false,
          max: 200
        },
        x: { 
          display: false
        }
      },
      elements: {
        bar: {
          borderRadius: 4
        }
      }
    }
  });
}

function updateFinishedWorkouts() {
  const finishedWorkouts = WORKOUTS
    .filter(w => w.completion_status === 'completed')
    .slice(0, 6)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const container = document.getElementById('finishedWorkouts');
  
  if (finishedWorkouts.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-calendar-x fs-1"></i>
        <p class="mt-2">No completed workouts yet</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = finishedWorkouts.map(workout => {
    const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.strength;
    const workoutDate = new Date(workout.date);
    const isRecent = (new Date() - workoutDate) < (7 * 24 * 60 * 60 * 1000); // Last 7 days
    
    return `
      <div class="d-flex align-items-center p-2 border-bottom workout-item" 
           style="cursor: pointer;" onclick="showWorkoutDetails(${workout.id})">
        <div class="rounded me-3 d-flex align-items-center justify-content-center" 
             style="width: 40px; height: 40px; background: ${config.bgGradient};">
          <span style="font-size: 16px;">${config.emoji}</span>
        </div>
        <div class="flex-grow-1">
          <div class="fw-medium small">${workout.title}</div>
          <div class="text-muted small">
            ${formatDate(workout.date)} ‚Ä¢ ${workout.actual_duration || workout.planned_duration || 0}m
            ${isRecent ? '<span class="badge bg-success ms-1" style="font-size: 8px;">NEW</span>' : ''}
          </div>
        </div>
        <div class="text-success">
          <i class="bi bi-check-circle-fill"></i>
        </div>
      </div>
    `;
  }).join('');
}

function updateTrainingEffect() {
  const recentWorkouts = WORKOUTS.filter(w => 
    w.completion_status === 'completed' && 
    (new Date() - new Date(w.date)) < (7 * 24 * 60 * 60 * 1000)
  );
  
  if (recentWorkouts.length === 0) {
    document.getElementById('recoveryTime').textContent = '--';
    document.getElementById('trainingEffectBar').innerHTML = '<div class="text-muted small">No recent data</div>';
    return;
  }
  
  const avgRecoveryTime = Math.round(
    recentWorkouts.reduce((sum, w) => sum + (w.recovery_time || 24), 0) / recentWorkouts.length
  );
  
  document.getElementById('recoveryTime').textContent = `${avgRecoveryTime}h`;
  
  // Simple training effect visualization
  const effectTypes = ['Minor', 'Maintaining', 'Improving', 'Recovery', 'Overreaching'];
  const effectColors = ['success', 'warning', 'info', 'primary', 'danger'];
  const effectWidths = [20, 25, 30, 20, 5]; // Example distribution
  
  const barHTML = effectTypes.map((type, i) => 
    `<div class="progress-bar bg-${effectColors[i]}" style="width: ${effectWidths[i]}%"></div>`
  ).join('');
  
  document.getElementById('trainingEffectBar').innerHTML = barHTML;
}

// Form handling
document.getElementById('workoutForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Show loading state
  document.getElementById('saveButtonText').textContent = 'Saving...';
  document.getElementById('saveSpinner').classList.remove('d-none');
  document.getElementById('saveWorkoutBtn').disabled = true;
  
  const formData = new FormData();
  
  // Basic workout data
  formData.append('title', document.getElementById('workoutTitle').value);
  formData.append('workout_type', document.getElementById('workoutType').value);
  formData.append('planned_duration', document.getElementById('plannedDuration').value);
  formData.append('actual_duration', document.getElementById('plannedDuration').value); // Same as planned for now
  formData.append('calories_burned', document.getElementById('caloriesBurned').value || '0');
  formData.append('difficulty_level', document.getElementById('difficultyLevel').value);
  formData.append('completion_status', document.getElementById('completionStatus').value);
  formData.append('date', document.getElementById('workoutDate').value);
  formData.append('notes', document.getElementById('workoutNotes').value);
  
  // Advanced metrics (optional)
  const avgHR = document.getElementById('avgHeartRateInput').value;
  const maxHR = document.getElementById('maxHeartRateInput').value;
  const aerobicEffect = document.getElementById('aerobicEffect').value;
  const anaerobicEffect = document.getElementById('anaerobicEffect').value;
  const recoveryTime = document.getElementById('recoveryTimeInput').value;
  
  if (avgHR) formData.append('avg_heart_rate', avgHR);
  if (maxHR) formData.append('max_heart_rate', maxHR);
  if (recoveryTime) formData.append('recovery_time', recoveryTime);
  
  // Training effects
  if (aerobicEffect || anaerobicEffect) {
    const trainingEffects = {
      aerobic: parseFloat(aerobicEffect) || 0,
      anaerobic: parseFloat(anaerobicEffect) || 0
    };
    formData.append('training_effects', JSON.stringify(trainingEffects));
  }
  
  // Generate and attach image
  const generatedImageDataURL = generateWorkoutImage();
  if (generatedImageDataURL) {
    // Convert data URL to blob
    const response = await fetch(generatedImageDataURL);
    const blob = await response.blob();
    formData.append('image', blob, `workout_${Date.now()}.png`);
  }
  
  try {
    const url = editingWorkoutId ? 
      `/athlete/api/workouts/${editingWorkoutId}` : 
      '/athlete/api/workouts';
    const method = editingWorkoutId ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      credentials: 'include',
      body: formData
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      alertShow(data.msg || 'Operation failed', 'danger');
      return;
    }
    
    alertShow(editingWorkoutId ? 'Workout updated successfully!' : 'Workout created successfully!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('workoutModal')).hide();
    resetForm();
    fetchWorkouts();
    
  } catch (error) {
    console.error('Submit error:', error);
    alertShow('Network error occurred', 'danger');
  } finally {
    // Reset loading state
    document.getElementById('saveButtonText').textContent = 'Save Workout';
    document.getElementById('saveSpinner').classList.add('d-none');
    document.getElementById('saveWorkoutBtn').disabled = false;
  }
});

function resetForm() {
  document.getElementById('workoutForm').reset();
  editingWorkoutId = null;
  selectedWorkout = null;
  document.getElementById('workoutModalTitle').textContent = 'Add Workout';
  document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  
  // Reset image preview
  document.getElementById('generatedImage').style.display = 'none';
  document.getElementById('imagePlaceholder').style.display = 'flex';
  
  // Reset advanced section
  const advancedCollapse = document.getElementById('collapseAdvanced');
  if (advancedCollapse.classList.contains('show')) {
    bootstrap.Collapse.getInstance(advancedCollapse).hide();
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Set default date to today
  document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
  
  // Load initial data
  fetchWorkouts();
  generateWeeklyCalendar();
  generateMonthlyCalendar();
  
  // Set up auto-calculation triggers
  document.getElementById('workoutType').addEventListener('change', () => {
    generateWorkoutImage();
    updateCaloriesEstimate();
  });
  
  document.getElementById('plannedDuration').addEventListener('input', updateCaloriesEstimate);
  document.getElementById('difficultyLevel').addEventListener('change', updateCaloriesEstimate);
  
  // Reset form when modal closes
  document.getElementById('workoutModal').addEventListener('hidden.bs.modal', resetForm);
  
  // Generate initial image
  setTimeout(() => generateWorkoutImage(), 500);
});

// Add CSS for better styling
const additionalCSS = `
<style>
.workout-item:hover {
  background-color: #f8f9fa;
}

.calendar-day:hover {
  background-color: #e9ecef !important;
}

.calendar-mini-day:hover {
  background-color: #dee2e6 !important;
}

#imagePreview {
  transition: all 0.3s ease;
}

#generatedImage {
  transition: opacity 0.3s ease;
}

.progress {
  border-radius: 6px;
}

.progress-bar {
  border-radius: 6px;
}

.card {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: none;
}

.badge {
  font-size: 10px;
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', additionalCSS);
</script>
{% endblock %}