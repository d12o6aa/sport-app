{% extends "shared/base.html" %}

{% block content %}
<section class="section dashboard">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="m-0">Workouts</h5>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#wModal">
      <i class="bi bi-plus-lg me-1"></i> Add Workout
    </button>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card bg-light text-center p-3">
        <h6 class="text-muted">Total Time</h6>
        <h4 id="totalTime">0 mins</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light text-center p-3">
        <h6 class="text-muted">Calories Burned</h6>
        <h4 id="totalCalories">0 kcal</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light text-center p-3">
        <h6 class="text-muted">Workouts Completed</h6>
        <h4 id="totalWorkouts">0</h4>
      </div>
    </div>
  </div>

  <div class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label small text-muted">Search</label>
      <input id="wSearch" type="text" class="form-control" placeholder="Search by title">
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Type</label>
      <select id="wType" class="form-select">
        <option value="">All</option>
        <option value="strength">Strength</option>
        <option value="cardio">Cardio</option>
        <option value="mobility">Mobility</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Level</label>
      <select id="wLevel" class="form-select">
        <option value="">All</option>
        <option value="beginner">Beginner</option>
        <option value="intermediate">Intermediate</option>
        <option value="advanced">Advanced</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Duration</label>
      <select id="wDuration" class="form-select">
        <option value="">All</option>
        <option value="0-30">0-30 mins</option>
        <option value="30-60">30-60 mins</option>
        <option value="60+">60+ mins</option>
      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-outline-primary w-100" onclick="applyFilters()">Apply Filters</button>
    </div>
  </div>

  <div class="row g-3" id="wList"></div>
  <div id="wEmpty" class="text-center py-5 d-none">
    <i class="bi bi-emoji-neutral fs-1 text-muted"></i>
    <p class="mt-2 text-muted">No workouts yet.</p>
  </div>
</section>

<div class="modal fade" id="wModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="wForm" class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="wModalTitle">Add Workout</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="wId">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input id="wTitle" type="text" class="form-control" required maxlength="120">
        </div>
        <div class="mb-3">
          <label class="form-label">Type</label>
          <select id="wTypeInput" class="form-select">
            <option value="strength">Strength</option>
            <option value="cardio">Cardio</option>
            <option value="mobility">Mobility</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Level</label>
          <select id="wLevelInput" class="form-select">
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (mins)</label>
          <input id="wDurationInput" type="number" class="form-control" min="1" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Calories</label>
          <input id="wCaloriesInput" type="number" class="form-control" min="0" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Image</label>
          <input id="wImage" type="file" class="form-control" accept="image/*">
        </div>
        <div class="mb-0">
          <label class="form-label">Notes</label>
          <textarea id="wNotes" class="form-control" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<<div class="modal fade" id="timerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h4 id="timerDisplay">00:00</h4>
      <p id="currentExercise">Starting...</p>
      <div class="mt-3">
        <button class="btn btn-success" onclick="startWorkout()">Start</button>
        <button class="btn btn-danger" onclick="stopWorkout()">Stop</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

<script>
  function alertShow(m, t = "info") {
    const c = document.getElementById("alert-container") || document.body;
    const w = document.createElement("div");
    w.innerHTML = `<div class="alert alert-${t} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index:1055;">${m}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    c.appendChild(w);
    setTimeout(() => w.remove(), 4000);
  }

  let WORKOUTS = [], editId = null;
  const $list = document.getElementById('wList'), $empty = document.getElementById('wEmpty');

  // Workout Card Template
  function wCard(w) {
    const imageUrl = w.image_url || 'https://via.placeholder.com/300x200';
    return `<div class="col-md-4">
      <div class="card h-100 shadow-sm border-0">
        <img src="${imageUrl}" class="card-img-top" alt="${w.title}" style="object-fit: cover; height: 200px;">
        <div class="card-body d-flex flex-column">
          <h6 class="card-title">${w.title}</h6>
          <p class="text-muted small mb-2"><i class="bi bi-clock"></i> ${w.duration || 0} mins | <i class="bi bi-fire"></i> ${w.calories || 0} kcal</p>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="badge ${w.level === 'advanced' ? 'bg-danger' : w.level === 'intermediate' ? 'bg-warning' : 'bg-success'}">${w.level || 'beginner'}</span>
            <button class="btn btn-sm btn-primary" onclick="startWorkout(${w.id || 0})">Start Now</button>
          </div>
          <p class="card-text flex-grow-1 text-truncate">${w.notes || 'No notes'}</p>
          <div class="d-flex justify-content-end">
            <button class="btn btn-sm btn-light me-1" onclick="openEdit(${w.id || 0})"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-light text-danger" onclick="removeWorkout(${w.id || 0})"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    </div>`;
  }

  function render() {
    const q = document.getElementById('wSearch').value.trim().toLowerCase();
    const t = document.getElementById('wType').value;
    const l = document.getElementById('wLevel').value;
    const d = document.getElementById('wDuration').value;
    let list = [...WORKOUTS];
    if (q) list = list.filter(w => w.title && w.title.toLowerCase().includes(q));
    if (t) list = list.filter(w => w.type && w.type === t);
    if (l) list = list.filter(w => w.level && w.level === l);
    if (d) {
      const [min, max] = d.split('-').map(n => n || (d === '60+' ? 999 : 0));
      list = list.filter(w => w.duration && w.duration >= parseInt(min) && w.duration <= parseInt(max));
    }
    $list.innerHTML = list.map(wCard).join('');
    $empty.classList.toggle('d-none', list.length > 0);
    updateStats(list);
  }

  function updateStats(list) {
    document.getElementById('totalTime').textContent = `${list.reduce((sum, w) => sum + (w.duration || 0), 0)} mins`;
    document.getElementById('totalCalories').textContent = `${list.reduce((sum, w) => sum + (w.calories || 0), 0)} kcal`;
    document.getElementById('totalWorkouts').textContent = list.length;
  }

  function applyFilters() {
    render();
  }

  // **FIXED AUTHENTICATION:** Only use credentials: 'include'
  async function fetchWorkouts() {
    try {
      const res = await fetch('/athlete/api/workouts', {
        credentials: 'include'
      });
      if (!res.ok) throw new Error(await res.text() || 'Network error');
      const data = await res.json();
      WORKOUTS = Array.isArray(data) ? data : [];
      console.log('Workouts fetched:', WORKOUTS);
    } catch (e) {
      console.error('Fetch error:', e.message, e);
      WORKOUTS = [];
      alertShow(`Failed to load workouts: ${e.message}. Check console for details.`, 'danger');
    } finally {
      render();
    }
  }

  function openEdit(id) {
    const w = WORKOUTS.find(x => x.id === id);
    if (!w) {
      alertShow('Workout not found.', 'danger');
      return;
    }
    editId = id;
    document.getElementById('wModalTitle').textContent = 'Edit Workout';
    document.getElementById('wId').value = w.id;
    document.getElementById('wTitle').value = w.title || '';
    document.getElementById('wTypeInput').value = w.type || 'strength';
    document.getElementById('wLevelInput').value = w.level || 'beginner';
    document.getElementById('wDurationInput').value = w.duration || 30;
    document.getElementById('wCaloriesInput').value = w.calories || 0;
    document.getElementById('wNotes').value = w.notes || '';
    document.getElementById('wImage').value = '';
    new bootstrap.Modal(document.getElementById('wModal')).show();
  }

  document.getElementById('wForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target); // Use FormData directly from the form

    let res;
    if (editId) {
      res = await fetch(`/athlete/api/workouts/${editId}`, {
        method: 'PUT',
        credentials: 'include',
        body: formData
      });
    } else {
      res = await fetch('/athlete/api/workouts', {
        method: 'POST',
        credentials: 'include',
        body: formData
      });
    }
    const data = await (async () => { try { return await res.json() } catch { return {} } })();
    if (!res.ok) { alertShow(data?.msg || 'Operation failed', 'danger'); return; }
    alertShow(editId ? 'Workout updated' : 'Workout created', 'success');
    bootstrap.Modal.getInstance(document.getElementById('wModal')).hide();
    editId = null; e.target.reset(); fetchWorkouts();
  });

  async function removeWorkout(id) {
    if (!confirm('Delete this workout?')) return;
    const res = await fetch(`/athlete/api/workouts/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await (async () => { try { return await res.json() } catch { return {} } })();
    if (!res.ok) { alertShow(data?.msg || 'Delete failed', 'danger'); return; }
    alertShow('Workout deleted', 'success'); fetchWorkouts();
  }

  document.getElementById('wSearch').addEventListener('input', render);
  document.getElementById('wType').addEventListener('change', render);
  document.getElementById('wLevel').addEventListener('change', render);
  document.getElementById('wDuration').addEventListener('change', render);

  // Workout Timer Logic
// Workout Timer Logic
let time = 0, timer = null, currentWorkout = null; // تعريف مرة واحدة هنا

function startWorkout(id) {
  currentWorkout = WORKOUTS.find(w => w.id === id);
  if (!currentWorkout) {
    alertShow('Workout not found.', 'danger');
    return;
  }
  document.getElementById('currentExercise').textContent = `Workout: ${currentWorkout.title}`;
  time = 0;
  timer = setInterval(() => {
    time++;
    const minutes = Math.floor(time / 60);
    const seconds = time % 60;
    document.getElementById('timerDisplay').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
  const modal = new bootstrap.Modal(document.getElementById('timerModal'));
  modal.show();
  modal._element.focus();
}

function stopWorkout() {
  clearInterval(timer); // استخدام المتغير العام
  if (currentWorkout) {
    alertShow(`Workout completed! Time: ${document.getElementById('timerDisplay').textContent}`, 'success');
    fetch(`/athlete/api/workouts/${currentWorkout.id}`, {
      method: 'PUT',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${document.cookie.split('; ').find(row => row.startsWith('access_token_cookie='))?.split('=')[1] || ''}` },
      body: JSON.stringify({ duration: time })
    });
  }
  const modal = bootstrap.Modal.getInstance(document.getElementById('timerModal'));
  if (modal) {
    modal.hide();
  }
  currentWorkout = null;
  timer = null; // إعادة تهيئة المتغير بعد الإيقاف
}

  fetchWorkouts();
</script>
{% endblock %}
