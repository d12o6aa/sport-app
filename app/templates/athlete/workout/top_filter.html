{% extends "shared/base.html" %}
{% block style%}
  <style>
  /* All your existing CSS styles are kept here */
  .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #495057;
  }

  .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
  }

  /* Top Workout Cards */
  .top-workout-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
  }

  .top-workout-item:hover {
    background-color: #e9ecef;
    transform: translateX(5px);
  }

  .rank-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin-right: 1rem;
  }

  .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; }
  .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #333; }
  .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); color: white; }
  .rank-default { background: #6c757d; color: white; }

  /* Achievement Badges */
  .achievement-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 20px;
    font-size: 0.8rem;
    margin: 0.25rem;
  }
  </style>
{% endblock %}

{% block content %}
<section class="section">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="m-0">Top Workouts</h5>
    <div class="btn-group">
      <button class="btn btn-outline-primary active" onclick="showTopWorkouts('calories', event)">Most Calories</button>
      <button class="btn btn-outline-primary" onclick="showTopWorkouts('duration', event)">Longest</button>
      <button class="btn btn-outline-primary" onclick="showTopWorkouts('recent', event)">Most Recent</button>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0"><i class="bi bi-trophy"></i> Top Performers</h6>
        </div>
        <div class="card-body" id="topPerformers">
          </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-heart"></i> Recent Favorites</h6>
        </div>
        <div class="card-body" id="recentFavorites">
          </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-star"></i> Achievements</h6>
        </div>
        <div class="card-body" id="achievements">
          </div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header">
      <h6 class="mb-0">All Time Best Workouts</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Workout</th>
              <th>Type</th>
              <th>Duration</th>
              <th>Calories</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="topWorkoutsTable">
            </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>

  <script>
  // Global variables
  let topWorkouts = [];

  // Define workout configs for dynamic card styling
  const WORKOUT_CONFIGS = {
      strength: { emoji: '💪', color: '#f56a6a', bgGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
      cardio: { emoji: '🏃', color: '#4CAF50', bgGradient: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
      yoga: { emoji: '🧘‍♀️', color: '#2196F3', bgGradient: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
      crossfit: { emoji: '🏋️‍♂️', color: '#FF9800', bgGradient: 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)' },
      running: { emoji: '🏃‍♀️', color: '#FF5722', bgGradient: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%)' },
      cycling: { emoji: '🚴', color: '#9C27B0', bgGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
      swimming: { emoji: '🏊‍♂️', color: '#03A9F4', bgGradient: 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)' },
      mobility: { emoji: '🤸', color: '#795548', bgGradient: 'linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%)' },
      custom: { emoji: '✍️', color: '#607D8B', bgGradient: 'linear-gradient(135deg, #d4d2d6 0%, #848286 100%)' }
  };

  // ================================
  // Top Workouts Page Functions  
  // ================================

  function showTopWorkouts(sortBy, event) {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    fetch(`/athlete/api/workouts/top?sort=${sortBy}`, {
      credentials: 'include'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      topWorkouts = data;
      displayTopWorkouts();
      displayTopPerformers();
      displayRecentFavorites();
      displayAchievements();
    })
    .catch(error => {
      console.error('Error fetching top workouts:', error);
      alertShow('Failed to load top workouts', 'danger');
    });
  }

  function displayTopWorkouts() {
    const tableBody = document.getElementById('topWorkoutsTable');
    if (!tableBody) return;
    
    if (topWorkouts.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No completed workouts to display.</td></tr>`;
      return;
    }
    
    tableBody.innerHTML = topWorkouts.map((workout, index) => {
      const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.strength;
      const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-default';
      
      return `
        <tr>
          <td>
            <div class="rank-badge ${rankClass}">${index + 1}</div>
          </td>
          <td>
            <div class="d-flex align-items-center">
              <div class="rounded me-2 d-flex align-items-center justify-content-center" 
                  style="width: 30px; height: 30px; background: ${config.bgGradient};">
                <span style="font-size: 12px;">${config.emoji}</span>
              </div>
              ${workout.title}
            </div>
          </td>
          <td><span class="badge" style="background-color: ${config.color}">${workout.workout_type}</span></td>
          <td>${workout.actual_duration || 0} min</td>
          <td>${workout.calories_burned || 0} cal</td>
          <td>${formatDate(workout.date)}</td>
          <td>
            <a href="/athlete/workout/summary/${workout.id}" class="btn btn-sm btn-outline-primary">
              View
            </a>
          </td>
        </tr>
      `;
    }).join('');
  }

  function displayTopPerformers() {
    const container = document.getElementById('topPerformers');
    if (!container) return;
    
    const topThree = topWorkouts.slice(0, 3);
    if (topThree.length === 0) {
      container.innerHTML = `<div class="text-center text-muted">No top performers yet.</div>`;
      return;
    }

    container.innerHTML = topThree.map((workout, index) => {
      const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.strength;
      const rankClass = `rank-${index + 1}`;
      
      return `
        <div class="top-workout-item">
          <div class="rank-badge ${rankClass}">${index + 1}</div>
          <div class="flex-grow-1">
            <div class="fw-medium">${workout.title}</div>
            <small class="text-muted">${workout.calories_burned || 0} calories</small>
          </div>
        </div>
      `;
    }).join('');
  }

  function displayRecentFavorites() {
    const container = document.getElementById('recentFavorites');
    if (!container) return;
    
    // Get recent completed workouts
    const recentCompleted = topWorkouts.filter(w => w.completion_status === 'completed').slice(0, 5);
    
    if (recentCompleted.length === 0) {
      container.innerHTML = `<div class="text-center text-muted">No recent favorites yet.</div>`;
      return;
    }

    container.innerHTML = recentCompleted.map(workout => {
      const config = WORKOUT_CONFIGS[workout.workout_type] || WORKOUT_CONFIGS.strength;
      
      return `
        <div class="top-workout-item">
          <div class="rounded me-3 d-flex align-items-center justify-content-center" 
              style="width: 30px; height: 30px; background: ${config.bgGradient};">
            <span style="font-size: 12px;">${config.emoji}</span>
          </div>
          <div class="flex-grow-1">
            <div class="fw-medium">${workout.title}</div>
            <small class="text-muted">${formatDate(workout.date)}</small>
          </div>
          <i class="bi bi-heart-fill text-danger"></i>
        </div>
      `;
    }).join('');
  }

  function displayAchievements() {
    const container = document.getElementById('achievements');
    if (!container) return;
    
    // Calculate some achievements based on topWorkouts data
    const totalWorkouts = topWorkouts.length;
    const totalCalories = topWorkouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
    const totalTime = topWorkouts.reduce((sum, w) => sum + (w.actual_duration || 0), 0);
    
    const achievements = [];
    
    if (totalWorkouts >= 10) achievements.push('Workout Warrior');
    if (totalCalories >= 5000) achievements.push('Calorie Crusher');
    if (totalTime >= 1000) achievements.push('Time Master');
    if (topWorkouts.some(w => w.difficulty_level === 'advanced')) achievements.push('Advanced Athlete');
    
    if (achievements.length === 0) {
      container.innerHTML = `<div class="text-center text-muted">No achievements yet.</div>`;
      return;
    }

    container.innerHTML = `
      <div class="text-center mb-3">
        <div class="stat-number">${achievements.length}</div>
        <div class="stat-label">Achievements</div>
      </div>
      <div class="text-center">
        ${achievements.map(achievement => `
          <span class="achievement-badge">${achievement}</span>
        `).join('')}
      </div>
    `;
  }

  // Helper functions
  function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
  }
  
  function alertShow(message, type) {
      console.log(`Alert (${type}): ${message}`);
      // In a real application, you'd use a UI library to show a toast or a modal.
  }

  // Initialize page-specific functions when DOM loads
  document.addEventListener('DOMContentLoaded', function() {
    // Default to show top workouts by calories on page load
    const defaultButton = document.querySelector('.btn-group .btn.active');
    if (defaultButton) {
        showTopWorkouts(defaultButton.textContent.split(' ')[1].toLowerCase(), { currentTarget: defaultButton });
    }
  });
  </script>
{% endblock %}